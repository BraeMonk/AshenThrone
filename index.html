<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<!-- Favicon -->
<link rel="icon" type="image/png" sizes="32x32" href="F2171A02-E8D8-4FE9-952A-5021B5CDC6A3.png">

<!-- Apple Touch Icon (VERY IMPORTANT for iOS Home Screen) -->
<link rel="apple-touch-icon" sizes="180x180" href="F2171A02-E8D8-4FE9-952A-5021B5CDC6A3.png">

<!-- PWA Icons -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#2b0000">
<title>Ashen Throne</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cinzel+Decorative:wght@700&family=Crimson+Text:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<style>
/* ========================================================
   RESET & ROOT ‚Äî 32-BIT VISUAL UPGRADE
======================================================== */
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;}
:root{
  --bg:#09080c;
  --panel:#13111a;
  --panel2:#1a1824;
  --panel3:#22202e;
  --panel4:#2a2838;
  --border:#2e2b42;
  --border2:#4a4670;
  --border3:#6a6490;
  --gold:#f0c030;
  --gold2:#ffd86e;
  --gold3:#c89018;
  --golddim:#9a7a20;
  --goldglow:rgba(240,192,48,0.35);
  --red:#e83040;
  --red2:#ff6070;
  --green:#30c050;
  --green2:#60e080;
  --blue:#3060e0;
  --blue2:#6090ff;
  --purple:#9040d0;
  --ember:#d04020;
  --txt:#ffffff;
  --txt2:#e8d8f0;
  --txt3:#b0a0c8;
  --txtdim:#9088a8;
  --sp-xs:6px;
  --sp-sm:10px;
  --sp-md:14px;
  --sp-lg:20px;
  --fs-xs:0.62rem;
  --fs-sm:0.74rem;
  --fs-md:0.88rem;
  --fs-lg:1.0rem;
  --fs-xl:1.2rem;
}

/* ========================================================
APP SHELL
======================================================== */
body{font-family:'Cinzel',Georgia,serif;}
#app{position:fixed;inset:0;width:100%;height:100%;overflow:hidden;transform-origin:top left;}
.scr{position:absolute;inset:0;display:none;flex-direction:column;overflow:hidden;}
.scr.on{display:flex;}

/* ========================================================
TITLE SCREEN ‚Äî 32-bit atmospheric depth
======================================================== */
#s0{
background:
radial-gradient(ellipse 80% 60% at 50% 70%, rgba(180,40,10,0.18) 0%, transparent 70%),
radial-gradient(ellipse 120% 90% at 50% 60%, #140a18 0%, #080508 100%);
align-items:center;justify-content:center;
}
#s0-cv{position:absolute;inset:0;width:100%;height:100%;}
.t-body{
position:relative;z-index:2;
display:flex;flex-direction:column;align-items:center;
gap:14px;padding:32px 28px;text-align:center;
}
.t-crest{
font-size:3.8rem;
filter:drop-shadow(0 0 30px rgba(200,60,20,0.9)) drop-shadow(0 0 70px rgba(200,60,20,0.5)) drop-shadow(0 4px 2px rgba(0,0,0,0.9));
animation:cresthover 3s ease-in-out infinite;
}
@keyframes cresthover{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-6px) scale(1.03);}}
.t-title{
font-family:'Cinzel Decorative',serif;font-weight:700;font-size:2.4rem;
color:transparent;
background:linear-gradient(180deg,#ffe090 0%,#f0c030 35%,#c08010 70%,#8a5808 100%);
-webkit-background-clip:text;background-clip:text;
letter-spacing:6px;line-height:.95;
filter:drop-shadow(0 4px 16px rgba(0,0,0,0.9));text-shadow:none;
}
.t-sub{font-size:0.68rem;color:#a08040;letter-spacing:8px;text-transform:uppercase;opacity:0.9;}
.t-divider{display:flex;align-items:center;gap:12px;width:280px;max-width:88vw;}
.t-line{flex:1;height:1px;background:linear-gradient(90deg,transparent,#4a3818,#f0c030,#4a3818,transparent);}
.t-divider-ico{color:#c09020;font-size:0.7rem;opacity:0.7;}
.t-lore{font-family:'Crimson Text',serif;font-style:italic;font-size:0.88rem;color:#9a7e3a;max-width:300px;line-height:1.7;}
.t-btns{display:flex;flex-direction:column;gap:10px;width:100%;max-width:280px;}
.t-btn{
font-family:'Cinzel',serif;font-size:0.95rem;font-weight:700;letter-spacing:3px;color:#1a0e00;
background:linear-gradient(180deg,#ffe080 0%,#f0c030 18%,#d4a020 50%,#b07810 82%,#8a5808 100%);
border:none;border-radius:5px;padding:15px 36px;
box-shadow:0 0 28px rgba(240,192,48,0.5),0 4px 0 #5a3a00,0 6px 20px rgba(0,0,0,0.9),inset 0 1px 0 rgba(255,255,255,0.35),inset 0 -1px 0 rgba(0,0,0,0.3);
min-height:50px;cursor:pointer;transition:transform .1s,box-shadow .1s,filter .1s;position:relative;overflow:hidden;
}
.t-btn::before{
content:'';position:absolute;top:0;left:-100%;width:60%;height:100%;
background:linear-gradient(90deg,transparent,rgba(255,255,255,0.2),transparent);
animation:btnshine 4s infinite;
}
@keyframes btnshine{0%,100%{left:-100%;}45%,55%{left:150%;}}
.t-btn:active{transform:scale(.94) translateY(2px);box-shadow:0 0 14px rgba(240,192,48,0.3),0 2px 0 #5a3a00,0 3px 8px rgba(0,0,0,0.8);}
.t-btn-sec{
font-family:'Cinzel',serif;font-size:0.72rem;color:#a08848;
background:rgba(20,16,30,0.8);border:1.5px solid #3a3020;border-radius:5px;
padding:11px 20px;cursor:pointer;letter-spacing:2px;min-height:42px;transition:all .18s;
box-shadow:0 2px 8px rgba(0,0,0,0.5),inset 0 1px 0 rgba(255,255,255,0.04);
}
.t-btn-sec:active{border-color:#f0c030;color:#f0c030;background:rgba(30,24,10,0.9);}
.t-hint{font-size:0.6rem;color:#7a6840;font-style:italic;}

/* ========================================================
CLASS SELECT
======================================================== */
#s1{background:var(--bg);overflow-y:auto;-webkit-overflow-scrolling:touch;}
.page-hdr{
flex-shrink:0;
padding:max(12px,env(safe-area-inset-top,12px)) var(--sp-md) var(--sp-sm);
background:var(--panel);border-bottom:2px solid var(--border2);
box-shadow:0 2px 16px rgba(0,0,0,0.6);
}
.page-hdr-title{font-size:var(--fs-sm);color:var(--gold);letter-spacing:5px;text-align:center;text-shadow:0 0 12px var(--goldglow);}
.page-hdr-sub{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#7a6540;text-align:center;margin-top:4px;}
.cls-list{
padding:var(--sp-md);display:grid;
grid-template-columns:repeat(auto-fill,minmax(min(100%,360px),1fr));
gap:var(--sp-md);align-content:start;
}
.cls-list::-webkit-scrollbar{width:3px;}
.cls-list::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.cls-card{
background:linear-gradient(135deg,var(--panel2),var(--panel3));
border:2px solid var(--border);border-radius:10px;
padding:var(--sp-md);display:flex;gap:var(--sp-md);align-items:flex-start;
cursor:pointer;overflow:hidden;transition:border-color .18s,background .18s,box-shadow .18s,transform .12s;
position:relative;box-shadow:0 2px 12px rgba(0,0,0,0.5);
}
.cls-card::before{
content:'';position:absolute;top:0;left:0;right:0;height:1px;
background:linear-gradient(90deg,transparent,rgba(255,255,255,0.06),transparent);
}
.cls-card:hover{border-color:var(--border3);transform:translateY(-1px);box-shadow:0 4px 20px rgba(0,0,0,0.7);}
.cls-card.sel{
border-color:var(--gold);background:linear-gradient(135deg,#1e1a10,#2a2410);
box-shadow:0 0 20px var(--goldglow),0 4px 20px rgba(0,0,0,0.7);
}
.cls-sprite-wrap{
width:68px;height:68px;flex-shrink:0;border-radius:8px;
background:radial-gradient(circle at 40% 35%,#1e1a2a,#0a0810);
border:2px solid var(--border2);overflow:hidden;
box-shadow:inset 0 2px 8px rgba(0,0,0,0.8),inset 0 -1px 3px rgba(255,255,255,0.03);
}
.cls-sprite-wrap canvas{image-rendering:pixelated;width:100%;height:100%;}
.cls-text{flex:1;min-width:0;}
.cls-name{font-size:var(--fs-md);font-weight:700;color:var(--gold);margin-bottom:3px;text-shadow:0 0 8px var(--goldglow);}
.cls-flavor{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#9a8048;line-height:1.45;margin-bottom:5px;}
.cls-lore{font-family:'Crimson Text',serif;font-size:var(--fs-xs);color:#8a7248;line-height:1.45;margin-bottom:7px;}
.cls-stats{display:flex;gap:5px;flex-wrap:wrap;}
.cls-stat{
font-size:var(--fs-xs);color:#b8a060;background:rgba(0,0,0,0.4);
border:1px solid var(--border2);border-radius:3px;padding:2px 6px;
box-shadow:inset 0 1px 3px rgba(0,0,0,0.4);
}
.cls-foot{padding:var(--sp-sm) var(--sp-md) max(var(--sp-md),env(safe-area-inset-bottom,12px));background:var(--panel);border-top:2px solid var(--border2);position:sticky;bottom:0;z-index:10;}
.cls-go{
width:100%;padding:13px;font-family:'Cinzel',serif;font-size:var(--fs-md);font-weight:700;
letter-spacing:3px;color:#1a0e00;background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);
border:none;border-radius:5px;cursor:pointer;min-height:48px;
box-shadow:0 4px 0 #5a3a00,0 6px 16px rgba(240,192,48,0.3);transition:all .12s;
}
.cls-go:disabled{opacity:.2;pointer-events:none;}
.cls-go:active{transform:translateY(2px);box-shadow:0 2px 0 #5a3a00,0 3px 8px rgba(240,192,48,0.2);}

/* ========================================================
MAIN GAME
======================================================== */
#s2{background:var(--bg);height:100%;overflow:hidden;flex-direction:column;}

/* === HUD === */
#hud{
flex-shrink:0;
padding:max(10px,env(safe-area-inset-top,10px)) var(--sp-md) 10px;
background:linear-gradient(180deg,var(--panel) 0%,rgba(19,17,26,0.95) 100%);
border-bottom:2px solid var(--border2);box-shadow:0 3px 16px rgba(0,0,0,0.7);
display:grid;grid-template-columns:44px 1fr auto;align-items:center;gap:var(--sp-sm);
}
#hud-av{
width:44px;height:44px;border-radius:50%;
background:radial-gradient(circle at 40% 35%,#252030,#0c0a14);
border:2px solid var(--border3);display:flex;align-items:center;justify-content:center;
font-size:1.3rem;box-shadow:0 0 12px rgba(106,100,144,0.3),inset 0 2px 6px rgba(0,0,0,0.8);
}
#hud-bars{display:flex;flex-direction:column;gap:4px;}
.br{display:flex;align-items:center;gap:5px;}
.br-ico{font-size:0.7rem;width:13px;flex-shrink:0;filter:drop-shadow(0 0 3px currentColor);}
.br-track{
flex:1;height:8px;background:rgba(0,0,0,0.7);border-radius:5px;overflow:hidden;
border:1px solid rgba(255,255,255,0.05);box-shadow:inset 0 2px 4px rgba(0,0,0,0.8);
}
.br-fill{height:100%;border-radius:5px;transition:width .35s ease;position:relative;overflow:hidden;}
.br-fill::after{content:'';position:absolute;top:0;left:0;right:0;height:45%;background:rgba(255,255,255,0.18);border-radius:5px 5px 0 0;}
.br-fill::before{
content:'';position:absolute;top:0;left:-100%;width:50%;height:100%;
background:rgba(255,255,255,0.1);animation:barsheen 2.5s ease-in-out infinite;
}
@keyframes barsheen{0%{left:-100%;}50%,100%{left:200%;}}
.br-fill.hp{background:linear-gradient(90deg,#700808,#c02020 30%,#e84040 70%,#ff6060 100%);}
.br-fill.mp{background:linear-gradient(90deg,#080c50,#1830a0 30%,#3858d8 70%,#6090ff 100%);}
.br-fill.xp{background:linear-gradient(90deg,#082808,#156015 30%,#28a028 70%,#50d050 100%);}
.br-val{font-size:var(--fs-xs);color:var(--txt3);width:56px;text-align:right;flex-shrink:0;white-space:nowrap;}
#hud-right{text-align:right;}
#hud-gold{
font-size:var(--fs-sm);color:var(--gold);
display:flex;align-items:center;justify-content:flex-end;gap:4px;
text-shadow:0 0 8px var(--goldglow);
}
#hud-lv{font-size:var(--fs-xs);color:var(--txtdim);margin-top:2px;}
#hud-zb{
font-size:var(--fs-xs);color:#e08830;background:rgba(180,90,20,0.15);
border:1px solid rgba(180,90,20,0.3);border-radius:3px;
padding:2px 6px;margin-top:3px;display:inline-block;box-shadow:0 0 6px rgba(200,100,20,0.15);
}

/* === STORY TICKER === */
#story-ticker{
flex-shrink:0;height:26px;
background:linear-gradient(90deg,#0c0910,#141020,#0c0910);
border-bottom:1px solid var(--border);
overflow:hidden;display:flex;align-items:center;padding:0 var(--sp-md);gap:8px;
}
#story-ico{font-size:0.72rem;flex-shrink:0;filter:drop-shadow(0 0 3px rgba(240,192,48,0.4));}
#story-txt{font-family:'Crimson Text',serif;font-style:italic;font-size:0.78rem;color:#a08848;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* === ARENA === */
#arena-wrap{
flex-shrink:0;height:30vh;min-height:150px;max-height:260px;position:relative;background:#050408;overflow:hidden;
border-bottom:2px solid var(--border);
}
#arena-cv{position:absolute;inset:0;width:100%;height:100%;display:block;}
#arena-ov{position:absolute;inset:0;pointer-events:none;z-index:10;}
#zone-prog{position:absolute;top:0;left:0;right:0;height:3px;z-index:15;background:rgba(0,0,0,0.5);}
#zone-prog-fill{
height:100%;background:linear-gradient(90deg,rgba(90,70,10,0.6),var(--gold));
box-shadow:0 0 6px var(--goldglow);transition:width .5s ease;
}
#btn-auto{
position:absolute;bottom:8px;left:8px;z-index:20;
background:rgba(10,9,16,0.85);border:1.5px solid var(--border2);border-radius:16px;
color:var(--txtdim);font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:1.5px;
padding:6px 12px;cursor:pointer;min-height:32px;transition:all .2s;
backdrop-filter:blur(4px);box-shadow:0 2px 8px rgba(0,0,0,0.6);
}
#btn-auto.on{border-color:var(--green);color:var(--green);box-shadow:0 0 12px rgba(48,192,80,0.35),0 2px 8px rgba(0,0,0,0.6);}
#btn-zone-lbl{
position:absolute;bottom:8px;left:50%;transform:translateX(-50%);z-index:20;
background:rgba(10,9,16,0.85);border:1.5px solid var(--border3);border-radius:16px;
color:var(--gold);font-family:'Cinzel',serif;font-size:0.6rem;letter-spacing:1px;
padding:6px 12px;min-height:32px;white-space:nowrap;
display:flex;align-items:center;gap:5px;cursor:pointer;
backdrop-filter:blur(4px);box-shadow:0 0 10px var(--goldglow),0 2px 8px rgba(0,0,0,0.6);
}
#btn-attack{
position:absolute;bottom:8px;right:8px;z-index:20;
width:62px;height:62px;border-radius:50%;
background:radial-gradient(circle at 35% 30%,#e85030,#b82818,#780810);
border:3px solid #d4a020;display:flex;align-items:center;justify-content:center;
font-size:1.5rem;cursor:pointer;
box-shadow:0 4px 24px rgba(200,60,20,0.7),0 0 40px rgba(200,60,20,0.2),inset 0 1px 0 rgba(255,255,255,0.25),inset 0 -2px 4px rgba(0,0,0,0.4);
transition:transform .1s,box-shadow .1s;
}
#btn-attack::before{
content:'';position:absolute;width:70%;height:40%;top:8%;border-radius:50%;
background:radial-gradient(ellipse,rgba(255,255,255,0.18),transparent);
}
#btn-attack:active{transform:scale(.87);box-shadow:0 2px 8px rgba(200,60,20,0.4),inset 0 -1px 0 rgba(0,0,0,0.5);}

/* === TABS === */
#tabs{
flex-shrink:0;display:grid;grid-template-columns:repeat(6,1fr);
background:var(--panel);border-top:2px solid var(--border2);
border-bottom:2px solid var(--border);box-shadow:0 -2px 12px rgba(0,0,0,0.5);
}
.tab-btn{
padding:7px 2px 6px;display:flex;flex-direction:column;align-items:center;gap:3px;
cursor:pointer;border-right:1px solid var(--border);transition:background .18s;position:relative;
}
.tab-btn:last-child{border-right:none;}
.tab-btn.on{background:linear-gradient(180deg,var(--panel3),var(--panel2));border-bottom:2px solid var(--gold);}
.tab-ico{font-size:1.05rem;line-height:1;}
.tab-lbl{font-size:0.5rem;color:var(--txtdim);letter-spacing:.5px;text-transform:uppercase;}
.tab-btn.on .tab-lbl{color:var(--gold);}
.tab-dot{position:absolute;top:4px;right:5px;width:7px;height:7px;background:var(--red);border-radius:50%;border:1.5px solid var(--panel);box-shadow:0 0 6px rgba(232,48,64,0.6);}

/* === TAB BODY === */
#tab-body{
flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;
-webkit-overflow-scrolling:touch;background:var(--bg);
padding-bottom:max(var(--sp-md),env(safe-area-inset-bottom,10px));
}
#tab-body::-webkit-scrollbar{width:3px;}
#tab-body::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* ========================================================
LAYOUT ‚Äî Tablet / Desktop
======================================================== */
@media (min-width:640px) and (max-width:1023px){
.cls-list{grid-template-columns:repeat(2,1fr);}
.q-list,.boon-list{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--sp-sm);}
.story-list{display:grid;grid-template-columns:repeat(2,1fr);gap:var(--sp-sm);}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-md);}
}
@media (min-width:1024px){
#s2{flex-direction:row;align-items:stretch;}
#game-left{
width:100%;flex-shrink:0;display:flex;flex-direction:column;
border-right:2px solid var(--border2);overflow:hidden;height:100%;
box-shadow:4px 0 20px rgba(0,0,0,0.5);
}
#game-right{flex:1;min-width:0;display:flex;flex-direction:column;overflow:hidden;height:100%;}
#tab-body{flex:1;overflow-y:auto;}
#tab-body .sec{max-width:900px;margin:0 auto;padding:var(--sp-lg) var(--sp-md);}
.q-list,.boon-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:var(--sp-md);}
.story-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(340px,1fr));gap:var(--sp-md);}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(--sp-md);}
.cls-list{grid-template-columns:repeat(auto-fill,minmax(310px,1fr));}
.sk-card{min-height:120px;}
.sk-ico{width:52px;height:52px;font-size:1.5rem;}
.sk-name{font-size:.78rem;}
.sk-desc{font-size:.64rem;}
#hud-gold{font-size:var(--fs-sm);}
}
@media (min-width:1400px){
.q-list,.boon-list{grid-template-columns:repeat(3,1fr);}
.story-list{grid-template-columns:repeat(3,1fr);}
}
#game-left,#game-right{display:contents;}
@media (min-width:1024px){
#game-left,#game-right{display:flex;flex-direction:column;}
}

/* ========================================================
SHARED SECTION STYLES
======================================================== */
.sec{padding:var(--sp-lg) var(--sp-md);}
.sec-hdr{
font-size:var(--fs-xs);color:var(--gold);letter-spacing:4px;text-transform:uppercase;
padding-bottom:8px;margin-bottom:var(--sp-md);border-bottom:1px solid var(--border2);
display:flex;align-items:center;justify-content:space-between;
text-shadow:0 0 10px var(--goldglow);
}
.sp-badge{
background:linear-gradient(135deg,var(--panel3),var(--panel4));
border:1px solid var(--border3);border-radius:12px;
padding:3px 12px;font-size:var(--fs-sm);color:var(--gold);
box-shadow:0 0 8px var(--goldglow),inset 0 1px 3px rgba(0,0,0,0.5);
}
.filter-row{
display:flex;gap:6px;margin-bottom:var(--sp-md);
overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:3px;
}
.filter-row::-webkit-scrollbar{display:none;}
.f-btn{
flex-shrink:0;padding:5px 12px;border:1.5px solid var(--border);border-radius:14px;
font-size:var(--fs-xs);color:var(--txtdim);cursor:pointer;
background:var(--panel2);letter-spacing:.5px;transition:all .18s;
box-shadow:0 2px 6px rgba(0,0,0,0.4);
}
.f-btn.on{border-color:var(--gold);color:var(--gold);background:var(--panel3);box-shadow:0 0 10px var(--goldglow);}

/* ========================================================
STORY TAB
======================================================== */
.story-list{display:flex;flex-direction:column;gap:var(--sp-md);}
@media (min-width:900px){
.story-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(360px,1fr));}
}
.chapter-card{
background:linear-gradient(135deg,var(--panel2),var(--panel3));
border:2px solid var(--border);border-radius:10px;overflow:hidden;position:relative;
box-shadow:0 3px 14px rgba(0,0,0,0.5);transition:box-shadow .18s,border-color .18s;
}
.chapter-card:hover{box-shadow:0 4px 20px rgba(0,0,0,0.7);}
.chapter-card.active{border-color:var(--border3);}
.chapter-card.complete{border-color:#1e5820;box-shadow:0 3px 14px rgba(30,88,32,0.2);}
.chapter-card.locked{opacity:.3;}
.chapter-card::before{content:'';position:absolute;top:0;left:0;right:0;height:2px;}
.chapter-card.active::before{background:linear-gradient(90deg,transparent,var(--gold),transparent);}
.chapter-card.complete::before{background:linear-gradient(90deg,transparent,var(--green),transparent);}
.ch-hdr{padding:var(--sp-md);display:flex;align-items:center;gap:var(--sp-sm);border-bottom:1px solid var(--border);}
.ch-num{font-size:var(--fs-xs);color:var(--golddim);letter-spacing:2px;text-transform:uppercase;flex-shrink:0;}
.ch-ico{font-size:1.4rem;flex-shrink:0;filter:drop-shadow(0 2px 4px rgba(0,0,0,0.8));}
.ch-info{flex:1;min-width:0;}
.ch-title{font-size:var(--fs-md);color:#f0d868;font-weight:700;text-shadow:0 0 8px rgba(240,216,104,0.3);}
.ch-zone{font-size:var(--fs-xs);color:#8a7040;letter-spacing:1px;margin-top:2px;}
.ch-lock{font-size:var(--fs-sm);color:var(--txtdim);flex-shrink:0;}
.ch-body{padding:var(--sp-md);}
.ch-quote{
font-family:'Crimson Text',serif;font-style:italic;
font-size:var(--fs-sm);color:#8a7040;margin-bottom:8px;
border-left:2px solid var(--border3);padding-left:10px;line-height:1.5;
}
.ch-desc{font-family:'Crimson Text',serif;font-size:var(--fs-sm);color:#9a8050;line-height:1.6;margin-bottom:10px;}
.ch-objs{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
.ch-obj{display:flex;align-items:center;gap:7px;}
.ch-obj-ico{font-size:var(--fs-sm);width:16px;flex-shrink:0;}
.ch-obj-txt{font-size:var(--fs-xs);color:#a88c50;flex:1;}
.ch-obj-bar{height:4px;flex:1;background:rgba(255,255,255,0.05);border-radius:3px;overflow:hidden;}
.ch-obj-fill{height:100%;background:linear-gradient(90deg,var(--golddim),var(--gold));border-radius:3px;transition:width .5s;box-shadow:0 0 4px var(--goldglow);}
.ch-obj-val{font-size:var(--fs-xs);color:var(--golddim);white-space:nowrap;}
.ch-rew{
font-size:var(--fs-xs);color:var(--gold);padding:7px var(--sp-md);
background:rgba(240,192,48,0.05);border-top:1px solid var(--border);
display:flex;align-items:center;gap:7px;
}
.ch-complete{
font-size:var(--fs-xs);color:var(--green2);padding:7px var(--sp-md);
background:rgba(48,192,80,0.05);border-top:1px solid #1a4810;
display:flex;align-items:center;gap:6px;
}

/* ========================================================
SKILL TREES
======================================================== */
.sk-tree-tabs{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:var(--sp-lg);}
.sk-tree-tab{
padding:7px 2px;text-align:center;
background:linear-gradient(180deg,var(--panel2),var(--panel));
border:1.5px solid var(--border);border-radius:7px;
font-size:var(--fs-xs);color:var(--txtdim);cursor:pointer;
transition:all .18s;min-height:44px;
display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;
box-shadow:0 2px 8px rgba(0,0,0,0.4);
}
.sk-tree-tab span:first-child{font-size:1.0rem;}
.sk-tree-tab.on{
background:linear-gradient(180deg,var(--panel4),var(--panel3));
border-color:var(--gold);color:var(--gold);
box-shadow:0 0 12px var(--goldglow),0 2px 8px rgba(0,0,0,0.5);
}
.sk-tier-wrap{display:flex;flex-direction:column;}
.sk-connector{height:16px;position:relative;margin:0 8px;}
.sk-connector::before{content:'';position:absolute;top:0;left:50%;width:1px;height:100%;background:var(--border3);}
.sk-connector.fork::before{display:none;}
.sk-connector.fork::after{content:'';position:absolute;top:0;left:25%;right:25%;height:50%;border:1px solid var(--border3);border-top:none;}
.sk-row{display:grid;gap:8px;}
.sk-row-1{grid-template-columns:minmax(0,1fr);max-width:180px;margin:0 auto;}
.sk-row-2{grid-template-columns:1fr 1fr;}
.sk-row-3{grid-template-columns:1fr 1fr 1fr;}
.sk-card{
background:linear-gradient(180deg,var(--panel2),var(--panel));
border:2px solid var(--border);border-radius:8px;padding:10px 8px;
cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;
text-align:center;position:relative;
transition:border-color .18s,background .18s,transform .1s,box-shadow .15s;
min-height:110px;box-shadow:0 2px 10px rgba(0,0,0,0.5);
}
.sk-card::before{
content:'';position:absolute;top:0;left:0;right:0;height:1px;
background:linear-gradient(90deg,transparent,rgba(255,255,255,0.05),transparent);
}
.sk-card.unlocked{border-color:var(--border3);background:linear-gradient(180deg,var(--panel3),var(--panel2));}
.sk-card.maxed{
border-color:var(--gold);background:linear-gradient(180deg,#201a08,#18140a);
box-shadow:0 0 16px var(--goldglow),0 2px 10px rgba(0,0,0,0.6);
}
.sk-card.locked{opacity:.28;pointer-events:none;}
.sk-card.capstone{border-style:dashed;}
.sk-card.capstone.maxed{border-style:solid;box-shadow:0 0 22px var(--goldglow);}
.sk-card.capstone.unlocked{border-style:solid;}
.sk-card:active:not(.locked){transform:scale(.96);}
.sk-ico{
width:44px;height:44px;border-radius:50%;
background:radial-gradient(circle at 40% 35%,var(--panel3),var(--panel));
border:2px solid var(--border);display:flex;align-items:center;justify-content:center;
font-size:1.25rem;transition:all .18s;box-shadow:inset 0 2px 6px rgba(0,0,0,0.6);
}
.sk-card.unlocked .sk-ico{border-color:var(--border3);box-shadow:0 0 10px rgba(240,192,48,0.2),inset 0 2px 6px rgba(0,0,0,0.5);}
.sk-card.maxed .sk-ico{border-color:var(--gold);box-shadow:0 0 16px var(--goldglow),inset 0 2px 6px rgba(0,0,0,0.4);}
.sk-name{font-size:var(--fs-xs);color:#e8d870;font-weight:700;line-height:1.2;text-shadow:0 0 6px rgba(232,216,112,0.3);}
.sk-desc{font-size:0.58rem;color:#9a8050;font-style:italic;line-height:1.35;}
.sk-pips{display:flex;gap:2.5px;flex-wrap:wrap;justify-content:center;margin-top:2px;}
.pip{width:8px;height:3px;border-radius:2px;background:#0e0c18;border:1px solid rgba(255,255,255,0.04);}
.pip.on{background:#c09828;box-shadow:0 0 4px rgba(192,152,40,0.5);}
.pip.onmax{background:var(--gold);box-shadow:0 0 6px var(--goldglow);}
.sk-rank{font-size:var(--fs-xs);color:var(--gold);}
.sk-cap-tag{position:absolute;top:2px;right:4px;font-size:.42rem;color:#c0a040;letter-spacing:.4px;text-transform:uppercase;}
.sk-req-warn{font-size:0.54rem;color:var(--red);margin-top:1px;}

/* ========================================================
   SKILL INVESTMENT (Level 90+)
======================================================== */
.sk-invest-intro{
  font-family:'Crimson Text',serif;font-style:italic;
  font-size:var(--fs-sm);color:#a08848;line-height:1.7;
  margin-bottom:var(--sp-lg);padding:var(--sp-md);
  background:rgba(240,192,48,0.04);border:1px solid var(--border2);border-radius:8px;
}
.sk-invest-list{display:flex;flex-direction:column;gap:var(--sp-md);}
.sk-invest-card{
  background:linear-gradient(135deg,var(--panel2),var(--panel3));
  border:2px solid var(--border);border-radius:10px;
  padding:var(--sp-md);display:flex;gap:var(--sp-md);align-items:center;
  box-shadow:0 2px 12px rgba(0,0,0,0.45);
}
.sk-invest-card.maxed{border-color:var(--golddim);}
.sk-invest-ico{
  width:48px;height:48px;border-radius:9px;flex-shrink:0;
  background:radial-gradient(circle at 40% 35%,var(--panel3),var(--panel));
  border:2px solid var(--border2);display:flex;align-items:center;justify-content:center;
  font-size:1.3rem;box-shadow:inset 0 2px 8px rgba(0,0,0,0.7);
}
.sk-invest-body{flex:1;min-width:0;}
.sk-invest-name{font-size:var(--fs-sm);color:#e8d870;font-weight:700;margin-bottom:2px;}
.sk-invest-desc{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#a07c48;line-height:1.4;margin-bottom:5px;}
.sk-invest-bar-wrap{height:5px;background:rgba(0,0,0,0.5);border-radius:3px;overflow:hidden;margin-bottom:4px;}
.sk-invest-bar{height:100%;background:linear-gradient(90deg,var(--golddim),var(--gold));border-radius:3px;transition:width .4s;box-shadow:0 0 4px var(--goldglow);}
.sk-invest-prog{font-size:var(--fs-xs);color:var(--txtdim);margin-bottom:4px;}
.sk-invest-rew{font-size:var(--fs-xs);color:var(--green2);}
.sk-invest-diminish{font-size:var(--fs-xs);color:var(--golddim);margin-top:2px;font-style:italic;}
.btn-invest{
  flex-shrink:0;padding:9px 14px;font-family:'Cinzel',serif;font-size:var(--fs-xs);
  font-weight:700;letter-spacing:1px;border:none;border-radius:5px;cursor:pointer;
  min-height:40px;min-width:60px;transition:all .12s;
  background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);
  color:#1a0e00;box-shadow:0 3px 0 #5a3a00,0 0 10px rgba(240,192,48,0.2);
}
.btn-invest:active{transform:translateY(1px);box-shadow:0 1px 0 #5a3a00;}
.btn-invest:disabled{opacity:.25;pointer-events:none;}
.sk-invest-locked{
  text-align:center;padding:var(--sp-lg);
  font-family:'Crimson Text',serif;font-style:italic;
  font-size:var(--fs-sm);color:#7a6040;
}

/* ========================================================
   ASHEN MEMORY BOON (special unlock at Lv 100)
======================================================== */
.ashen-memory-card{
  background:linear-gradient(135deg,#100c18,#1a1428);
  border:2px solid #5a3a90;border-radius:12px;
  padding:var(--sp-lg);margin-bottom:var(--sp-lg);
  box-shadow:0 0 28px rgba(120,60,200,0.25),0 4px 16px rgba(0,0,0,0.6);
  position:relative;overflow:hidden;
}
.ashen-memory-card::before{
  content:'';position:absolute;top:0;left:0;right:0;height:2px;
  background:linear-gradient(90deg,transparent,#9060d0,transparent);
}
.ashen-memory-header{display:flex;align-items:center;gap:12px;margin-bottom:10px;}
.ashen-memory-ico{font-size:2rem;filter:drop-shadow(0 0 12px rgba(180,100,255,0.7));}
.ashen-memory-title{font-size:var(--fs-lg);color:#c090f0;font-weight:700;text-shadow:0 0 12px rgba(160,80,240,0.5);}
.ashen-memory-lv{font-size:var(--fs-xs);color:#8060b0;letter-spacing:2px;margin-top:2px;}
.ashen-memory-desc{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-sm);color:#9070c0;line-height:1.7;margin-bottom:10px;}
.ashen-memory-effect{font-size:var(--fs-sm);color:#c090f0;margin-bottom:10px;padding:8px 12px;background:rgba(120,60,200,0.1);border:1px solid rgba(120,60,200,0.25);border-radius:6px;}
.ashen-memory-cost{font-size:var(--fs-xs);color:var(--golddim);margin-bottom:10px;}
.ashen-memory-locked{font-size:var(--fs-xs);color:#60406080;letter-spacing:2px;}
.btn-ashen-memory{
  width:100%;padding:12px;font-family:'Cinzel',serif;font-size:var(--fs-sm);font-weight:700;
  letter-spacing:2px;border:none;border-radius:6px;cursor:pointer;min-height:46px;
  background:linear-gradient(180deg,#c090f0,#8040c0,#50208080);
  color:#f0e8ff;box-shadow:0 4px 0 #2a0860,0 0 20px rgba(140,60,220,0.4);transition:all .12s;
}
.btn-ashen-memory:active{transform:translateY(2px);box-shadow:0 2px 0 #2a0860;}
.btn-ashen-memory:disabled{opacity:.25;pointer-events:none;}

/* ========================================================
QUESTS
======================================================== */
.q-list{display:flex;flex-direction:column;gap:var(--sp-md);}
.q-card{
background:linear-gradient(135deg,var(--panel2),var(--panel3));
border:2px solid var(--border);border-radius:10px;
padding:var(--sp-md);display:flex;gap:var(--sp-md);align-items:flex-start;
transition:border-color .18s,box-shadow .18s;box-shadow:0 2px 12px rgba(0,0,0,0.45);
}
.q-card.in-progress{border-color:var(--border3);}
.q-card.done{border-color:#1a4818;background:linear-gradient(135deg,#0e1510,#121a10);box-shadow:0 2px 12px rgba(20,60,16,0.2);}
.q-ico{
width:44px;height:44px;border-radius:8px;flex-shrink:0;
background:radial-gradient(circle at 40% 35%,var(--panel3),var(--panel));
border:2px solid var(--border);display:flex;align-items:center;justify-content:center;
font-size:1.2rem;box-shadow:inset 0 2px 6px rgba(0,0,0,0.6);
}
.q-card.done .q-ico{border-color:#204820;}
.q-body{flex:1;min-width:0;}
.q-name{font-size:var(--fs-sm);color:#e8d870;font-weight:700;margin-bottom:3px;text-shadow:0 0 6px rgba(232,216,112,0.2);}
.q-cat{font-size:var(--fs-xs);color:var(--golddim);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px;}
.q-desc{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#a07c48;line-height:1.45;margin-bottom:6px;}
.q-bar-wrap{height:5px;background:rgba(0,0,0,0.5);border-radius:3px;overflow:hidden;margin-bottom:4px;}
.q-bar{height:100%;background:linear-gradient(90deg,var(--golddim),var(--gold));border-radius:3px;transition:width .5s;box-shadow:0 0 4px var(--goldglow);}
.q-prog{font-size:var(--fs-xs);color:var(--txtdim);}
.q-rew{display:flex;gap:5px;flex-wrap:wrap;margin-top:4px;}
.q-rew-tag{
font-size:var(--fs-xs);color:var(--gold);
background:rgba(240,192,48,0.08);border:1px solid rgba(240,192,48,0.2);
border-radius:3px;padding:2px 7px;box-shadow:0 0 4px var(--goldglow);
}
.q-done-lbl{font-size:var(--fs-xs);color:var(--green2);letter-spacing:.5px;margin-top:3px;}

/* ========================================================
BOONS
======================================================== */
.boon-list{display:flex;flex-direction:column;gap:var(--sp-md);}
.boon-card{
background:linear-gradient(135deg,var(--panel2),var(--panel3));
border:2px solid var(--border);border-radius:10px;
padding:var(--sp-md);display:flex;gap:var(--sp-md);
align-items:center;cursor:pointer;position:relative;overflow:hidden;
transition:border-color .18s,background .18s,box-shadow .18s;
box-shadow:0 2px 12px rgba(0,0,0,0.45);
}
.boon-card.owned{border-color:#1a4818;background:linear-gradient(135deg,#0e1510,#121a10);pointer-events:none;}
.boon-card.cant{opacity:.28;pointer-events:none;}
.boon-card.can:hover{border-color:var(--border3);box-shadow:0 4px 20px rgba(0,0,0,0.7);}
.boon-card.can:active{background:var(--panel3);border-color:var(--border2);}
.boon-card.elite{border-color:#5a1880;}
.boon-card.elite.owned{border-color:#301050;}
.boon-card.elite:hover{box-shadow:0 4px 20px rgba(100,20,160,0.3);}
.boon-rar{
position:absolute;top:0;right:0;font-size:.48rem;
letter-spacing:.5px;text-transform:uppercase;padding:4px 9px;border-radius:0 8px 0 5px;
}
.boon-rar.common{background:rgba(50,100,50,.35);color:#70c070;}
.boon-rar.rare{background:rgba(20,60,200,.35);color:#6898f0;}
.boon-rar.epic{background:rgba(100,20,200,.35);color:#a068f0;}
.boon-rar.legendary{background:rgba(190,100,0,.35);color:#e0a030;}
.boon-ico{
width:44px;height:44px;border-radius:9px;flex-shrink:0;
background:radial-gradient(circle at 40% 35%,var(--panel3),var(--panel));
border:2px solid var(--border);display:flex;align-items:center;justify-content:center;
font-size:1.35rem;box-shadow:inset 0 2px 8px rgba(0,0,0,0.7);
}
.boon-card.owned .boon-ico{border-color:#204820;}
.boon-body{flex:1;min-width:0;}
.boon-name{font-size:var(--fs-sm);color:#e8d870;font-weight:700;margin-bottom:3px;text-shadow:0 0 6px rgba(232,216,112,0.2);}
.boon-desc{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#a07c48;line-height:1.45;}
.boon-cost{font-size:var(--fs-xs);color:var(--gold);margin-top:4px;}
.boon-own-lbl{font-size:var(--fs-xs);color:var(--green2);margin-top:4px;}

/* ========================================================
STATS
======================================================== */
.stat-grp{
background:linear-gradient(135deg,var(--panel2),var(--panel3));
border:2px solid var(--border);border-radius:10px;
padding:var(--sp-md);margin-bottom:var(--sp-md);box-shadow:0 2px 12px rgba(0,0,0,0.4);
}
.stat-grp-title{
font-size:var(--fs-xs);color:var(--gold);letter-spacing:2.5px;
margin-bottom:8px;padding-bottom:7px;border-bottom:1px solid var(--border2);
text-shadow:0 0 8px var(--goldglow);
}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,0.03);}
.stat-row:last-child{border-bottom:none;}
.stat-lbl{font-size:var(--fs-sm);color:var(--txt3);}
.stat-val{font-size:var(--fs-sm);color:#e8d870;font-weight:700;}
.prestige-box{
background:linear-gradient(135deg,#14100c,#1e1810,#14100c);
border:2px solid var(--border3);border-radius:10px;
padding:var(--sp-lg);margin-bottom:var(--sp-sm);
box-shadow:0 4px 20px rgba(0,0,0,0.5),0 0 40px rgba(240,192,48,0.06);
position:relative;overflow:hidden;
}
.prestige-box::before{
content:'';position:absolute;top:0;left:0;right:0;height:1px;
background:linear-gradient(90deg,transparent,var(--golddim),transparent);
}
.pres-title{font-size:var(--fs-md);color:var(--gold);margin-bottom:7px;text-shadow:0 0 10px var(--goldglow);}
.pres-desc{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-sm);color:#b08c58;line-height:1.6;margin-bottom:7px;}
.pres-warn{font-size:var(--fs-xs);color:var(--red);margin-bottom:var(--sp-md);padding:6px 12px;background:rgba(200,30,30,0.08);border:1px solid rgba(200,30,30,0.2);border-radius:5px;}
.btn-prestige{
width:100%;padding:13px;font-family:'Cinzel',serif;font-size:var(--fs-md);font-weight:700;
letter-spacing:2px;color:#1a0e00;background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);
border:none;border-radius:5px;cursor:pointer;min-height:48px;
box-shadow:0 4px 0 #5a3a00,0 6px 16px rgba(240,192,48,0.3);transition:all .12s;
}
.btn-prestige:active{transform:translateY(2px);box-shadow:0 2px 0 #5a3a00,0 3px 8px rgba(240,192,48,0.2);}

/* ========================================================
DAMAGE NUMBERS
======================================================== */
.dmg-num{
position:absolute;pointer-events:none;font-family:'Cinzel',serif;
font-size:0.9rem;font-weight:700;
animation:floatup .85s ease-out forwards;white-space:nowrap;
text-shadow:0 1px 4px #000,0 0 10px rgba(0,0,0,0.95);
}
.dmg-num.crit{font-size:1.15rem;color:#ffe040;text-shadow:0 0 12px rgba(255,224,64,0.8),0 1px 4px #000;}
.dmg-num.hit{color:#ff6858;text-shadow:0 0 8px rgba(255,80,50,0.6),0 1px 4px #000;}
.dmg-num.heal{color:#50e870;font-size:0.8rem;text-shadow:0 0 8px rgba(80,232,112,0.6),0 1px 4px #000;}
.dmg-num.enemy{color:#ff9050;text-shadow:0 0 8px rgba(255,120,50,0.5),0 1px 4px #000;}
.dmg-num.dodge{color:#80d8ff;font-size:0.74rem;text-shadow:0 0 8px rgba(128,216,255,0.6),0 1px 4px #000;}
.dmg-num.spell{color:#c878f8;text-shadow:0 0 10px rgba(200,120,248,0.7),0 1px 4px #000;}
.dmg-num.special{color:#ffd868;font-size:1.1rem;text-shadow:0 0 14px rgba(255,216,104,0.8),0 1px 4px #000;}
@keyframes floatup{
0%{opacity:1;transform:translateY(0) scale(1.1);}
15%{transform:translateY(-8px) scale(1.2);}
60%{opacity:1;}
100%{opacity:0;transform:translateY(-62px) scale(.72);}
}

/* ========================================================
LEVEL UP
======================================================== */
#lvlup{
position:fixed;inset:0;z-index:500;pointer-events:none;
display:flex;flex-direction:column;align-items:center;justify-content:center;gap:7px;
opacity:0;transition:opacity .28s;
}
#lvlup.show{opacity:1;}
.lvlup-txt{
font-family:'Cinzel Decorative',serif;font-weight:700;font-size:2.0rem;
color:var(--gold);
text-shadow:0 0 30px var(--gold),0 0 60px rgba(200,60,20,0.8),0 4px 8px #000;
animation:lvlpop .78s ease-out forwards;
}
.lvlup-sub{font-size:0.74rem;color:#a08838;letter-spacing:3px;animation:lvlpop .78s ease-out .12s both;}
@keyframes lvlpop{
0%{transform:scale(.35);opacity:0;}
55%{transform:scale(1.2);}
74%{transform:scale(.93);}
100%{transform:scale(1);opacity:1;}
}

/* ========================================================
TOAST
======================================================== */
#toast{
position:fixed;top:max(60px,env(safe-area-inset-top,60px));
left:50%;transform:translateX(-50%) translateY(-18px);
background:linear-gradient(135deg,var(--panel2),var(--panel3));
border:2px solid var(--border3);border-radius:6px;
padding:9px 16px;font-family:'Cinzel',serif;font-size:var(--fs-xs);color:var(--gold);
opacity:0;transition:opacity .22s,transform .22s;z-index:900;pointer-events:none;
white-space:nowrap;letter-spacing:1px;
box-shadow:0 4px 28px rgba(0,0,0,0.9),0 0 16px var(--goldglow);
max-width:92vw;overflow:hidden;text-overflow:ellipsis;
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ========================================================
MODAL
======================================================== */
#modal{
position:fixed;inset:0;background:rgba(0,0,0,0.92);z-index:800;
display:none;align-items:center;justify-content:center;padding:var(--sp-md);
backdrop-filter:blur(4px);
}
#modal.open{display:flex;}
.modal-box{
background:linear-gradient(160deg,var(--panel2),var(--panel3));
border:2px solid var(--border3);border-radius:12px;padding:24px 20px;
width:100%;max-width:min(460px,94vw);text-align:center;
box-shadow:0 10px 50px rgba(0,0,0,0.95),0 0 40px rgba(106,100,144,0.15);
position:relative;overflow:hidden;
}
.modal-box::before{
content:'';position:absolute;top:0;left:0;right:0;height:2px;
background:linear-gradient(90deg,transparent,var(--border3),transparent);
}
.modal-title{font-size:var(--fs-lg);color:var(--gold);margin-bottom:10px;text-shadow:0 0 12px var(--goldglow);}
.modal-body{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-sm);color:#b89858;line-height:1.7;margin-bottom:9px;}
.modal-warn{font-size:var(--fs-xs);color:var(--red);margin-bottom:var(--sp-md);padding:6px 12px;background:rgba(200,30,30,0.08);border:1px solid rgba(200,30,30,0.2);border-radius:5px;}
.modal-btns{display:flex;gap:10px;}
.m-btn{
flex:1;padding:12px;border:none;border-radius:5px;cursor:pointer;
font-family:'Cinzel',serif;font-size:var(--fs-sm);font-weight:700;letter-spacing:1.5px;
min-height:48px;transition:all .12s;
}
.m-btn.go{background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);color:#1a0e00;box-shadow:0 4px 0 #5a3a00,0 6px 14px rgba(240,192,48,0.25);}
.m-btn.go:active{transform:translateY(2px);box-shadow:0 2px 0 #5a3a00;}
.m-btn.cancel{background:var(--panel3);color:var(--txt3);border:2px solid var(--border2);}
.m-btn.cancel:active{transform:scale(.97);}

/* ========================================================
SHORT SCREENS
======================================================== */
@media (max-height:600px){
.t-crest{font-size:2.3rem;}
.t-lore{display:none;}
.t-divider{display:none;}
#story-ticker{height:20px;}
.ch-desc,.cls-lore{display:none;}
.tab-lbl{display:none;}
.tab-btn{padding:8px 2px;}
}
@media (max-height:480px){
#hud{padding-top:4px;padding-bottom:4px;}
#btn-attack{width:48px;height:48px;font-size:1.15rem;}
}
/* ========================================================
CURSES TAB
======================================================== */
:root{
  --curse:#8b0000;
  --curse2:#c0392b;
  --cursebright:#e74c3c;
  --curseglow:rgba(180,30,30,0.5);
  --curseborder:#6b1a1a;
}
.curse-section-hdr{
  font-size:var(--fs-xs);color:#e74c3c;letter-spacing:4px;text-transform:uppercase;
  padding-bottom:8px;margin-bottom:var(--sp-md);margin-top:var(--sp-lg);
  border-bottom:1px solid #4a1a1a;
  display:flex;align-items:center;justify-content:space-between;
  text-shadow:0 0 10px rgba(231,76,60,0.5);
}
.curse-section-hdr:first-child{margin-top:0;}
.curse-intro{
  font-family:'Crimson Text',serif;font-style:italic;
  font-size:var(--fs-sm);color:#a05050;line-height:1.7;
  margin-bottom:var(--sp-lg);padding:var(--sp-md);
  background:rgba(100,10,10,0.15);border:1px solid #3a1010;border-radius:8px;
}
.curse-list{display:flex;flex-direction:column;gap:var(--sp-md);}
.curse-card{
  background:linear-gradient(135deg,#130a0a,#1a0e0e);
  border:2px solid #3a1818;border-radius:10px;
  padding:var(--sp-md);display:flex;gap:var(--sp-md);
  align-items:flex-start;position:relative;overflow:hidden;
  transition:border-color .18s,box-shadow .18s;
  box-shadow:0 2px 12px rgba(0,0,0,0.6);
}
.curse-card::before{content:'';position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,rgba(180,30,30,0.3),transparent);}
.curse-card.can{cursor:pointer;}
.curse-card.can:hover{border-color:#7a2020;box-shadow:0 4px 20px rgba(150,20,20,0.4);}
.curse-card.active{border-color:#c0392b;background:linear-gradient(135deg,#1a0808,#220a0a);box-shadow:0 0 18px rgba(180,30,30,0.4);}
.curse-card.active::before{background:linear-gradient(90deg,transparent,#c0392b,transparent);}
.curse-card.locked{opacity:.3;pointer-events:none;}
.curse-card.sacrifice-done{border-color:#4a1010;opacity:.5;pointer-events:none;}
.curse-ico{
  width:48px;height:48px;border-radius:9px;flex-shrink:0;
  background:radial-gradient(circle at 40% 35%,#2a0808,#100404);
  border:2px solid #4a1818;display:flex;align-items:center;justify-content:center;
  font-size:1.4rem;box-shadow:inset 0 2px 8px rgba(0,0,0,0.8),0 0 12px rgba(150,20,20,0.2);
}
.curse-card.active .curse-ico{border-color:#c0392b;box-shadow:0 0 14px rgba(180,30,30,0.5),inset 0 2px 8px rgba(0,0,0,0.6);}
.curse-body{flex:1;min-width:0;}
.curse-name{font-size:var(--fs-sm);color:#e05050;font-weight:700;margin-bottom:3px;text-shadow:0 0 8px rgba(200,60,60,0.4);}
.curse-type-tag{
  font-size:.48rem;letter-spacing:1.5px;text-transform:uppercase;
  padding:2px 7px;border-radius:3px;margin-bottom:5px;display:inline-block;
}
.curse-type-tag.affliction{background:rgba(100,20,20,.4);color:#e07070;}
.curse-type-tag.sacrifice{background:rgba(80,20,80,.4);color:#c070e0;}
.curse-type-tag.age{background:rgba(20,20,100,.4);color:#7090e0;}
.curse-penalty{font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#c04040;line-height:1.4;margin-bottom:4px;}
.curse-reward{font-family:'Crimson Text',serif;font-size:var(--fs-xs);color:#80d080;line-height:1.4;margin-bottom:5px;}
.curse-status{font-size:var(--fs-xs);margin-top:4px;}
.curse-status.on{color:#e05050;}
.curse-status.off{color:#604040;}
.curse-status.done{color:#8060a0;}
.curse-active-hud{
  display:flex;gap:4px;flex-wrap:wrap;margin-top:4px;
}
.curse-pip{
  font-size:0.6rem;padding:2px 6px;border-radius:3px;
  background:rgba(150,20,20,0.25);border:1px solid #6b1a1a;color:#e05050;
}
.btn-curse{
  width:100%;padding:10px;font-family:'Cinzel',serif;font-size:var(--fs-xs);font-weight:700;
  letter-spacing:2px;border:none;border-radius:5px;cursor:pointer;min-height:40px;
  transition:all .12s;margin-top:6px;
}
.btn-curse.toggle-on{background:linear-gradient(180deg,#8b0000,#5a0000);color:#ffaaaa;box-shadow:0 3px 0 #2a0000,0 0 14px rgba(150,20,20,0.4);}
.btn-curse.toggle-on:active{transform:translateY(1px);}
.btn-curse.toggle-off{background:linear-gradient(180deg,#2a0a0a,#1a0606);color:#804040;border:1px solid #4a1818;}
.btn-curse.sacrifice-btn{background:linear-gradient(180deg,#4a0880,#2a0450);color:#d0a0f0;box-shadow:0 3px 0 #1a0230,0 0 14px rgba(100,20,160,0.4);}
.btn-curse.sacrifice-btn:active{transform:translateY(1px);}
.curses-summary{
  background:linear-gradient(135deg,#100808,#180a0a);
  border:1px solid #3a1010;border-radius:8px;
  padding:var(--sp-sm) var(--sp-md);margin-bottom:var(--sp-md);
  display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:6px;
}
.curses-summary-lbl{font-size:var(--fs-xs);color:#804040;letter-spacing:2px;}
.curses-summary-val{font-size:var(--fs-sm);color:#e05050;font-weight:700;}
</style>

</head>
<body>
<div id="app">

<!-- ========== TITLE ========== -->

<div class="scr on" id="s0">
  <canvas id="s0-cv"></canvas>
  <div class="t-body">
    <div class="t-crest">üè∞</div>
    <div class="t-title">ASHEN<br>THRONE</div>
    <div class="t-divider"><div class="t-line"></div><span class="t-divider-ico">‚ú¶</span><div class="t-line"></div></div>
    <div class="t-sub">Gothic Idle RPG</div>
    <div class="t-lore">"The realm lies shattered beneath an ashen sky. One warrior must reclaim what was taken ‚Äî or burn alongside everything else."</div>
    <div class="t-btns">
      <button class="t-btn" onclick="gotoClassSelect()">‚öî ENTER THE REALM</button>
      <button class="t-btn-sec" onclick="clearSavePrompt()">‚Ü∫ New Game</button>
    </div>
    <div class="t-hint">Progress saves automatically</div>
  </div>
</div>

<!-- ========== CLASS SELECT ========== -->

<div class="scr" id="s1">
  <div class="page-hdr">
    <div class="page-hdr-title">‚Äî CHOOSE YOUR PATH ‚Äî</div>
    <div class="page-hdr-sub">"Destiny is not given. It is forged."</div>
  </div>
  <div class="cls-list" id="cls-list"></div>
  <div class="cls-foot">
    <button class="cls-go" id="cls-go-btn" disabled onclick="confirmClass()">BEGIN YOUR JOURNEY</button>
  </div>
</div>

<!-- ========== MAIN GAME ========== -->

<div class="scr" id="s2">
  <div id="game-left">
    <div id="hud">
      <div id="hud-av">‚öî</div>
      <div id="hud-bars">
        <div class="br"><span class="br-ico" style="color:#ff6060">‚ô•</span><div class="br-track"><div class="br-fill hp" id="b-hp" style="width:100%"></div></div><span class="br-val" id="v-hp">100/100</span></div>
        <div class="br"><span class="br-ico" style="color:#6090ff">‚ú¶</span><div class="br-track"><div class="br-fill mp" id="b-mp" style="width:100%"></div></div><span class="br-val" id="v-mp">50/50</span></div>
        <div class="br"><span class="br-ico" style="color:#50d050">‚òÖ</span><div class="br-track"><div class="br-fill xp" id="b-xp" style="width:0%"></div></div><span class="br-val" id="v-xp">0/100</span></div>
      </div>
      <div id="hud-right">
        <div id="hud-gold">üí∞ <span id="hud-gold-val">0</span><span id="hud-gps" style="font-size:0.55rem;color:var(--golddim);margin-left:3px;"></span></div>
        <div id="hud-lv">Lv.<span id="hud-lv-val">1</span> ¬∑ <span id="hud-cls-name">?</span></div>
        <div id="hud-zb">Zone <span id="hud-zone-val">1</span> ¬∑ Age <span id="hud-age-val">1</span></div>
      </div>
    </div>
    <div id="story-ticker">
      <span id="story-ico">üìú</span>
      <span id="story-txt">Your journey begins...</span>
    </div>
    <div id="arena-wrap">
      <canvas id="arena-cv"></canvas>
      <div id="arena-ov"></div>
      <div id="zone-prog"><div id="zone-prog-fill" style="width:0%"></div></div>
      <button id="btn-auto" onclick="toggleAuto()">AUTO OFF</button>
      <div id="btn-zone-lbl">üìç <span id="zone-name-lbl">Ashen Fields</span></div>
      <button id="btn-attack" ontouchstart="doAttackTouch(event)" onmousedown="doAttackTouch(event)">‚öî</button>
    </div>
    <div id="tabs">
      <div class="tab-btn" id="tb-story" onclick="openTab('story')"><span class="tab-ico">üìñ</span><span class="tab-lbl">Story</span></div>
      <div class="tab-btn on" id="tb-skills" onclick="openTab('skills')"><span class="tab-ico">‚öî</span><span class="tab-lbl">Skills</span></div>
      <div class="tab-btn" id="tb-quests" onclick="openTab('quests')"><span class="tab-ico">üìú</span><span class="tab-lbl">Quests</span></div>
      <div class="tab-btn" id="tb-boons" onclick="openTab('boons')"><span class="tab-ico">‚öó</span><span class="tab-lbl">Boons</span></div>
      <div class="tab-btn" id="tb-curses" onclick="openTab('curses')"><span class="tab-ico">ü©∏</span><span class="tab-lbl">Curses</span></div>
      <div class="tab-btn" id="tb-stats" onclick="openTab('stats')"><span class="tab-ico">üìä</span><span class="tab-lbl">Stats</span></div>
    </div>
  </div>
  <div id="game-right">
    <div id="tab-body"></div>
  </div>
</div>

</div><!-- #app -->

<div id="lvlup"><div class="lvlup-txt" id="lvlup-txt">LEVEL UP!</div><div class="lvlup-sub">+1 SKILL POINT</div></div>
<div id="toast"></div>
<div id="modal">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Confirm</div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-warn" id="modal-warn"></div>
    <div class="modal-btns">
      <button class="m-btn go" id="modal-ok">Confirm</button>
      <button class="m-btn cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* ===============================================
   AUDIO
=============================================== */
const _=null;
let AC=null,audioOn=false;
function initAudio(){if(AC)return;try{AC=new(window.AudioContext||window.webkitAudioContext)();audioOn=true;}catch(e){}}
function tone(f,t,d,v,dl=0){if(!AC||!audioOn)return;const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(AC.destination);o.type=t;o.frequency.value=f;const ts=AC.currentTime+dl;g.gain.setValueAtTime(v,ts);g.gain.exponentialRampToValueAtTime(.001,ts+d);o.start(ts);o.stop(ts+d+.01);}
function noise(d,v,dl=0){if(!AC||!audioOn)return;const b=AC.createBuffer(1,AC.sampleRate*d,AC.sampleRate);const da=b.getChannelData(0);for(let i=0;i<da.length;i++)da[i]=Math.random()*2-1;const s=AC.createBufferSource(),g=AC.createGain();s.buffer=b;s.connect(g);g.connect(AC.destination);const ts=AC.currentTime+dl;g.gain.setValueAtTime(v,ts);g.gain.exponentialRampToValueAtTime(.001,ts+d);s.start(ts);}
const SFX={
  hit(){noise(.042,.16);tone(155,'square',.042,.07,.018)},
  crit(){tone(340,'square',.036,.16);tone(680,'square',.036,.13,.036);tone(1020,'square',.036,.1,.072)},
  die(){tone(190,'sawtooth',.08,.14);tone(130,'sawtooth',.12,.11,.06);tone(95,'sawtooth',.18,.09,.12)},
  kill(){tone(430,'square',.036,.13);tone(340,'square',.036,.11,.036);tone(240,'square',.065,.09,.072)},
  lvlup(){[380,480,600,760,960].forEach((f,i)=>tone(f,'square',.08,.17,i*.08))},
  gold(){tone(860,'sine',.042,.09);tone(1290,'sine',.036,.07,.042)},
  skill(){tone(620,'triangle',.055,.12);tone(930,'triangle',.075,.09,.045)},
  quest(){[510,640,770,640,770,960].forEach((f,i)=>tone(f,'square',.055,.14,i*.062))},
  prestige(){[210,315,420,525,630,840,1050].forEach((f,i)=>tone(f,'square',.1,.19,i*.086))},
  hurt(){tone(180,'sawtooth',.052,.11);noise(.036,.065,.018)},
  chapter(){[300,400,500,650,820].forEach((f,i)=>tone(f,'square',.1,.19,i*.1))},
  boon(){[500,700,900].forEach((f,i)=>tone(f,'triangle',.08,.15,i*.06))},
};
function startBGM(){
  if(!AC)return;
  const mel=[220,261,330,196,220,246,220,196];let i=0;
  (function n(){if(audioOn){const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(AC.destination);o.type='triangle';o.frequency.value=mel[i%mel.length];g.gain.setValueAtTime(.024,AC.currentTime);g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.38);o.start();o.stop(AC.currentTime+.38);}i++;setTimeout(n,i%4===0?950:480);})();
}

/* ===============================================
   32-BIT SPRITES ‚Äî More color depth, shading, highlights
=============================================== */
const PX=4;

// 32-bit style pixel helpers ‚Äî more palette colors, depth shading
function drawSprite32(ctx,sprite,ox,oy,scale=1){
  sprite.forEach((row,ry)=>row.forEach((c,rx)=>{
    if(!c||c==='.'||c==='_')return;
    ctx.fillStyle=c;
    ctx.fillRect(ox+rx*PX*scale,oy+ry*PX*scale,PX*scale,PX*scale);
  }));
}

// 32-bit warrior: multi-tone armor with specular highlight
const SPR32={
  warrior(p,attacking){
    const _=null;
    if(attacking) return [
      // Attack frame ‚Äî sword arm raised, weight forward
      [_,    _,    p.helmShad,p.helm,   p.helmRim,p.helmRim,p.helm,   p.helmShad,_,    _    ],
      [_,    p.helmShad,p.helm,p.helmHl,p.helmHl, p.helmHl, p.helmHl,p.helm,   p.helmShad,_],
      [_,    p.helmShad,p.skin,p.skinHl,p.skin,   p.skin,   p.skinHl,p.skin,   p.helmShad,_],
      [_,    p.helmShad,p.skin,p.e,     p.skinHl, p.skinHl, p.e,     p.skin,   p.helmShad,_],
      [_,    p.helmShad,p.helm,p.skin,  p.skinShad,p.skinShad,p.skin,p.helm,   p.helmShad,_],
      // Arm swung forward ‚Äî right pauldron shifted
      [p.armorShad,p.armorHl,p.armorRim,p.belt,p.belt,p.armorRim,p.armorHl,p.armorShad,p.armorHl,p.armorRim],
      [p.cape,p.armorHl,p.armorRim,p.armor,p.armorHl,p.armorHl,p.armor,p.armorRim,p.armorRim,p.armorShad],
      [p.cape,p.armor,p.armorHl,p.belt,p.armorShad,p.armorShad,p.belt,p.armorHl,p.armorShad,_],
      [p.cape,p.armorShad,p.belt,p.belt,p.beltShad,p.beltShad,p.belt,p.belt,p.armorShad,_],
      // Legs planted wide
      [p.capeShad,p.armor,p.armorShad,p.armorHl,p.armor,p.armor,p.armorHl,p.armorShad,p.armor,p.capeShad],
      [_,    p.armorShad,p.armorDark,p.armor,_,    _,    p.armor,p.armorDark,p.armorShad,_],
      [_,    p.armor,p.armorHl,p.armorShad,_,    _,    p.armorShad,p.armorHl,p.armor,_],
      [_,    p.armorShad,p.armor,p.armorDark,_,    _,    p.armorDark,p.armor,p.armorShad,_],
      [_,    p.boot,p.bootHl,p.boot,_,    _,    p.boot,p.bootHl,p.boot,_],
    ];
    return[
      [_,    _,    p.helmShad,p.helm,   p.helmRim,p.helmRim,p.helm,   p.helmShad,_,    _    ],
      [_,    p.helmShad,p.helm,p.helmHl,p.helmHl, p.helmHl, p.helmHl,p.helm,   p.helmShad,_],
      [_,    p.helmShad,p.skin,p.skinHl,p.skin,   p.skin,   p.skinHl,p.skin,   p.helmShad,_],
      [_,    p.helmShad,p.skin,p.e,     p.skinHl, p.skinHl, p.e,     p.skin,   p.helmShad,_],
      [_,    p.helmShad,p.helm,p.skin,  p.skinShad,p.skinShad,p.skin,p.helm,   p.helmShad,_],
      [p.armorShad,p.armor,p.armorHl,p.armorRim,p.belt,p.belt,p.armorRim,p.armorHl,p.armor,p.armorShad],
      [p.armorShad,p.armorHl,p.armorRim,p.armor,p.armorHl,p.armorHl,p.armor,p.armorRim,p.armorHl,p.armorShad],
      [p.cape,p.armor,p.armorHl,p.belt,p.armorShad,p.armorShad,p.belt,p.armorHl,p.armor,p.cape],
      [p.cape,p.armorShad,p.belt,p.belt,p.beltShad,p.beltShad,p.belt,p.belt,p.armorShad,p.cape],
      [p.capeShad,p.armor,p.armorShad,p.armorHl,p.armor,p.armor,p.armorHl,p.armorShad,p.armor,p.capeShad],
      [_,    p.armorShad,p.armorDark,p.armor,_,    _,    p.armor,p.armorDark,p.armorShad,_],
      [_,    p.armor,p.armorHl,p.armorShad,_,    _,    p.armorShad,p.armorHl,p.armor,_],
      [_,    p.armorShad,p.armor,p.armorDark,_,    _,    p.armorDark,p.armor,p.armorShad,_],
      [_,    p.boot,p.bootHl,p.boot,_,    _,    p.boot,p.bootHl,p.boot,_],
    ];
  },
  mage(p,attacking){
    const _=null;
    if(attacking) return [
      [_,    _,    _,    p.hatShad,p.hat,   p.hatShad,_,    _,    _,    _    ],
      [_,    _,    p.hatShad,p.hat,   p.hatHl,  p.hat,   p.hatShad,_,    _,    _    ],
      [_,    p.hatShad,p.hat,   p.hatHl,  p.hat,   p.hat,   p.hatHl,  p.hat,   p.hatShad,_],
      [p.hatShad,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatShad],
      [_,    p.robeShad,p.skin,   p.skinHl, p.skin,   p.skin,   p.skinHl, p.skin,   p.robeShad,_],
      [_,    p.robeShad,p.skin,   p.e,      p.skinHl, p.skinHl, p.e,      p.skin,   p.robeShad,_],
      // Casting ‚Äî both arms raised, orb forward
      [p.staffOrb,p.staffHl,p.robe,p.robeHl,p.robeTrim,p.robeTrim,p.robeHl,p.robe,p.staffHl,p.staffOrb],
      [p.gemGlow,p.robeHl,p.gem,p.gemGlow,p.gemGlow,p.gemGlow,p.gem,p.robeHl,p.gemGlow,p.staffOrb],
      [p.staff,p.robeShad,p.robeTrim,p.robe,p.robeHl,p.robeHl,p.robe,p.robeTrim,p.robeShad,_],
      [p.staffHl,p.robe,p.robeShad,p.robeTrim,p.robe,p.robe,p.robeTrim,p.robeShad,p.robe,_],
      [p.staff,p.robeDark,p.robe,p.robeHl,p.robeDark,p.robeDark,p.robeHl,p.robe,p.robeDark,_],
      [_,    p.robeDark,p.robeShad,p.robe,p.robeHl,p.robeHl,p.robe,p.robeShad,p.robeDark,_],
      [p.staffOrb,p.robeDark,p.robe,p.robeTrim,p.robeDark,p.robeDark,p.robeTrim,p.robe,p.robeDark,_],
      [p.staffHl,p.boot,p.bootHl,p.boot,_,    _,    p.boot,p.bootHl,p.boot,_],
    ];
    return[
      [_,    _,    _,    p.hatShad,p.hat,   p.hatShad,_,    _,    _,    _    ],
      [_,    _,    p.hatShad,p.hat,   p.hatHl,  p.hat,   p.hatShad,_,    _,    _    ],
      [_,    p.hatShad,p.hat,   p.hatHl,  p.hat,   p.hat,   p.hatHl,  p.hat,   p.hatShad,_],
      [p.hatShad,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatBrim,p.hatShad],
      [_,    p.robeShad,p.skin,   p.skinHl, p.skin,   p.skin,   p.skinHl, p.skin,   p.robeShad,_],
      [_,    p.robeShad,p.skin,   p.e,      p.skinHl, p.skinHl, p.e,      p.skin,   p.robeShad,_],
      [p.staff,p.robeShad,p.robe,  p.robeHl, p.robeTrim,p.robeTrim,p.robeHl,p.robe,  p.robeShad,_],
      [p.staffHl,p.robe,  p.robeHl, p.gem,    p.gemGlow,p.gemGlow,p.gem,    p.robeHl, p.robe,   _],
      [p.staff,p.robeShad,p.robeTrim,p.robe, p.robeHl, p.robeHl, p.robe,  p.robeTrim,p.robeShad,_],
      [p.staffHl,p.robe,  p.robeShad,p.robeTrim,p.robe,p.robe,p.robeTrim,p.robeShad,p.robe,_],
      [p.staff,p.robeDark,p.robe,  p.robeHl, p.robeDark,p.robeDark,p.robeHl,p.robe,p.robeDark,_],
      [_,    p.robeDark,p.robeShad,p.robe, p.robeHl,p.robeHl,p.robe, p.robeShad,p.robeDark,_],
      [p.staffOrb,p.robeDark,p.robe,p.robeTrim,p.robeDark,p.robeDark,p.robeTrim,p.robe,p.robeDark,_],
      [p.staffHl,p.boot,  p.bootHl, p.boot,   _,    _,    p.boot,   p.bootHl, p.boot,   _],
    ];
  },
  rogue(p,attacking){
    const _=null;
    if(attacking) return [
      [_,    _,    p.hoodShad,p.hood,   p.hoodRim,p.hood,   p.hoodShad,_,    _,    _    ],
      [_,    p.hoodShad,p.hood, p.hoodHl, p.hood,   p.hoodHl, p.hood,   p.hoodShad,_,  _],
      [p.cloakShad,p.hood,p.hoodShad,p.skin,p.skinHl,p.skin,p.hoodShad,p.hood,p.cloakShad,_],
      [p.cloakShad,p.hood,p.skin,p.e,p.skinHl,p.skinHl,p.e,p.skin,p.hood,p.cloakShad],
      [p.cloakShad,p.hood,p.hoodShad,p.skin,p.skinShad,p.skinShad,p.skin,p.hoodShad,p.blade,p.cloakShad],
      // Lunge ‚Äî body tilted, blade fully extended forward
      [_,    p.cloakHl,p.cloakRim,p.cloak,p.accent,p.accent,p.cloak,p.bladeHl,p.bladeEdge,p.bladeShad],
      [p.cloakShad,p.cloak,p.accent,p.accentHl,p.cloakHl,p.cloakHl,p.bladeHl,p.bladeEdge,p.bladeShad,_],
      [p.cloak,p.cloakShad,p.cloakHl,p.cloak,p.cloakShad,p.bladeHl,p.bladeEdge,p.bladeShad,_,    _],
      [p.cloakShad,p.cloak,p.accent,p.accentHl,p.cloak,p.cloak,p.accentHl,p.accent,_,    _],
      [p.cloak,p.cloakShad,p.cloakHl,p.cloak,p.cloakShad,p.cloakShad,p.cloak,p.cloakHl,_,    _],
      [_,    p.cloakShad,p.cloak,p.cloakHl,_,    _,    p.cloakHl,p.cloak,p.cloakShad,_],
      [_,    p.cloak,p.cloakRim,p.cloakShad,_,    _,    p.cloakShad,p.cloakRim,p.cloak,_],
      [_,    p.cloakShad,p.cloakHl,p.cloak,_,    _,    p.cloak,p.cloakHl,p.cloakShad,_],
      [_,    p.boot,p.bootHl,p.boot,_,    _,    p.boot,p.bootHl,p.boot,_],
    ];
    return[
      [_,    _,    p.hoodShad,p.hood,   p.hoodRim,p.hood,   p.hoodShad,_,    _,    _    ],
      [_,    p.hoodShad,p.hood, p.hoodHl, p.hood,   p.hoodHl, p.hood,   p.hoodShad,_,  _],
      [p.cloakShad,p.hood,p.hoodShad,p.skin,p.skinHl,p.skin,p.hoodShad,p.hood,p.cloakShad,_],
      [p.cloakShad,p.hood,p.skin,p.e,p.skinHl,p.skinHl,p.e,p.skin,p.hood,p.cloakShad],
      [p.cloakShad,p.hood,p.hoodShad,p.skin,p.skinShad,p.skinShad,p.skin,p.hoodShad,p.blade,p.cloakShad],
      [p.cloak,p.cloakHl,p.cloakRim,p.cloak,p.accent,p.accent,p.cloak,p.cloakRim,p.blade,p.cloakShad],
      [p.cloakShad,p.cloakHl,p.cloak,p.accent,p.cloakHl,p.cloakHl,p.accent,p.cloak,p.bladeHl,p.bladeShad],
      [p.cloak,p.cloakShad,p.cloakRim,p.cloak,p.cloakShad,p.cloakShad,p.cloak,p.cloakRim,p.blade,p.bladeEdge],
      [p.cloakShad,p.cloak,p.accent,p.accentHl,p.cloak,p.cloak,p.accentHl,p.accent,p.blade,p.bladeShad],
      [p.cloak,p.cloakShad,p.cloakHl,p.cloak,p.cloakShad,p.cloakShad,p.cloak,p.cloakHl,p.bladeEdge,_],
      [_,    p.cloakShad,p.cloak,p.cloakHl,_,    _,    p.cloakHl,p.cloak,p.cloakShad,_],
      [_,    p.cloak,p.cloakRim,p.cloakShad,_,    _,    p.cloakShad,p.cloakRim,p.cloak,_],
      [_,    p.cloakShad,p.cloakHl,p.cloak,_,    _,    p.cloak,p.cloakHl,p.cloakShad,_],
      [_,    p.boot,p.bootHl,p.boot,_,    _,    p.boot,p.bootHl,p.boot,_],
    ];
  },
  paladin(p,attacking){
    const _=null;
    if(attacking) return [
      [_,    _,    p.helmShad,p.helmRim,p.holy,   p.helmRim,p.helmShad,_,    _,    _    ],
      [_,    p.helmShad,p.helm,p.helmHl,p.helmRim,p.helmRim,p.helmHl,p.helm,p.helmShad,_],
      [_,    p.helmShad,p.helmHl,p.armorShad,p.armorDark,p.armorDark,p.armorShad,p.helmHl,p.helmShad,_],
      [_,    p.helm,p.armorDark,p.ep,p.holyGlow,p.holyGlow,p.ep,p.armorDark,p.helm,_],
      [_,    p.helmShad,p.helm,p.helmHl,p.helm,p.helm,p.helmHl,p.helm,p.helmShad,_],
      // Smite ‚Äî both arms raised overhead, holy glow bursting
      [p.holyGlow,p.armorRim,p.holy,p.holyGlow,p.holyGlow,p.holyGlow,p.holy,p.armorRim,p.holyGlow,p.holy],
      [p.armorHl,p.armorRim,p.holyDim,p.holy,p.holyGlow,p.holyGlow,p.holy,p.holyDim,p.armorRim,p.armorHl],
      [p.cape,p.armorHl,p.armorRim,p.holy,p.holyGlow,p.holyGlow,p.holy,p.armorRim,p.armorHl,p.cape],
      [p.capeShad,p.armor,p.armorHl,p.armorRim,p.armor,p.armor,p.armorRim,p.armorHl,p.armor,p.capeShad],
      [p.capeShad,p.armor,p.armorShad,p.armorHl,p.armorDark,p.armorDark,p.armorHl,p.armorShad,p.armor,p.capeShad],
      [_,    p.armorShad,p.armorDark,p.armor,_,    _,    p.armor,p.armorDark,p.armorShad,_],
      [_,    p.armor,p.armorRim,p.armorShad,_,    _,    p.armorShad,p.armorRim,p.armor,_],
      [_,    p.armorShad,p.armor,p.armorHl,_,    _,    p.armorHl,p.armor,p.armorShad,_],
      [_,    p.boot,p.bootHl,p.armorRim,_,    _,    p.armorRim,p.bootHl,p.boot,_],
    ];
    return[
      [_,    _,    p.helmShad,p.helmRim,p.holy,   p.helmRim,p.helmShad,_,    _,    _    ],
      [_,    p.helmShad,p.helm,p.helmHl,p.helmRim,p.helmRim,p.helmHl,p.helm,p.helmShad,_],
      [_,    p.helmShad,p.helmHl,p.armorShad,p.armorDark,p.armorDark,p.armorShad,p.helmHl,p.helmShad,_],
      [_,    p.helm,p.armorDark,p.ep,p.holyGlow,p.holyGlow,p.ep,p.armorDark,p.helm,_],
      [_,    p.helmShad,p.helm,p.helmHl,p.helm,p.helm,p.helmHl,p.helm,p.helmShad,_],
      [p.armorShad,p.armorHl,p.armorRim,p.holy,p.holyGlow,p.holyGlow,p.holy,p.armorRim,p.armorHl,p.armorShad],
      [p.cape,p.armorHl,p.armorRim,p.armorHl,p.holyDim,p.holyDim,p.armorHl,p.armorRim,p.armorHl,p.cape],
      [p.capeShad,p.armor,p.armorHl,p.holy,p.holyGlow,p.holyGlow,p.holy,p.armorHl,p.armor,p.capeShad],
      [p.cape,p.armorShad,p.armor,p.armorHl,p.armor,p.armor,p.armorHl,p.armor,p.armorShad,p.cape],
      [p.capeShad,p.armor,p.armorShad,p.armorHl,p.armorDark,p.armorDark,p.armorHl,p.armorShad,p.armor,p.capeShad],
      [_,    p.armorShad,p.armorDark,p.armor,_,    _,    p.armor,p.armorDark,p.armorShad,_],
      [_,    p.armor,p.armorRim,p.armorShad,_,    _,    p.armorShad,p.armorRim,p.armor,_],
      [_,    p.armorShad,p.armor,p.armorHl,_,    _,    p.armorHl,p.armor,p.armorShad,_],
      [_,    p.boot,p.bootHl,p.armorRim,_,    _,    p.armorRim,p.bootHl,p.boot,_],
    ];
  },
  ranger(p,attacking){
    const _=null;
    if(attacking) return [
      [_,    _,    p.hoodShad,p.hood,   p.leaf,   p.hood,   p.hoodShad,_,    _,    _    ],
      [_,    p.hoodShad,p.hood,p.hoodHl,p.leafHl, p.hoodHl, p.hood,   p.hoodShad,_,    _    ],
      [p.leafShad,p.hood,p.hoodShad,p.skin,p.skinHl,p.skin,p.hoodShad,p.hood,p.leafShad,_],
      [p.leafShad,p.hood,p.skin,p.e,p.skinHl,p.skinHl,p.e,p.skin,p.hood,p.leafShad],
      [p.leafShad,p.hood,p.hoodShad,p.skin,p.skinShad,p.skinShad,p.skin,p.hoodShad,p.hood,_],
      // Draw ‚Äî bow arm fully extended, string pulled back
      [p.bowStr,p.bowHl,p.gearRim,p.gear,p.gearHl,p.gearHl,p.gear,p.bow,p.bowHl,p.bowStr],
      [p.bowStr,p.gear,p.gearHl,p.leafHl,p.gear,p.gear,p.bow,p.bowHl,p.bow,p.bowStr],
      [p.bowStr,p.gearShad,p.gear,p.gearHl,p.gearShad,p.bow,p.bowHl,p.bow,_,    p.bowStr],
      [p.leafShad,p.gear,p.leafHl,p.leaf,p.gear,p.gear,p.leaf,p.leafHl,_,    _    ],
      [p.leaf,p.gearShad,p.gearHl,p.gear,p.gearShad,p.gearShad,p.gear,p.gearHl,_,    _    ],
      [_,    p.gearShad,p.gear,p.gearHl,_,    _,    p.gearHl,p.gear,p.gearShad,_],
      [_,    p.gear,p.gearRim,p.gearShad,_,    _,    p.gearShad,p.gearRim,p.gear,_],
      [_,    p.gearShad,p.gearHl,p.gear,_,    _,    p.gear,p.gearHl,p.gearShad,_],
      [_,    p.boot,p.bootHl,p.boot,_,    _,    p.boot,p.bootHl,p.boot,_],
    ];
    return[
      [_,    _,    p.hoodShad,p.hood,   p.leaf,   p.hood,   p.hoodShad,_,    _,    _    ],
      [_,    p.hoodShad,p.hood,p.hoodHl,p.leafHl, p.hoodHl, p.hood,   p.hoodShad,_,    _    ],
      [p.leafShad,p.hood,p.hoodShad,p.skin,p.skinHl,p.skin,p.hoodShad,p.hood,p.leafShad,_],
      [p.leafShad,p.hood,p.skin,p.e,p.skinHl,p.skinHl,p.e,p.skin,p.hood,p.leafShad],
      [p.leafShad,p.hood,p.hoodShad,p.skin,p.skinShad,p.skinShad,p.skin,p.hoodShad,p.hood,_],
      [p.leaf,p.gearHl,p.gearRim,p.gear,p.gearHl,p.gearHl,p.gear,p.gearRim,p.bow,p.leafShad],
      [p.leafShad,p.gear,p.gearHl,p.leafHl,p.gear,p.gear,p.leafHl,p.gearHl,p.bowHl,p.bow],
      [p.leaf,p.gearShad,p.gear,p.gearHl,p.gearShad,p.gearShad,p.gearHl,p.gear,p.bow,p.bowHl],
      [p.leafShad,p.gear,p.leafHl,p.leaf,p.gear,p.gear,p.leaf,p.leafHl,p.bow,p.bowStr],
      [p.leaf,p.gearShad,p.gearHl,p.gear,p.gearShad,p.gearShad,p.gear,p.gearHl,p.bowHl,p.bow],
      [_,    p.gearShad,p.gear,p.gearHl,_,    _,    p.gearHl,p.gear,p.gearShad,_],
      [_,    p.gear,p.gearRim,p.gearShad,_,    _,    p.gearShad,p.gearRim,p.gear,_],
      [_,    p.gearShad,p.gearHl,p.gear,_,    _,    p.gear,p.gearHl,p.gearShad,_],
      [_,    p.boot,p.bootHl,p.boot,_,    _,    p.boot,p.bootHl,p.boot,_],
    ];
  },
};

const PAL32={
  warrior:{
    helm:'#4a3c1e',helmShad:'#2e2410',helmHl:'#7a6430',helmRim:'#c8a040',
    skin:'#d4956a',skinShad:'#a86440',skinHl:'#f0c090',skinDark:'#804830',
    armor:'#5a7090',armorShad:'#38506a',armorHl:'#9ab8d0',armorRim:'#c0d8e8',armorDark:'#283848',
    belt:'#d4a030',beltShad:'#9a7018',
    cape:'#8a1818',capeShad:'#580e0e',capeHl:'#c02828',
    e:'#1a0c04',ep:'#e85040',
    boot:'#302818',bootHl:'#504030',
  },
  mage:{
    hat:'#1a1248',hatShad:'#0e0a2e',hatHl:'#2e2070',hatBrim:'#8060c0',
    skin:'#d4956a',skinShad:'#a86440',skinHl:'#f0c090',skinDark:'#804830',
    robe:'#5a1a90',robeShad:'#380a60',robeHl:'#8a40c0',robeTrim:'#c0a030',robeDark:'#22083a',
    gem:'#e040f0',gemAlt:'#a020c0',gemGlow:'#f8a0ff',
    staff:'#6a4820',staffHl:'#9a7040',staffOrb:'#40d0f0',
    e:'#8020c0',ep:'#e040f0',
    boot:'#200a40',bootHl:'#3a1860',
  },
  rogue:{
    hood:'#1a161e',hoodShad:'#0e0c12',hoodHl:'#2e2838',hoodRim:'#504860',
    skin:'#c07858',skinShad:'#904838',skinHl:'#e0a070',skinDark:'#703828',
    cloak:'#1e1c28',cloakShad:'#12101a',cloakHl:'#342e44',cloakRim:'#504468',
    blade:'#d8e8f8',bladeShad:'#9ab0c8',bladeHl:'#ffffff',bladeEdge:'#c0d4e8',
    accent:'#7040a0',accentHl:'#a060d0',
    e:'#1a0c14',ep:'#d040a0',
    boot:'#161014',bootHl:'#281e2c',
  },
  paladin:{
    helm:'#3a3010',helmShad:'#201a08',helmHl:'#5a4c18',helmRim:'#e0c040',
    skin:'#d4956a',skinShad:'#a86440',skinHl:'#f0c090',skinDark:'#804830',
    armor:'#8898b8',armorShad:'#607090',armorHl:'#c0d8f0',armorRim:'#e8f0ff',armorDark:'#405060',
    holy:'#f8f040',holyDim:'#d0c020',holyGlow:'#fff8a0',
    cape:'#1a3080',capeShad:'#101a50',capeHl:'#3050b0',
    e:'#c09810',ep:'#fff080',
    boot:'#303020',bootHl:'#504e30',
  },
  ranger:{
    hood:'#1e2e10',hoodShad:'#101808',hoodHl:'#304018',hoodRim:'#607838',
    skin:'#c07858',skinShad:'#904838',skinHl:'#e0a070',skinDark:'#703828',
    gear:'#3c5820',gearShad:'#243810',gearHl:'#607838',gearRim:'#90b050',
    leaf:'#5a8830',leafShad:'#3a5c18',leafHl:'#80b848',leafDark:'#2a4010',
    bow:'#7a5028',bowHl:'#b07840',bowStr:'#e0d090',
    e:'#1a1008',ep:'#80e040',
    boot:'#283018',bootHl:'#404e28',
  },
};

// 32-bit enemies with more color detail
const ENEMIES32={
  rat:{draw(ctx,x,y,sc){
    const p=PX*sc;
    // Richer rat: dark grey body, pink snout, red eyes, scaly tail
    const c={
      fur1:'#5a4838',fur2:'#7a6450',fur3:'#9a8468',
      belly:'#c0a888',snout:'#d09090',eye:'#c01818',eyeGlow:'#ff3030',
      ear:'#c07878',earIn:'#e0a0a0',tail:'#8a6858',tailTip:'#c09080',
      shadow:'#2e2018',claw:'#d0c0a0',
    };
    const sp=[
      [_,    _,    c.fur2,c.fur1,c.fur1,c.fur2,_,    _    ],
      [_,    c.fur1,c.ear, c.earIn,c.earIn,c.ear, c.fur1,_    ],
      [c.fur1,c.fur2,c.fur3,c.fur2,c.fur2,c.fur3,c.fur2,c.fur1],
      [c.fur2,c.fur3,c.belly,c.snout,c.snout,c.belly,c.fur3,c.fur2],
      [c.fur1,c.fur3,c.eye, c.eyeGlow,c.eyeGlow,c.eye, c.fur3,c.fur1],
      [c.shadow,c.fur2,c.fur3,c.belly,c.belly,c.fur3,c.fur2,c.tail],
      [_,    c.fur1,c.fur2,c.claw,c.claw,c.fur2,c.tail,c.tailTip],
      [_,    _,    c.shadow,c.fur1,c.fur1,c.shadow,_,    _    ],
    ];
    sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col||col==='_')return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));
  }},

  skeleton:{draw(ctx,x,y,sc){
    const p=PX*sc;
    const c={
      bone1:'#f0e8d0',bone2:'#d8d0b8',bone3:'#e8e0c8',
      shadow:'#a89878',joint:'#c8c0a8',dark:'#180e08',
      eye:'#d04010',eyeGlow:'#ff6020',crack:'#b8a888',
      rust:'#8a5020',
    };
    const sp=[
      [_,    c.bone2,c.bone1,c.bone3,c.bone3,c.bone1,c.bone2,_    ],
      [c.bone2,c.bone3,c.crack,c.bone1,c.bone1,c.crack,c.bone3,c.bone2],
      [c.bone1,c.bone3,c.eye, c.eyeGlow,c.eyeGlow,c.eye, c.bone3,c.bone1],
      [c.bone2,c.bone1,c.bone3,c.dark, c.dark, c.bone3,c.bone1,c.bone2],
      [_,    c.shadow,c.bone1,c.bone2,c.bone2,c.bone1,c.shadow,_    ],
      [c.rust,c.bone2,c.joint,c.bone1,c.bone1,c.joint,c.bone2,c.rust],
      [c.bone1,c.joint,c.bone2,c.shadow,c.shadow,c.bone2,c.joint,c.bone1],
      [_,    c.bone2,c.shadow,_,    _,    c.shadow,c.bone2,_    ],
      [_,    c.bone1,c.bone2,_,    _,    c.bone2,c.bone1,_    ],
      [_,    c.joint,c.bone1,_,    _,    c.bone1,c.joint,_    ],
    ];
    sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col||col==='_')return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));
  }},

  zombie:{draw(ctx,x,y,sc){
    const p=PX*sc;
    const c={
      skin1:'#708060',skin2:'#8a9a70',skin3:'#607050',
      rot1:'#486040',rot2:'#304830',
      flesh:'#d09090',wound:'#a04040',blood:'#801010',
      cloth1:'#5a5040',cloth2:'#3e3828',clothHL:'#706858',
      eye:'#c8e040',eyeGlow:'#e8ff60',bone:'#d0c8a8',
      shadow:'#202818',
    };
    const sp=[
      [_,    c.rot2, c.skin1,c.skin2,c.skin2,c.skin1,c.rot2, _    ],
      [c.rot2,c.skin2,c.skin3,c.skin1,c.skin1,c.skin3,c.skin2,c.rot2],
      [c.skin1,c.skin2,c.eye,  c.eyeGlow,c.eyeGlow,c.eye,c.skin2,c.skin1],
      [c.rot2,c.skin1,c.flesh,c.wound,c.wound,c.flesh,c.skin1,c.rot2],
      [_,    c.shadow,c.skin3,c.rot1, c.rot1, c.skin3,c.shadow,_    ],
      [c.cloth1,c.clothHL,c.cloth2,c.blood,c.blood,c.cloth2,c.clothHL,c.cloth1],
      [c.rot1,c.cloth2,c.clothHL,c.cloth1,c.cloth1,c.clothHL,c.cloth2,c.rot1],
      [c.cloth1,c.rot2,c.cloth2,c.rot1, c.rot1, c.cloth2,c.rot2,c.cloth1],
      [_,    c.cloth2,c.rot2, c.cloth1,c.cloth1,c.rot2, c.cloth2,_    ],
      [_,    c.rot1, c.cloth1,_,    _,    c.cloth1,c.rot1, _    ],
    ];
    sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col||col==='_')return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));
  }},

  wraith:{draw(ctx,x,y,sc){
    const p=PX*sc;
    // Ethereal fade: time-based shimmer
    const t=Date.now()*0.002;
    const c={
      core1:'#2030c0',core2:'#4060e0',core3:'#7090f8',
      glow1:'#a0c0ff',glow2:'#c0d8ff',
      fade1:`rgba(40,60,200,${0.5+0.3*Math.sin(t)})`,
      fade2:`rgba(80,120,240,${0.3+0.2*Math.sin(t+1)})`,
      eye1:'#ffffff',eye2:'#e0f0ff',eyeCore:'#60a0ff',
      veil:'#101840',veilHL:'#202860',
      soul:'rgba(160,200,255,0.6)',
    };
    const sp=[
      [_,    _,    c.fade2,c.core2,c.core3,c.core2,c.fade2,_    ],
      [_,    c.fade1,c.core2,c.glow1,c.glow2,c.glow1,c.core2,c.fade1],
      [c.fade1,c.core2,c.glow2,c.eye1, c.eye2, c.eye1, c.glow2,c.core2],
      [c.fade1,c.core1,c.eyeCore,c.eye2,c.eye2,c.eyeCore,c.core1,c.fade1],
      [_,    c.veil, c.core2,c.glow1,c.glow1,c.core2,c.veil, _    ],
      [c.fade2,c.veil,c.veilHL,c.core2,c.core2,c.veilHL,c.veil,c.fade2],
      [c.fade1,c.veilHL,c.veil,c.core1,c.core1,c.veil,c.veilHL,c.fade1],
      [_,    c.fade1,c.veil,c.fade2,c.fade2,c.veil,c.fade1,_    ],
      [_,    c.fade2,c.fade1,_,    _,    c.fade1,c.fade2,_    ],
    ];
    sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col||col==='_')return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));
  }},

  dragon:{draw(ctx,x,y,sc){
    const p=PX*sc;
    const c={
      scale1:'#9a1010',scale2:'#c82020',scale3:'#e83030',scaleHl:'#ff6040',
      belly:'#d09040',bellyHl:'#f0c060',bellyShad:'#a06820',
      eye:'#f0c000',eyeGlow:'#ffee40',eyeSlit:'#200800',
      horn:'#4a3010',hornHl:'#7a5820',
      fire:'#ff8010',fireBright:'#ffee40',fireCore:'#ffffff',
      wing1:'#780808',wing2:'#a01010',wingMem:'rgba(200,40,20,0.7)',
      shadow:'#480808',claw:'#d0c080',
    };
    const sp=[
      [_,    _,    c.horn, c.scale2,c.scale3,c.scale2,_,    c.fire, c.fireBright],
      [_,    c.horn,c.hornHl,c.scale3,c.scaleHl,c.scale3,c.wing2,c.fireBright,c.fireCore],
      [c.wing1,c.scale2,c.scale3,c.scaleHl,c.eye,c.eyeGlow,c.wing2,c.fire, c.fireBright],
      [c.wing1,c.scale3,c.scale2,c.eyeSlit,c.eyeGlow,c.eyeSlit,c.scale2,c.wing1,_    ],
      [_,    c.scale1,c.scale2,c.belly,c.bellyHl,c.belly,c.scale1,_,    _    ],
      [_,    c.shadow,c.scale1,c.bellyHl,c.belly,c.bellyHl,c.shadow,_,    _    ],
      [c.wing1,c.scale2,c.belly,c.bellyShad,c.bellyShad,c.belly,c.scale2,c.wing2,_    ],
      [c.wing1,c.shadow,c.scale1,c.scale2,c.scale1,c.scale2,c.shadow,c.wing1,_    ],
      [_,    c.claw, c.shadow,_,    _,    c.shadow,c.claw, _,    _    ],
    ];
    sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col||col==='_')return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));
  }},

  lich:{draw(ctx,x,y,sc){
    const p=PX*sc;
    const c={
      robe1:'#16102a',robe2:'#241848',robe3:'#382060',robeHl:'#6040a0',
      trim:'#c09020',trimHl:'#f0c840',trimShad:'#806010',
      skull1:'#e8e0d0',skull2:'#d0c8b8',skull3:'#f0e8d8',
      eye1:'#d01810',eye2:'#ff3020',eyeGlow:'#ff8060',
      soul:'#8060d0',soulGlow:'#b090f0',soulCore:'#e0d0ff',
      crown:'#c09020',crownGem:'#e040a0',crownGemGlow:'#ff80d0',
      bony:'#c8c0a8',bonyShad:'#9a9080',
      orb:'#4020c0',orbGlow:'#8060f0',orbCore:'#c0a8ff',
      shadow:'#0c0818',
    };
    const sp=[
      [_,    c.crown,c.crownGem,c.crownGemGlow,c.trimHl,c.crownGemGlow,c.crownGem,c.crown,_],
      [_,    c.skull2,c.skull3,c.skull1,c.skull3,c.skull1,c.skull3,c.skull2,_],
      [_,    c.skull1,c.eye2, c.eyeGlow,c.skull3,c.eyeGlow,c.eye2, c.skull1,_],
      [_,    c.skull2,c.bony, c.skull1,c.skull2,c.skull1,c.bony, c.skull2,_],
      [_,    c.bonyShad,c.skull1,c.bony,c.shadow,c.bony,c.skull1,c.bonyShad,_],
      [c.shadow,c.robe3,c.robeHl,c.soul,c.soulGlow,c.soul,c.robeHl,c.robe3,c.shadow],
      [c.trim,c.robeHl,c.robe2,c.soulGlow,c.soulCore,c.soulGlow,c.robe2,c.robeHl,c.trim],
      [c.trimHl,c.robe3,c.robeHl,c.orb,c.orbGlow,c.orb,c.robeHl,c.robe3,c.trimHl],
      [c.trim,c.robe2,c.robe3,c.orbGlow,c.orbCore,c.orbGlow,c.robe3,c.robe2,c.trim],
      [_,    c.trimShad,c.robe2,c.robe1,c.robe2,c.robe1,c.robe2,c.trimShad,_],
      [_,    c.robe1, c.trimShad,c.robe2,c.shadow,c.robe2,c.trimShad,c.robe1,_],
    ];
    sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col||col==='_')return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));
  }},
};

/* ===============================================
   WORLD DATA
=============================================== */
const ZONES=[
  {name:'Ashen Fields',sky:['#160e0a','#221408'],ground:'#2c1e10',hill:'#180e06',enemies:['rat','rat','skeleton'],story:'The ancient farmlands choke on ash and sorrow.'},
  {name:'Rotwood Forest',sky:['#0c1006','#141808'],ground:'#1a2010',hill:'#0c1006',enemies:['skeleton','zombie','skeleton'],story:"These twisted trees remember the Lich's first corruption."},
  {name:'Catacombs Deep',sky:['#0e0808','#180e0a'],ground:'#1c1210',hill:'#0c0808',enemies:['zombie','wraith','zombie'],story:'Sealed for a reason. That reason still prowls the dark.'},
  {name:'Shadowmere',sky:['#080c18','#101828'],ground:'#1a2030',hill:'#08101e',enemies:['wraith','wraith','lich'],story:'The cursed marshlands where wraiths struck a pact with death.'},
  {name:"Sorcerer's Veil",sky:['#0e0818','#180c28'],ground:'#1a1028',hill:'#0c0814',enemies:['dragon','lich','dragon'],story:'A pocket dimension of corrupted magic. Nothing here is real.'},
  {name:'Obsidian Keep',sky:['#100606','#1a0808'],ground:'#1e0e0c',hill:'#0e0606',enemies:['lich','dragon','lich'],story:'Built from the bones of those who dared resist the king.'},
  {name:'Void Spire',sky:['#060610','#0e0e1e'],ground:'#14141e',hill:'#060610',enemies:['dragon','lich','dragon'],story:'The Spire reaches into a dimension of raw, unraveling power.'},
  {name:'Infernal Core',sky:['#1c0606','#260808'],ground:'#220c0c',hill:'#160404',enemies:['lich','dragon','lich'],story:"The Ashen King's throne. Reality fractures here."},
];
const ENAMES={rat:['Grave Rat','Diseased Rat','Feral Rat','Plague Carrier'],skeleton:['Skeleton Guard','Bone Archer','Crypt Warrior','Restless Dead'],zombie:['Rot Zombie','Plague Shambler','Brute Zombie','Cursed Revenant'],wraith:['Frost Wraith','Shadow Wraith','Banshee','Soul Eater'],dragon:['Shadow Drake','Ember Wyvern','Ancient Dragon','Void Serpent'],lich:['Bone Lich','Void Lich','Soul Lich','Death Incarnate']};

/* ===============================================
   STORY CHAPTERS
=============================================== */
const STORY_CHAPTERS=[
  {id:'ch1',zone:1,ico:'üåæ',title:'The Shattered Kingdom',
   quote:'"Once, Aetheron shone like a beacon. Then the Ashen King came ‚Äî and everything burned."',
   desc:'You wake in ruined farmlands tasting ash. Corpses rise from shallow graves. A distant castle looms. The realm is dying and no one is coming to save it. Someone must stand.',
   objs:[{t:'kills',n:'Slay 10 enemies',tar:10},{t:'level',n:'Reach level 5',tar:5}],
   rew:{g:100,sp:3},done:false,unlocked:true},
  {id:'ch2',zone:2,ico:'üå≤',title:'The Rotwood Conspiracy',
   quote:'"The forest\'s corruption began with a single experiment. Now nothing within it is clean."',
   desc:'The Rotwood was once sacred druidic land. A torn journal hints at a fragment of the Ashen Crown buried beneath the oldest oak ‚Äî one of six. Find it.',
   objs:[{t:'kills',n:'Slay 100 enemies',tar:100},{t:'zone',n:'Reach Zone 3',tar:3},{t:'level',n:'Reach level 12',tar:12}],
   rew:{g:400,sp:6},done:false,unlocked:false},
  {id:'ch3',zone:3,ico:'üíÄ',title:'Descent Into Darkness',
   quote:'"The Catacombs were sealed a hundred years ago. Whatever is down there, it wasn\'t supposed to wake."',
   desc:'The labyrinthine tombs beneath the forest. Ancient soldiers entombed here now march in undead legions. The second Crown fragment is guarded by something ancient.',
   objs:[{t:'kills',n:'Slay 300 enemies',tar:300},{t:'level',n:'Reach level 20',tar:20},{t:'sktotal',n:'Unlock 8 skills',tar:8}],
   rew:{g:1000,sp:10},done:false,unlocked:false},
  {id:'ch4',zone:4,ico:'üåä',title:'The Shadowmere Pact',
   quote:'"The Wraiths gave the King their deathless service. He gave them eternity. Neither party was satisfied."',
   desc:'The cursed marshlands. Wraiths bound by blood-oaths drift among withered reeds. The third Crown fragment rests at the heart of Shadowmere.',
   objs:[{t:'kills',n:'Slay 750 enemies',tar:750},{t:'gtotal',n:'Earn 5000 gold',tar:5000},{t:'level',n:'Reach level 30',tar:30}],
   rew:{g:2500,sp:15},done:false,unlocked:false},
  {id:'ch5',zone:5,ico:'üîÆ',title:"The Sorcerer's Betrayal",
   quote:'"He was the King\'s most trusted advisor. He was also the architect of his master\'s damnation."',
   desc:'The Sorcerer\'s Veil ‚Äî a pocket dimension of broken reality. Floating towers. Dragons circling ruins. The fourth fragment floats in an arcane cage.',
   objs:[{t:'kills',n:'Slay 1500 enemies',tar:1500},{t:'boons',n:'Own 3 boons',tar:3},{t:'level',n:'Reach level 42',tar:42}],
   rew:{g:5000,sp:20},done:false,unlocked:false},
  {id:'ch6',zone:6,ico:'üè∞',title:'The Obsidian Keep',
   quote:'"Its walls are built from the bones of those who resisted. The stones still remember the screams."',
   desc:'The Ashen King\'s fortress. Black stone that devours light. The fifth fragment is embedded in the throne room wall.',
   objs:[{t:'kills',n:'Slay 3000 enemies',tar:3000},{t:'level',n:'Reach level 55',tar:55},{t:'prestige',n:'Ascend once',tar:1}],
   rew:{g:10000,sp:30},done:false,unlocked:false},
  {id:'ch7',zone:7,ico:'‚≠ê',title:'The Void Ascent',
   quote:'"The Void Spire reaches into dimensions no living mind was meant to perceive."',
   desc:'Pure void-matter crackles in the air. Reality tears at the edges. The Ashen King\'s phylactery is somewhere within.',
   objs:[{t:'kills',n:'Slay 6000 enemies',tar:6000},{t:'level',n:'Reach level 70',tar:70},{t:'prestige',n:'Ascend twice',tar:2}],
   rew:{g:20000,sp:50},done:false,unlocked:false},
  {id:'ch8',zone:8,ico:'üî•',title:'The Final Reckoning',
   quote:'"The Ashen King sits on a throne of cinders, wearing a crown of stolen souls. Today, the debt is repaid."',
   desc:'The Infernal Core. Time moves strangely here. The six Crown fragments hum with stolen power in your hands. This is what all of it was for.',
   objs:[{t:'kills',n:'Slay 12000 enemies',tar:12000},{t:'level',n:'Reach level 99',tar:99},{t:'prestige',n:'Ascend three times',tar:3}],
   rew:{g:50000,sp:100},done:false,unlocked:false},
];

/* ===============================================
   CLASSES
=============================================== */
const CLASSES={
  warrior:{icon:'‚öî',name:'Ironclad Warrior',flavor:'"Where others shatter, I endure."',lore:'A veteran of a hundred campaigns. The Warrior is the hammer that never bends ‚Äî raw power backed by iron flesh and unbreakable will.',baseAtk:8,baseDef:5,baseHp:160,baseMana:30,baseSpd:1.0,baseCrit:5,baseSpell:0,hints:['‚öî Highest Attack','üõ° Best Defense','‚ù§ Most HP']},
  mage:{icon:'üîÆ',name:'Void Mage',flavor:'"Power without mercy. Magic without limit."',lore:'A scholar who delved too deep into forbidden lore. The Mage commands devastating arcane forces but must manage precious mana with care.',baseAtk:4,baseDef:2,baseHp:90,baseMana:120,baseSpd:1.0,baseCrit:12,baseSpell:14,hints:['üîÆ Spell Damage','üí• High Crits','‚ú¶ Mana Scaling']},
  rogue:{icon:'üó°',name:'Shadow Rogue',flavor:'"Strike unseen. Vanish before the blood hits the ground."',lore:'An assassin born in the slums of a fallen city. The Rogue relies on blistering speed, crippling critical strikes, and the ability to ghost through death itself.',baseAtk:6,baseDef:2,baseHp:110,baseMana:70,baseSpd:1.6,baseCrit:22,baseSpell:0,hints:['‚ö° Fastest Attacks','üí• Best Crits','üë§ Dodge Chance']},
  paladin:{icon:'‚úù',name:'Fallen Paladin',flavor:'"Even shattered faith leaves a mark."',lore:'The order of Paladins was destroyed by the Ashen King. One survivor channels divine wrath through cracked armor, fueled by grief and righteous fury.',baseAtk:7,baseDef:4,baseHp:130,baseMana:80,baseSpd:1.0,baseCrit:8,baseSpell:8,hints:['‚úù Holy Damage','üõ° Strong Defense','üíö Self-Healing']},
  ranger:{icon:'üèπ',name:'Cursed Ranger',flavor:'"The wilds remember every injustice done to them."',lore:"A tracker who witnessed the Rotwood's corruption firsthand and was changed by it. The Ranger strikes from range with nature-imbued arrows.",baseAtk:6,baseDef:3,baseHp:105,baseMana:85,baseSpd:1.35,baseCrit:18,baseSpell:5,hints:['üèπ Ranged Attacks','üåø Nature Magic','‚ö° High Speed']},
};

/* ===============================================
   SKILL TREES
=============================================== */
const SKTREES={
  offense:{label:'Offense',ico:'‚öî',tiers:[
    [{id:'heavy',name:'Heavy Strike',ico:'üí•',desc:'+4 ATK per rank',max:6,eff:'atk',val:4}],
    [{id:'execute',name:'Execute',ico:'üó°',desc:'+6% crit per rank',max:5,eff:'crit',val:6,req:'heavy'},{id:'cleave',name:'Cleave',ico:'‚öî',desc:'+2 bonus DMG per rank',max:4,eff:'atk',val:2,req:'heavy'}],
    [{id:'berserk',name:'Berserker',ico:'üî•',desc:'<30% HP ‚Üí +70% ATK',max:1,eff:'special',req:'execute',cap:true},{id:'overpower',name:'Overpower',ico:'üí¢',desc:'Every 5th hit: √ó3 damage',max:1,eff:'special',req:'execute',cap:true}],
  ]},
  defense:{label:'Defense',ico:'üõ°',tiers:[
    [{id:'ironskin',name:'Iron Skin',ico:'üõ°',desc:'+3 DEF per rank',max:6,eff:'def',val:3}],
    [{id:'vigor',name:'Vigor',ico:'‚ù§',desc:'+22 Max HP per rank',max:5,eff:'maxHp',val:22,req:'ironskin'},{id:'fortress',name:'Fortress',ico:'üè∞',desc:'Block 18% enemy damage',max:1,eff:'block',val:18,req:'ironskin',cap:true}],
    [{id:'regen',name:'Regeneration',ico:'üíö',desc:'Heal 2% HP per kill',max:4,eff:'regen',val:2,req:'vigor'},{id:'secondwind',name:'Second Wind',ico:'üå¨',desc:'Revive once at 40% HP',max:1,eff:'special',req:'vigor',cap:true}],
  ]},
  magic:{label:'Magic',ico:'üîÆ',tiers:[
    [{id:'arcane',name:'Arcane Surge',ico:'‚ú®',desc:'+6 Spell DMG per rank',max:6,eff:'spell',val:6}],
    [{id:'manawell',name:'Mana Well',ico:'‚ú¶',desc:'+22 Max Mana per rank',max:5,eff:'maxMana',val:22,req:'arcane'},{id:'soulburn',name:'Soul Burn',ico:'üåë',desc:'Spells deal +35% damage',max:1,eff:'special',req:'arcane',cap:true}],
    [{id:'drain',name:'Life Drain',ico:'ü©∏',desc:'+3% lifesteal per rank',max:4,eff:'life',val:3,req:'manawell'},{id:'voidbolt',name:'Void Bolt',ico:'‚ö´',desc:'5% chance: instakill <20% HP',max:1,eff:'special',req:'manawell',cap:true}],
  ]},
  agility:{label:'Agility',ico:'‚ö°',tiers:[
    [{id:'swift',name:'Swiftness',ico:'‚ö°',desc:'+0.12 ATK speed per rank',max:5,eff:'spd',val:0.12}],
    [{id:'dodge',name:'Shadow Step',ico:'üë§',desc:'+8% dodge per rank',max:4,eff:'dodge',val:8,req:'swift'},{id:'flurry',name:'Flurry',ico:'üåÄ',desc:'Crits trigger +2 bonus hits',max:1,eff:'special',req:'swift',cap:true}],
    [{id:'shadowform',name:'Shadowform',ico:'üå´',desc:'+18% to ALL stats',max:1,eff:'allstats',val:18,req:'dodge',cap:true}],
  ]},
  holy:{label:'Holy',ico:'‚úù',tiers:[
    [{id:'smite',name:'Holy Smite',ico:'‚úù',desc:'+5 holy DMG per rank',max:6,eff:'spell',val:5}],
    [{id:'blessed',name:'Blessed Armor',ico:'üåü',desc:'+4 DEF, +0.05 SPD per rank',max:4,eff:'both',req:'smite'},{id:'consecrate',name:'Consecrate',ico:'üïä',desc:'+5% ATK heals per rank',max:3,eff:'life',val:5,req:'smite'}],
    [{id:'divine',name:'Divine Shield',ico:'‚õ®',desc:'Negate one fatal hit',max:1,eff:'special',req:'blessed',cap:true},{id:'radiance',name:'Radiance',ico:'‚òÄ',desc:'+20% gold & XP',max:1,eff:'special',req:'consecrate',cap:true}],
  ]},
};

/* ===============================================
   SKILL INVESTMENT TABLE (Level 90+)
   Fair but not game-breaking ‚Äî diminishing linear scale
=============================================== */
const SK_INVEST=[
  {id:'si_atk',ico:'‚öî',name:'Iron Mastery',
   desc:'Each point grants +1% base ATK. Diminishes: every 10 points the bonus halves.',
   maxPts:100,
   reward(pts){
     // +1% per pt up to 10, +0.5% per pt 11-30, +0.25% per pt 31-100
     let bonus=0;
     const t1=Math.min(pts,10),t2=Math.max(0,Math.min(pts-10,20)),t3=Math.max(0,pts-30);
     bonus+=t1*1+t2*0.5+t3*0.25;
     return{label:`+${bonus.toFixed(1)}% ATK`,atkPct:bonus};
   }
  },
  {id:'si_def',ico:'üõ°',name:'Fortress Mind',
   desc:'Each point grants +1% base DEF. Diminishes every 10 points.',
   maxPts:100,
   reward(pts){
     const t1=Math.min(pts,10),t2=Math.max(0,Math.min(pts-10,20)),t3=Math.max(0,pts-30);
     const bonus=t1*1+t2*0.5+t3*0.25;
     return{label:`+${bonus.toFixed(1)}% DEF`,defPct:bonus};
   }
  },
  {id:'si_hp',ico:'‚ù§',name:'Vital Endurance',
   desc:'Each point grants +0.5% Max HP. Diminishes every 20 points.',
   maxPts:100,
   reward(pts){
     const t1=Math.min(pts,20),t2=Math.max(0,Math.min(pts-20,30)),t3=Math.max(0,pts-50);
     const bonus=t1*0.5+t2*0.25+t3*0.1;
     return{label:`+${bonus.toFixed(1)}% Max HP`,hpPct:bonus};
   }
  },
  {id:'si_gold',ico:'üí∞',name:'Hoarder\'s Instinct',
   desc:'Each point grants +0.5% gold from kills. Diminishes every 20 points.',
   maxPts:100,
   reward(pts){
     const t1=Math.min(pts,20),t2=Math.max(0,Math.min(pts-20,30)),t3=Math.max(0,pts-50);
     const bonus=t1*0.5+t2*0.25+t3*0.1;
     return{label:`+${bonus.toFixed(1)}% gold`,goldPct:bonus};
   }
  },
  {id:'si_xp',ico:'‚≠ê',name:'Soulward Study',
   desc:'Each point grants +0.5% XP from kills. Diminishes every 20 points.',
   maxPts:100,
   reward(pts){
     const t1=Math.min(pts,20),t2=Math.max(0,Math.min(pts-20,30)),t3=Math.max(0,pts-50);
     const bonus=t1*0.5+t2*0.25+t3*0.1;
     return{label:`+${bonus.toFixed(1)}% XP`,xpPct:bonus};
   }
  },
];

/* ===============================================
   QUESTS & BOONS
=============================================== */
const QUESTS=[
  {id:'q_s1',cat:'story',ico:'üìñ',name:'The First Step',desc:'Your journey begins. Leave your mark on the Ashen Fields.',type:'kills',target:10,rew:{g:50,sp:2},done:false},
  {id:'q_s2',cat:'story',ico:'üìñ',name:'Into the Dark',desc:'Descend through the zones to reach the Catacombs.',type:'zone',target:3,rew:{g:400,sp:7},done:false},
  {id:'q_s3',cat:'story',ico:'üìñ',name:'The Long March',desc:"Journey beyond the Shadowmere to the Sorcerer's domain.",type:'zone',target:5,rew:{g:2000,sp:15},done:false},
  {id:'q_s4',cat:'story',ico:'üìñ',name:'The Throne Room',desc:'Reach the heart of the Infernal Core.',type:'zone',target:8,rew:{g:12000,sp:50},done:false},
  {id:'q_k1',cat:'slayer',ico:'üíÄ',name:'First Blood',desc:'Slay your first enemies and prove yourself worthy.',type:'kills',target:10,rew:{g:50,sp:2},done:false},
  {id:'q_k2',cat:'slayer',ico:'üíÄ',name:'Slaughterer',desc:'One thousand foes shall fall before you.',type:'kills',target:1000,rew:{g:2000,sp:10},done:false},
  {id:'q_k3',cat:'slayer',ico:'üíÄ',name:'Undying Reaper',desc:'Five thousand slain. Your name is spoken in whispers.',type:'kills',target:5000,rew:{g:8000,sp:25},done:false},
  {id:'q_k4',cat:'slayer',ico:'üíÄ',name:'Death Incarnate',desc:'Ten thousand souls released. You have become legend.',type:'kills',target:10000,rew:{g:25000,sp:60},done:false},
  {id:'q_l1',cat:'mastery',ico:'‚¨Ü',name:'Initiate',desc:'Show the realm what you are capable of.',type:'level',target:10,rew:{g:150,sp:3},done:false},
  {id:'q_l2',cat:'mastery',ico:'‚¨Ü',name:'Champion',desc:'Your power eclipses all who came before.',type:'level',target:30,rew:{g:1500,sp:8},done:false},
  {id:'q_l3',cat:'mastery',ico:'‚¨Ü',name:'Legend',desc:'Your name is spoken in hushed reverence.',type:'level',target:60,rew:{g:6000,sp:20},done:false},
  {id:'q_l4',cat:'mastery',ico:'‚¨Ü',name:'Ascendant',desc:'You have surpassed all mortal limits.',type:'level',target:99,rew:{g:18000,sp:50},done:false},
  {id:'q_m1',cat:'mastery',ico:'‚ú®',name:'Skill Seeker',desc:'Walk the paths of power.',type:'sktotal',target:5,rew:{g:500,sp:4},done:false},
  {id:'q_m2',cat:'mastery',ico:'‚ú®',name:'Skill Master',desc:'The skill trees bend to your will.',type:'sktotal',target:20,rew:{g:2500,sp:14},done:false},
  {id:'q_m3',cat:'mastery',ico:'‚ú®',name:'Skill Lord',desc:'All paths of power walk through you.',type:'sktotal',target:40,rew:{g:8000,sp:30},done:false},
  {id:'q_g1',cat:'wealth',ico:'üí∞',name:'Coin Gatherer',desc:'Wealth is power. Begin accumulating.',type:'gtotal',target:1000,rew:{g:0,sp:3},done:false},
  {id:'q_g2',cat:'wealth',ico:'üí∞',name:'Treasure Lord',desc:"The old kingdom's vaults hold less than you.",type:'gtotal',target:15000,rew:{g:0,sp:10},done:false},
  {id:'q_g3',cat:'wealth',ico:'üí∞',name:'Vault Sovereign',desc:'Gold beyond reckoning flows through your hands.',type:'gtotal',target:100000,rew:{g:0,sp:25},done:false},
  {id:'q_b1',cat:'mastery',ico:'‚öó',name:'Boon Seeker',desc:'Acquire your first permanent boon.',type:'boons',target:1,rew:{g:800,sp:4},done:false},
  {id:'q_b2',cat:'mastery',ico:'‚öó',name:'Boon Collector',desc:'Collect five permanent boons.',type:'boons',target:5,rew:{g:3000,sp:12},done:false},
  {id:'q_p1',cat:'prestige',ico:'üîÑ',name:'First Ascension',desc:'Die to be reborn. Embrace the cycle.',type:'prestige',target:1,rew:{g:0,sp:30},done:false},
  {id:'q_p2',cat:'prestige',ico:'üîÑ',name:'Eternal Cycle',desc:'Three times reborn. Three times stronger.',type:'prestige',target:3,rew:{g:0,sp:75},done:false},
];
const BOONS=[
  {id:'b1',ico:'üí™',name:'Iron Discipline',desc:'+10% base ATK per level.',cost:500,rarity:'common',cat:'combat'},
  {id:'b2',ico:'üåë',name:'Shadow Harvest',desc:'+15% gold per level.',cost:300,rarity:'common',cat:'wealth'},
  {id:'b3',ico:'üìö',name:'Ancient Wisdom',desc:'+25% XP per level.',cost:600,rarity:'common',cat:'growth'},
  {id:'b4',ico:'ü©∏',name:'Blood Pact',desc:'Restore HP to full on every kill.',cost:800,rarity:'common',cat:'survival'},
  {id:'b5',ico:'üå¨',name:'Ethereal Gale',desc:'+0.3 attack speed per level.',cost:1200,rarity:'rare',cat:'combat'},
  {id:'b6',ico:'üîÆ',name:'Soul Crystal',desc:'+28% spell damage per level.',cost:1000,rarity:'rare',cat:'combat'},
  {id:'b7',ico:'üåø',name:'Life Root',desc:'+3% lifesteal per level.',cost:900,rarity:'rare',cat:'survival'},
  {id:'b8',ico:'‚ö°',name:'Static Surge',desc:'Critical hits trigger +2 bonus hits.',cost:1800,rarity:'rare',cat:'combat'},
  {id:'b9',ico:'üêâ',name:'Dragonfire Pact',desc:'ATK +35% per level. Enemies have +40% HP.',cost:1600,rarity:'epic',cat:'combat'},
  {id:'b10',ico:'üëë',name:'Sovereign Mark',desc:'+6 to ALL stats per zone level, per level.',cost:2200,rarity:'epic',cat:'growth'},
  {id:'b11',ico:'‚öó',name:"Alchemist's Greed",desc:'Each prestige grants +12% gold, per level.',cost:2500,rarity:'epic',cat:'wealth'},
  {id:'b12',ico:'üåå',name:'Void Conduit',desc:'20% chance per attack: free spell.',cost:3200,rarity:'epic',cat:'combat'},
  {id:'b13',ico:'üíÄ',name:"Death's Bargain",desc:'Once per minute: revive at 40% HP upon death.',cost:5000,rarity:'legendary',cat:'survival'},
  {id:'b14',ico:'üåü',name:"Fate's Chosen",desc:'+22% ALL stats per level.',cost:5500,rarity:'legendary',cat:'growth'},
  {id:'b15',ico:'üî•',name:'Pyre Ascendant',desc:'Every 10th kill: chain explosion 6√ó ATK.',cost:8000,rarity:'legendary',cat:'combat'},
  {id:'b16',ico:'üïØ',name:'Soul Lantern',desc:'+50% XP in zones 4+ per level.',cost:1400,rarity:'rare',cat:'growth'},
  {id:'b17',ico:'‚öî',name:'War Covenant',desc:'Kill streaks stack +3% ATK per level (max 30%).',cost:2000,rarity:'epic',cat:'combat'},
  {id:'b18',ico:'üßø',name:'Ward of the Ancients',desc:'+20% block per level. Blocked damage fuels a reflect strike.',cost:2800,rarity:'epic',cat:'survival'},
  {id:'b19',ico:'üíß',name:'Arcane Flow',desc:'+25% mana regen speed per level.',cost:800,rarity:'common',cat:'combat'},
  {id:'b20',ico:'üè¶',name:'Ashen Vault',desc:'Generates 250 gold/sec per level.',cost:400,rarity:'common',cat:'wealth'},
  {id:'b21',ico:'üíÄ',name:'Bone Market',desc:'Generates 800 gold/sec per level.',cost:1500,rarity:'rare',cat:'wealth'},
  {id:'b22',ico:'üåë',name:'Shadow Exchange',desc:'Generates 2,500 gold/sec per level.',cost:5000,rarity:'epic',cat:'wealth'},
  {id:'b23',ico:'üëë',name:'Infernal Mint',desc:'Generates 15,000 gold/sec per level. Scales with Age.',cost:18000,rarity:'legendary',cat:'wealth'},
  {id:'b_memory',ico:'üåí',name:'Ashen Memory',desc:'Reclaims 50% of all skill points lost to the void between upgrades. Unlocked at level 100.',cost:0,rarity:'legendary',cat:'growth',memoryBoon:true},
];

/* ===============================================
   CURSES DATA
=============================================== */
const AFFLICTIONS=[
  {id:'af1',ico:'üíÄ',name:'Brittle Bones',
   penalty:'You take 25% more damage from all sources.',
   reward:'+20% gold and XP from all kills. Permanently.',
   penaltyKey:'moreDmgTaken',penaltyVal:0.25,
   rewardKey:'goldXpBonus',rewardVal:0.20},
  {id:'af2',ico:'ü©∏',name:'Cursed Blood',
   penalty:'Lose 1% of max HP every 4 seconds passively.',
   reward:'+35% ATK permanently.',
   penaltyKey:'hpDrain',penaltyVal:0.01,
   rewardKey:'atkBonus',rewardVal:0.35},
  {id:'af3',ico:'üìñ',name:'Soul Debt',
   penalty:'XP gain is halved.',
   reward:'+60% gold from all sources permanently.',
   penaltyKey:'xpHalved',penaltyVal:0.5,
   rewardKey:'goldBonus',rewardVal:0.60},
  {id:'af4',ico:'üåë',name:'Blind Fury',
   penalty:'All dodge chance and block are reduced to zero.',
   reward:'+40% ATK and +20% attack speed permanently.',
   penaltyKey:'noDefense',penaltyVal:1,
   rewardKey:'furyBonus',rewardVal:1},
];

const SACRIFICES=[
  {id:'sa1',ico:'‚ù§',name:'Blood Tithe',
   penalty:'Sacrifice 20% of your maximum HP. Permanent.',
   reward:'+40% to all passive gold/sec (vault) permanently.',
   penaltyKey:'hpSacrifice',penaltyVal:0.20,
   rewardKey:'vaultBonus',rewardVal:0.40},
  {id:'sa2',ico:'üí∞',name:'The Pact',
   penalty:'Lose ALL current gold immediately.',
   reward:'Double your prestige stat bonus permanently.',
   penaltyKey:'loseGold',penaltyVal:1,
   rewardKey:'doublePrestige',rewardVal:1},
  {id:'sa3',ico:'‚≠ê',name:'Mark of Ruin',
   penalty:'Lose all unspent Skill Points immediately.',
   reward:'+3 SP every time you advance a zone. Permanently.',
   penaltyKey:'loseSP',penaltyVal:1,
   rewardKey:'spPerZone',rewardVal:3},
  {id:'sa4',ico:'üîÆ',name:'Shattered Will',
   penalty:'All skills are reset to zero ranks permanently.',
   reward:'+25% to spell damage and +15% to all stats. Permanently.',
   penaltyKey:'resetSkills',penaltyVal:1,
   rewardKey:'shatterBonus',rewardVal:1},
];

const CURSES_OF_AGES=[
  {id:'ca1',ico:'üßü',name:'The Withering',
   penalty:'Enemies regenerate 2% of their max HP every second.',
   reward:'+15% to ALL stats per active Curse of Ages.',
   penaltyKey:'enemyRegen',penaltyVal:0.02,
   rewardKey:'perCurseBonus',rewardVal:0.15,
   ageReq:2},
  {id:'ca2',ico:'‚ú¶',name:'Void Hunger',
   penalty:'Mana never regenerates naturally.',
   reward:'All spells deal 3√ó damage.',
   penaltyKey:'noManaRegen',penaltyVal:1,
   rewardKey:'spellTriple',rewardVal:3,
   ageReq:2},
  {id:'ca3',ico:'‚ò†',name:"Death's Toll",
   penalty:'Every death permanently costs 5% max HP (min 50 HP). Recoverable by slaying 50 enemies.',
   reward:'+100% XP from all sources.',
   penaltyKey:'deathToll',penaltyVal:0.05,
   rewardKey:'doubleXP',rewardVal:1,
   ageReq:3},
];

function boonLevel(id){ return G.boons[id] || 0; }
function boonUpgradeCost(b){ const lv = boonLevel(b.id); return Math.round(b.cost * Math.pow(1.5, lv)); }
 
/* ===============================================
   GAME STATE
=============================================== */
const SAVE='ashen_v7';
let G=null;
function mkState(){return{cls:'warrior',selCls:null,lv:1,xp:0,xpNext:100,hp:160,maxHp:160,mana:30,maxMana:30,gold:0,gtotal:0,kills:0,deaths:0,zone:1,age:1,zoneKills:0,zoneTarget:10,sp:0,prestige:0,pbonus:1.0,sk:{},quests:QUESTS.map(q=>({...q})),boons:{},boonCount:0,idle:false,lastSave:Date.now(),sktotal:0,chapters:STORY_CHAPTERS.map(c=>({...c,objs:c.objs.map(o=>({...o}))})),chainKills:0,divineReady:true,deathBargain:true,
curses:{},sacrifices:{},deathTollDebt:0,deathTollKills:0,
skInvest:{},skInvestWasted:0,skInvestWastedAtLastMemory:0,ashenMemoryLevel:0,spSpentTotal:0,everReachedLv100:false};}
function saveG(){try{localStorage.setItem(SAVE,JSON.stringify({...G,idle:false,lastSave:Date.now()}));}catch(e){}}
function loadG(){
  try{
    const d=localStorage.getItem(SAVE);
    if(d){
      const s=JSON.parse(d);G=mkState();
      ['cls','selCls','lv','xp','xpNext','hp','maxHp','mana','maxMana','gold','gtotal','kills','deaths','zone','age','zoneKills','zoneTarget','sp','prestige','pbonus','sk','boons','boonCount','sktotal','curses','sacrifices','deathTollDebt','deathTollKills','skInvest','skInvestWasted','skInvestWastedAtLastMemory','ashenMemoryLevel','spSpentTotal','everReachedLv100'].forEach(k=>{if(s[k]!==undefined)G[k]=s[k];});
      G.quests=QUESTS.map(q=>{const sq=(s.quests||[]).find(x=>x.id===q.id);return sq?{...q,...sq}:{...q};});
      G.chapters=STORY_CHAPTERS.map(c=>{const sc=(s.chapters||[]).find(x=>x.id===c.id);if(!sc)return{...c,objs:c.objs.map(o=>({...o}))};return{...c,...sc,objs:c.objs.map((o,i)=>sc.objs&&sc.objs[i]?{...o,...sc.objs[i]}:{...o})};});
      // Offline progress ‚Äî full simulation
      const now = Date.now();
      const elapsed = Math.min((now - (s.lastSave || now)) / 1000, 8 * 3600);
      if(elapsed > 10){
        // Helpers that work off saved state (s) not live G
        const bl = id => (s.boons&&s.boons[id])||0;
        const sk = id => (s.sk&&s.sk[id])||0;

        // Attack speed
        let offSpd = (s.cls ? CLASSES[s.cls].baseSpd : 1.0);
        offSpd += sk('swift')*0.12 + bl('b5')*0.3;
        offSpd = Math.max(0.5, offSpd);
        const attacksPerSec = offSpd;
        const killChance = 0.35;

        // Simulate second by second
        let simZone = s.zone||1;
        let simAge  = s.age||1;
        let simZoneKills = s.zoneKills||0;
        let simZoneTarget = s.zoneTarget||10;
        let offKills=0, offGold=0, offXP=0, offLevels=0, offSP=0;
        let simLv = s.lv||1;
        let simXp = s.xp||0;
        let simXpNext = s.xpNext||100;
        let offZoneAdv=0, offAgeAdv=0;

        // Vault g/s from saved boons
        const vaultAgeMult = Math.pow(1.15, simAge-1);
        const vaultGps = Math.round((bl('b20')*250 + bl('b21')*800 + bl('b22')*2500 + bl('b23')*15000*vaultAgeMult) * (s.pbonus||1) * 10)/10;

        // Gold from vault over full offline period
        offGold += Math.floor(vaultGps * elapsed);

        // Simulate kills second by second (chunked for performance)
        const CHUNK = 10; // simulate in 10s chunks
        const chunks = Math.floor(elapsed / CHUNK);
        const remainder = elapsed % CHUNK;

        const simulateChunk = (secs) => {
          const kills = Math.floor(attacksPerSec * secs * killChance);
          for(let i=0;i<kills;i++){
            // Gold per kill
            let g = Math.round((6+simZone*5)*Math.pow(1.45,simZone-1)*0.9*Math.pow(1.2,simAge-1));
            if(bl('b2')) g = Math.round(g*(1+0.15*bl('b2')));
            if(bl('b9')) g = Math.round(g*(1+0.25*bl('b9')));
            if(bl('b11')&& s.prestige) g = Math.round(g*(1+s.prestige*0.12));
            offGold += g;

            // XP per kill
            let xpg = Math.round(13*Math.pow(1.45,simZone-1)*Math.pow(1.2,simAge-1));
            if(bl('b3')) xpg = Math.round(xpg*(1+0.25*bl('b3')));
            if(bl('b16')&&simZone>=4) xpg = Math.round(xpg*(1+0.5*bl('b16')));
            offXP += xpg;
            offKills++;

            // Zone progression
            simZoneKills++;
            if(simZoneKills >= simZoneTarget){
              simZoneKills = 0;
              simZoneTarget = Math.round(simZoneTarget*1.22);
              if(simZone >= 8){ simZone=1; simAge++; offAgeAdv++; }
              else { simZone++; offZoneAdv++; }
            }
          }
          // Level ups from XP
          simXp += offXP;
          offXP = 0;
          while(simXp >= simXpNext){
            simXp -= simXpNext; simLv++; simXpNext = xpFor(simLv); offSP++; offLevels++;
          }
        };

        for(let c=0;c<chunks;c++) simulateChunk(CHUNK);
        if(remainder>0) simulateChunk(remainder);

        // Flush remaining XP
        simXp += offXP;
        offXP = 0;
        while(simXp >= simXpNext){
          simXp -= simXpNext; simLv++; simXpNext = xpFor(simLv); offSP++; offLevels++;
        }

        // Apply everything to live state
        G.kills += offKills;
        G.gold += offGold;
        G.gtotal += offGold;
        G.xp = simXp;
        G.lv = simLv;
        G.xpNext = simXpNext;
        G.sp += offSP;
        G.zone = simZone;
        G.age = simAge;
        G.zoneKills = simZoneKills;
        G.zoneTarget = simZoneTarget;

        // HP/mana scale to new level
        const offSt = (() => {
          const c = CLASSES[G.cls];
          let mHp = c.baseHp + (G.lv-1)*13;
          if(sk('vigor')) mHp += sk('vigor')*22;
          if(bl('b14')) mHp = Math.round(mHp*(1+0.22*bl('b14')));
          mHp = Math.round(mHp*(s.pbonus||1));
          return { maxHp: mHp, maxMana: c.baseMana + sk('manawell')*22 };
        })();
        G.hp = offSt.maxHp;
        G.mana = offSt.maxMana;

        G._offlineRecap = {
          kills: offKills,
          gold: offGold,
          levels: offLevels,
          sp: offSP,
          zoneAdv: offZoneAdv,
          ageAdv: offAgeAdv,
          seconds: Math.round(elapsed)
        };
      }
      return true;
    }
  }catch(e){}G=mkState();return false;
}
function clearSavePrompt(){openModal('New Game','Are you sure you want to start over? All progress will be lost.','This cannot be undone.',()=>{localStorage.removeItem(SAVE);G=mkState();buildClassCards();showScr('s1');closeModal();},true);}

/* ===============================================
   COMPUTED STATS
=============================================== */
function getStats(){
  const c=CLASSES[G.cls];
  let atk=c.baseAtk,def=c.baseDef,spd=c.baseSpd,crit=c.baseCrit;
  let life=0,spell=c.baseSpell||0,maxHp=c.baseHp,maxMana=c.baseMana,dodge=0,block=0;
  const lv=G.lv,sk=G.sk;
  atk+=(lv-1)*2.2;def+=(lv-1)*1.1;maxHp+=(lv-1)*13;
  if(sk.heavy)atk+=sk.heavy*4;if(sk.cleave)atk+=sk.cleave*2;if(sk.ironskin)def+=sk.ironskin*3;
  if(sk.vigor)maxHp+=sk.vigor*22;if(sk.arcane)spell+=sk.arcane*6;if(sk.smite)spell+=sk.smite*5;
  if(sk.manawell)maxMana+=sk.manawell*22;if(sk.swift)spd+=sk.swift*0.12;if(sk.dodge)dodge+=sk.dodge*8;
  if(sk.execute)crit+=sk.execute*6;if(sk.drain)life+=sk.drain*3;if(sk.consecrate)life+=sk.consecrate*5;
  if(sk.fortress)block+=18;if(sk.blessed){def+=sk.blessed*4;spd+=sk.blessed*0.05;}
  if(sk.soulburn)spell=Math.round(spell*1.35);
  if(sk.shadowform){atk*=1.18;def*=1.18;maxHp=Math.round(maxHp*1.18);}
  const bl=id=>(G.boons[id]||0);
  if(bl('b1'))atk*=(1+0.10*bl('b1'));
  if(bl('b5'))spd+=0.3*bl('b5');
  if(bl('b6'))spell=Math.round(spell*(1+0.28*bl('b6')));
  if(bl('b7'))life+=3*bl('b7');
  if(bl('b9'))atk*=(1+0.35*bl('b9'));
  if(bl('b10')){const zb=G.zone*6*bl('b10');atk+=zb;def+=zb;maxHp+=zb*3;}
  if(bl('b14')){const m=1+0.22*bl('b14');atk*=m;def*=m;maxHp=Math.round(maxHp*m);}
  if(bl('b18'))block+=20*bl('b18');
  if(G.boons.b17&&G.chainKills>0)atk*=1+Math.min(G.chainKills,10)*0.03;
    // === CURSE EFFECTS ON STATS ===
  const ac=id=>(G.curses&&G.curses[id]);
  const sc=id=>(G.sacrifices&&G.sacrifices[id]);
  if(ac('af1')){/* damage taken handled in doAttack */}
  if(ac('af2'))atk*=1.35;
  if(ac('af3')){/* gold handled in killEnemy */}
  if(ac('af4')){spd*=1.20;atk*=1.40;dodge=0;block=0;}
  if(sc('sa1'))maxHp=Math.round(maxHp*0.80);
  if(sc('sa4')){spell=Math.round(spell*1.25);atk*=1.15;def*=1.15;maxHp=Math.round(maxHp*1.15);}
  // Curse of Ages: Withering ‚Äî +15% all stats per active CoA
  const activeCoA=[...CURSES_OF_AGES].filter(c=>G.curses&&G.curses[c.id]).length;
  if(activeCoA>0){const m=1+activeCoA*0.15;atk*=m;def*=m;maxHp=Math.round(maxHp*m);}
  // Void Hunger ‚Äî spells √ó3
  if(ac('ca2'))spell=Math.round(spell*3);
  // Death's Toll ‚Äî +100% XP handled in killEnemy; deathTollDebt reduces maxHp
  if(ac('ca3')&&G.deathTollDebt>0)maxHp=Math.max(50,maxHp-Math.round(G.deathTollDebt));
  // === SKILL INVESTMENT BONUSES (Level 90+) ===
  if(G.skInvest){
    SK_INVEST.forEach(si=>{
      const pts=G.skInvest[si.id]||0;
      if(pts<=0)return;
      const rew=si.reward(pts);
      if(rew.atkPct)atk*=(1+rew.atkPct/100);
      if(rew.defPct)def*=(1+rew.defPct/100);
      if(rew.hpPct)maxHp=Math.round(maxHp*(1+rew.hpPct/100));
    });
  }
  atk*=G.pbonus;def*=G.pbonus;maxHp=Math.round(maxHp*G.pbonus);
  return{atk:Math.round(atk*10)/10,def:Math.round(def*10)/10,spd:Math.round(Math.max(.5,spd)*100)/100,crit:Math.round(crit),life:Math.round(life),spell:Math.round(spell),maxHp:Math.round(maxHp),maxMana:Math.round(maxMana),dodge:Math.round(dodge),block:Math.round(block)};
}
function xpFor(lv){return Math.floor(100*Math.pow(1.28,lv-1));}
function atkInterval(){return Math.max(200,Math.round(1000/getStats().spd));}
function allSkList(){return Object.values(SKTREES).flatMap(t=>t.tiers.flat());}

/* ===============================================
   CANVAS ‚Äî 32-BIT ENHANCED RENDERING
=============================================== */
let CV=null,CTX=null,raf=null;
let PA={x:0,y:0,bob:0,aflash:0,hflash:0};
let EA={x:0,y:0,bob:0,hflash:0,dead:false,deathT:0};
let bgScroll=0,particles=[];

// Lighting overlay for 32-bit depth
let lightPulse=0;

function initCanvas(){CV=document.getElementById('arena-cv');CTX=CV.getContext('2d');resizeCv();window.addEventListener('resize',resizeCv);cancelAnimationFrame(raf);loop();}
function resizeCv(){const w=document.getElementById('arena-wrap');CV.width=w.clientWidth;CV.height=w.clientHeight;PA.x=CV.width*.17;PA.y=CV.height*.42;EA.x=CV.width*.66;EA.y=CV.height*.38;}
function loop(){
  PA.bob+=.042;EA.bob+=.036;bgScroll=(bgScroll+.28)%Math.max(CV.width,1);
  lightPulse+=0.035;
  if(PA.aflash>.01)PA.aflash-=.085;else PA.aflash=0;
  if(PA.hflash>.01)PA.hflash-=.085;else PA.hflash=0;
  if(EA.hflash>.01)EA.hflash-=.085;else EA.hflash=0;
  if(EA.dead&&EA.deathT<1)EA.deathT+=.06;
  particles=particles.filter(p=>{p.life-=.048;p.x+=p.vx;p.y+=p.vy;p.vy+=.12;return p.life>0;});
  drawArena32();raf=requestAnimationFrame(loop);
}

function drawArena32(){
  if(!CV||!CTX)return;
  const ctx=CTX,W=CV.width,H=CV.height;
  const zi=Math.min((G?G.zone:1)-1,ZONES.length-1);
  const z=ZONES[zi];

  // === 32-bit sky with gradient bands ===
  const sky=ctx.createLinearGradient(0,0,0,H*.7);
  sky.addColorStop(0,z.sky[0]);
  // Mid-tone for atmospheric depth
  const midR=parseInt(z.sky[0].slice(1,3),16),midG2=parseInt(z.sky[0].slice(3,5),16),midB=parseInt(z.sky[0].slice(5,7),16);
  sky.addColorStop(0.5,`rgb(${midR+12},${midG2+8},${midB+6})`);
  sky.addColorStop(1,z.sky[1]);
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

  // === Stars with twinkle (zones > 0) ===
  if(zi>0){
    for(let i=0;i<24;i++){
      const sx=((i*139+bgScroll*.04)%W);
      const sy=3+(i*53)%(H*.42);
      const twink=0.3+0.5*Math.sin(Date.now()*.0012+i*1.4);
      ctx.globalAlpha=twink;
      const sz=i%7===0?2:1;
      ctx.fillStyle=i%5===0?'#c0d8ff':'#ffffd8';
      ctx.fillRect(sx,sy,sz,sz);
    }
    ctx.globalAlpha=1;
  }

  // === Moon or sun disc ===
  const moonX=W*.82,moonY=H*.18;
  const moonGrad=ctx.createRadialGradient(moonX-4,moonY-4,1,moonX,moonY,16);
  if(zi<3){
    moonGrad.addColorStop(0,'rgba(255,220,140,0.5)');
    moonGrad.addColorStop(0.5,'rgba(255,180,80,0.15)');
    moonGrad.addColorStop(1,'transparent');
  }else{
    moonGrad.addColorStop(0,'rgba(180,180,255,0.35)');
    moonGrad.addColorStop(0.6,'rgba(120,120,200,0.1)');
    moonGrad.addColorStop(1,'transparent');
  }
  ctx.fillStyle=moonGrad;ctx.beginPath();ctx.arc(moonX,moonY,22,0,Math.PI*2);ctx.fill();

  // === Background hills ‚Äî 3 layers for depth ===
  // Far hill (darkest)
  ctx.fillStyle=adjustAlpha(z.hill,0.6);
  ctx.beginPath();ctx.moveTo(0,H*.72);
  for(let x=0;x<=W;x+=6)ctx.lineTo(x,H*.72+Math.sin(x*.012+bgScroll*.00035)*18+Math.sin(x*.025)*9);
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();

  // Mid hill
  ctx.fillStyle=lighten(z.hill,15);
  ctx.beginPath();ctx.moveTo(0,H*.65);
  for(let x=0;x<=W;x+=5)ctx.lineTo(x,H*.65+Math.sin(x*.016+bgScroll*.00055)*14+Math.sin(x*.034)*7);
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();

  // Near hill
  ctx.fillStyle=lighten(z.hill,28);
  ctx.beginPath();ctx.moveTo(0,H*.6);
  for(let x=0;x<=W;x+=4)ctx.lineTo(x,H*.6+Math.sin(x*.022+bgScroll*.0008)*12+Math.sin(x*.042)*6);
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();

  // === Ground with texture ===
  const gnd=ctx.createLinearGradient(0,H*.6,0,H);
  gnd.addColorStop(0,z.ground);
  gnd.addColorStop(0.4,lighten(z.ground,8));
  gnd.addColorStop(1,'#030202');
  ctx.fillStyle=gnd;ctx.fillRect(0,H*.6,W,H*.4);

  // === Ground tile texture ‚Äî cobble/dirt pattern ===
  const groundTop=Math.round(H*.60);
  ctx.save();
  ctx.globalAlpha=0.09;
  // Horizontal mortar lines
  ctx.fillStyle='#000000';
  for(let gy=groundTop;gy<H;gy+=8){ctx.fillRect(0,gy,W,1);}
  // Vertical brick offsets
  ctx.globalAlpha=0.06;
  let brickRow=0;
  for(let gy=groundTop;gy<H;gy+=8){
    const offset=brickRow%2===0?0:14;
    for(let gx=offset;gx<W;gx+=28){ctx.fillRect(gx,gy,1,8);}
    brickRow++;
  }
  // Subtle highlight on top edge of each brick row
  ctx.globalAlpha=0.07;
  ctx.fillStyle='#ffffff';
  for(let gy=groundTop+1;gy<H;gy+=8){ctx.fillRect(0,gy,W,1);}
  // Scattered dirt/grime dots
  ctx.globalAlpha=0.05;
  ctx.fillStyle='#000000';
  for(let i=0;i<60;i++){
    const dx=((i*137+bgScroll*.5)%W);
    const dy=groundTop+4+((i*79)%(H-groundTop-4));
    ctx.fillRect(dx,dy,2,1);
  }
  ctx.restore();

  // === Zone label ===
  ctx.font=`bold ${Math.max(7,Math.round(W*.017))}px Cinzel,serif`;
  ctx.textAlign='right';
  ctx.fillStyle='rgba(240,200,80,0.18)';
  ctx.fillText(z.name,W-8,14);
  ctx.textAlign='left';

  // === Particles ===
  particles.forEach(p=>{
    ctx.globalAlpha=Math.max(0,p.life);
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x,p.y,p.size,p.size);
    // 32-bit: add glow to large particles
    if(p.size>2){
      ctx.globalAlpha=Math.max(0,p.life)*0.3;
      ctx.fillStyle=p.color;
      ctx.fillRect(p.x-1,p.y-1,p.size+2,p.size+2);
    }
  });
  ctx.globalAlpha=1;

  // === ENEMY ‚Äî 32-bit rendered ===
  if(G&&curEnemy){
    const es=ENEMIES32[curEnemy.key];
    if(es){
      const sc=Math.min(2.6,1.15+G.zone*.14);
      const ey=EA.y+Math.sin(EA.bob)*3;
      ctx.save();
      if(EA.dead){
        ctx.globalAlpha=Math.max(0,1-EA.deathT*1.2);
        ctx.translate(EA.x,ey+EA.deathT*28);
        ctx.rotate(EA.deathT*0.4);
      }else{
        ctx.translate(EA.x,ey);
      }
      if(EA.hflash>.3){
        ctx.filter='brightness(5) saturate(0.2) hue-rotate(-10deg)';
      }
      ctx.scale(-sc,sc);
      es.draw(ctx,0,0,1);
      ctx.restore();

      // 32-bit: enemy glow rim
      if(!EA.dead&&EA.hflash<0.3){
        ctx.save();
        ctx.globalAlpha=0.12+0.08*Math.sin(lightPulse*2);
        ctx.filter='blur(6px)';
        ctx.translate(EA.x,ey);
        ctx.scale(-sc*1.05,sc*1.05);
        es.draw(ctx,0,0,1);
        ctx.restore();
      }

      if(!EA.dead){
        // Enemy health bar ‚Äî 32-bit styled
        const ep=eHP/eMaxHP;
        const bw=Math.round(58*sc),bx=EA.x-bw/2+PX*sc,by=ey-10;
        // Bar shadow
        ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(bx-1,by-1,bw+2,7);
        // Bar bg
        ctx.fillStyle='#1a0c08';ctx.fillRect(bx,by,bw,5);
        // Bar fill with gradient
        const barGrad=ctx.createLinearGradient(bx,by,bx+bw,by);
        if(ep>.5){barGrad.addColorStop(0,'#1a6010');barGrad.addColorStop(1,'#40c040');}
        else if(ep>.25){barGrad.addColorStop(0,'#806008');barGrad.addColorStop(1,'#c0a020');}
        else{barGrad.addColorStop(0,'#700808');barGrad.addColorStop(1,'#d82828');}
        ctx.fillStyle=barGrad;ctx.fillRect(bx,by,bw*Math.max(0,ep),5);
        // Bar highlight
        ctx.fillStyle='rgba(255,255,255,0.15)';ctx.fillRect(bx,by,bw*Math.max(0,ep),2);

        // Enemy name
        ctx.font=`bold ${Math.max(6,Math.round(W*.016))}px Cinzel,serif`;
        ctx.textAlign='center';
        ctx.fillStyle='rgba(240,216,120,0.9)';
        ctx.fillText(curEnemy.name,EA.x+PX*1.2*sc,by-4);
        ctx.textAlign='left';
      }
    }
  }

  // === PLAYER ‚Äî 32-bit rendered ===
  if(G){
    const py=PA.y+Math.sin(PA.bob)*3;
    const pal=PAL32[G.cls]||PAL32.warrior;
    const sprFn=SPR32[G.cls]||SPR32.warrior;
    const isAttacking=PA.aflash>0.5;
    const spr=sprFn(pal,isAttacking);

    // 32-bit: player glow shadow
    ctx.save();
    ctx.globalAlpha=0.18+0.06*Math.sin(lightPulse);
    ctx.filter='blur(5px)';
    drawSprite32(ctx,spr,PA.x-1,py+2);
    ctx.restore();

    ctx.save();
    if(PA.hflash>.3)ctx.filter='brightness(3) sepia(1) hue-rotate(280deg)';
    if(PA.aflash>.55)ctx.filter='brightness(2.8) saturate(1.5)';
    drawSprite32(ctx,spr,PA.x,py);
    ctx.restore();

    // Player HP bar
    const st=getStats();
    const php=G.hp/st.maxHp;
    ctx.fillStyle='rgba(0,0,0,0.6)';ctx.fillRect(PA.x-1,py-8,PX*9+2,6);
    ctx.fillStyle='#100808';ctx.fillRect(PA.x,py-7,PX*9,4);
    const pBarGrad=ctx.createLinearGradient(PA.x,py-7,PA.x+PX*9,py-7);
    pBarGrad.addColorStop(0,php>.5?'#1a6010':'#700808');
    pBarGrad.addColorStop(1,php>.5?'#40c040':php>.25?'#c0a020':'#e03030');
    ctx.fillStyle=pBarGrad;ctx.fillRect(PA.x,py-7,PX*9*Math.max(0,php),4);
    ctx.fillStyle='rgba(255,255,255,0.18)';ctx.fillRect(PA.x,py-7,PX*9*Math.max(0,php),1);
  }

    // === Attack projectiles ‚Äî class-specific 32-bit designs ===
  if(PA.aflash>.55){
    const prog=(PA.aflash-.55)*2.2;
    const sx=PA.x+32+prog*55, sy=PA.y+PX*3;
    ctx.save();

    if(G&&G.cls==='warrior'){
      // Tumbling axe ‚Äî a spinning pixel cross that rotates as it flies
      const angle=prog*Math.PI*3;
      ctx.save();
      ctx.translate(sx,sy);ctx.rotate(angle);
      ctx.globalAlpha=prog*.9;
      // Blade faces
      ctx.fillStyle='#c8d8e8';ctx.fillRect(-7,-2,14,4);
      ctx.fillRect(-2,-7,4,14);
      // Edge highlights
      ctx.fillStyle='#ffffff';ctx.fillRect(-7,-2,2,2);ctx.fillRect(5,-2,2,2);
      ctx.fillRect(-2,-7,2,2);ctx.fillRect(-2,5,2,2);
      // Dark spine
      ctx.fillStyle='#405060';ctx.fillRect(-1,-1,2,2);
      // Motion trail ‚Äî fading copies behind
      ctx.restore();
      for(let i=1;i<=3;i++){
        ctx.save();
        ctx.globalAlpha=prog*(0.35-i*0.1);
        ctx.translate(sx-i*14,sy+Math.sin(angle-i*.6)*4);
        ctx.rotate(angle-i*.9);
        ctx.fillStyle='#8ab0c8';ctx.fillRect(-5,-1,10,3);ctx.fillRect(-1,-5,3,10);
        ctx.restore();
      }

    } else if(G&&G.cls==='mage'){
      // Void bolt ‚Äî pulsing purple orb with arcane rune sparks
      ctx.globalAlpha=prog*.95;
      // Outer glow ring
      const orbGrad=ctx.createRadialGradient(sx,sy,0,sx,sy,14);
      orbGrad.addColorStop(0,'rgba(240,180,255,0.95)');
      orbGrad.addColorStop(.35,'rgba(160,80,240,0.8)');
      orbGrad.addColorStop(.7,'rgba(80,20,160,0.4)');
      orbGrad.addColorStop(1,'transparent');
      ctx.fillStyle=orbGrad;
      ctx.beginPath();ctx.arc(sx,sy,14,0,Math.PI*2);ctx.fill();
      // Core pixel orb (3x3 bright center)
      ctx.fillStyle='#ffffff';ctx.fillRect(sx-2,sy-2,4,4);
      ctx.fillStyle='#e0b0ff';ctx.fillRect(sx-4,sy-1,2,2);ctx.fillRect(sx+2,sy-1,2,2);
      ctx.fillRect(sx-1,sy-4,2,2);ctx.fillRect(sx-1,sy+2,2,2);
      // Orbiting spark pixels
      const t2=Date.now()*.008;
      [[1,0],[0,1],[-1,0],[0,-1]].forEach(([ox,oy],i)=>{
        const a=t2+i*Math.PI*.5;
        const px2=sx+Math.cos(a)*9,py2=sy+Math.sin(a)*9;
        ctx.fillStyle=i%2===0?'#c080f0':'#80c0ff';
        ctx.globalAlpha=prog*.7;
        ctx.fillRect(px2-1,py2-1,2,2);
      });
      // Trailing void smear
      for(let i=1;i<=4;i++){
        ctx.globalAlpha=prog*(0.4-i*0.09);
        const tg=ctx.createRadialGradient(sx-i*11,sy,0,sx-i*11,sy,7-i);
        tg.addColorStop(0,'rgba(140,60,220,0.7)');tg.addColorStop(1,'transparent');
        ctx.fillStyle=tg;
        ctx.beginPath();ctx.arc(sx-i*11,sy,7-i,0,Math.PI*2);ctx.fill();
      }

    } else if(G&&G.cls==='rogue'){
      // Twin daggers ‚Äî two offset blades with a poison mist trail
      ctx.globalAlpha=prog*.92;
      const tilt=0.28;
      const drawDagger=(ox,oy,flip)=>{
        ctx.save();ctx.translate(sx+ox,sy+oy);ctx.rotate(flip?-tilt:tilt);ctx.scale(flip?-1:1,1);
        // Blade
        ctx.fillStyle='#d8ecf8';ctx.fillRect(0,-1,12,2);
        // Edge glint
        ctx.fillStyle='#ffffff';ctx.fillRect(10,-1,2,1);
        // Guard
        ctx.fillStyle='#9060c0';ctx.fillRect(-1,-3,2,6);
        // Handle
        ctx.fillStyle='#281828';ctx.fillRect(-5,-1,4,2);
        ctx.fillStyle='#5a3878';ctx.fillRect(-4,-1,1,1);ctx.fillRect(-3,0,1,1);
        ctx.restore();
      };
      drawDagger(0,-5,false);
      drawDagger(0,3,false);
      // Poison mist trail ‚Äî small green-purple pixels
      for(let i=1;i<=5;i++){
        ctx.globalAlpha=prog*(0.45-i*0.08);
        const mx=sx-i*9+Math.sin(i*1.4)*3;
        ctx.fillStyle=i%2===0?'#60d080':'#9040c0';
        ctx.fillRect(mx,-6+i,2,2);
        ctx.fillRect(mx-3,i,2,2);
      }

    } else if(G&&G.cls==='paladin'){
      // Holy hammer ‚Äî chunky pixel maul spinning with divine light burst
      const angle=prog*Math.PI*2.5;
      ctx.save();ctx.translate(sx,sy);ctx.rotate(angle);ctx.globalAlpha=prog*.92;
      // Hammer head ‚Äî chunky gold block
      ctx.fillStyle='#e8c030';ctx.fillRect(-8,-5,16,10);
      // Highlight top face
      ctx.fillStyle='#fff080';ctx.fillRect(-8,-5,16,3);
      // Dark face sides
      ctx.fillStyle='#806010';ctx.fillRect(-8,3,16,2);ctx.fillRect(-8,-5,2,10);
      // Handle
      ctx.fillStyle='#5a3818';ctx.fillRect(-1,5,2,10);
      ctx.fillStyle='#8a5828';ctx.fillRect(-1,5,1,8);
      // Holy cross glow on face
      ctx.fillStyle='rgba(255,248,160,0.8)';ctx.fillRect(-1,-4,2,8);ctx.fillRect(-7,0,14,2);
      ctx.restore();
      // Divine light rays ‚Äî pixel cross pattern radiating out
      ctx.globalAlpha=prog*.5;
      const rayLen=prog*18+8;
      [[1,0],[0,1],[-1,0],[0,-1],[.7,.7],[-.7,.7],[.7,-.7],[-.7,-.7]].forEach(([rx,ry])=>{
        const ex=sx+rx*rayLen,ey=sy+ry*rayLen;
        ctx.strokeStyle='rgba(255,240,100,0.7)';ctx.lineWidth=1.5;
        ctx.beginPath();ctx.moveTo(sx,sy);ctx.lineTo(ex,ey);ctx.stroke();
      });
      // Fading trail copies
      for(let i=1;i<=3;i++){
        ctx.save();ctx.globalAlpha=prog*(0.3-i*0.09);
        ctx.translate(sx-i*13,sy+Math.sin(angle-i)*3);ctx.rotate(angle-i*.7);
        ctx.fillStyle='#c09020';ctx.fillRect(-6,-4,12,8);
        ctx.restore();
      }

    } else if(G&&G.cls==='ranger'){
      // Arrow ‚Äî pixel-perfect with fletching, head, and nature-leaf trail
      ctx.globalAlpha=prog*.93;
      ctx.save();ctx.translate(sx,sy);
      // Shaft
      ctx.fillStyle='#9a6830';ctx.fillRect(-16,0,28,2);
      // Arrowhead ‚Äî diamond pixel cluster
      ctx.fillStyle='#c8dce8';ctx.fillRect(12,-2,4,6);
      ctx.fillStyle='#e8f4ff';ctx.fillRect(14,-1,4,4);
      ctx.fillStyle='#78aac8';ctx.fillRect(12,-2,2,1);ctx.fillRect(12,5,2,1);
      ctx.fillRect(16,-3,2,8);
      // Tip pixel
      ctx.fillStyle='#ffffff';ctx.fillRect(18,0,3,2);
      // Fletching ‚Äî green leaf-style feathers
      ctx.fillStyle='#5aaa30';ctx.fillRect(-16,-4,6,3);ctx.fillRect(-16,3,6,3);
      ctx.fillStyle='#80d050';ctx.fillRect(-14,-4,3,2);ctx.fillRect(-14,4,3,2);
      ctx.fillStyle='#3a7818';ctx.fillRect(-16,-5,2,2);ctx.fillRect(-16,5,2,2);
      ctx.restore();
      // Nature leaf/spark trail
      for(let i=1;i<=5;i++){
        ctx.globalAlpha=prog*(0.5-i*0.09);
        const lx=sx-i*11;
        const ly=sy+Math.sin(i*1.2)*5;
        const leafSize=4-i*.5;
        ctx.fillStyle=i%3===0?'#f0c030':i%3===1?'#60c030':'#30a050';
        ctx.fillRect(lx-leafSize/2,ly-leafSize/2,leafSize,leafSize);
        // Small trailing dots
        ctx.fillStyle='rgba(100,200,60,0.6)';
        ctx.fillRect(lx+2,ly-3,2,2);
      }
    }

    ctx.restore();
  }

  // === Ambient light overlay for depth ===
  const ambientGrad=ctx.createRadialGradient(W*.5,H*.45,0,W*.5,H*.45,W*.6);
  ambientGrad.addColorStop(0,'transparent');
  ambientGrad.addColorStop(1,`rgba(0,0,0,${0.1+0.05*Math.sin(lightPulse*.5)})`);
  ctx.fillStyle=ambientGrad;ctx.fillRect(0,0,W,H);
}

// Color helpers for 32-bit depth
function lighten(hex,amt){
  const r=Math.min(255,parseInt(hex.slice(1,3),16)+amt);
  const g=Math.min(255,parseInt(hex.slice(3,5),16)+amt);
  const b=Math.min(255,parseInt(hex.slice(5,7),16)+amt);
  return`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;
}
function adjustAlpha(hex,a){
  const r=parseInt(hex.slice(1,3),16);
  const g=parseInt(hex.slice(3,5),16);
  const b=parseInt(hex.slice(5,7),16);
  return`rgba(${r},${g},${b},${a})`;
}

function spawnParticles(x,y,col,n=10){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=1.8+Math.random()*3.5;
    const sz=Math.random()<0.3?PX*2:PX;
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2.2,color:col,size:sz,life:1});
  }
}

/* ===============================================
   COMBAT
=============================================== */
let curEnemy=null,eHP=0,eMaxHP=0,atkTimer=null,curseTimer=null,manaTimer=null,vaultTimer=null,atkCount=0;
function spawnEnemy(){const zi=Math.min(G.zone-1,ZONES.length-1);const pool=ZONES[zi].enemies;const key=pool[Math.floor(Math.random()*pool.length)];const base=Math.round(28*Math.pow(1.6,G.zone-1));const ageMult=Math.pow(1.35,G.age-1);eMaxHP=Math.round(base*ageMult*(1+(boonLevel('b9')*0.4)));eHP=eMaxHP;const nl=ENAMES[key];curEnemy={key,name:nl[Math.floor(Math.random()*nl.length)]};EA.dead=false;EA.deathT=0;updateZoneBar();}
function doAttack(){
  if(!G||G.hp<=0)return;initAudio();
  const st=getStats();atkCount++;PA.aflash=1;
  let dmg=st.atk*(0.82+Math.random()*.36);
  const isCrit=Math.random()*100<st.crit;
  if(isCrit)dmg*=2;
  if(G.sk.berserk&&G.hp/st.maxHp<.3)dmg*=1.7;
  if(G.sk.overpower&&atkCount%5===0){dmg*=3;showDmg('OVERPOWER!',true,'special');}
  if(st.spell>0){
    if(G.mana>0){
      const sp=Math.round(st.spell*(.5+Math.random()*.5));
      const manaCost=Math.min(G.mana,Math.round(st.maxMana*0.08));
      G.mana=Math.max(0,G.mana-manaCost);
      const spellMult=G.boons.b12&&Math.random()<.2?1.5:1;
      dmg+=Math.round(sp*spellMult*(0.5+0.5*(G.mana/Math.max(1,st.maxMana))));
    } else {
      // Convert spell to weak physical ‚Äî 40% of normal spell value
      const sp=Math.round(st.spell*(.5+Math.random()*.5));
      dmg+=Math.round(sp*0.4);
      showDmg('NO MANA',false,'dodge');
    }
  }
  if(G.boons.b15){G._cc=(G._cc||0)+1;if(G._cc%10===0&&eHP-Math.round(dmg)<=0){dmg*=6;showDmg('PYRE!',true,'special');}}
  dmg=Math.round(dmg);
  SFX.hit();if(isCrit)SFX.crit();
  spawnParticles(EA.x,EA.y,isCrit?'#f0d020':st.spell>0?'#a050d0':'#d02010',isCrit?18:8);
  eHP=Math.max(0,eHP-dmg);EA.hflash=1;showDmg(dmg,isCrit,'hit');
  if(st.life>0){const h=Math.round(dmg*st.life/100);if(h>0)G.hp=Math.min(st.maxHp,G.hp+h);}
  if(isCrit&&G.sk.flurry){setTimeout(()=>quickHit(),88);setTimeout(()=>quickHit(),176);}
  if(isCrit&&G.boons.b8){setTimeout(()=>quickHit(),80);setTimeout(()=>quickHit(),160);}
  if(G.sk.voidbolt&&Math.random()<.05&&eHP/eMaxHP<.2)eHP=0;
  if(eHP<=0){killEnemy();return;}
    const eDmgRaw=Math.max(1,(4+G.zone*2.5)*Math.pow(1.18,G.zone-1)*Math.pow(1.25,G.age-1));
  // Curse of Ages: Withering ‚Äî enemy regens
  if(G.curses&&G.curses.ca1)eHP=Math.min(eMaxHP,eHP+Math.round(eMaxHP*0.02));
  const st2=getStats();
  const blocked=st2.block>0?eDmgRaw*st2.block/100:0;
  let eDmg=Math.max(0,Math.round(eDmgRaw-st2.def-blocked));
  // Affliction: Blind Fury ‚Äî no dodge/block
  if(!G.curses||!G.curses.af4){
    if(Math.random()*100<st2.dodge){eDmg=0;showDmg(0,false,'dodge');}
  }
  // Affliction: Brittle Bones ‚Äî take 25% more damage
  if(G.curses&&G.curses.af1)eDmg=Math.round(eDmg*1.25);
  if(G.sk&&G.sk.divine&&G.divineReady&&G.hp-eDmg<=0){eDmg=0;G.divineReady=false;showDmg('DIVINE!',false,'dodge');}
  if(eDmg>0){G.hp=Math.max(0,G.hp-eDmg);PA.hflash=1;SFX.hurt();showDmg(eDmg,false,'enemy');spawnParticles(PA.x+PX*4,PA.y+PX*5,'#d02020',5);}
  if(G.hp<=0)die();else updateHUD();
}
function quickHit(){if(!G||!curEnemy)return;const st=getStats();let dmg=Math.round(st.atk*.5);eHP=Math.max(0,eHP-dmg);PA.aflash=.62;if(eHP<=0){killEnemy();return;}showDmg(dmg,false,'hit');SFX.hit();updateHUD();}
function killEnemy(){
  G.kills++;G.zoneKills++;EA.dead=true;EA.deathT=0;SFX.kill();spawnParticles(EA.x,EA.y,'#d4a020',22);
  G.chainKills=(G.chainKills||0)+1;if(G.boons.b17){clearTimeout(G._ct);G._ct=setTimeout(()=>{G.chainKills=0;},5000);}
  let gold=Math.round((6+G.zone*5)*Math.pow(1.45,G.zone-1)*(0.8+Math.random()*.4)*Math.pow(1.2,G.age-1));
  if(boonLevel('b2'))gold=Math.round(gold*(1+0.15*boonLevel('b2')));
  if(boonLevel('b9'))gold=Math.round(gold*(1+0.25*boonLevel('b9')));
  if(G.boons&&G.boons.b11)gold=Math.round(gold*(1+G.prestige*0.12));
  // Affliction: Soul Debt +60% gold
  if(G.curses&&G.curses.af3)gold=Math.round(gold*1.60);
  // Affliction: Brittle Bones +20% gold
  if(G.curses&&G.curses.af1)gold=Math.round(gold*1.20);
  // Skill investment: gold bonus
  if(G.skInvest){const si=SK_INVEST.find(x=>x.id==='si_gold');if(si){const pts=G.skInvest.si_gold||0;if(pts>0)gold=Math.round(gold*(1+si.reward(pts).goldPct/100));}}
  G.gold+=gold;G.gtotal+=gold;SFX.gold();
  let xpg=Math.round(13*Math.pow(1.45,G.zone-1)*Math.pow(1.2,G.age-1));
  if(boonLevel('b3'))xpg=Math.round(xpg*(1+0.25*boonLevel('b3')));
  if(boonLevel('b16')&&G.zone>=4)xpg=Math.round(xpg*(1+0.5*boonLevel('b16')));
  if(G.sk&&G.sk.radiance){gold=Math.round(gold*1.2);xpg=Math.round(xpg*1.2);}
  // Affliction: Soul Debt ‚Äî XP halved
  if(G.curses&&G.curses.af3)xpg=Math.round(xpg*0.5);
  // Affliction: Brittle Bones +20% XP
  if(G.curses&&G.curses.af1)xpg=Math.round(xpg*1.20);
  // Curse of Ages: Death's Toll ‚Äî +100% XP, recover deathToll debt
  if(G.curses&&G.curses.ca3){
    xpg=Math.round(xpg*2);
    if(G.deathTollDebt>0){
      G.deathTollKills=(G.deathTollKills||0)+1;
      if(G.deathTollKills>=50){G.deathTollDebt=Math.max(0,G.deathTollDebt-1);G.deathTollKills=0;}
    }
  }
  // Skill investment: xp bonus
  if(G.skInvest){const si=SK_INVEST.find(x=>x.id==='si_xp');if(si){const pts=G.skInvest.si_xp||0;if(pts>0)xpg=Math.round(xpg*(1+si.reward(pts).xpPct/100));}}
  // Mark of Ruin ‚Äî +SP per zone advance (tracked in zone advance block)
  G.xp+=xpg;
  const st=getStats();if(G.boons.b4)G.hp=st.maxHp;if(G.sk.regen)G.hp=Math.min(st.maxHp,G.hp+Math.round(st.maxHp*G.sk.regen*.02));
  while(G.xp>=G.xpNext){G.xp-=G.xpNext;G.lv++;G.xpNext=xpFor(G.lv);G.sp++;const nst=getStats();G.hp=nst.maxHp;G.divineReady=true;SFX.lvlup();showLvlUp();if(G.lv>=100){G.everReachedLv100=true;saveG();}}
  if(G.zoneKills>=G.zoneTarget){
    G.zoneKills=0;G.zoneTarget=Math.round(G.zoneTarget*1.22);
    if(G.zone>=8){
      G.zone=1;G.age++;
      const agePct=Math.round((Math.pow(1.35,G.age-1)-1)*100);
      toast(`üîÑ Age ${G.age} begins ‚Äî enemies are ${agePct}% stronger!`);
      setStoryTicker(`‚ö† The realm grows darker. Age ${G.age} has begun.`,true);
    } else {
      G.zone++;
      // Sacrifice: Mark of Ruin ‚Äî +3 SP per zone
      if(G.sacrifices&&G.sacrifices.sa3){G.sp+=3;toast('üó∫ Zone advanced! +3 SP (Mark of Ruin)');}
      else toast('üó∫ Entered '+ZONES[G.zone-1].name+'!');
      setStoryTicker(ZONES[G.zone-1].story,true);
    }
    document.getElementById('zone-name-lbl').textContent=ZONES[G.zone-1].name;
    document.getElementById('hud-zone-val').textContent=G.zone;
    checkChapters();
  }
  checkQuests();checkChapters();setTimeout(spawnEnemy,500);updateHUD();
  if(curTab==='quests'||curTab==='story')renderTab();
}
function die(){
  G.deaths++;SFX.die();spawnParticles(PA.x+PX*4,PA.y+PX*5,'#d02020',24);
  if(G.boons.b13&&G.deathBargain){const st=getStats();G.hp=Math.round(st.maxHp*.4);G.deathBargain=false;showDmg('REBORN!',true,'special');setTimeout(()=>{G.deathBargain=true;},60000);spawnEnemy();updateHUD();return;}
  if(G.sk.secondwind&&G._swr!==false){const st=getStats();G.hp=Math.round(st.maxHp*.4);G._swr=false;showDmg('2ND WIND!',true,'dodge');spawnEnemy();updateHUD();return;}
  const st=getStats();G.hp=Math.round(st.maxHp*.5);
  // Curse of Ages: Death's Toll ‚Äî each death permanently reduces max HP
  if(G.curses&&G.curses.ca3){
    const toll=Math.round((CLASSES[G.cls].baseHp+(G.lv-1)*13)*0.05);
    G.deathTollDebt=(G.deathTollDebt||0)+toll;
    G.deathTollKills=0;
    toast(`‚ò† Death's Toll: -${toll} max HP until 50 kills`);
  }
  spawnEnemy();updateHUD();
}
function toggleAuto(){initAudio();G.idle=!G.idle;const b=document.getElementById('btn-auto');b.textContent=G.idle?'AUTO ON':'AUTO OFF';b.className=G.idle?'on':'';b.id='btn-auto';if(G.idle)startIdle();else stopIdle();}
function startIdle(){stopIdle();atkTimer=setInterval(doAttack,atkInterval());if(!manaTimer)manaTimer=setInterval(tickMana,1000);if(!vaultTimer)vaultTimer=setInterval(tickVault,1000);if(!curseTimer)curseTimer=setInterval(tickCurses,1000);}
function stopIdle(){if(atkTimer){clearInterval(atkTimer);atkTimer=null;}}
function tickCurses(){
  if(!G)return;
  // Affliction: Cursed Blood ‚Äî drain 1% HP every 4 seconds
  if(G.curses&&G.curses.af2){
    G._cbTick=(G._cbTick||0)+1;
    if(G._cbTick>=4){
      G._cbTick=0;
      const st=getStats();
      const drain=Math.max(1,Math.round(st.maxHp*0.01));
      G.hp=Math.max(1,G.hp-drain);
      showDmg(drain,false,'enemy');
      updateHUD();
    }
  }
}
function tickMana(){
  if(!G)return;
  const st=getStats();
  if(G.mana>=st.maxMana)return;
  // Regen ~5% of maxMana per second, minimum 1
  const regenMult=1+0.25*(G.boons.b19||0);
  const regen=Math.max(1,Math.round(st.maxMana*0.05*regenMult));
  G.mana=Math.min(st.maxMana,G.mana+regen);
  updateHUD();
}
function tickVault(){
  if(!G)return;
  const ageMult=Math.pow(1.15,(G.age||1)-1);
  let gps=0;
  gps+=(G.boons.b20||0)*250;
  gps+=(G.boons.b21||0)*800;
  gps+=(G.boons.b22||0)*2500;
  gps+=(G.boons.b23||0)*15000*ageMult;
  gps*=G.pbonus;
  if(G.sacrifices&&G.sacrifices.sa1)gps*=1.40;
  gps=Math.round(gps*10)/10;
  if(gps<=0)return;
  G.gold+=gps;G.gtotal+=gps;
  updateHUD();
}
function doAttackTouch(e){e.preventDefault();doAttack();}

/* ===============================================
   HUD
=============================================== */
function fmt(n){return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':String(n);}
function updateHUD(){
  if(!G)return;const st=getStats();
  const hp=Math.max(0,Math.min(100,G.hp/st.maxHp*100));
  const mp=Math.max(0,Math.min(100,G.mana/st.maxMana*100));
  const xp=Math.max(0,Math.min(100,G.xp/G.xpNext*100));
  document.getElementById('b-hp').style.width=hp+'%';document.getElementById('b-mp').style.width=mp+'%';document.getElementById('b-xp').style.width=xp+'%';
  document.getElementById('v-hp').textContent=Math.round(G.hp)+'/'+st.maxHp;document.getElementById('v-mp').textContent=Math.round(G.mana)+'/'+st.maxMana;document.getElementById('v-xp').textContent=G.xp+'/'+G.xpNext;
  document.getElementById('hud-gold-val').textContent=fmt(G.gold);const gpsEl=document.getElementById('hud-gps');if(gpsEl){const ageMult=Math.pow(1.15,(G.age||1)-1);let gps=(G.boons.b20||0)*250+(G.boons.b21||0)*800+(G.boons.b22||0)*2500+(G.boons.b23||0)*15000*ageMult;gps=Math.round(gps*G.pbonus*10)/10;gpsEl.textContent=gps>0?'+'+fmt(Math.round(gps))+'/s':'';}
  document.getElementById('hud-lv-val').textContent=G.lv;document.getElementById('hud-cls-name').textContent=CLASSES[G.cls].name.split(' ')[0];document.getElementById('hud-zone-val').textContent=G.zone;const ageEl=document.getElementById('hud-age-val');if(ageEl)ageEl.textContent=G.age;
  updateZoneBar();const sp=document.getElementById('sp-badge');if(sp)sp.textContent='SP: '+G.sp;
}
function updateZoneBar(){const pct=G?Math.min(100,(G.zoneKills/G.zoneTarget)*100):0;const el=document.getElementById('zone-prog-fill');if(el)el.style.width=pct+'%';}

/* ===============================================
   STORY TICKER
=============================================== */
const TLINES=['The realm holds its breath...','Old bones stir in the dark.','Something watches from the shadows.','Power grows in the ruins of the old kingdom.','Each kill brings you closer to the truth.',"The Ashen King's influence spreads like corruption.",'Whispers speak of a crown that grants dominion over death.','Even the earth here tastes of ancient sorrow.'];
function setStoryTicker(msg,hl=false){
  const el=document.getElementById('story-txt');if(el)el.textContent=msg;
  if(hl){const b=document.getElementById('story-ticker');if(b){b.style.background='linear-gradient(90deg,#120a04,#1c1008,#120a04)';b.style.borderBottomColor='#5c4a1e';setTimeout(()=>{b.style.background='';b.style.borderBottomColor='';},4000);}}
}
let _ti=0;function startTicker(){(function n(){setStoryTicker(TLINES[_ti%TLINES.length]);_ti++;setTimeout(n,8000);})();}

/* ===============================================
   TABS
=============================================== */
let curTab='story',skSub='offense',qFilter='all',boonCat='all';
function openTab(t){
  curTab=t;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));
  const tb=document.getElementById('tb-'+t);if(tb){tb.classList.add('on');const dot=tb.querySelector('.tab-dot');if(dot)dot.remove();}
  renderTab();
}
function renderTab(){
  const el=document.getElementById('tab-body');if(!el)return;
  if(curTab==='story')el.innerHTML=buildStory();
  else if(curTab==='skills')el.innerHTML=buildSkills();
  else if(curTab==='quests')el.innerHTML=buildQuests();
  else if(curTab==='boons')el.innerHTML=buildBoons();
  else if(curTab==='curses')el.innerHTML=buildCurses();
  else if(curTab==='stats')el.innerHTML=buildStats();
}
function notifyTab(t){if(curTab===t)return;const tb=document.getElementById('tb-'+t);if(!tb||tb.querySelector('.tab-dot'))return;const dot=document.createElement('div');dot.className='tab-dot';tb.appendChild(dot);}

/* ===============================================
   STORY TAB
=============================================== */
function chapV(o){if(o.t==='kills')return G.kills;if(o.t==='level')return G.lv;if(o.t==='zone')return G.zone;if(o.t==='gtotal')return G.gtotal;if(o.t==='sktotal')return G.sktotal||0;if(o.t==='prestige')return G.prestige;if(o.t==='boons')return G.boonCount||0;return 0;}
function buildStory(){
  let h='<div class="sec"><div class="sec-hdr">THE ASHEN CHRONICLES</div><div class="story-list">';
  G.chapters.forEach((ch,i)=>{
    const prev=i===0||G.chapters[i-1].done,locked=!prev&&!ch.done,active=!ch.done&&prev;
    const cls='chapter-card'+(ch.done?' complete':locked?' locked':active?' active':'');
    const rew=[ch.rew.g>0&&'üí∞'+ch.rew.g,ch.rew.sp>0&&'‚≠ê'+ch.rew.sp+' SP'].filter(Boolean).join(' ');
    h+=`<div class="${cls}">
      <div class="ch-hdr"><span class="ch-num">Ch.${i+1}</span><span class="ch-ico">${ch.done?'‚úÖ':ch.ico}</span>
        <div class="ch-info"><div class="ch-title">${ch.title}</div><div class="ch-zone">Zone ${ch.zone} ¬∑ ${ZONES[ch.zone-1].name}</div></div>
        ${locked?'<span class="ch-lock">üîí</span>':''}
      </div>
      <div class="ch-body">
        <div class="ch-quote">${ch.quote}</div>
        <div class="ch-desc">${ch.desc}</div>
        <div class="ch-objs">${ch.objs.map(o=>{const v=chapV(o);const pct=Math.min(100,(v/o.tar)*100);const d2=v>=o.tar;return`<div class="ch-obj"><span class="ch-obj-ico">${d2?'‚úÖ':'‚≠ï'}</span><span class="ch-obj-txt">${o.n}</span><div class="ch-obj-bar"><div class="ch-obj-fill" style="width:${pct}%"></div></div><span class="ch-obj-val">${Math.min(v,o.tar).toLocaleString()}/${o.tar.toLocaleString()}</span></div>`;}).join('')}</div>
      </div>
      ${ch.done?'<div class="ch-complete">‚ú¶ CHAPTER COMPLETE</div>':`<div class="ch-rew">üì¶ Reward: ${rew}</div>`}
    </div>`;
  });
  return h+'</div></div>';
}
function checkChapters(){
  G.chapters.forEach((ch,i)=>{
    if(ch.done)return;const prev=i===0||G.chapters[i-1].done;if(!prev)return;
    if(ch.objs.every(o=>chapV(o)>=o.tar)){
      ch.done=true;G.gold+=ch.rew.g;G.gtotal+=ch.rew.g;G.sp+=ch.rew.sp;
      SFX.chapter();toast('üìñ Ch.'+(i+1)+' "'+ch.title+'" complete! +'+ch.rew.sp+'SP');
      setStoryTicker('üìñ Chapter complete: "'+ch.title+'"',true);notifyTab('story');
      if(i+1<G.chapters.length)G.chapters[i+1].unlocked=true;
      if(curTab==='story')renderTab();
    }
  });
}

/* ===============================================
   SKILLS
=============================================== */
function buildSkills(){
  // Show invest tab only at Lv 90+
  const showInvest=G.lv>=90;
  const treeKeys=Object.keys(SKTREES);
  const allTabs=[...treeKeys,...(showInvest?['invest']:[])];
  // Guard: if skSub is 'invest' but not unlocked, reset
  if(skSub==='invest'&&!showInvest)skSub='offense';

  const tabs=allTabs.map(k=>{
    if(k==='invest')return`<div class="sk-tree-tab${skSub==='invest'?' on':''}" onclick="setSkSub('invest')"><span>üìà</span>Invest</div>`;
    const t=SKTREES[k];return`<div class="sk-tree-tab${skSub===k?' on':''}" onclick="setSkSub('${k}')"><span>${t.ico}</span>${t.label}</div>`;
  }).join('');

  let h=`<div class="sec"><div class="sec-hdr">SKILL TREES <span class="sp-badge" id="sp-badge">SP: ${G.sp}</span></div>
    <div class="sk-tree-tabs" style="grid-template-columns:repeat(${allTabs.length},1fr)">${tabs}</div>`;

  if(skSub==='invest'){
    h+=buildInvest();
  } else {
    const tree=SKTREES[skSub];
    h+=`<div class="sk-tier-wrap">`;
    tree.tiers.forEach((tier,ti)=>{
      if(ti>0){h+=tier.length===1?'<div class="sk-connector"></div>':'<div class="sk-connector fork"></div>';}
      h+=`<div class="sk-row sk-row-${Math.min(tier.length,3)}">`;
      tier.forEach(sk=>{
        const cur=G.sk[sk.id]||0,maxed=cur>=sk.max,locked=sk.req&&!(G.sk[sk.req]>=1);
        const cc='sk-card'+(sk.cap?' capstone':'')+(maxed?' maxed':locked?' locked':cur>0?' unlocked':'');
        const pips=Array.from({length:sk.max},(_,i)=>`<div class="pip${i<cur?' '+(cur===sk.max?'onmax':'on'):''}"></div>`).join('');
        const rn=sk.req?allSkList().find(s=>s.id===sk.req)?.name:'';
        h+=`<div class="${cc}" onclick="buySkill('${sk.id}')">
          ${sk.cap?'<div class="sk-cap-tag">CAPSTONE</div>':''}
          <div class="sk-ico">${sk.ico}</div><div class="sk-name">${sk.name}</div>
          <div class="sk-desc">${sk.desc}</div>
          ${locked&&rn?`<div class="sk-req-warn">Req: ${rn}</div>`:''}
          <div class="sk-pips">${pips}</div><div class="sk-rank">${cur}/${sk.max}</div>
        </div>`;
      });
      h+='</div>';
    });
    h+=`</div>`;
  }
  return h+'</div>';
}

function buildInvest(){
  const totalPts=Object.values(G.skInvest||{}).reduce((a,b)=>a+b,0);
  let h=`<div class="sk-invest-intro">
    "Some who have mastered combat choose not to spend their points on new techniques, but to drill endlessly ‚Äî perfecting what they already know. The returns diminish, but they never stop."<br><br>
    <strong style="color:var(--gold)">SP available: ${G.sp}</strong> &nbsp;¬∑&nbsp; Points invested: ${totalPts}
  </div><div class="sk-invest-list">`;

  SK_INVEST.forEach(si=>{
    const pts=G.skInvest[si.id]||0;
    const rew=si.reward(pts);
    const nextRew=pts<si.maxPts?si.reward(pts+1):null;
    const pct=Math.min(100,(pts/si.maxPts)*100);
    const maxed=pts>=si.maxPts;
    const canBuy=G.sp>0&&!maxed;
    h+=`<div class="sk-invest-card${maxed?' maxed':''}">
      <div class="sk-invest-ico">${si.ico}</div>
      <div class="sk-invest-body">
        <div class="sk-invest-name">${si.name}</div>
        <div class="sk-invest-desc">${si.desc}</div>
        <div class="sk-invest-bar-wrap"><div class="sk-invest-bar" style="width:${pct}%"></div></div>
        <div class="sk-invest-prog">${pts} / ${si.maxPts} points</div>
        <div class="sk-invest-rew">Current: ${rew.label}</div>
        ${nextRew&&!maxed?`<div class="sk-invest-diminish">Next point ‚Üí ${nextRew.label}</div>`:''}
        ${maxed?`<div class="sk-invest-rew" style="color:var(--gold)">‚òÖ MAXED</div>`:''}
      </div>
      <button class="btn-invest" onclick="buyInvest('${si.id}')" ${canBuy?'':'disabled'}>+1</button>
    </div>`;
  });

  h+='</div>';

  // === ASHEN MEMORY ‚Äî Bonus Boon at bottom of Invest tab ===
  const memUnlocked = G.everReachedLv100 || (G.ashenMemoryLevel||0) > 0 || G.lv >= 100;
  const memLv = G.ashenMemoryLevel || 0;
  const wastedSince = (G.skInvestWasted||0) - (G.skInvestWastedAtLastMemory||0);
  const wouldReturn = memLv === 0
    ? Math.floor((G.skInvestWasted||0) * 0.5)
    : Math.floor(wastedSince * 0.5);
  const upgCost = memLv === 0 ? 0 : Math.round(8000 * Math.pow(2, memLv - 1));
  const canAfford = upgCost === 0 || G.gold >= upgCost;

  if(memUnlocked){
    h+=`<div style="margin-top:var(--sp-lg);border-top:1px solid #3a2a5a;padding-top:var(--sp-lg)">
      <div style="font-size:var(--fs-xs);color:#7a5aaa;letter-spacing:3px;text-transform:uppercase;margin-bottom:var(--sp-md);text-shadow:0 0 8px rgba(140,80,220,0.4)">
        ‚ú¶ BONUS BOON ‚Äî UNLOCKED AT LEVEL 100
      </div>
      <div class="ashen-memory-card">
        <div class="ashen-memory-header">
          <span class="ashen-memory-ico">üåí</span>
          <div>
            <div class="ashen-memory-title">Ashen Memory</div>
            <div class="ashen-memory-lv">${memLv===0?'NOT YET ACQUIRED':'LEVEL '+memLv}</div>
          </div>
        </div>
        <div class="ashen-memory-desc">"The ashes remember every point you poured into the earth and lost. Once in a while, some of it finds its way back."</div>
        <div class="ashen-memory-effect">
          ${memLv===0
            ? `First unlock returns <strong style="color:#c090f0">50%</strong> of all SP ever spent on skills.<br>That's <strong style="color:#c090f0">${wouldReturn}</strong> SP right now.`
            : `Upgrade returns <strong style="color:#c090f0">50%</strong> of SP spent since last upgrade.<br>That's <strong style="color:#c090f0">${wouldReturn}</strong> SP right now.`
          }
        </div>
        ${upgCost>0?`<div class="ashen-memory-cost">Cost: üí∞${fmt(upgCost)}</div>`:'<div class="ashen-memory-cost">Cost: Free (first unlock)</div>'}
        <button class="btn-ashen-memory" onclick="buyAshenMemory()" ${canAfford?'':'disabled'}>
          ${memLv===0?'üåí UNLOCK ASHEN MEMORY':`üåí UPGRADE ‚Äî Reclaim ${wouldReturn} SP`}
        </button>
      </div>
    </div>`;
  } else {
    h+=`<div style="margin-top:var(--sp-lg);border-top:1px solid #2a1a3a;padding-top:var(--sp-lg)">
      <div class="ashen-memory-card" style="opacity:0.35;pointer-events:none">
        <div class="ashen-memory-header">
          <span class="ashen-memory-ico" style="filter:grayscale(1)">üåí</span>
          <div>
            <div class="ashen-memory-title" style="color:#806090">Ashen Memory</div>
            <div class="ashen-memory-lv">üîí LOCKED UNTIL LEVEL 100</div>
          </div>
        </div>
        <div class="ashen-memory-desc">"Some knowledge can only be earned through true mastery. Return when you have proven yourself."</div>
        <div class="ashen-memory-locked">Reach Level 100 to unlock this boon</div>
      </div>
    </div>`;
  }

  return h;
}

function setSkSub(s){skSub=s;renderTab();}
function buySkill(id){
  initAudio();if(G.sp<=0){toast('No skill points ‚Äî level up!');return;}
  const sk=allSkList().find(s=>s.id===id);if(!sk)return;
  const cur=G.sk[id]||0;if(cur>=sk.max){toast('Already maxed!');return;}
  if(sk.req&&!(G.sk[sk.req]>=1)){toast('Unlock prerequisite first!');return;}
  G.sp--;G.sk[id]=(G.sk[id]||0)+1;G.sktotal=(G.sktotal||0)+1;
  G.spSpentTotal=(G.spSpentTotal||0)+1;
  G.skInvestWasted=(G.skInvestWasted||0)+1; // every SP spent in skills counts as "invested/wasted"
  if(G.sk.secondwind)G._swr=true;if(G.idle)startIdle();SFX.skill();
  checkQuests();checkChapters();renderTab();updateHUD();saveG();
}

function buyInvest(id){
  initAudio();
  if(G.lv<90){toast('Reach level 90 to invest skill points!');return;}
  if(G.sp<=0){toast('No skill points available!');return;}
  const si=SK_INVEST.find(x=>x.id===id);if(!si)return;
  if(!G.skInvest)G.skInvest={};
  const cur=G.skInvest[id]||0;
  if(cur>=si.maxPts){toast('Already maxed!');return;}
  G.sp--;
  G.skInvest[id]=(G.skInvest[id]||0)+1;
  SFX.skill();
  renderTab();updateHUD();saveG();
}

/* ===============================================
   QUESTS
=============================================== */
const QCATS=['all','story','slayer','mastery','wealth','prestige'];
function qVal(q){if(q.type==='kills')return G.kills;if(q.type==='level')return G.lv;if(q.type==='zone')return G.zone;if(q.type==='gtotal')return G.gtotal;if(q.type==='sktotal')return G.sktotal||0;if(q.type==='prestige')return G.prestige;if(q.type==='boons')return G.boonCount||0;return 0;}
function buildQuests(){
  const cats=`<div class="filter-row">${QCATS.map(c=>`<div class="f-btn${qFilter===c?' on':''}" onclick="setQFilter('${c}')">${c[0].toUpperCase()+c.slice(1)}</div>`).join('')}</div>`;
  const items=G.quests.filter(q=>qFilter==='all'||q.cat===qFilter);
  let h=`<div class="sec"><div class="sec-hdr">QUEST LOG</div>${cats}<div class="q-list">`;
  items.forEach(q=>{
    const v=qVal(q),pct=Math.min(100,(v/q.target)*100),active=!q.done&&v>0;
    const rew=[q.rew.g>0&&'üí∞'+q.rew.g,q.rew.sp>0&&'‚≠ê'+q.rew.sp+'SP'].filter(Boolean);
    h+=`<div class="q-card${q.done?' done':active?' in-progress':''}">
      <div class="q-ico">${q.done?'‚úÖ':q.ico}</div>
      <div class="q-body">
        <div class="q-name">${q.name}</div><div class="q-cat">${q.cat}</div>
        <div class="q-desc">${q.desc}</div>
        ${q.done?'<div class="q-done-lbl">‚ú¶ COMPLETE</div>':`<div class="q-bar-wrap"><div class="q-bar" style="width:${pct}%"></div></div><div class="q-prog">${Math.min(v,q.target).toLocaleString()} / ${q.target.toLocaleString()}</div><div class="q-rew">${rew.map(r=>`<span class="q-rew-tag">${r}</span>`).join('')}</div>`}
      </div>
    </div>`;
  });
  return h+'</div></div>';
}
function setQFilter(f){qFilter=f;renderTab();}
function checkQuests(){G.quests.forEach(q=>{if(q.done)return;if(qVal(q)>=q.target){q.done=true;G.gold+=q.rew.g;G.gtotal+=q.rew.g;G.sp+=q.rew.sp;SFX.quest();toast('üìú "'+q.name+'" complete! +'+q.rew.sp+'SP');notifyTab('quests');}});}

/* ===============================================
   BOONS
=============================================== */
const BCATS=['all','combat','survival','wealth','growth'];
function buildBoons(){
  const cats=`<div class="filter-row">${BCATS.map(c=>`<div class="f-btn${boonCat===c?' on':''}" onclick="setBoonCat('${c}')">${c[0].toUpperCase()+c.slice(1)}</div>`).join('')}</div>`;

  // Ashen Memory ‚Äî always shown at top if lv >= 100 or already owns it
  const memBoon=BOONS.find(b=>b.memoryBoon);
  const memLv=G.ashenMemoryLevel||0;
  const memUnlocked=G.everReachedLv100||memLv>0;
  let memSection='';
  if(memUnlocked&&memBoon){
    // Wasted SP since last memory upgrade
    const wastedSince=(G.skInvestWasted||0)-(G.skInvestWastedAtLastMemory||0);
    const wouldReturn=Math.floor(wastedSince*0.5);
    const upgCost=memLv===0?0:Math.round(8000*Math.pow(2,memLv-1));
    const canAfford=memLv===0||G.gold>=upgCost;
    memSection=`<div class="ashen-memory-card">
      <div class="ashen-memory-header">
        <span class="ashen-memory-ico">${memBoon.ico}</span>
        <div>
          <div class="ashen-memory-title">${memBoon.name}</div>
          <div class="ashen-memory-lv">${memLv===0?'NOT YET ACQUIRED':`LEVEL ${memLv}`}</div>
        </div>
      </div>
      <div class="ashen-memory-desc">"The ashes remember every point you poured into the earth and lost. Once in a while, some of it finds its way back."</div>
      <div class="ashen-memory-effect">
        ${memLv===0
          ? `First unlock returns <strong style="color:#c090f0">50%</strong> of all SP ever wasted since the game began.<br>That's <strong style="color:#c090f0">${Math.floor((G.skInvestWasted||0)*0.5)}</strong> SP right now.`
          : `Upgrade returns <strong style="color:#c090f0">50%</strong> of SP wasted since last upgrade.<br>That's <strong style="color:#c090f0">${wouldReturn}</strong> SP right now.`
        }
      </div>
      ${upgCost>0?`<div class="ashen-memory-cost">Cost: üí∞${fmt(upgCost)}</div>`:'<div class="ashen-memory-cost">Cost: Free (first unlock)</div>'}
      <button class="btn-ashen-memory" onclick="buyAshenMemory()" ${canAfford?'':'disabled'}>
        ${memLv===0?'üåí UNLOCK ASHEN MEMORY':`üåí UPGRADE MEMORY ‚Äî Reclaim ${wouldReturn} SP`}
      </button>
    </div>`;
  }

  const sorted=[...BOONS].filter(b=>!b.memoryBoon).sort((a,b)=>({common:0,rare:1,epic:2,legendary:3}[a.rarity])-({common:0,rare:1,epic:2,legendary:3}[b.rarity]));
  const filtered=sorted.filter(b=>boonCat==='all'||b.cat===boonCat);
  let h=`<div class="sec"><div class="sec-hdr">PERMANENT BOONS</div>${memSection}${cats}<div class="boon-list">`;
  filtered.forEach(b=>{
    const lv=boonLevel(b.id);
    const upgCost=boonUpgradeCost(b);
    const cant=G.gold<upgCost;
    const cls='boon-card'+(cant?' cant':' can')+((b.rarity==='epic'||b.rarity==='legendary')?' elite':'');
    h+=`<div class="${cls}" onpointerdown="${cant?'':  `buyBoon('${b.id}')`}">
      <div class="boon-rar ${b.rarity}">${b.rarity}</div>
      <div class="boon-ico">${b.ico}</div>
      <div class="boon-body">
        <div class="boon-name">${b.name}</div>
        <div class="boon-desc">${b.desc}</div>
        <div style="margin-top:4px;display:flex;align-items:center;justify-content:space-between">
          ${lv>0?`<span style="color:var(--txt3);font-size:var(--fs-xs)">Lv ${lv} ‚Üí ${lv+1}</span>`:`<span style="color:var(--txt3);font-size:var(--fs-xs)">Not acquired</span>`}
          <div class="boon-cost">üí∞ ${fmt(upgCost)}</div>
        </div>
      </div>
    </div>`;
  });
  return h+'</div></div>';
}

function setBoonCat(c){boonCat=c;renderTab();}
function buyBoon(id){
  initAudio();
  const b = BOONS.find(x=>x.id===id);
  if(!b) return;
  const lv = boonLevel(id);
  const cost = boonUpgradeCost(b);
  if(G.gold < cost){ toast('Not enough gold!'); return; }
  G.gold -= cost;
  G.boons[id] = lv + 1;
    if(lv === 0) G.boonCount = (G.boonCount||0) + 1;
    // Grant XP for boon purchase ‚Äî scales with boon cost
    const boonXP = Math.round(cost * 0.4);
    G.xp += boonXP;
    while(G.xp >= G.xpNext){ G.xp -= G.xpNext; G.lv++; G.xpNext = xpFor(G.lv); G.sp++; showLvlUp(); }
  SFX.boon();
  if(G.idle) startIdle();
  toast(`‚öó ${b.name} ‚Üí Level ${lv+1}!`);
  renderTab(); updateHUD(); checkQuests(); checkChapters(); saveG();
}

function buyAshenMemory(){
  initAudio();
  if(G.lv<100&&(G.ashenMemoryLevel||0)===0){toast('Reach level 100 to unlock Ashen Memory!');return;}
  const memLv=G.ashenMemoryLevel||0;
  const upgCost=memLv===0?0:Math.round(8000*Math.pow(2,memLv-1));
  if(upgCost>0&&G.gold<upgCost){toast('Not enough gold!');return;}

  // Calculate SP to return
  let returned=0;
  if(memLv===0){
    // First unlock: 50% of all wasted SP since game start
    returned=Math.floor((G.skInvestWasted||0)*0.5);
  } else {
    // Upgrade: 50% of wasted SP since last upgrade
    const wastedSince=(G.skInvestWasted||0)-(G.skInvestWastedAtLastMemory||0);
    returned=Math.floor(wastedSince*0.5);
  }

  if(upgCost>0)G.gold-=upgCost;
  G.ashenMemoryLevel=(G.ashenMemoryLevel||0)+1;
  G.skInvestWastedAtLastMemory=G.skInvestWasted||0;
  G.sp+=returned;

  tone(520,'triangle',.08,.14);tone(780,'triangle',.1,.12,.07);tone(1040,'triangle',.12,.1,.14);
  toast(`üåí Ashen Memory Lv${G.ashenMemoryLevel}! +${returned} SP reclaimed from the void.`);
  if(returned===0)toast('üåí Memory upgraded ‚Äî reclaim SP as you lose more in future prestiges.');
  renderTab();updateHUD();saveG();
}

/* ===============================================
   CURSES TAB
=============================================== */
function buildCurses(){
  const activeCount=[...AFFLICTIONS,...CURSES_OF_AGES].filter(c=>G.curses&&G.curses[c.id]).length;
  const sacCount=SACRIFICES.filter(s=>G.sacrifices&&G.sacrifices[s.id]).length;

  let h=`<div class="sec">
    <div class="sec-hdr" style="color:#e74c3c;border-bottom-color:#4a1a1a;text-shadow:0 0 10px rgba(231,76,60,0.5)">
      ü©∏ CURSES &amp; DARK PACTS
      <span style="font-size:var(--fs-xs);color:#804040;font-weight:400">${activeCount} active</span>
    </div>
    <div class="curse-intro">
      "Power has its price. The realm does not give without taking. These are not choices ‚Äî they are bargains struck in blood, witnessed by things older than gods."
    </div>`;

  // Active curse indicators
  if(activeCount>0||sacCount>0){
    h+=`<div class="curses-summary">
      <span class="curses-summary-lbl">ü©∏ ACTIVE AFFLICTIONS</span>
      <div class="curse-active-hud">`;
    [...AFFLICTIONS,...CURSES_OF_AGES].forEach(c=>{
      if(G.curses&&G.curses[c.id])h+=`<span class="curse-pip">${c.ico} ${c.name}</span>`;
    });
    SACRIFICES.forEach(s=>{
      if(G.sacrifices&&G.sacrifices[s.id])h+=`<span class="curse-pip" style="background:rgba(80,20,80,0.3);border-color:#6b1a6b;color:#c070e0">${s.ico} ${s.name}</span>`;
    });
    h+=`</div></div>`;
  }

  // AFFLICTIONS
  h+=`<div class="curse-section-hdr">‚ö† AFFLICTIONS ‚Äî Toggle On/Off</div>
    <div style="font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#704040;margin-bottom:var(--sp-md)">Passive difficulty increases. Toggle freely ‚Äî bonuses only apply while active.</div>
    <div class="curse-list">`;

  AFFLICTIONS.forEach(c=>{
    const on=G.curses&&G.curses[c.id];
    h+=`<div class="curse-card ${on?'active':'can'}">
      <div class="curse-ico">${c.ico}</div>
      <div class="curse-body">
        <div class="curse-name">${c.name}</div>
        <span class="curse-type-tag affliction">Affliction</span>
        <div class="curse-penalty">‚ö† ${c.penalty}</div>
        <div class="curse-reward">‚ú¶ ${c.reward}</div>
        <button class="btn-curse ${on?'toggle-on':'toggle-off'}" onclick="toggleAffliction('${c.id}')">
          ${on?'ü©∏ ACTIVE ‚Äî Click to Disable':'‚òê Inactive ‚Äî Click to Afflict'}
        </button>
      </div>
    </div>`;
  });
  h+=`</div>`;

  // SACRIFICES
  h+=`<div class="curse-section-hdr" style="margin-top:var(--sp-lg)">üíÄ SACRIFICES ‚Äî Permanent &amp; Irreversible</div>
    <div style="font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#704040;margin-bottom:var(--sp-md)">One-time permanent trades. Cannot be undone. Ever.</div>
    <div class="curse-list">`;

  SACRIFICES.forEach(s=>{
    const done=G.sacrifices&&G.sacrifices[s.id];
    h+=`<div class="curse-card ${done?'sacrifice-done':'can'}">
      <div class="curse-ico">${s.ico}</div>
      <div class="curse-body">
        <div class="curse-name">${s.name}</div>
        <span class="curse-type-tag sacrifice">Sacrifice</span>
        <div class="curse-penalty">‚ö† ${s.penalty}</div>
        <div class="curse-reward">‚ú¶ ${s.reward}</div>
        ${done
          ? `<div class="curse-status done">‚ú¶ SACRIFICE MADE ‚Äî Bonus active forever</div>`
          : `<button class="btn-curse sacrifice-btn" onclick="doSacrifice('${s.id}')">üíú MAKE THE SACRIFICE</button>`
        }
      </div>
    </div>`;
  });
  h+=`</div>`;

  // CURSES OF AGES
  h+=`<div class="curse-section-hdr" style="margin-top:var(--sp-lg)">üåÄ CURSES OF AGES ‚Äî Unlocked at Age 2+</div>
    <div style="font-family:'Crimson Text',serif;font-style:italic;font-size:var(--fs-xs);color:#704040;margin-bottom:var(--sp-md)">Scaling curses that grow stronger the more you embrace. Each active Curse of Ages boosts the Withering bonus.</div>
    <div class="curse-list">`;

  CURSES_OF_AGES.forEach(c=>{
    const on=G.curses&&G.curses[c.id];
    const locked=(G.age||1)<c.ageReq;
    h+=`<div class="curse-card ${locked?'locked':on?'active':'can'}">
      <div class="curse-ico">${c.ico}</div>
      <div class="curse-body">
        <div class="curse-name">${c.name}</div>
        <span class="curse-type-tag age">Curse of Ages</span>
        ${locked?`<div style="font-size:var(--fs-xs);color:#604040;margin-bottom:4px">üîí Requires Age ${c.ageReq}</div>`:''}
        <div class="curse-penalty">‚ö† ${c.penalty}</div>
        <div class="curse-reward">‚ú¶ ${c.reward}</div>
        ${!locked?`<button class="btn-curse ${on?'toggle-on':'toggle-off'}" onclick="toggleAffliction('${c.id}')">
          ${on?'üåÄ ACTIVE ‚Äî Click to Disable':'‚òê Inactive ‚Äî Click to Curse'}
        </button>`:''}
      </div>
    </div>`;
  });
  h+=`</div></div>`;
  return h;
}

function toggleAffliction(id){
  initAudio();
  if(!G.curses)G.curses={};
  const isOn=G.curses[id];
  if(isOn){
    G.curses[id]=false;
    const c=[...AFFLICTIONS,...CURSES_OF_AGES].find(x=>x.id===id);
    toast(`${c?c.ico:'ü©∏'} Curse lifted: ${c?c.name:id}`);
  } else {
    G.curses[id]=true;
    const c=[...AFFLICTIONS,...CURSES_OF_AGES].find(x=>x.id===id);
    toast(`ü©∏ Cursed: ${c?c.name:id}!`);
    // Immediately apply Void Hunger ‚Äî stop mana regen
    if(id==='ca2'&&manaTimer){clearInterval(manaTimer);manaTimer=null;}
    if(id!=='ca2'&&!manaTimer&&!(G.curses&&G.curses.ca2))manaTimer=setInterval(tickMana,1000);
  }
  // Re-evaluate mana timer based on Void Hunger state
  if(G.curses&&G.curses.ca2){if(manaTimer){clearInterval(manaTimer);manaTimer=null;}}
  else{if(!manaTimer)manaTimer=setInterval(tickMana,1000);}
  tone(160,'sawtooth',.08,.12);tone(120,'sawtooth',.14,.09,.06);
  renderTab();updateHUD();saveG();
}

function doSacrifice(id){
  initAudio();
  if(!G.sacrifices)G.sacrifices={};
  if(G.sacrifices[id]){toast('Already sacrificed.');return;}
  const s=SACRIFICES.find(x=>x.id===id);
  if(!s)return;

  // Build warning text
  let warn='‚ö† THIS CANNOT BE UNDONE. EVER.';
  if(id==='sa2')warn+=` You will lose ${fmt(G.gold)} gold.`;
  if(id==='sa3')warn+=` You will lose ${G.sp} skill points.`;
  if(id==='sa4')warn+=` All skill ranks will be wiped.`;
  if(id==='sa1'){const st=getStats();warn+=` Your max HP will drop by ${Math.round(st.maxHp*0.20)}.`;}

  openModal(
    `üíú ${s.name}`,
    s.penalty+' In return: '+s.reward,
    warn,
    ()=>applySacrifice(id),
    true
  );
}

function applySacrifice(id){
  if(!G.sacrifices)G.sacrifices={};
  G.sacrifices[id]=true;
  const s=SACRIFICES.find(x=>x.id===id);
  // Apply immediate penalties
  if(id==='sa1'){const st=getStats();G.hp=Math.min(G.hp,st.maxHp);}
  if(id==='sa2'){toast(`üíÄ ${fmt(G.gold)} gold consumed by the Pact.`);G.gold=0;}
  if(id==='sa3'){toast(`üíÄ ${G.sp} skill points consumed.`);G.sp=0;}
  if(id==='sa4'){
    toast('üíÄ Your skills shatter. Power floods in.');
    G.sk={};G.sktotal=0;
  }
  if(id==='sa2'){G.pbonus=1+(G.prestige*0.05*2);} // double prestige bonus
  tone(80,'sawtooth',.2,.18);tone(60,'sawtooth',.3,.14,.1);tone(40,'sawtooth',.4,.1,.2);
  renderTab();updateHUD();saveG();
}

/* ===============================================
   STATS
=============================================== */
function buildStats(){
  const st=getStats(),gain=Math.max(1,Math.floor(G.lv/5));
  const sr=(l,v)=>`<div class="stat-row"><span class="stat-lbl">${l}</span><span class="stat-val">${v}</span></div>`;
  return`<div class="sec"><div class="sec-hdr">STATISTICS</div>
    <div class="stats-grid">
      <div class="stat-grp">
        <div class="stat-grp-title">‚öî COMBAT</div>
        ${sr('‚öî Attack',st.atk)}${sr('üõ° Defense',st.def)}${sr('‚ö° Speed',st.spd+'√ó')}
        ${sr('üí• Crit %',st.crit+'%')}${sr('üîÆ Spell',st.spell)}${sr('ü©∏ Lifesteal',st.life+'%')}
        ${sr('üë§ Dodge',st.dodge+'%')}${sr('üè∞ Block',st.block+'%')}
      </div>
      <div class="stat-grp">
        <div class="stat-grp-title">üìä LIFETIME</div>
        ${sr('üíÄ Kills',G.kills.toLocaleString())}${sr('üí∞ Gold Earned',G.gtotal.toLocaleString())}${(()=>{const ageMult=Math.pow(1.15,(G.age||1)-1);let gps=(G.boons.b20||0)*250+(G.boons.b21||0)*800+(G.boons.b22||0)*2500+(G.boons.b23||0)*15000*ageMult;gps=Math.round(gps*G.pbonus*10)/10;return gps>0?sr('üí∞ Gold / Sec','+'+fmt(Math.round(gps))+'/s'):'';})()}
        ${sr('üíÄ Deaths',G.deaths)}${sr('‚ú® Prestige',G.prestige)}
        ${sr('‚öó Boons',G.boonCount||0)}${sr('üìà Stat Bonus','+'+Math.round((G.pbonus-1)*100)+'%')}
        ${sr('üìú Quests',G.quests.filter(q=>q.done).length+'/'+G.quests.length)}
        ${sr('üìñ Chapters',G.chapters.filter(c=>c.done).length+'/'+G.chapters.length)}
        ${(()=>{
          const ac=[...AFFLICTIONS,...CURSES_OF_AGES].filter(c=>G.curses&&G.curses[c.id]).length;
          const sc=SACRIFICES.filter(s=>G.sacrifices&&G.sacrifices[s.id]).length;
          return (ac||sc)?sr('ü©∏ Active Curses',ac+' / Sacrifices: '+sc):'';
        })()}
      </div>
    </div>
    <div class="prestige-box">
      <div class="pres-title">‚ú® Prestige Ascension</div>
      <div class="pres-desc">Sacrifice your progress to be reborn with greater power. Earn <strong style="color:var(--gold)">${gain}</strong> prestige point${gain>1?'s':''}, increasing ALL stats by <strong style="color:var(--gold)">${gain*5}%</strong> permanently. Boons are kept.</div>
      <div class="pres-warn">‚ö† Resets: level, gold, skills, zone. 50% of unspent SP carries over</div>
      <button class="btn-prestige" onclick="openPrestige()">‚ú® ASCEND ‚Äî GAIN ${gain} POINT${gain>1?'S':''}</button>
    </div>
  </div>`;
}

/* ===============================================
   PRESTIGE
=============================================== */
function openPrestige(){const gain=Math.max(1,Math.floor(G.lv/5));openModal('‚ú® Prestige Ascension',`Gain ${gain} prestige point${gain>1?'s':''}, permanently increasing all stats by ${gain*5}%.`,'‚ö† Your level, gold, skills, and zone will reset. Boons and 50% of current SP persist.',doPrestige,true);}
function doPrestige(){
  const gain=Math.max(1,Math.floor(G.lv/5));G.prestige+=gain;G.pbonus=1+G.prestige*.05;
    const carryoverSP=Math.floor(G.sp*0.5);
  // SP that didn't carry over counts as wasted
  G.skInvestWasted=(G.skInvestWasted||0)+Math.ceil(G.sp*0.5);
  G.lv=1;G.xp=0;G.xpNext=100;G.sp=carryoverSP;G.sk={};
  G.zone=1;G.zoneKills=0;G.zoneTarget=10;G.gold=0;G.sktotal=0;G.chainKills=0;G.divineReady=true;G._swr=true;
  const st=getStats();G.hp=st.maxHp;G.mana=CLASSES[G.cls].baseMana;
  spawnEnemy();closeModal();checkQuests();checkChapters();SFX.prestige();
  toast('‚ú® Prestige '+G.prestige+'! +'+Math.round((G.pbonus-1)*100)+'% stats! '+carryoverSP+' SP carried over.');
}

/* ===============================================
   DAMAGE NUMBERS
=============================================== */
function showDmg(val,isCrit,type){
  const ov=document.getElementById('arena-ov');if(!ov)return;
  const el=document.createElement('div');
  el.className='dmg-num '+(isCrit?'crit':type==='heal'?'heal':type==='dodge'?'dodge':type==='spell'?'spell':type==='special'?'special':type==='enemy'?'enemy':'hit');
  const W=CV?CV.width:300,H=CV?CV.height:180;const isEn=type==='enemy';
  const bx=isEn?(PA.x+Math.random()*16):(EA.x+Math.random()*16);
  const by=isEn?(PA.y+3):(EA.y-5);
  el.style.left=Math.max(2,Math.min(W-72,bx))+'px';
  el.style.top=Math.max(0,Math.min(H-26,by))+'px';
  el.textContent=type==='dodge'?'DODGE':typeof val==='string'?val:type==='heal'?'+'+val:(isCrit?'‚òÖ':'')+val;
  ov.appendChild(el);setTimeout(()=>el.remove(),880);
}

/* ===============================================
   CLASS SELECT ‚Äî 32-bit sprite preview
=============================================== */
function buildClassCards(){
  const list=document.getElementById('cls-list');if(!list)return;list.innerHTML='';
  Object.entries(CLASSES).forEach(([k,c])=>{
    const card=document.createElement('div');
    card.className='cls-card'+(G.selCls===k?' sel':'');card.id='cls-'+k;card.onclick=()=>pickClass(k);
    const wrap=document.createElement('div');wrap.className='cls-sprite-wrap';
    const cv=document.createElement('canvas');cv.width=80;cv.height=80;
    const cx=cv.getContext('2d');cx.imageSmoothingEnabled=false;
    // Render 32-bit class sprite
    const pal=PAL32[k]||PAL32.warrior;
    const sprFn=SPR32[k]||SPR32.warrior;
    const spr=sprFn(pal);
    const S=1.6;
    spr.forEach((row,ry)=>row.forEach((col,rx)=>{
      if(!col||col==='.')return;
      cx.fillStyle=col;
      cx.fillRect(3+rx*PX*S,3+ry*PX*S,PX*S,PX*S);
    }));
    wrap.appendChild(cv);card.appendChild(wrap);
    card.insertAdjacentHTML('beforeend',`<div class="cls-text">
      <div class="cls-name">${c.icon} ${c.name}</div>
      <div class="cls-flavor">${c.flavor}</div>
      <div class="cls-lore">${c.lore}</div>
      <div class="cls-stats">${c.hints.map(h=>`<span class="cls-stat">${h}</span>`).join('')}</div>
      <div style="margin-top:8px;display:grid;grid-template-columns:1fr 1fr;gap:4px;">
        <span class="cls-stat">‚öî ATK ${c.baseAtk}</span>
        <span class="cls-stat">üõ° DEF ${c.baseDef}</span>
        <span class="cls-stat">‚ù§ HP ${c.baseHp}</span>
        <span class="cls-stat">‚ú¶ MP ${c.baseMana}</span>
        <span class="cls-stat">‚ö° SPD ${c.baseSpd}√ó</span>
        <span class="cls-stat">üí• CRIT ${c.baseCrit}%</span>
        ${c.baseSpell>0?`<span class="cls-stat" style="grid-column:1/-1">üîÆ SPELL ${c.baseSpell}</span>`:''}
      </div>
    </div>`);
    list.appendChild(card);
  });
}
function pickClass(k){
  G.selCls=k;G.cls=k;
  document.querySelectorAll('.cls-card').forEach(c=>c.classList.remove('sel'));
  document.getElementById('cls-'+k)?.classList.add('sel');
  document.getElementById('cls-go-btn').disabled=false;
  const st=getStats();G.hp=st.maxHp;G.maxHp=st.maxHp;G.mana=CLASSES[k].baseMana;G.maxMana=G.mana;
}
function confirmClass(){
  if(!G.selCls)return;
  document.getElementById('hud-av').textContent=CLASSES[G.cls].icon;
  showScr('s2');initCanvas();spawnEnemy();updateHUD();openTab('story');renderTab();
  setStoryTicker('Your legend begins in the Ashen Fields.',true);startBGM();if(G.idle)startIdle();setInterval(saveG,30000);if(!manaTimer)manaTimer=setInterval(tickMana,1000);if(!vaultTimer)vaultTimer=setInterval(tickVault,1000);
}

/* ===============================================
   MODAL
=============================================== */
function openModal(title,body,warn,cb,sc=true){
  document.getElementById('modal-title').textContent=title;document.getElementById('modal-body').textContent=body;document.getElementById('modal-warn').textContent=warn||'';
  document.getElementById('modal-ok').onclick=()=>{if(cb){cb();closeModal();}else closeModal();};
  document.querySelectorAll('.m-btn.cancel').forEach(b=>b.style.display=sc?'':'none');
  document.getElementById('modal').classList.add('open');
}
function closeModal(){document.getElementById('modal').classList.remove('open');}

/* ===============================================
   SCREEN FLOW
=============================================== */
function showScr(id){document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));document.getElementById(id)?.classList.add('on');}
function gotoClassSelect(){
  initAudio();const had=loadG();
  if(had&&G.selCls){
    document.getElementById('hud-av').textContent=CLASSES[G.cls].icon;
    showScr('s2');initCanvas();spawnEnemy();updateHUD();openTab('story');renderTab();
    setStoryTicker(ZONES[Math.min(G.zone-1,ZONES.length-1)].story);startBGM();if(G.idle)startIdle();setInterval(saveG,30000);if(!manaTimer)manaTimer=setInterval(tickMana,1000);if(!vaultTimer)vaultTimer=setInterval(tickVault,1000);
      if(G._offlineRecap){
        const r=G._offlineRecap;delete G._offlineRecap;
        const hrs=Math.floor(r.seconds/3600),mins=Math.floor((r.seconds%3600)/60);
        const timeStr=hrs>0?`${hrs}h ${mins}m`:`${mins}m`;
        const parts=[`+${fmt(r.gold)}üí∞`,`+${r.kills} kills`];
        if(r.levels>0)parts.push(`+${r.levels} levels`);
        if(r.sp>0)parts.push(`+${r.sp} SP`);
        if(r.ageAdv>0)parts.push(`+${r.ageAdv} ages`);
        else if(r.zoneAdv>0)parts.push(`+${r.zoneAdv} zones`);
        setTimeout(()=>toast(`‚è≥ Away ${timeStr}: ${parts.join(' ¬∑ ')}`),800);
      }
  }else{G=mkState();buildClassCards();showScr('s1');}
}

/* ===============================================
   TOAST & LEVEL UP
=============================================== */
let toastT;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3200);}
let lvlT;
function showLvlUp(){
  const el=document.getElementById('lvlup');
  document.getElementById('lvlup-txt').textContent='LEVEL '+G.lv+'!';
  el.classList.add('show');clearTimeout(lvlT);lvlT=setTimeout(()=>el.classList.remove('show'),1800);
}

/* ===============================================
   TITLE FX ‚Äî 32-bit enhanced ember particles
=============================================== */
function titleFX() {
  const cv = document.getElementById('s0-cv');
  function resize() { cv.width = window.innerWidth; cv.height = window.innerHeight; }
  resize();
  const ctx = cv.getContext('2d');
  window.addEventListener('resize', resize);

  // More varied ember system for 32-bit feel
  const embers=Array.from({length:80},()=>({
    x:Math.random()*cv.width,
    y:cv.height+Math.random()*100,
    spd:.6+Math.random()*2.5,
    sz:1+Math.random()*2.2,
    drift:(Math.random()-.5)*.65,
    life:0,
    maxLife:.4+Math.random()*.9,
    hue:Math.random()<0.7?0:30, // red or orange
  }));

  // Distant castle silhouette for atmospheric depth
  function drawCastle(){
    const bh=cv.height;const bw=cv.width;
    ctx.fillStyle='rgba(8,4,2,0.7)';
    // Main keep
    ctx.fillRect(bw*.38,bh*.42,bw*.24,bh*.45);
    // Towers
    ctx.fillRect(bw*.34,bh*.36,bw*.06,bh*.51);
    ctx.fillRect(bw*.60,bh*.36,bw*.06,bh*.51);
    // Battlements
    for(let i=0;i<4;i++){ctx.fillRect(bw*.34+i*bw*.008,bh*.34,bw*.006,bh*.024);}
    for(let i=0;i<4;i++){ctx.fillRect(bw*.60+i*bw*.008,bh*.34,bw*.006,bh*.024);}
    for(let i=0;i<6;i++){ctx.fillRect(bw*.38+i*bw*.014,bh*.40,bw*.009,bh*.022);}
    // Gate
    ctx.fillStyle='rgba(180,40,8,0.08)';
    ctx.fillRect(bw*.47,bh*.64,bw*.06,bh*.23);
  }

  function fr(){
    ctx.clearRect(0,0,cv.width,cv.height);
    // Background glow layers
    const g1=ctx.createRadialGradient(cv.width/2,cv.height*.72,0,cv.width/2,cv.height*.72,cv.width*.65);
    g1.addColorStop(0,'rgba(140,40,8,0.28)');g1.addColorStop(.4,'rgba(80,16,4,0.12)');g1.addColorStop(1,'transparent');
    ctx.fillStyle=g1;ctx.fillRect(0,0,cv.width,cv.height);
    // Castle silhouette
    drawCastle();
    // Embers
    embers.forEach(e=>{
      e.y-=e.spd;e.x+=e.drift;e.life+=.018;
      if(e.y<-10||e.life>e.maxLife){e.y=cv.height+12;e.x=Math.random()*cv.width;e.life=0;}
      const a=Math.sin(e.life/e.maxLife*Math.PI);
      ctx.globalAlpha=a*.78;
      // 32-bit: ember glow
      ctx.shadowBlur=e.sz*4;ctx.shadowColor=e.hue===0?'#ff4010':'#ff8010';
      ctx.fillStyle=e.life<e.maxLife*.5?'#e07018':'#c02808';
      ctx.fillRect(e.x,e.y,e.sz,e.sz);
    });
    ctx.shadowBlur=0;ctx.globalAlpha=1;
    requestAnimationFrame(fr);
  }
  fr();
}
   
window.addEventListener('load',()=>{titleFX();});
</script>

</body>
</html>
