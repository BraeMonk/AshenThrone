<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ashen Throne</title>
<link href="https://fonts.googleapis.com/css2?family=MedievalSharp&family=IM+Fell+English:ital@0;1&family=Cinzel:wght@400;600;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none}
:root{
  --parchment:#1a1208;
  --parchment2:#221a0e;
  --parchment3:#2a2010;
  --gold:#d4a017;
  --gold2:#f0c030;
  --gold3:#8a6010;
  --ember:#c84820;
  --ember2:#e06030;
  --stone:#3a3428;
  --stone2:#4a4438;
  --green:#2a5a1a;
  --green2:#50a030;
  --blue:#1a2a5a;
  --blue2:#3060c0;
  --purple:#3a1a5a;
  --purple2:#8040c0;
  --text:#e8d8a8;
  --text2:#b09060;
  --text3:#786040;
  --hp:#c02020;
  --hp2:#e04040;
  --mana:#2040c0;
  --xp:#208040;
  --shadow:rgba(0,0,0,0.8);
}
html,body{width:100%;height:100%;overflow:hidden;background:#000;font-family:'IM Fell English',Georgia,serif}

/* ===== SCREENS ===== */
#game{width:100%;height:100%;position:relative;overflow:hidden;background:var(â€“parchment)}

/* Grain overlay */
#game::after{content:â€™â€™;position:fixed;inset:0;opacity:.04;pointer-events:none;z-index:9999;
background-image:url(â€œdata:image/svg+xml,%3Csvg viewBox=â€˜0 0 256 256â€™ xmlns=â€˜http://www.w3.org/2000/svgâ€™%3E%3Cfilter id=â€˜noiseâ€™%3E%3CfeTurbulence type=â€˜fractalNoiseâ€™ baseFrequency=â€˜0.9â€™ numOctaves=â€˜4â€™ stitchTiles=â€˜stitchâ€™/%3E%3C/filter%3E%3Crect width=â€˜100%25â€™ height=â€˜100%25â€™ filter=â€˜url(%23noise)â€™/%3E%3C/svg%3Eâ€);
background-repeat:repeat;background-size:128px}

/* ===== CANVAS AREA ===== */
#arena-wrap{position:relative;width:100%;height:220px;overflow:hidden;flex-shrink:0}
#arena{width:100%;height:100%;display:block}

/* ===== SCREENS ===== */
.screen{position:absolute;inset:0;display:none;flex-direction:column}
.screen.active{display:flex}

/* ===== TITLE SCREEN ===== */
#screen-title{
background:radial-gradient(ellipse at 50% 30%, #2a1a08 0%, #0a0800 70%);
align-items:center;justify-content:center;gap:0;
}
.title-bg{position:absolute;inset:0;overflow:hidden}
.title-bg canvas{width:100%;height:100%}
.title-content{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;gap:16px;padding:20px}
.game-logo{font-family:â€˜Cinzelâ€™,serif;font-size:3rem;font-weight:900;color:var(â€“gold2);
text-shadow:0 0 40px rgba(212,160,23,0.8),0 4px 8px #000,0 0 80px rgba(200,72,32,0.4);
letter-spacing:4px;line-height:1;text-align:center}
.game-subtitle{font-family:â€˜Cinzelâ€™,serif;font-size:.85rem;color:var(â€“text2);letter-spacing:8px;text-transform:uppercase}
.title-divider{width:200px;height:1px;background:linear-gradient(90deg,transparent,var(â€“gold3),transparent);margin:8px 0}
.ember-particle{position:absolute;width:2px;border-radius:50%;animation:rise linear infinite;opacity:0}
@keyframes rise{0%{transform:translateY(0) translateX(0);opacity:1}100%{transform:translateY(-100vh) translateX(var(â€“drift));opacity:0}}
.btn-title{
font-family:â€˜Cinzelâ€™,serif;font-size:1.1rem;color:var(â€“parchment);
background:linear-gradient(180deg,var(â€“gold2),var(â€“gold3));
border:none;border-radius:3px;padding:14px 48px;cursor:pointer;
box-shadow:0 4px 12px rgba(0,0,0,0.6),inset 0 1px 0 rgba(255,255,255,0.2);
transition:all .2s;letter-spacing:2px;
}
.btn-title:active{transform:scale(0.97);box-shadow:0 2px 6px rgba(0,0,0,0.6)}

/* ===== CLASS SELECT ===== */
#screen-class{background:var(â€“parchment);padding:16px;gap:12px;overflow-y:auto}
.screen-header{font-family:â€˜Cinzelâ€™,serif;font-size:1.1rem;color:var(â€“gold);text-align:center;letter-spacing:3px;
padding-bottom:10px;border-bottom:1px solid var(â€“stone)}
.class-cards{display:flex;flex-direction:column;gap:10px}
.class-card{
background:var(â€“parchment2);border:2px solid var(â€“stone);border-radius:6px;
padding:14px;display:flex;align-items:center;gap:14px;cursor:pointer;
transition:all .2s;position:relative;overflow:hidden;
}
.class-card::before{content:â€™â€™;position:absolute;inset:0;opacity:0;transition:opacity .2s;
background:linear-gradient(135deg,rgba(212,160,23,0.1),transparent)}
.class-card:active,.class-card.selected{border-color:var(â€“gold);background:var(â€“parchment3)}
.class-card:active::before,.class-card.selected::before{opacity:1}
.class-sprite{width:64px;height:64px;flex-shrink:0}
.class-sprite canvas{width:64px;height:64px;image-rendering:pixelated}
.class-info{flex:1}
.class-name{font-family:â€˜Cinzelâ€™,serif;font-size:1rem;color:var(â€“gold2);margin-bottom:4px}
.class-flavor{font-style:italic;font-size:.8rem;color:var(â€“text2);line-height:1.4;margin-bottom:8px}
.class-stats-row{display:flex;gap:8px;flex-wrap:wrap}
.cstat{font-size:.75rem;color:var(â€“text3);display:flex;align-items:center;gap:3px}
.cstat b{color:var(â€“text)}

/* ===== MAIN GAME ===== */
#screen-game{background:var(â€“parchment);flex-direction:column;height:100%}

/* Top HUD */
#hud-top{
background:linear-gradient(180deg,rgba(0,0,0,0.7),rgba(0,0,0,0.3));
padding:8px 10px 6px;display:flex;align-items:center;gap:8px;flex-shrink:0;
border-bottom:1px solid var(â€“stone);
}
.hud-avatar{width:36px;height:36px;border:2px solid var(â€“gold3);border-radius:50%;
background:var(â€“parchment2);display:flex;align-items:center;justify-content:center;
font-size:1.2rem;flex-shrink:0}
.hud-bars{flex:1;display:flex;flex-direction:column;gap:3px}
.hud-bar-row{display:flex;align-items:center;gap:6px}
.hud-bar{flex:1;height:7px;background:rgba(0,0,0,0.5);border-radius:3px;overflow:hidden;border:1px solid rgba(255,255,255,0.1)}
.hud-bar-fill{height:100%;border-radius:3px;transition:width .3s}
.bar-hp .hud-bar-fill{background:linear-gradient(90deg,#801010,var(â€“hp2));box-shadow:0 0 6px rgba(224,64,64,0.4)}
.bar-mana .hud-bar-fill{background:linear-gradient(90deg,#102080,var(â€“blue2));box-shadow:0 0 6px rgba(48,96,192,0.4)}
.bar-xp .hud-bar-fill{background:linear-gradient(90deg,#106030,var(â€“xp));box-shadow:0 0 6px rgba(32,128,64,0.4)}
.hud-bar-label{font-size:.65rem;color:var(â€“text3);width:18px;text-align:right;flex-shrink:0}
.hud-right{display:flex;flex-direction:column;align-items:flex-end;gap:2px}
.hud-gold{font-family:â€˜Cinzelâ€™,serif;font-size:.8rem;color:var(â€“gold);display:flex;align-items:center;gap:3px}
.hud-level{font-family:â€˜Cinzelâ€™,serif;font-size:.75rem;color:var(â€“text2)}
.hud-zone-badge{font-size:.65rem;color:var(â€“ember2);background:rgba(200,72,32,0.15);
border:1px solid var(â€“ember);border-radius:3px;padding:1px 5px}

/* Arena */
#arena-section{position:relative;flex-shrink:0}
#arena-wrap{height:200px}

/* Combat overlay */
#combat-overlay{position:absolute;inset:0;pointer-events:none;z-index:10}
.damage-number{position:absolute;font-family:â€˜Cinzelâ€™,serif;font-size:1.1rem;font-weight:600;
pointer-events:none;animation:floatDmg .8s forwards;white-space:nowrap}
.damage-number.crit{font-size:1.4rem;color:var(â€“gold2)}
.damage-number.hit{color:var(â€“hp2)}
.damage-number.heal{color:var(â€“green2)}
.damage-number.enemy{color:var(â€“ember2)}
@keyframes floatDmg{0%{opacity:1;transform:translateY(0)}100%{opacity:0;transform:translateY(-60px)}}

/* Attack button */
#attack-btn-wrap{position:absolute;bottom:10px;right:10px;z-index:20}
#attack-btn{
width:64px;height:64px;border-radius:50%;
background:radial-gradient(circle at 40% 35%,var(â€“ember2),var(â€“ember));
border:3px solid var(â€“gold3);cursor:pointer;
box-shadow:0 4px 16px rgba(200,72,32,0.6),inset 0 1px 0 rgba(255,255,255,0.2);
display:flex;align-items:center;justify-content:center;font-size:1.6rem;
transition:all .1s;
}
#attack-btn:active{transform:scale(0.9);box-shadow:0 2px 8px rgba(200,72,32,0.4)}

/* Auto toggle */
#auto-btn{
position:absolute;bottom:10px;left:10px;z-index:20;
background:rgba(0,0,0,0.6);border:2px solid var(â€“stone2);border-radius:20px;
color:var(â€“text2);font-family:â€˜Cinzelâ€™,serif;font-size:.65rem;letter-spacing:1px;
padding:5px 10px;cursor:pointer;transition:all .2s;
}
#auto-btn.on{border-color:var(â€“green2);color:var(â€“green2);box-shadow:0 0 10px rgba(80,160,48,0.3)}

/* Zone advance */
#zone-btn{
position:absolute;bottom:10px;left:50%;transform:translateX(-50%);z-index:20;
background:rgba(0,0,0,0.6);border:2px solid var(â€“gold3);border-radius:20px;
color:var(â€“gold);font-family:â€˜Cinzelâ€™,serif;font-size:.65rem;letter-spacing:1px;
padding:5px 14px;cursor:pointer;transition:all .2s;
}

/* Bottom tabs */
#tabs{display:flex;background:var(â€“parchment2);border-top:1px solid var(â€“stone);border-bottom:1px solid var(â€“stone);flex-shrink:0}
.tab{flex:1;padding:8px 4px;text-align:center;cursor:pointer;transition:all .2s;
display:flex;flex-direction:column;align-items:center;gap:2px;
border-right:1px solid var(â€“stone);font-size:1.2rem}
.tab:last-child{border-right:none}
.tab-label{font-size:.55rem;color:var(â€“text3);letter-spacing:1px;text-transform:uppercase}
.tab.active{background:var(â€“parchment3);border-bottom:2px solid var(â€“gold)}
.tab.active .tab-label{color:var(â€“gold)}

/* Tab content */
#tab-content{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch}
#tab-content::-webkit-scrollbar{width:3px}
#tab-content::-webkit-scrollbar-thumb{background:var(â€“stone2)}

/* ===== SKILLS TAB ===== */
.skill-section{padding:10px}
.skill-tree-header{display:flex;align-items:center;gap:8px;margin-bottom:10px}
.skill-tree-title{font-family:â€˜Cinzelâ€™,serif;font-size:.85rem;color:var(â€“gold);letter-spacing:2px}
.sp-badge{background:var(â€“parchment3);border:1px solid var(â€“gold3);border-radius:12px;
padding:3px 10px;font-family:â€˜Cinzelâ€™,serif;font-size:.8rem;color:var(â€“gold2);margin-left:auto}

.skill-tab-bar{display:flex;gap:4px;padding:0 10px;margin-bottom:8px}
.stab{flex:1;padding:6px;text-align:center;background:var(â€“parchment2);border:1px solid var(â€“stone);
border-radius:4px;font-size:.7rem;color:var(â€“text3);cursor:pointer;letter-spacing:1px;font-family:â€˜Cinzelâ€™,serif;transition:all .2s}
.stab.active{background:var(â€“parchment3);border-color:var(â€“gold);color:var(â€“gold)}

.skill-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;padding:0 10px 10px}
.skill-node{
background:var(â€“parchment2);border:2px solid var(â€“stone);border-radius:6px;
padding:10px;cursor:pointer;transition:all .2s;position:relative;overflow:hidden;
display:flex;flex-direction:column;align-items:center;gap:6px;text-align:center;
}
.skill-node::after{content:â€™â€™;position:absolute;inset:0;background:linear-gradient(135deg,rgba(255,255,255,0.03),transparent);pointer-events:none}
.skill-node:active:not(.locked){transform:scale(0.97)}
.skill-node.unlocked{border-color:var(â€“gold3)}
.skill-node.maxed{border-color:var(â€“gold2);background:rgba(212,160,23,0.1)}
.skill-node.locked{opacity:.4;cursor:not-allowed}
.skill-icon-wrap{width:44px;height:44px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.4rem;
background:var(â€“parchment3);border:2px solid var(â€“stone2);transition:all .2s}
.skill-node.unlocked .skill-icon-wrap{border-color:var(â€“gold3);box-shadow:0 0 10px rgba(212,160,23,0.2)}
.skill-node.maxed .skill-icon-wrap{border-color:var(â€“gold2);box-shadow:0 0 14px rgba(212,160,23,0.4)}
.skill-node-name{font-family:â€˜Cinzelâ€™,serif;font-size:.7rem;color:var(â€“text);letter-spacing:.5px}
.skill-node-desc{font-size:.65rem;color:var(â€“text3);font-style:italic;line-height:1.3}
.skill-node-level{font-size:.65rem;color:var(â€“gold);font-family:â€˜Cinzelâ€™,serif}
.skill-lock-icon{position:absolute;top:4px;right:4px;font-size:.7rem;opacity:.6}
.skill-pips{display:flex;gap:2px;margin-top:2px}
.pip{width:8px;height:4px;border-radius:2px;background:var(â€“stone2);transition:background .2s}
.pip.filled{background:var(â€“gold)}
.pip.filled.max{background:var(â€“gold2)}

/* ===== QUESTS TAB ===== */
.quest-section{padding:10px;display:flex;flex-direction:column;gap:8px}
.quest-card{
background:var(â€“parchment2);border:1px solid var(â€“stone);border-radius:6px;
padding:12px;display:flex;gap:12px;align-items:flex-start;
}
.quest-card.done{border-color:var(â€“gold3);background:rgba(212,160,23,0.06)}
.quest-icon-wrap{width:42px;height:42px;border-radius:50%;background:var(â€“parchment3);
border:2px solid var(â€“stone2);display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
.quest-card.done .quest-icon-wrap{border-color:var(â€“gold3)}
.quest-body{flex:1}
.quest-name{font-family:â€˜Cinzelâ€™,serif;font-size:.8rem;color:var(â€“text);margin-bottom:3px}
.quest-desc{font-size:.7rem;color:var(â€“text3);font-style:italic;margin-bottom:6px}
.quest-prog-bar{height:5px;background:var(â€“stone);border-radius:3px;overflow:hidden;margin-bottom:4px}
.quest-prog-fill{height:100%;background:linear-gradient(90deg,var(â€“gold3),var(â€“gold));border-radius:3px;transition:width .4s}
.quest-prog-text{font-size:.65rem;color:var(â€“text3)}
.quest-reward{font-size:.7rem;color:var(â€“gold);margin-top:4px}
.quest-complete-badge{font-size:.65rem;color:var(â€“gold2);font-family:â€˜Cinzelâ€™,serif;letter-spacing:1px}

/* ===== BOONS TAB ===== */
.boons-section{padding:10px;display:flex;flex-direction:column;gap:8px}
.boon-card{
background:var(â€“parchment2);border:1px solid var(â€“stone);border-radius:6px;
padding:12px;display:flex;gap:12px;align-items:center;cursor:pointer;transition:all .2s;
}
.boon-card.owned{border-color:var(â€“green2);background:rgba(42,90,26,0.12);cursor:default}
.boon-card.cant-afford{opacity:.5;cursor:not-allowed}
.boon-card:not(.owned):not(.cant-afford):active{transform:scale(0.98)}
.boon-icon{width:44px;height:44px;border-radius:8px;background:var(â€“parchment3);
border:2px solid var(â€“stone2);display:flex;align-items:center;justify-content:center;font-size:1.5rem;flex-shrink:0}
.boon-card.owned .boon-icon{border-color:var(â€“green2)}
.boon-body{flex:1}
.boon-name{font-family:â€˜Cinzelâ€™,serif;font-size:.8rem;color:var(â€“text);margin-bottom:3px}
.boon-desc{font-size:.7rem;color:var(â€“text3);font-style:italic}
.boon-cost{font-size:.75rem;color:var(â€“gold);margin-top:4px;font-family:â€˜Cinzelâ€™,serif}
.boon-owned{font-size:.7rem;color:var(â€“green2);margin-top:4px}

/* ===== STATS TAB ===== */
.stats-section{padding:10px;display:flex;flex-direction:column;gap:8px}
.stat-group{background:var(â€“parchment2);border:1px solid var(â€“stone);border-radius:6px;padding:12px}
.stat-group-title{font-family:â€˜Cinzelâ€™,serif;font-size:.75rem;color:var(â€“gold);letter-spacing:2px;
margin-bottom:10px;padding-bottom:6px;border-bottom:1px solid var(â€“stone)}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:4px 0;
border-bottom:1px solid rgba(58,52,40,0.4)}
.stat-row:last-child{border-bottom:none}
.stat-label{font-size:.75rem;color:var(â€“text3);display:flex;align-items:center;gap:5px}
.stat-val{font-size:.8rem;color:var(â€“gold2);font-family:â€˜Cinzelâ€™,serif}
.prestige-section{background:var(â€“parchment2);border:1px solid var(â€“stone);border-radius:6px;padding:12px}
.prestige-title{font-family:â€˜Cinzelâ€™,serif;font-size:.85rem;color:var(â€“gold2);margin-bottom:8px}
.prestige-desc{font-size:.75rem;color:var(â€“text3);font-style:italic;line-height:1.5;margin-bottom:12px}
.btn-prestige{
width:100%;padding:12px;background:linear-gradient(180deg,rgba(138,96,16,0.4),rgba(58,52,40,0.6));
border:2px solid var(â€“gold3);border-radius:5px;color:var(â€“gold);font-family:â€˜Cinzelâ€™,serif;
font-size:.85rem;letter-spacing:2px;cursor:pointer;transition:all .2s;
}
.btn-prestige:active{transform:scale(0.98)}

/* ===== NOTIFICATIONS ===== */
#toast{
position:fixed;top:16px;left:50%;transform:translateX(-50%) translateY(-80px);
background:var(â€“parchment2);border:1px solid var(â€“gold3);border-radius:6px;
padding:10px 16px;font-family:â€˜Cinzelâ€™,serif;font-size:.75rem;color:var(â€“gold);
transition:transform .3s cubic-bezier(.34,1.56,.64,1);z-index:1000;
box-shadow:0 4px 16px rgba(0,0,0,0.6);white-space:nowrap;letter-spacing:1px;
}
#toast.show{transform:translateX(-50%) translateY(0)}

/* ===== LEVEL UP SPLASH ===== */
#levelup-splash{
position:fixed;inset:0;z-index:500;pointer-events:none;
display:flex;align-items:center;justify-content:center;
opacity:0;transition:opacity .3s;
}
#levelup-splash.show{opacity:1}
.levelup-text{
font-family:â€˜Cinzelâ€™,serif;font-size:2rem;font-weight:900;color:var(â€“gold2);
text-shadow:0 0 30px var(â€“gold),0 0 60px var(â€“gold2),0 4px 8px #000;
animation:levelPop .8s forwards;
}
@keyframes levelPop{0%{transform:scale(0.5);opacity:0}50%{transform:scale(1.1)}70%{transform:scale(0.95)}100%{transform:scale(1);opacity:1}}

/* ===== CONFIRM MODAL ===== */
#modal{
position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:800;
display:none;align-items:center;justify-content:center;padding:20px;
}
#modal.open{display:flex}
.modal-box{background:var(â€“parchment2);border:2px solid var(â€“gold3);border-radius:8px;
padding:24px;max-width:320px;width:100%;text-align:center}
.modal-title{font-family:â€˜Cinzelâ€™,serif;font-size:1.1rem;color:var(â€“gold2);margin-bottom:8px}
.modal-desc{font-size:.8rem;color:var(â€“text2);line-height:1.6;margin-bottom:16px;font-style:italic}
.modal-warn{font-size:.75rem;color:var(â€“ember2);margin-bottom:16px}
.modal-btns{display:flex;gap:10px}
.modal-btn{flex:1;padding:11px;border-radius:5px;cursor:pointer;font-family:â€˜Cinzelâ€™,serif;font-size:.8rem;letter-spacing:1px;border:none;transition:all .2s}
.modal-btn.confirm{background:linear-gradient(180deg,var(â€“gold2),var(â€“gold3));color:var(â€“parchment)}
.modal-btn.cancel{background:var(â€“stone);color:var(â€“text2);border:1px solid var(â€“stone2)}

/* ===== AUDIO BUTTON ===== */
#audio-btn{
position:fixed;top:8px;right:8px;z-index:200;
width:28px;height:28px;border-radius:50%;background:rgba(0,0,0,0.5);
border:1px solid var(â€“stone2);color:var(â€“text3);font-size:.9rem;
cursor:pointer;display:flex;align-items:center;justify-content:center;
display:none;
}

/* scrollbar */
#tab-content::-webkit-scrollbar{width:3px}
#tab-content::-webkit-scrollbar-track{background:var(â€“parchment)}
#tab-content::-webkit-scrollbar-thumb{background:var(â€“stone2);border-radius:3px}

@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-4px)}75%{transform:translateX(4px)}}
.shake{animation:shake .3s}

/* Pixel art font for numbers */
.pixel-num{font-family:â€˜Courier Newâ€™,monospace;font-weight:bold}
</style>

</head>
<body>
<div id="game">

  <!-- TITLE SCREEN -->

  <div class="screen active" id="screen-title">
    <div class="title-bg"><canvas id="title-canvas"></canvas></div>
    <div class="title-content">
      <div style="font-size:4rem;filter:drop-shadow(0 0 20px rgba(200,72,32,0.8))">ğŸ°</div>
      <div class="game-logo">ASHEN<br>THRONE</div>
      <div class="title-divider"></div>
      <div class="game-subtitle">Gothic Idle RPG</div>
      <div style="height:20px"></div>
      <button class="btn-title" onclick="startGame()">âš” ENTER REALM</button>
      <div style="font-size:.7rem;color:var(--text3);font-style:italic;margin-top:8px">Progress saves automatically</div>
    </div>
  </div>

  <!-- CLASS SELECT -->

  <div class="screen" id="screen-class">
    <div class="screen-header">Choose Your Path</div>
    <div class="class-cards" id="class-cards" style="padding:10px"></div>
    <div style="padding:10px;padding-top:0">
      <button class="btn-title" style="width:100%;padding:12px" id="confirm-class-btn" onclick="confirmClass()" disabled>Begin Journey</button>
    </div>
  </div>

  <!-- MAIN GAME -->

  <div class="screen" id="screen-game">
    <!-- HUD -->
    <div id="hud-top">
      <div class="hud-avatar" id="hud-avatar">âš”</div>
      <div class="hud-bars">
        <div class="hud-bar-row">
          <div class="hud-bar-label" style="color:#e04040">â™¥</div>
          <div class="hud-bar bar-hp"><div class="hud-bar-fill" id="bar-hp" style="width:100%"></div></div>
          <div style="font-size:.6rem;color:var(--text3);width:60px;text-align:right" id="label-hp">100/100</div>
        </div>
        <div class="hud-bar-row">
          <div class="hud-bar-label" style="color:#3060c0">âœ¦</div>
          <div class="hud-bar bar-mana"><div class="hud-bar-fill" id="bar-mana" style="width:100%"></div></div>
          <div style="font-size:.6rem;color:var(--text3);width:60px;text-align:right" id="label-mana">50/50</div>
        </div>
        <div class="hud-bar-row">
          <div class="hud-bar-label" style="color:#208040">â˜…</div>
          <div class="hud-bar bar-xp"><div class="hud-bar-fill" id="bar-xp" style="width:0%"></div></div>
          <div style="font-size:.6rem;color:var(--text3);width:60px;text-align:right" id="label-xp">0/100</div>
        </div>
      </div>
      <div class="hud-right">
        <div class="hud-gold">ğŸ’° <span id="hud-gold">0</span></div>
        <div class="hud-level">Lv.<span id="hud-level">1</span></div>
        <div class="hud-zone-badge">Zone <span id="hud-zone">1</span></div>
      </div>
    </div>

```
<!-- Arena -->
<div id="arena-section">
  <div id="arena-wrap">
    <canvas id="arena"></canvas>
    <div id="combat-overlay"></div>
    <button id="auto-btn" onclick="toggleAuto()">AUTO OFF</button>
    <button id="zone-btn" onclick="advanceZone()">â†’ ZONE</button>
    <div id="attack-btn-wrap">
      <div id="attack-btn" ontouchstart="touchAttack(event)" onmousedown="touchAttack(event)">âš”</div>
    </div>
  </div>
</div>

<!-- Tabs -->
<div id="tabs">
  <div class="tab active" onclick="switchTab('combat')" id="tab-combat">
    <span>âš”</span><span class="tab-label">Skills</span>
  </div>
  <div class="tab" onclick="switchTab('quests')" id="tab-quests">
    <span>ğŸ“œ</span><span class="tab-label">Quests</span>
  </div>
  <div class="tab" onclick="switchTab('boons')" id="tab-boons">
    <span>âš—</span><span class="tab-label">Boons</span>
  </div>
  <div class="tab" onclick="switchTab('stats')" id="tab-stats">
    <span>ğŸ“Š</span><span class="tab-label">Stats</span>
  </div>
</div>

<!-- Tab Content -->
<div id="tab-content"></div>
```

  </div>

</div>

<!-- TOAST -->

<div id="toast"></div>
<!-- LEVEL UP -->
<div id="levelup-splash"><div class="levelup-text">LEVEL UP!</div></div>
<!-- MODAL -->
<div id="modal">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Prestige</div>
    <div class="modal-desc" id="modal-desc">Are you sure?</div>
    <div class="modal-warn" id="modal-warn"></div>
    <div class="modal-btns">
      <button class="modal-btn confirm" id="modal-confirm">Confirm</button>
      <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>
<!-- AUDIO BTN -->
<div id="audio-btn" onclick="toggleAudio()">ğŸ”Š</div>

<script>
// =====================================================
// AUDIO ENGINE â€” Web Audio API 16-bit style
// =====================================================
let audioCtx = null, audioEnabled = false;
function initAudio(){
  try{
    audioCtx = new(window.AudioContext||window.webkitAudioContext)();
    audioEnabled = true;
    document.getElementById('audio-btn').style.display='flex';
  }catch(e){}
}
function toggleAudio(){
  audioEnabled=!audioEnabled;
  document.getElementById('audio-btn').textContent=audioEnabled?'ğŸ”Š':'ğŸ”‡';
}

function playTone(freq, type='square', dur=0.1, vol=0.15, delay=0){
  if(!audioCtx||!audioEnabled) return;
  const osc=audioCtx.createOscillator();
  const gain=audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.type=type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime+delay);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime+delay);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+delay+dur);
  osc.start(audioCtx.currentTime+delay);
  osc.stop(audioCtx.currentTime+delay+dur+0.01);
}

function playNoise(dur=0.05, vol=0.1, delay=0){
  if(!audioCtx||!audioEnabled) return;
  const buf=audioCtx.createBuffer(1, audioCtx.sampleRate*dur, audioCtx.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++) d[i]=(Math.random()*2-1);
  const src=audioCtx.createBufferSource();
  const gain=audioCtx.createGain();
  const filter=audioCtx.createBiquadFilter();
  filter.type='bandpass'; filter.frequency.value=800;
  src.buffer=buf; src.connect(filter); filter.connect(gain); gain.connect(audioCtx.destination);
  gain.gain.setValueAtTime(vol, audioCtx.currentTime+delay);
  gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+delay+dur);
  src.start(audioCtx.currentTime+delay);
}

const SFX = {
  hit:()=>{playNoise(0.05,0.2); playTone(150,'square',0.05,0.1,0.02)},
  crit:()=>{playTone(300,'square',0.04,0.2); playTone(600,'square',0.04,0.2,0.04); playTone(900,'square',0.04,0.15,0.08)},
  die:()=>{playTone(200,'sawtooth',0.08,0.15); playTone(150,'sawtooth',0.1,0.15,0.06); playTone(100,'sawtooth',0.15,0.1,0.12)},
  enemyDie:()=>{playTone(400,'square',0.05,0.12); playTone(300,'square',0.05,0.12,0.05); playTone(200,'square',0.08,0.1,0.1)},
  levelup:()=>{[400,500,600,800].forEach((f,i)=>playTone(f,'square',0.08,0.18,i*0.08))},
  gold:()=>{playTone(800,'sine',0.06,0.1); playTone(1200,'sine',0.04,0.08,0.06)},
  skill:()=>{playTone(600,'triangle',0.06,0.12); playTone(900,'triangle',0.08,0.1,0.05)},
  quest:()=>{[500,700,900,700,900].forEach((f,i)=>playTone(f,'square',0.06,0.15,i*0.07))},
  prestige:()=>{[200,300,400,600,800,1000,800].forEach((f,i)=>playTone(f,'square',0.1,0.2,i*0.1))},
  hurt:()=>{playTone(180,'sawtooth',0.06,0.12); playNoise(0.04,0.08,0.02)},
};

// Background music â€” simple looping arpeggio
let bgMusicHandle = null;
function startBgMusic(){
  if(!audioCtx||!audioEnabled) return;
  const notes=[220,277,330,440,370,330,277,220];
  let i=0;
  function playNext(){
    if(!audioEnabled){bgMusicHandle=setTimeout(playNext,600);return}
    const osc=audioCtx.createOscillator();
    const gain=audioCtx.createGain();
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.type='triangle'; osc.frequency.value=notes[i%notes.length];
    gain.gain.setValueAtTime(0.04, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime+0.3);
    osc.start(); osc.stop(audioCtx.currentTime+0.3);
    i++;
    bgMusicHandle=setTimeout(playNext, i%4===0?800:400);
  }
  bgMusicHandle=setTimeout(playNext,1000);
}

// =====================================================
// CANVAS RENDERING â€” Pixel-art style sprites
// =====================================================
const PIXEL = 3; // scale factor

function drawPixelArt(ctx, sprite, x, y, scale=1){
  const s=PIXEL*scale;
  sprite.forEach((row,ry)=>row.forEach((col,rx)=>{
    if(!col) return;
    ctx.fillStyle=col;
    ctx.fillRect(x+rx*s, y+ry*s, s, s);
  }));
}

// Color palettes
const PAL = {
  warrior: {skin:'#d4906a',armor:'#5a6880',armor2:'#8090a8',sword:'#c0c8d0',sword2:'#e0e8f0',hair:'#403020',belt:'#a06020',eye:'#201810'},
  mage: {skin:'#d4906a',robe:'#4a1a6a',robe2:'#7040a0',staff:'#806040',staff2:'#c0a060',gem:'#a020e0',hair:'#1a1a3a',eye:'#6020c0'},
  rogue: {skin:'#c07850',cloak:'#202020',cloak2:'#383838',blade:'#c8d0d8',blade2:'#e8f0f8',hair:'#181210',eye:'#201810'},
};

const SPRITES = {
  warrior: (p)=>[
    [0,0,0,p.hair,p.hair,p.hair,0,0,0],
    [0,0,p.hair,p.skin,p.skin,p.skin,p.hair,0,0],
    [0,0,p.skin,p.skin,p.skin,p.skin,p.skin,0,0],
    [0,0,p.skin,p.eye,p.skin,p.eye,p.skin,0,0],
    [0,0,p.skin,p.skin,p.skin,p.skin,p.skin,0,0],
    [0,p.armor2,p.armor,p.belt,p.belt,p.belt,p.armor,p.armor2,0],
    [p.armor,p.armor2,p.armor,p.armor,p.armor,p.armor,p.armor,p.armor2,p.armor],
    [0,p.armor,p.armor2,p.armor,p.armor,p.armor,p.armor2,p.armor,0],
    [0,p.armor,p.armor,p.armor2,p.armor2,p.armor2,p.armor,p.armor,0],
    [0,p.armor2,p.armor,0,0,0,p.armor,p.armor2,0],
    [0,p.armor,p.armor,0,0,0,p.armor,p.armor,0],
    [0,p.armor2,p.armor2,0,0,0,p.armor2,p.armor2,0],
  ],
  mage: (p)=>[
    [0,0,p.hair,p.hair,p.hair,p.hair,p.hair,0,0],
    [0,p.hair,p.skin,p.skin,p.skin,p.skin,p.skin,p.hair,0],
    [0,0,p.skin,p.skin,p.skin,p.skin,p.skin,0,0],
    [0,0,p.skin,p.eye,p.skin,p.eye,p.skin,0,0],
    [0,0,p.skin,p.skin,p.skin,p.skin,p.skin,0,0],
    [0,p.robe2,p.robe,p.robe,p.robe,p.robe,p.robe,p.robe2,0],
    [p.robe,p.robe2,p.robe,p.robe,p.robe,p.robe,p.robe,p.robe2,p.robe],
    [0,p.robe,p.robe2,p.gem,p.robe,p.gem,p.robe2,p.robe,0],
    [0,p.robe,p.robe,p.robe2,p.robe2,p.robe2,p.robe,p.robe,0],
    [0,p.robe2,p.robe,0,0,0,p.robe,p.robe2,0],
    [0,p.robe,p.robe,0,0,0,p.robe,p.robe,0],
    [0,p.robe2,p.robe2,0,0,0,p.robe2,p.robe2,0],
  ],
  rogue: (p)=>[
    [0,0,p.hair,p.hair,p.hair,p.hair,0,0,0],
    [0,p.cloak2,p.skin,p.skin,p.skin,p.skin,p.cloak2,0,0],
    [0,0,p.skin,p.skin,p.skin,p.skin,p.skin,0,0],
    [0,0,p.cloak,p.eye,p.skin,p.eye,p.skin,0,0],
    [0,0,p.skin,p.skin,p.skin,p.skin,p.skin,0,0],
    [0,p.cloak2,p.cloak,p.cloak,p.cloak,p.cloak,p.cloak,p.cloak2,0],
    [p.cloak,p.cloak2,p.cloak,p.cloak,p.cloak,p.cloak,p.cloak,p.cloak2,p.blade],
    [0,p.cloak,p.cloak2,p.cloak,p.cloak,p.cloak,p.cloak2,p.cloak,p.blade2],
    [0,p.cloak,p.cloak,p.cloak2,p.cloak2,p.cloak2,p.cloak,p.cloak,p.blade],
    [0,p.cloak2,p.cloak,0,0,0,p.cloak,p.cloak2,0],
    [0,p.cloak,p.cloak,0,0,0,p.cloak,p.cloak,0],
    [0,p.cloak2,p.cloak2,0,0,0,p.cloak2,p.cloak2,0],
  ],
};

// Enemy sprites
const ENEMY_SPRITES = {
  rat:{
    colors:['#603020','#804030','#a06040','#201010','#ff2020'],
    draw(ctx,x,y,flip){
      const c=this.colors;
      const p=PIXEL;
      if(flip){ctx.save();ctx.translate(x+7*p,0);ctx.scale(-1,1);x=0;}
      [[0,0,0,c[0],c[0],0,c[1],0],[0,0,c[0],c[1],c[1],c[0],c[1],0],[0,c[0],c[1],c[2],c[2],c[1],c[0],0],
       [c[0],c[1],c[2],c[3],c[2],c[2],c[1],c[0]],[0,c[0],c[1],c[2],c[1],c[1],c[0],0],
       [0,0,c[0],c[0],c[0],c[0],0,0],[0,c[0],c[0],0,0,c[0],c[0],0]].forEach((row,ry)=>
        row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
      if(flip) ctx.restore();
    }
  },
  skeleton:{
    colors:['#d8d0b8','#b8b0a0','#e8e0d0','#201810','#c03020'],
    draw(ctx,x,y,flip){
      const c=this.colors;const p=PIXEL;
      if(flip){ctx.save();ctx.translate(x+8*p,0);ctx.scale(-1,1);x=0;}
      [[0,c[0],c[0],c[0],c[0],c[0],0,0],[0,c[2],c[0],c[0],c[0],c[2],0,0],
       [0,c[0],c[3],c[0],c[3],c[0],0,0],[0,c[0],c[0],c[0],c[0],c[0],0,0],
       [0,c[1],c[2],c[2],c[2],c[1],0,0],[c[1],c[0],c[1],c[0],c[1],c[0],c[1],0],
       [0,c[1],c[0],c[0],c[0],c[1],0,0],[0,c[0],c[1],0,c[1],c[0],0,0],
       [0,c[1],c[0],0,c[0],c[1],0,0],[0,c[0],c[1],0,c[1],c[0],0,0]].forEach((row,ry)=>
        row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
      if(flip) ctx.restore();
    }
  },
  zombie:{
    colors:['#507840','#406030','#203018','#201810','#c03020','#a8c888'],
    draw(ctx,x,y,flip){
      const c=this.colors;const p=PIXEL;
      if(flip){ctx.save();ctx.translate(x+9*p,0);ctx.scale(-1,1);x=0;}
      [[0,c[0],c[1],c[0],c[0],c[1],0,0,0],[0,c[5],c[0],c[5],c[5],c[0],c[5],0,0],
       [0,c[0],c[5],c[5],c[5],c[5],c[0],0,0],[0,c[0],c[3],c[5],c[3],c[5],c[0],0,0],
       [0,c[0],c[5],c[5],c[5],c[5],c[0],0,0],[0,c[1],c[0],c[0],c[0],c[0],c[1],0,0],
       [c[1],c[0],c[1],c[0],c[0],c[1],c[0],c[1],0],[0,c[0],c[1],c[0],c[0],c[1],c[0],0,0],
       [0,c[1],c[0],0,0,c[0],c[1],0,0],[0,c[0],c[0],0,0,c[0],c[0],0,0]].forEach((row,ry)=>
        row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
      if(flip) ctx.restore();
    }
  },
  wraith:{
    colors:['#4040c0','#6060e0','#8080f8','#2020a0','#e0e0ff','#ffffff'],
    draw(ctx,x,y,flip){
      const c=this.colors;const p=PIXEL;
      if(flip){ctx.save();ctx.translate(x+8*p,0);ctx.scale(-1,1);x=0;}
      [[0,0,c[2],c[1],c[1],c[2],0,0],[0,c[1],c[5],c[2],c[2],c[5],c[1],0],
       [0,c[1],c[2],c[5],c[2],c[2],c[1],0],[0,c[0],c[1],c[2],c[2],c[1],c[0],0],
       [0,c[1],c[0],c[1],c[1],c[0],c[1],0],[c[3],c[0],c[1],c[0],c[0],c[1],c[0],c[3]],
       [0,c[3],c[0],c[3],c[3],c[0],c[3],0],[0,0,c[3],0,0,c[3],0,0]].forEach((row,ry)=>
        row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
      if(flip) ctx.restore();
    }
  },
  dragon:{
    colors:['#802010','#c03020','#e04030','#401010','#ffa030','#ffcc60'],
    draw(ctx,x,y,flip){
      const c=this.colors;const p=PIXEL;
      if(flip){ctx.save();ctx.translate(x+12*p,0);ctx.scale(-1,1);x=0;}
      [[0,0,0,c[0],c[1],c[0],0,0,0,0,0,0],
       [0,0,c[0],c[2],c[2],c[2],c[0],0,0,0,c[4],0],
       [0,c[0],c[2],c[1],c[2],c[1],c[2],c[0],0,c[4],c[5],c[4]],
       [c[0],c[2],c[2],c[3],c[2],c[3],c[2],c[2],c[0],c[4],c[5],c[4]],
       [0,c[1],c[2],c[2],c[2],c[2],c[2],c[1],0,0,c[4],0],
       [0,c[0],c[1],c[0],c[0],c[0],c[1],c[0],0,0,0,0],
       [c[0],c[1],c[0],c[1],c[0],c[1],c[0],c[1],c[0],0,0,0],
       [0,c[0],c[1],c[0],c[0],c[0],c[1],c[0],0,0,0,0],
       [0,c[0],c[0],c[1],0,c[1],c[0],c[0],0,0,0,0]].forEach((row,ry)=>
        row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
      if(flip) ctx.restore();
    }
  },
  lich:{
    colors:['#1a1a2a','#3a2a5a','#6a4a9a','#a070d8','#e8e0ff','#c84820'],
    draw(ctx,x,y,flip){
      const c=this.colors;const p=PIXEL;
      if(flip){ctx.save();ctx.translate(x+9*p,0);ctx.scale(-1,1);x=0;}
      [[0,c[1],c[2],c[3],c[3],c[2],c[1],0,0],
       [c[1],c[2],c[4],c[3],c[3],c[4],c[2],c[1],0],
       [0,c[2],c[3],c[5],c[3],c[5],c[3],c[2],0],
       [0,c[1],c[3],c[3],c[3],c[3],c[3],c[1],0],
       [0,c[2],c[1],c[2],c[2],c[2],c[1],c[2],0],
       [c[1],c[2],c[3],c[2],c[2],c[2],c[3],c[2],c[1]],
       [0,c[1],c[2],c[3],c[2],c[3],c[2],c[1],0],
       [0,c[2],c[1],0,0,0,c[1],c[2],0],
       [0,c[1],c[2],0,0,0,c[2],c[1],0],
       [0,c[1],c[1],0,0,0,c[1],c[1],0]].forEach((row,ry)=>
        row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
      if(flip) ctx.restore();
    }
  }
};

// Background parallax layers per zone
const ZONE_BG = [
  { sky:['#1a1208','#2a1a10'], ground:'#2a1e10', accent:'#3a2818', trees:'#1a1408', name:'Ashen Fields' },
  { sky:['#120808','#1a1010'], ground:'#1a1208', accent:'#241810', trees:'#0e0808', name:'Catacombs' },
  { sky:['#080c18','#101828'], ground:'#1a2030', accent:'#2030404', trees:'#080c18', name:'Frostmere' },
  { sky:['#0c0818','#180c28'], ground:'#1a1028', accent:'#281838', trees:'#0c0818', name:'Shadowmere' },
  { sky:['#180808','#200808'], ground:'#201010', accent:'#301818', trees:'#100808', name:'Obsidian Keep' },
  { sky:['#0a0a18','#141428'], ground:'#181820', accent:'#282830', trees:'#0a0a14', name:'Spectral Wastes' },
  { sky:['#180818','#200c20'], ground:'#201020', accent:'#2c1428', trees:'#100810', name:'Voidspire' },
  { sky:['#100808','#180808'], ground:'#1c0c0c', accent:'#240c0c', trees:'#0c0404', name:'Infernal Core' },
];

const ZONE_ENEMIES = [
  ['rat','rat','skeleton'],
  ['skeleton','zombie','skeleton'],
  ['zombie','wraith','zombie'],
  ['wraith','wraith','lich'],
  ['dragon','lich','dragon'],
  ['lich','dragon','wraith'],
  ['dragon','lich','dragon'],
  ['lich','dragon','lich'],
];

// =====================================================
// GAME DATA
// =====================================================
const CLASSES_DATA = {
  warrior:{
    icon:'âš”', name:'Ironclad Warrior', flavor:'"Unyielding as stone, fierce as flame"',
    baseAtk:8, baseDef:5, baseHp:160, baseMana:30, baseSpd:1.0, baseCrit:5, baseSpell:0,
    statHints:['âš” High damage','ğŸ›¡ Best defense','â¤ Strong HP'],
    colors: PAL.warrior,
  },
  mage:{
    icon:'ğŸ”®', name:'Void Mage', flavor:'"From darkness, power without limit"',
    baseAtk:4, baseDef:2, baseHp:90, baseMana:120, baseSpd:1.0, baseCrit:12, baseSpell:14,
    statHints:['ğŸ”® Spell damage','ğŸ’¥ High crit','âœ¦ Mana scaling'],
    colors: PAL.mage,
  },
  rogue:{
    icon:'ğŸ—¡', name:'Shadow Rogue', flavor:'"Strike unseen, vanish like smoke"',
    baseAtk:6, baseDef:2, baseHp:110, baseMana:70, baseSpd:1.6, baseCrit:22, baseSpell:0,
    statHints:['ğŸ—¡ Fast attacks','ğŸ’¥ High crit','ğŸ‘¤ Dodge'],
    colors: PAL.rogue,
  },
};

const SKILL_TREES = {
  offense:[
    {id:'heavy',name:'Heavy Strike',icon:'ğŸ’¥',desc:'+4 ATK/lv',max:6,eff:'atk',val:4},
    {id:'execution',name:'Execution',icon:'ğŸ—¡',desc:'+6% crit/lv',max:5,eff:'crit',val:6,req:'heavy'},
    {id:'berserker',name:'Berserker',icon:'ğŸ”¥',desc:'<30% HP: +60% ATK',max:1,eff:'special'},
    {id:'overpower',name:'Overpower',icon:'ğŸ’¢',desc:'Every 5th hit: 3Ã— dmg',max:1,eff:'special',req:'execution'},
  ],
  defense:[
    {id:'ironskin',name:'Iron Skin',icon:'ğŸ›¡',desc:'+3 DEF/lv',max:6,eff:'def',val:3},
    {id:'vigor',name:'Vigor',icon:'â¤',desc:'+20 max HP/lv',max:5,eff:'maxHp',val:20},
    {id:'regen',name:'Regeneration',icon:'ğŸ’š',desc:'Regen 2% HP/kill',max:3,eff:'regen',val:2,req:'vigor'},
    {id:'fortress',name:'Fortress',icon:'ğŸ°',desc:'Block 15% dmg',max:1,eff:'block',val:15,req:'ironskin'},
  ],
  magic:[
    {id:'arcane',name:'Arcane Surge',icon:'âœ¨',desc:'+6 spell/lv',max:6,eff:'spell',val:6},
    {id:'manapool',name:'Mana Pool',icon:'âœ¦',desc:'+20 max mana/lv',max:5,eff:'maxMana',val:20},
    {id:'soulburn',name:'Soul Burn',icon:'ğŸŒ‘',desc:'Spells deal +25% dmg',max:1,eff:'special',req:'arcane'},
    {id:'lifedrain',name:'Life Drain',icon:'ğŸ©¸',desc:'+3% lifesteal/lv',max:4,eff:'life',val:3},
  ],
  agility:[
    {id:'swift',name:'Swiftness',icon:'âš¡',desc:'+0.12 ATK spd/lv',max:5,eff:'spd',val:0.12},
    {id:'dodge',name:'Shadow Step',icon:'ğŸ‘¤',desc:'+8% dodge/lv',max:3,eff:'dodge',val:8},
    {id:'flurry',name:'Flurry',icon:'ğŸŒ€',desc:'+2 bonus hits/crit',max:1,eff:'special',req:'swift'},
    {id:'shadow',name:'Shadowform',icon:'ğŸŒ«',desc:'+20% all stats at night',max:1,eff:'special'},
  ],
};

const QUESTS = [
  {id:'q1',icon:'ğŸ©¸',name:'First Blood',desc:'Slay 10 foes',type:'kills',target:10,reward:{gold:50,sp:2},done:false},
  {id:'q2',icon:'ğŸ’€',name:'Slaughterer',desc:'100 kills',type:'kills',target:100,reward:{gold:300,sp:5},done:false},
  {id:'q3',icon:'ğŸ’€',name:'Reaper',desc:'1000 kills',type:'kills',target:1000,reward:{gold:2000,sp:15},done:false},
  {id:'q4',icon:'â¬†',name:'Initiate',desc:'Reach level 5',type:'level',target:5,reward:{gold:100,sp:3},done:false},
  {id:'q5',icon:'â¬†',name:'Champion',desc:'Reach level 20',type:'level',target:20,reward:{gold:1000,sp:10},done:false},
  {id:'q6',icon:'â¬†',name:'Legend',desc:'Reach level 50',type:'level',target:50,reward:{gold:5000,sp:25},done:false},
  {id:'q7',icon:'ğŸ—º',name:'Explorer',desc:'Reach Zone 3',type:'zone',target:3,reward:{gold:400,sp:8},done:false},
  {id:'q8',icon:'ğŸ—º',name:'Conqueror',desc:'Reach Zone 6',type:'zone',target:6,reward:{gold:2000,sp:20},done:false},
  {id:'q9',icon:'ğŸ’°',name:'Miser',desc:'Earn 1000 gold',type:'goldTotal',target:1000,reward:{gold:0,sp:5},done:false},
  {id:'q10',icon:'ğŸ’°',name:'Wealthy',desc:'Earn 10000 gold',type:'goldTotal',target:10000,reward:{gold:0,sp:15},done:false},
  {id:'q11',icon:'âœ¨',name:'Awakened',desc:'Unlock 10 skills',type:'skills',target:10,reward:{gold:1500,sp:12},done:false},
  {id:'q12',icon:'ğŸ”„',name:'Reborn',desc:'Prestige once',type:'prestige',target:1,reward:{gold:0,sp:30},done:false},
];

const BOONS = [
  {id:'b1',icon:'ğŸ’ª',name:'Iron Discipline',desc:'+10% base ATK',cost:500,eff:'atk_pct',val:0.1},
  {id:'b2',icon:'ğŸŒ‘',name:'Shadow Harvest',desc:'+15% gold drops',cost:300,eff:'gold_pct',val:0.15},
  {id:'b3',icon:'ğŸ“š',name:'Ancient Wisdom',desc:'+20% XP gained',cost:600,eff:'xp_pct',val:0.2},
  {id:'b4',icon:'ğŸ©¸',name:'Blood Pact',desc:'Start fights at full HP',cost:800,eff:'hp_start'},
  {id:'b5',icon:'ğŸŒ¬',name:'Ethereal Gale',desc:'+0.3 attack speed',cost:1200,eff:'spd_bonus',val:0.3},
  {id:'b6',icon:'ğŸ‰',name:'Dragonfire',desc:'+30% ATK, +30% enemy HP',cost:1500,eff:'cursed'},
  {id:'b7',icon:'ğŸ”®',name:'Soul Crystal',desc:'+25% spell damage',cost:1000,eff:'spell_pct',val:0.25},
  {id:'b8',icon:'ğŸ‘‘',name:'Sovereign\'s Mark',desc:'+5 all stats/zone',cost:2000,eff:'zone_scale'},
  {id:'b9',icon:'âš¡',name:'Static Surge',desc:'Crits chain to nearby',cost:1800,eff:'chain_crit'},
  {id:'b10',icon:'ğŸŒ¿',name:'Life Root',desc:'+3% lifesteal',cost:900,eff:'life_bonus',val:0.03},
];

// =====================================================
// GAME STATE
// =====================================================
const SAVE_KEY = 'ashen_v3';
let G = null; // game state

function defaultState(){
  return {
    class:'warrior', name:'The Hollow', selectedClass:null,
    level:1, xp:0, xpNext:100,
    hp:160, maxHp:160, mana:30, maxMana:30,
    gold:0, goldTotal:0, kills:0, deaths:0,
    zone:1, zoneKills:0, zoneTarget:10,
    sp:0, prestige:0, prestigeBonus:1.0,
    skills:{}, quests:QUESTS.map(q=>({...q})),
    boosts:{}, idle:false, lastSave:Date.now(),
    totalSkillsUnlocked:0, muted:false,
  };
}

function saveGame(){
  try{ localStorage.setItem(SAVE_KEY, JSON.stringify({...G, idle:false, lastSave:Date.now()})); }catch(e){}
}
function loadGame(){
  try{
    const d = localStorage.getItem(SAVE_KEY);
    if(d){
      const s = JSON.parse(d);
      G = defaultState();
      Object.assign(G, s);
      G.quests = QUESTS.map(q=>{ const sq=(s.quests||[]).find(x=>x.id===q.id); return sq?{...q,...sq}:{...q}; });
      return true;
    }
  }catch(e){}
  G = defaultState();
  return false;
}

// =====================================================
// COMPUTED STATS
// =====================================================
function getStats(){
  const c = CLASSES_DATA[G.class];
  let atk=c.baseAtk, def=c.baseDef, spd=c.baseSpd, crit=c.baseCrit;
  let life=0, spell=c.baseSpell||0, maxHp=c.baseHp, maxMana=c.baseMana, dodge=0, block=0;

  // Level scaling (exponential)
  const lvScale = Math.pow(1.08, G.level - 1);
  atk += (G.level-1)*2*lvScale*0.3;
  def += (G.level-1)*1*lvScale*0.2;
  maxHp += (G.level-1)*12;

  // Skills
  const sk = G.skills;
  if(sk.heavy)   atk  += sk.heavy*4;
  if(sk.ironskin) def += sk.ironskin*3;
  if(sk.vigor)   maxHp+=sk.vigor*20;
  if(sk.arcane)  spell+=sk.arcane*6;
  if(sk.manapool) maxMana+=sk.manapool*20;
  if(sk.swift)   spd  +=sk.swift*0.12;
  if(sk.dodge)   dodge+=sk.dodge*8;
  if(sk.execution) crit+=sk.execution*6;
  if(sk.lifedrain) life+=sk.lifedrain*3;
  if(sk.fortress) block+=15;
  if(sk.soulburn) spell=Math.round(spell*1.25);

  // Boosts
  if(G.boosts.b1) atk*=1.1;
  if(G.boosts.b5) spd+=0.3;
  if(G.boosts.b6){ atk*=1.3; }
  if(G.boosts.b7) spell*=1.25;
  if(G.boosts.b8){ const zb=G.zone*5; atk+=zb;def+=zb;maxHp+=zb*3; }
  if(G.boosts.b10) life+=3;

  // Prestige
  const pb=G.prestigeBonus;
  atk*=pb; def*=pb; maxHp=Math.round(maxHp*pb);

  return {
    atk:Math.round(atk*10)/10, def:Math.round(def*10)/10,
    spd:Math.round(Math.max(0.5,spd)*100)/100,
    crit:Math.round(crit), life:Math.round(life),
    spell:Math.round(spell), maxHp:Math.round(maxHp),
    maxMana:Math.round(maxMana), dodge:Math.round(dodge),
    block:Math.round(block),
  };
}
function xpForLevel(lv){ return Math.floor(100*Math.pow(1.28,lv-1)); }
function attackInterval(){ return Math.max(250, Math.round(1000/getStats().spd)); }

// =====================================================
// CANVAS ENGINE
// =====================================================
let arenaCanvas, arenaCtx, animFrame=null;
let playerAnim={x:0,y:0,bobPhase:0,attackFlash:0,hurtFlash:0};
let enemyAnim={x:0,y:0,bobPhase:0,attackFlash:0,hurtFlash:0,deathAnim:0,dead:false};
let bgOffset=0;
let particles=[];

function initArena(){
  arenaCanvas = document.getElementById('arena');
  arenaCtx = arenaCanvas.getContext('2d');
  resizeArena();
  window.addEventListener('resize', resizeArena);
  renderLoop();
}

function resizeArena(){
  const wrap = document.getElementById('arena-wrap');
  arenaCanvas.width = wrap.clientWidth;
  arenaCanvas.height = wrap.clientHeight;
  // Set initial positions
  const W=arenaCanvas.width, H=arenaCanvas.height;
  playerAnim.x = W*0.22;
  playerAnim.y = H*0.45;
  enemyAnim.x = W*0.68;
  enemyAnim.y = H*0.42;
}

function renderLoop(){
  if(!arenaCanvas) return;
  const now = performance.now();
  playerAnim.bobPhase += 0.04;
  enemyAnim.bobPhase += 0.035;
  bgOffset = (bgOffset + 0.3) % arenaCanvas.width;
  if(playerAnim.attackFlash > 0) playerAnim.attackFlash -= 0.08;
  if(playerAnim.hurtFlash > 0) playerAnim.hurtFlash -= 0.08;
  if(enemyAnim.attackFlash > 0) enemyAnim.attackFlash -= 0.08;
  if(enemyAnim.hurtFlash > 0) enemyAnim.hurtFlash -= 0.08;
  if(enemyAnim.dead && enemyAnim.deathAnim < 1) enemyAnim.deathAnim += 0.05;
  drawArena();
  // Update particles
  particles = particles.filter(p=>{
    p.life -= 0.04;
    p.x += p.vx; p.y += p.vy;
    p.vy += 0.15;
    return p.life > 0;
  });
  animFrame = requestAnimationFrame(renderLoop);
}

function drawArena(){
  const ctx=arenaCtx, W=arenaCanvas.width, H=arenaCanvas.height;
  const zi = Math.min(G?G.zone-1:0, ZONE_BG.length-1);
  const bg = ZONE_BG[zi];

  // Sky gradient
  const sky = ctx.createLinearGradient(0,0,0,H*0.6);
  sky.addColorStop(0, bg.sky[0]);
  sky.addColorStop(1, bg.sky[1]);
  ctx.fillStyle = sky;
  ctx.fillRect(0,0,W,H);

  // Stars (for dark zones)
  if(zi > 1){
    ctx.fillStyle = 'rgba(255,255,240,0.4)';
    for(let i=0;i<20;i++){
      const sx=((i*137+bgOffset*0.1)%W), sy=(i*41)%H*0.4;
      const ss=i%3===0?1.5:0.8;
      ctx.fillRect(sx,sy,ss,ss);
    }
  }

  // Distant hills/silhouettes
  ctx.fillStyle = bg.trees;
  ctx.beginPath();
  ctx.moveTo(0,H*0.55);
  for(let x=0;x<=W;x+=8){
    const hn=Math.sin(x*0.02+bgOffset*0.002)*15 + Math.sin(x*0.05)*8;
    ctx.lineTo(x, H*0.55+hn);
  }
  ctx.lineTo(W,H); ctx.lineTo(0,H); ctx.closePath();
  ctx.fill();

  // Ground
  const grd = ctx.createLinearGradient(0,H*0.62,0,H);
  grd.addColorStop(0, bg.ground);
  grd.addColorStop(1, '#0a0804');
  ctx.fillStyle = grd;
  ctx.fillRect(0,H*0.62,W,H*0.38);

  // Ground detail lines
  ctx.strokeStyle = bg.accent;
  ctx.lineWidth = 1;
  for(let i=0;i<3;i++){
    ctx.globalAlpha = 0.3;
    ctx.beginPath();
    ctx.moveTo(0,H*0.64+i*6);
    ctx.lineTo(W,H*0.64+i*6);
    ctx.stroke();
  }
  ctx.globalAlpha = 1;

  // Zone name
  ctx.fillStyle = 'rgba(232,216,168,0.25)';
  ctx.font = '10px Cinzel, serif';
  ctx.textAlign = 'right';
  ctx.fillText(ZONE_BG[zi].name, W-8, 14);
  ctx.textAlign = 'left';

  // Kill progress bar (top of arena)
  if(G){
    const pct = G.zoneKills/G.zoneTarget;
    ctx.fillStyle = 'rgba(0,0,0,0.3)';
    ctx.fillRect(0,0,W,5);
    const barGrad = ctx.createLinearGradient(0,0,W*pct,0);
    barGrad.addColorStop(0,'#403010'); barGrad.addColorStop(1,'#c0a020');
    ctx.fillStyle = barGrad;
    ctx.fillRect(0,0,W*pct,5);
  }

  // Draw particles
  particles.forEach(p=>{
    ctx.globalAlpha = p.life;
    ctx.fillStyle = p.color;
    ctx.fillRect(p.x,p.y,p.size,p.size);
  });
  ctx.globalAlpha = 1;

  // Draw enemy
  if(G && currentEnemy && !enemyAnim.dead){
    const es = ENEMY_SPRITES[currentEnemy.spriteKey];
    if(es){
      const ey = enemyAnim.y + Math.sin(enemyAnim.bobPhase)*2;
      ctx.save();
      if(enemyAnim.hurtFlash > 0){
        ctx.globalAlpha = 1;
        ctx.filter='brightness(3) saturate(0)';
      }
      if(enemyAnim.attackFlash > 0){
        ctx.globalAlpha = 0.9;
        ctx.filter='brightness(1.5) sepia(1) hue-rotate(0deg)';
      }
      const escale = 1 + (G.zone-1)*0.12;
      ctx.save();
      ctx.translate(enemyAnim.x, ey);
      ctx.scale(escale,escale);
      es.draw(ctx, 0, 0, true);
      ctx.restore();
      ctx.restore();

      // Enemy HP bar
      if(G){
        const ehpPct = enemyHp/enemyMaxHp;
        const bw=50, bh=4, bx=enemyAnim.x-bw/2*escale, by=ey-8;
        ctx.fillStyle='rgba(0,0,0,0.6)'; ctx.fillRect(bx,by,bw*escale,bh);
        ctx.fillStyle=ehpPct>0.5?'#40a020':ehpPct>0.25?'#a08020':'#c02020';
        ctx.fillRect(bx,by,bw*escale*ehpPct,bh);
        // Enemy name
        ctx.fillStyle='rgba(232,216,168,0.7)';
        ctx.font='8px Cinzel,serif';
        ctx.textAlign='center';
        ctx.fillText(currentEnemy.name, enemyAnim.x+PIXEL*4*escale, by-3);
        ctx.textAlign='left';
      }
    }
  } else if(enemyAnim.dead) {
    // Death animation
    ctx.globalAlpha = 1-enemyAnim.deathAnim;
    const es = ENEMY_SPRITES[currentEnemy?.spriteKey];
    if(es) es.draw(ctx, enemyAnim.x, enemyAnim.y + enemyAnim.deathAnim*20, true);
    ctx.globalAlpha=1;
  }

  // Draw player
  if(G){
    const py = playerAnim.y + Math.sin(playerAnim.bobPhase)*2;
    const playerSprite = SPRITES[G.class];
    const pal = CLASSES_DATA[G.class].colors;
    ctx.save();
    if(playerAnim.hurtFlash>0){ ctx.filter='brightness(3) saturate(0) sepia(1) hue-rotate(310deg)'; }
    if(playerAnim.attackFlash>0){ ctx.filter='brightness(1.8)'; }
    drawPixelArt(ctx, playerSprite(pal), playerAnim.x, py);
    ctx.restore();

    // Player HP indicator
    const stats=getStats();
    const phpPct=G.hp/stats.maxHp;
    ctx.fillStyle='rgba(0,0,0,0.5)'; ctx.fillRect(playerAnim.x,py-8,36,4);
    ctx.fillStyle=phpPct>0.5?'#40a020':phpPct>0.25?'#a08020':'#c02020';
    ctx.fillRect(playerAnim.x,py-8,36*phpPct,4);
  }

  // Attack animation â€” slash effect
  if(playerAnim.attackFlash>0.5){
    const prog=(playerAnim.attackFlash-0.5)*2;
    const sx=playerAnim.x+30+prog*60, sy=playerAnim.y+5;
    ctx.globalAlpha=prog*0.8;
    ctx.strokeStyle='#e8d8a8';
    ctx.lineWidth=PIXEL;
    ctx.beginPath();
    ctx.moveTo(sx,sy-10); ctx.lineTo(sx+20,sy+10);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(sx+5,sy-15); ctx.lineTo(sx+25,sy+5);
    ctx.stroke();
    ctx.globalAlpha=1;
  }

  // Spell effect (mage)
  if(G?.class==='mage' && playerAnim.attackFlash>0.5){
    const prog=(playerAnim.attackFlash-0.5)*2;
    for(let i=0;i<5;i++){
      const angle=(i/5)*Math.PI*2 + prog*5;
      const r=20*prog;
      const bx=playerAnim.x+30+r*Math.cos(angle);
      const by=playerAnim.y+15+r*Math.sin(angle)*0.5;
      ctx.globalAlpha=prog*0.7;
      ctx.fillStyle=i%2===0?'#8040e0':'#c0a0f0';
      ctx.fillRect(bx,by,PIXEL,PIXEL);
    }
    ctx.globalAlpha=1;
  }
}

function spawnParticles(x,y,color,count=6){
  for(let i=0;i<count;i++){
    const angle=Math.random()*Math.PI*2;
    const spd=1+Math.random()*3;
    particles.push({
      x,y,
      vx:Math.cos(angle)*spd,vy:Math.sin(angle)*spd-2,
      color,size:PIXEL,life:1,
    });
  }
}

// =====================================================
// CLASS SELECT RENDERING
// =====================================================
function renderClassSelect(){
  const container = document.getElementById('class-cards');
  container.innerHTML = '';
  Object.entries(CLASSES_DATA).forEach(([key,cls])=>{
    const card = document.createElement('div');
    card.className = 'class-card' + (G.selectedClass===key?' selected':'');
    card.id = 'cls-card-'+key;
    card.onclick = ()=>selectClass(key);
    const cvWrap = document.createElement('div');
    cvWrap.className = 'class-sprite';
    const cv = document.createElement('canvas');
    cv.width=64; cv.height=64;
    const cx=cv.getContext('2d');
    cx.imageSmoothingEnabled=false;
    drawPixelArt(cx, SPRITES[key](cls.colors), 4, 4, 1.5);
    cvWrap.appendChild(cv);
    card.innerHTML = `
      <div class="class-info">
        <div class="class-name">${cls.name}</div>
        <div class="class-flavor">${cls.flavor}</div>
        <div class="class-stats-row">${cls.statHints.map(h=>`<div class="cstat"><b>${h}</b></div>`).join('')}</div>
      </div>`;
    card.prepend(cvWrap);
    container.appendChild(card);
  });
}

function selectClass(key){
  G.selectedClass = key;
  G.class = key;
  document.querySelectorAll('.class-card').forEach(c=>c.classList.remove('selected'));
  document.getElementById('cls-card-'+key)?.classList.add('selected');
  document.getElementById('confirm-class-btn').disabled = false;
  const cls = CLASSES_DATA[key];
  const stats=getStats();
  G.hp=stats.maxHp; G.maxHp=stats.maxHp;
  G.mana=cls.baseMana; G.maxMana=cls.baseMana;
}

function confirmClass(){
  if(!G.selectedClass) return;
  showScreen('screen-game');
  initArena();
  spawnEnemy();
  renderAll();
  initAudio();
  startBgMusic();
  if(G.idle) startIdle();
  setInterval(saveGame, 30000);
}

// =====================================================
// COMBAT
// =====================================================
let currentEnemy=null, enemyHp=0, enemyMaxHp=0;
let attackTimer=null, attackCount=0;

function spawnEnemy(){
  const zi = Math.min(G.zone-1, ZONE_ENEMIES.length-1);
  const pool = ZONE_ENEMIES[zi];
  const spriteKey = pool[Math.floor(Math.random()*pool.length)];
  const baseHp = Math.floor(25*Math.pow(1.6,G.zone-1));
  const boost = G.boosts.b6?1.3:1;
  enemyMaxHp = Math.round(baseHp*boost);
  enemyHp = enemyMaxHp;
  const names = {
    rat:['Grave Rat','Feral Rat','Diseased Rat'],
    skeleton:['Skeleton Warrior','Bone Archer','Skeletal Guard'],
    zombie:['Rotting Zombie','Plague Zombie','Undead Brute'],
    wraith:['Frost Wraith','Shadow Wraith','Banshee'],
    dragon:['Ancient Drake','Shadow Dragon','Ember Wyvern'],
    lich:['Bone Lich','Soul Lich','Void Lich'],
  };
  const nlist=names[spriteKey]||['Unknown'];
  currentEnemy = { name:nlist[Math.floor(Math.random()*nlist.length)], spriteKey };
  enemyAnim.dead=false; enemyAnim.deathAnim=0;
}

function doAttack(manual=false){
  if(!G||G.hp<=0) return;
  const stats=getStats();
  attackCount++;
  playerAnim.attackFlash=1;

  // Damage calculation
  let dmg = stats.atk*(0.85+Math.random()*0.3);
  const isCrit = Math.random()*100 < stats.crit;
  if(isCrit) dmg*=2;
  // Berserker
  if(G.skills.berserker && G.hp/stats.maxHp<0.3) dmg*=1.6;
  // Overpower
  if(G.skills.overpower && attackCount%5===0) dmg*=3;
  // Spell damage
  if(stats.spell>0) dmg+=stats.spell*(0.6+Math.random()*0.4);
  dmg=Math.round(dmg);

  SFX.hit();
  if(isCrit) SFX.crit();

  spawnParticles(enemyAnim.x+PIXEL*4, enemyAnim.y+PIXEL*5, isCrit?'#f0c030':'#c03020', isCrit?12:6);

  enemyHp=Math.max(0,enemyHp-dmg);
  enemyAnim.hurtFlash=1;

  // Show damage number
  showDmgNumber(dmg, isCrit, false);

  // Lifesteal
  if(stats.life>0){
    const heal=Math.round(dmg*stats.life/100);
    if(heal>0){ G.hp=Math.min(stats.maxHp,G.hp+heal); showDmgNumber(heal,false,'heal'); }
  }

  // Flurry (bonus hits on crit)
  if(isCrit && G.skills.flurry){
    setTimeout(()=>doAttack(false), 80);
    setTimeout(()=>doAttack(false), 160);
  }

  if(enemyHp<=0){ killEnemy(); return; }

  // Enemy attacks back
  const enemyDmgBase = Math.max(1, (3+G.zone*2.2)*Math.pow(1.18,G.zone-1));
  const blocked = stats.block>0 ? enemyDmgBase*stats.block/100 : 0;
  let enemyDmg = Math.max(1, Math.round(enemyDmgBase - stats.def - blocked));
  // Dodge
  if(Math.random()*100 < stats.dodge){ enemyDmg=0; showDmgNumber(0,false,'dodge'); }

  if(enemyDmg>0){
    G.hp=Math.max(0,G.hp-enemyDmg);
    playerAnim.hurtFlash=1;
    enemyAnim.attackFlash=0.5;
    SFX.hurt();
    showDmgNumber(enemyDmg,false,'enemy');
    spawnParticles(playerAnim.x+PIXEL*4, playerAnim.y+PIXEL*5,'#c02020',4);
  }

  if(G.hp<=0){ die(); return; }
  updateHUD();
}

function killEnemy(){
  G.kills++;
  G.zoneKills++;
  enemyAnim.dead=true;
  enemyAnim.deathAnim=0;
  SFX.enemyDie();
  spawnParticles(enemyAnim.x+PIXEL*4, enemyAnim.y+PIXEL*4,'#d4a017',16);

  // Gold
  let gold=Math.round((2+G.zone*2.5)*Math.pow(1.4,G.zone-1)*(0.8+Math.random()*0.4));
  if(G.boosts.b2) gold=Math.round(gold*1.15);
  if(G.boosts.b6) gold=Math.round(gold*1.3);
  G.gold+=gold; G.goldTotal+=gold;
  SFX.gold();

  // XP
  let xpGained=Math.round(8*Math.pow(1.45,G.zone-1));
  if(G.boosts.b3) xpGained=Math.round(xpGained*1.2);
  G.xp+=xpGained;

  // Regen
  const stats=getStats();
  if(G.skills.regen){ G.hp=Math.min(stats.maxHp, G.hp+Math.round(stats.maxHp*G.skills.regen*0.02)); }

  // Level up loop
  while(G.xp>=G.xpNext){
    G.xp-=G.xpNext; G.level++;
    G.xpNext=xpForLevel(G.level);
    G.sp++;
    G.hp=getStats().maxHp; // heal on level up
    SFX.levelup();
    showLevelUp();
    toast(`âš¡ Level ${G.level}!`);
  }

  // Zone advance
  if(G.zoneKills>=G.zoneTarget){
    G.zone=Math.min(G.zone+1,8);
    G.zoneKills=0;
    G.zoneTarget=Math.round(G.zoneTarget*1.25);
    toast(`ğŸ—º Zone ${G.zone}: ${ZONE_BG[Math.min(G.zone-1,ZONE_BG.length-1)].name}!`);
  }

  checkQuests();
  setTimeout(spawnEnemy, 400);
  updateHUD();
  renderTabContent();
}

function die(){
  G.deaths++;
  SFX.die();
  const stats=getStats();
  G.hp=Math.round(stats.maxHp*0.5);
  spawnParticles(playerAnim.x+PIXEL*4,playerAnim.y+PIXEL*5,'#c02020',20);
  spawnEnemy();
  updateHUD();
}

function toggleAuto(){
  G.idle=!G.idle;
  const btn=document.getElementById('auto-btn');
  btn.textContent=G.idle?'AUTO ON':'AUTO OFF';
  btn.className=G.idle?'on':'';
  btn.id='auto-btn';
  if(G.idle) startIdle(); else stopIdle();
}
function startIdle(){
  stopIdle();
  attackTimer=setInterval(()=>{ doAttack(); },attackInterval());
}
function stopIdle(){ if(attackTimer){clearInterval(attackTimer);attackTimer=null;} }
function advanceZone(){
  if(G.zone<8){ G.zone++; G.zoneKills=0; spawnEnemy(); toast(`â†’ Zone ${G.zone}`); updateHUD(); }
}

function touchAttack(e){
  e.preventDefault();
  if(!audioCtx) initAudio();
  doAttack(true);
}

// Damage numbers
let dmgContainer;
function showDmgNumber(val,isCrit,type){
  if(!dmgContainer) dmgContainer=document.getElementById('combat-overlay');
  const el=document.createElement('div');
  const W=arenaCanvas?arenaCanvas.width:300;
  const H=arenaCanvas?arenaCanvas.height:200;
  el.className='damage-number '+(isCrit?'crit':type==='heal'?'heal':type==='enemy'?'enemy':type==='dodge'?'heal':'hit');
  const isEnemy=type==='enemy';
  const ex=isEnemy?(playerAnim.x+Math.random()*20):(enemyAnim.x+Math.random()*20);
  const ey=isEnemy?(playerAnim.y+10):(enemyAnim.y+10);
  el.style.left=Math.min(W-60,Math.max(0,ex))+'px';
  el.style.top=Math.min(H-30,ey)+'px';
  if(type==='dodge') el.textContent='DODGE';
  else if(type==='heal') el.textContent='+'+val;
  else el.textContent=(isCrit?'â˜…':'')+val;
  dmgContainer.appendChild(el);
  setTimeout(()=>el.remove(),800);
}

// =====================================================
// HUD UPDATES
// =====================================================
function updateHUD(){
  if(!G) return;
  const stats=getStats();
  const hpPct=Math.max(0,Math.min(100,G.hp/stats.maxHp*100));
  const manaPct=Math.max(0,Math.min(100,G.mana/stats.maxMana*100));
  const xpPct=Math.max(0,Math.min(100,G.xp/G.xpNext*100));
  document.getElementById('bar-hp').style.width=hpPct+'%';
  document.getElementById('bar-mana').style.width=manaPct+'%';
  document.getElementById('bar-xp').style.width=xpPct+'%';
  document.getElementById('label-hp').textContent=Math.round(G.hp)+'/'+stats.maxHp;
  document.getElementById('label-mana').textContent=Math.round(G.mana)+'/'+stats.maxMana;
  document.getElementById('label-xp').textContent=G.xp+'/'+G.xpNext;
  document.getElementById('hud-gold').textContent=formatNum(G.gold);
  document.getElementById('hud-level').textContent=G.level;
  document.getElementById('hud-zone').textContent=G.zone;
  document.getElementById('sp-display') && (document.getElementById('sp-display').textContent=G.sp);
}

function formatNum(n){ return n>=1000000?Math.floor(n/100000)/10+'M':n>=1000?Math.floor(n/100)/10+'K':n; }

// =====================================================
// TABS
// =====================================================
let currentTab='combat';
let skillSubTab='offense';

function switchTab(tab){
  currentTab=tab;
  document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
  document.getElementById('tab-'+tab)?.classList.add('active');
  renderTabContent();
}

function renderTabContent(){
  const container=document.getElementById('tab-content');
  if(currentTab==='combat') renderSkillsTab(container);
  else if(currentTab==='quests') renderQuestsTab(container);
  else if(currentTab==='boons') renderBoonsTab(container);
  else if(currentTab==='stats') renderStatsTab(container);
}

// ===== SKILLS TAB =====
function renderSkillsTab(container){
  const tabs=['offense','defense','magic','agility'];
  const tabLabels={offense:'âš”',defense:'ğŸ›¡',magic:'ğŸ”®',agility:'âš¡'};
  let html=`<div class="skill-section">
    <div class="skill-tree-header">
      <div class="skill-tree-title">SKILL TREES</div>
      <div class="sp-badge" id="sp-display">SP: ${G.sp}</div>
    </div>
    <div class="skill-tab-bar">
      ${tabs.map(t=>`<div class="stab${skillSubTab===t?' active':''}" onclick="setSkillSub('${t}')">${tabLabels[t]}</div>`).join('')}
    </div>
    <div class="skill-grid">`;
  const skills=SKILL_TREES[skillSubTab];
  const allSkills=Object.values(SKILL_TREES).flat();
  skills.forEach(sk=>{
    const cur=G.skills[sk.id]||0;
    const maxed=cur>=sk.max;
    const locked=sk.req&&!(G.skills[sk.req]>=1);
    let cls='skill-node';
    if(maxed) cls+=' maxed';
    else if(locked) cls+=' locked';
    else if(cur>0) cls+=' unlocked';
    const pips=Array.from({length:sk.max},(_,i)=>`<div class="pip ${i<cur?'filled':''}${i<cur&&cur===sk.max?' max':''}"></div>`).join('');
    html+=`<div class="${cls}" onclick="buySkill('${sk.id}')">
      ${locked?'<span class="skill-lock-icon">ğŸ”’</span>':''}
      <div class="skill-icon-wrap">${sk.icon}</div>
      <div class="skill-node-name">${sk.name}</div>
      <div class="skill-node-desc">${sk.desc}</div>
      <div class="skill-pips">${pips}</div>
      <div class="skill-node-level">${cur}/${sk.max}</div>
    </div>`;
  });
  html+=`</div></div>`;
  container.innerHTML=html;
}

function setSkillSub(tab){
  skillSubTab=tab;
  renderTabContent();
}

function buySkill(id){
  if(!audioCtx) initAudio();
  if(G.sp<=0){ toast('No skill points!'); return; }
  const allSkills=Object.values(SKILL_TREES).flat();
  const sk=allSkills.find(s=>s.id===id);
  if(!sk) return;
  const cur=G.skills[id]||0;
  if(cur>=sk.max){ toast('Already maxed!'); return; }
  if(sk.req&&!(G.skills[sk.req]>=1)){ toast(`Requires: ${allSkills.find(s=>s.id===sk.req)?.name}`); return; }
  G.sp--;
  G.skills[id]=(G.skills[id]||0)+1;
  G.totalSkillsUnlocked=(G.totalSkillsUnlocked||0)+1;
  // Update attack interval if speed changed
  if(G.idle){ startIdle(); }
  SFX.skill();
  checkQuests();
  renderTabContent();
  updateHUD();
  saveGame();
}

// ===== QUESTS TAB =====
function renderQuestsTab(container){
  let html='<div class="quest-section">';
  G.quests.forEach(q=>{
    const prog=getQuestProg(q);
    const pct=Math.min(100,(prog/q.target)*100);
    const rewardStr=[q.reward.gold>0&&`ğŸ’°${q.reward.gold}`,q.reward.sp>0&&`â­${q.reward.sp}SP`].filter(Boolean).join(' ');
    html+=`<div class="quest-card${q.done?' done':''}">
      <div class="quest-icon-wrap">${q.done?'âœ…':q.icon}</div>
      <div class="quest-body">
        <div class="quest-name">${q.name}</div>
        <div class="quest-desc">${q.desc}</div>
        ${!q.done?`<div class="quest-prog-bar"><div class="quest-prog-fill" style="width:${pct}%"></div></div>
        <div class="quest-prog-text">${Math.min(prog,q.target).toLocaleString()} / ${q.target.toLocaleString()}</div>`:''}
        ${q.done?`<div class="quest-complete-badge">âœ¦ COMPLETE</div>`:`<div class="quest-reward">${rewardStr}</div>`}
      </div>
    </div>`;
  });
  html+='</div>';
  container.innerHTML=html;
}

function getQuestProg(q){
  if(q.type==='kills') return G.kills;
  if(q.type==='level') return G.level;
  if(q.type==='zone') return G.zone;
  if(q.type==='goldTotal') return G.goldTotal;
  if(q.type==='skills') return G.totalSkillsUnlocked||0;
  if(q.type==='prestige') return G.prestige;
  return 0;
}

function checkQuests(){
  G.quests.forEach(q=>{
    if(q.done) return;
    if(getQuestProg(q)>=q.target){
      q.done=true;
      G.gold+=q.reward.gold; G.goldTotal+=q.reward.gold;
      G.sp+=q.reward.sp;
      SFX.quest();
      toast(`ğŸ“œ ${q.name} complete! +${q.reward.sp}SP`);
    }
  });
}

// ===== BOONS TAB =====
function renderBoonsTab(container){
  let html='<div class="boons-section">';
  BOONS.forEach(b=>{
    const owned=!!G.boosts[b.id];
    const canBuy=!owned&&G.gold>=b.cost;
    html+=`<div class="boon-card${owned?' owned':!canBuy?' cant-afford':''}" onclick="${owned?'':canBuy?`buyBoon('${b.id}')`:''}" >
      <div class="boon-icon">${b.icon}</div>
      <div class="boon-body">
        <div class="boon-name">${b.name}</div>
        <div class="boon-desc">${b.desc}</div>
        ${owned?`<div class="boon-owned">âœ“ Acquired</div>`:`<div class="boon-cost">ğŸ’° ${formatNum(b.cost)}</div>`}
      </div>
    </div>`;
  });
  html+='</div>';
  container.innerHTML=html;
}

function buyBoon(id){
  const b=BOONS.find(x=>x.id===id);
  if(!b||G.boosts[id]) return;
  if(G.gold<b.cost){ toast('Not enough gold!'); return; }
  G.gold-=b.cost;
  G.boosts[id]=true;
  SFX.skill();
  toast(`âš— ${b.name} acquired!`);
  if(G.idle) startIdle();
  renderTabContent();
  updateHUD();
  saveGame();
}

// ===== STATS TAB =====
function renderStatsTab(container){
  const stats=getStats();
  const prestigeGain=Math.max(1,Math.floor(G.level/5));
  container.innerHTML=`<div class="stats-section">
    <div class="stat-group">
      <div class="stat-group-title">âš” COMBAT</div>
      <div class="stat-row"><span class="stat-label">âš” Attack</span><span class="stat-val">${stats.atk}</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ›¡ Defense</span><span class="stat-val">${stats.def}</span></div>
      <div class="stat-row"><span class="stat-label">âš¡ Speed</span><span class="stat-val">${stats.spd}x</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ’¥ Crit %</span><span class="stat-val">${stats.crit}%</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ”® Spell</span><span class="stat-val">${stats.spell}</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ©¸ Lifesteal</span><span class="stat-val">${stats.life}%</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ‘¤ Dodge</span><span class="stat-val">${stats.dodge}%</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ° Block</span><span class="stat-val">${stats.block}%</span></div>
    </div>
    <div class="stat-group">
      <div class="stat-group-title">ğŸ“Š LIFETIME</div>
      <div class="stat-row"><span class="stat-label">ğŸ’€ Total Kills</span><span class="stat-val">${G.kills.toLocaleString()}</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ’° Gold Earned</span><span class="stat-val">${G.goldTotal.toLocaleString()}</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ’€ Deaths</span><span class="stat-val">${G.deaths}</span></div>
      <div class="stat-row"><span class="stat-label">âœ¨ Prestige</span><span class="stat-val">${G.prestige}</span></div>
      <div class="stat-row"><span class="stat-label">ğŸ“ˆ Bonus</span><span class="stat-val">+${Math.round((G.prestigeBonus-1)*100)}%</span></div>
    </div>
    <div class="prestige-section">
      <div class="prestige-title">âœ¨ Prestige Ascension</div>
      <div class="prestige-desc">Reset your journey â€” keep prestige bonuses. Gain <b style="color:var(--gold2)">${prestigeGain}</b> prestige point${prestigeGain>1?'s':''} (+5% all stats each).</div>
      <div class="prestige-desc" style="color:var(--ember2);margin-bottom:12px">âš  Resets: level, gold, skills, zone</div>
      <button class="btn-prestige" onclick="openPrestige()">âœ¨ ASCEND (${prestigeGain} point${prestigeGain>1?'s':''})</button>
    </div>
  </div>`;
}

function renderAll(){
  updateHUD();
  renderTabContent();
}

// =====================================================
// PRESTIGE
// =====================================================
function openPrestige(){
  const gain=Math.max(1,Math.floor(G.level/5));
  document.getElementById('modal-title').textContent='âœ¨ Prestige Ascension';
  document.getElementById('modal-desc').textContent=`Sacrifice your progress and return ${gain} prestige point${gain>1?'s':''} stronger. Your stats will be permanently boosted.`;
  document.getElementById('modal-warn').textContent='âš  Level, gold, skills and zone will reset.';
  document.getElementById('modal-confirm').onclick=doPrestige;
  document.getElementById('modal').classList.add('open');
}
function closeModal(){ document.getElementById('modal').classList.remove('open'); }
function doPrestige(){
  const gain=Math.max(1,Math.floor(G.level/5));
  G.prestige+=gain;
  G.prestigeBonus=1+G.prestige*0.05;
  G.level=1; G.xp=0; G.xpNext=100;
  G.sp=0; G.skills={};
  G.zone=1; G.zoneKills=0; G.zoneTarget=10;
  G.gold=0; G.totalSkillsUnlocked=0;
  const stats=getStats();
  G.hp=stats.maxHp; G.maxHp=stats.maxHp;
  G.mana=CLASSES_DATA[G.class].baseMana; G.maxMana=G.mana;
  spawnEnemy();
  closeModal();
  checkQuests();
  SFX.prestige();
  toast(`âœ¨ Prestige ${G.prestige}! +${Math.round((G.prestigeBonus-1)*100)}% all stats!`);
  renderAll();
  saveGame();
}

// =====================================================
// SCREENS
// =====================================================
function showScreen(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
}

function startGame(){
  if(!audioCtx) initAudio();
  const hasData=loadGame();
  if(hasData && G.selectedClass){
    showScreen('screen-game');
    initArena();
    spawnEnemy();
    renderAll();
    initAudio();
    startBgMusic();
    if(G.idle) startIdle();
    setInterval(saveGame, 30000);
  } else {
    G=defaultState();
    renderClassSelect();
    showScreen('screen-class');
  }
}

// =====================================================
// TITLE CANVAS ANIMATION
// =====================================================
function animateTitleCanvas(){
  const cv=document.getElementById('title-canvas');
  if(!cv) return;
  const ctx=cv.getContext('2d');
  cv.width=window.innerWidth; cv.height=window.innerHeight;
  let t=0;
  const embers=Array.from({length:60},()=>({
    x:Math.random()*cv.width, y:cv.height+Math.random()*100,
    spd:0.5+Math.random()*2, size:1+Math.random()*2,
    drift:(Math.random()-0.5)*0.5, life:0, maxLife:0.4+Math.random()*0.8,
  }));
  function frame(){
    ctx.clearRect(0,0,cv.width,cv.height);
    const grad=ctx.createRadialGradient(cv.width/2,cv.height*0.6,0,cv.width/2,cv.height*0.6,cv.width*0.7);
    grad.addColorStop(0,'rgba(100,30,5,0.4)');
    grad.addColorStop(0.5,'rgba(50,10,0,0.2)');
    grad.addColorStop(1,'transparent');
    ctx.fillStyle=grad; ctx.fillRect(0,0,cv.width,cv.height);
    embers.forEach(e=>{
      e.y-=e.spd; e.x+=e.drift; e.life+=0.02;
      if(e.y<-10||e.life>e.maxLife){ e.y=cv.height+10; e.x=Math.random()*cv.width; e.life=0; }
      const a=Math.sin(e.life/e.maxLife*Math.PI);
      ctx.globalAlpha=a*0.7;
      ctx.fillStyle=e.life<e.maxLife*0.5?'#f08020':'#c03010';
      ctx.fillRect(e.x,e.y,e.size,e.size);
    });
    ctx.globalAlpha=1;
    t++;
    requestAnimationFrame(frame);
  }
  frame();
}

// =====================================================
// TOAST & LEVEL UP
// =====================================================
let toastTimer;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg; el.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>el.classList.remove('show'),2800);
}

let lvlTimer;
function showLevelUp(){
  const el=document.getElementById('levelup-splash');
  el.querySelector('.levelup-text').textContent=`LEVEL ${G.level}!`;
  el.classList.add('show');
  clearTimeout(lvlTimer);
  lvlTimer=setTimeout(()=>el.classList.remove('show'),1500);
}

// =====================================================
// INIT
// =====================================================
window.addEventListener('load',()=>{
  animateTitleCanvas();
});
</script>

</body>
</html>
