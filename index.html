<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>Ashen Throne</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Cinzel+Decorative:wght@700&family=Crimson+Text:ital,wght@0,400;1,400&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;}
:root{
  --bg:#09080c;--panel:#13111a;--panel2:#1a1824;--panel3:#22202e;--panel4:#2a2838;
  --border:#2e2b42;--border2:#4a4670;--border3:#6a6490;
  --gold:#f0c030;--gold2:#ffd86e;--gold3:#c89018;--golddim:#9a7a20;--goldglow:rgba(240,192,48,0.35);
  --red:#e83040;--green:#30c050;--green2:#60e080;--blue2:#6090ff;--purple:#9040d0;
  --txt:#fff;--txt2:#e8d8f0;--txt3:#b0a0c8;--txtdim:#9088a8;
  --sp-xs:6px;--sp-sm:10px;--sp-md:14px;--sp-lg:20px;
  --fs-xs:0.62rem;--fs-sm:0.74rem;--fs-md:0.88rem;--fs-lg:1.0rem;--fs-xl:1.2rem;
}

/* â”€â”€ APP SHELL: fills 100vw Ã— 100vh, NO fixed 390px â”€â”€ */
body{font-family:â€˜Cinzelâ€™,Georgia,serif;}
#app{position:fixed;inset:0;width:100vw;height:100vh;overflow:hidden;display:flex;flex-direction:column;}
.scr{position:absolute;inset:0;display:none;flex-direction:column;overflow:hidden;}
.scr.on{display:flex;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
TITLE SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s0{background:radial-gradient(ellipse 80% 60% at 50% 70%,rgba(180,40,10,.18) 0%,transparent 70%),radial-gradient(ellipse 120% 90% at 50% 60%,#140a18 0%,#080508 100%);align-items:center;justify-content:center;}
#s0-cv{position:absolute;inset:0;width:100%;height:100%;}
.t-body{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;gap:14px;padding:32px 28px;text-align:center;}
.t-crest{font-size:clamp(2.2rem,5vw,3.8rem);filter:drop-shadow(0 0 30px rgba(200,60,20,.9)) drop-shadow(0 0 70px rgba(200,60,20,.5));animation:cresthover 3s ease-in-out infinite;}
@keyframes cresthover{0%,100%{transform:translateY(0) scale(1);}50%{transform:translateY(-6px) scale(1.03);}}
.t-title{font-family:â€˜Cinzel Decorativeâ€™,serif;font-weight:700;font-size:clamp(1.6rem,4vw,2.4rem);color:transparent;background:linear-gradient(180deg,#ffe090 0%,#f0c030 35%,#c08010 70%,#8a5808 100%);-webkit-background-clip:text;background-clip:text;letter-spacing:6px;line-height:.95;}
.t-sub{font-size:.68rem;color:#a08040;letter-spacing:8px;text-transform:uppercase;}
.t-divider{display:flex;align-items:center;gap:12px;width:280px;max-width:88vw;}
.t-line{flex:1;height:1px;background:linear-gradient(90deg,transparent,#4a3818,#f0c030,#4a3818,transparent);}
.t-divider-ico{color:#c09020;font-size:.7rem;opacity:.7;}
.t-lore{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:.88rem;color:#9a7e3a;max-width:300px;line-height:1.7;}
.t-btns{display:flex;flex-direction:column;gap:10px;width:100%;max-width:280px;}
.t-btn{font-family:â€˜Cinzelâ€™,serif;font-size:.95rem;font-weight:700;letter-spacing:3px;color:#1a0e00;background:linear-gradient(180deg,#ffe080 0%,#f0c030 18%,#d4a020 50%,#b07810 82%,#8a5808 100%);border:none;border-radius:5px;padding:15px 36px;box-shadow:0 0 28px rgba(240,192,48,.5),0 4px 0 #5a3a00,0 6px 20px rgba(0,0,0,.9),inset 0 1px 0 rgba(255,255,255,.35);min-height:50px;cursor:pointer;transition:transform .1s,box-shadow .1s;position:relative;overflow:hidden;}
.t-btn::before{content:â€™â€™;position:absolute;top:0;left:-100%;width:60%;height:100%;background:linear-gradient(90deg,transparent,rgba(255,255,255,.2),transparent);animation:btnshine 4s infinite;}
@keyframes btnshine{0%,100%{left:-100%;}45%,55%{left:150%;}}
.t-btn:active{transform:scale(.94) translateY(2px);}
.t-btn-sec{font-family:â€˜Cinzelâ€™,serif;font-size:.72rem;color:#a08848;background:rgba(20,16,30,.8);border:1.5px solid #3a3020;border-radius:5px;padding:11px 20px;cursor:pointer;letter-spacing:2px;min-height:42px;transition:all .18s;}
.t-btn-sec:active{border-color:var(â€“gold);color:var(â€“gold);}
.t-hint{font-size:.6rem;color:#7a6840;font-style:italic;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
CLASS SELECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s1{background:var(â€“bg);}
.page-hdr{flex-shrink:0;padding:max(12px,env(safe-area-inset-top,12px)) var(â€“sp-md) var(â€“sp-sm);background:var(â€“panel);border-bottom:2px solid var(â€“border2);box-shadow:0 2px 16px rgba(0,0,0,.6);}
.page-hdr-title{font-size:var(â€“fs-sm);color:var(â€“gold);letter-spacing:5px;text-align:center;text-shadow:0 0 12px var(â€“goldglow);}
.page-hdr-sub{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:var(â€“fs-xs);color:#7a6540;text-align:center;margin-top:4px;}
.cls-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:var(â€“sp-md);display:grid;grid-template-columns:repeat(auto-fill,minmax(min(100%,360px),1fr));gap:var(â€“sp-md);align-content:start;}
.cls-list::-webkit-scrollbar{width:3px;}.cls-list::-webkit-scrollbar-thumb{background:var(â€“border2);}
.cls-card{background:linear-gradient(135deg,var(â€“panel2),var(â€“panel3));border:2px solid var(â€“border);border-radius:10px;padding:var(â€“sp-md);display:flex;gap:var(â€“sp-md);align-items:flex-start;cursor:pointer;transition:border-color .18s,box-shadow .18s,transform .12s;position:relative;box-shadow:0 2px 12px rgba(0,0,0,.5);}
.cls-card:hover{border-color:var(â€“border3);transform:translateY(-1px);}
.cls-card.sel{border-color:var(â€“gold);background:linear-gradient(135deg,#1e1a10,#2a2410);box-shadow:0 0 20px var(â€“goldglow);}
.cls-sprite-wrap{width:68px;height:68px;flex-shrink:0;border-radius:8px;background:radial-gradient(circle at 40% 35%,#1e1a2a,#0a0810);border:2px solid var(â€“border2);overflow:hidden;}
.cls-sprite-wrap canvas{image-rendering:pixelated;width:100%;height:100%;}
.cls-text{flex:1;min-width:0;}
.cls-name{font-size:var(â€“fs-md);font-weight:700;color:var(â€“gold);margin-bottom:3px;}
.cls-flavor{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:var(â€“fs-xs);color:#9a8048;line-height:1.45;margin-bottom:5px;}
.cls-lore{font-family:â€˜Crimson Textâ€™,serif;font-size:var(â€“fs-xs);color:#8a7248;line-height:1.45;margin-bottom:7px;}
.cls-stats{display:flex;gap:5px;flex-wrap:wrap;}
.cls-stat{font-size:var(â€“fs-xs);color:#b8a060;background:rgba(0,0,0,.4);border:1px solid var(â€“border2);border-radius:3px;padding:2px 6px;}
.cls-foot{flex-shrink:0;padding:var(â€“sp-sm) var(â€“sp-md);background:var(â€“panel);border-top:2px solid var(â€“border2);}
.cls-go{width:100%;padding:13px;font-family:â€˜Cinzelâ€™,serif;font-size:var(â€“fs-md);font-weight:700;letter-spacing:3px;color:#1a0e00;background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);border:none;border-radius:5px;cursor:pointer;min-height:48px;box-shadow:0 4px 0 #5a3a00;transition:all .12s;}
.cls-go:disabled{opacity:.2;pointer-events:none;}
.cls-go:active{transform:translateY(2px);box-shadow:0 2px 0 #5a3a00;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
MAIN GAME â€” TRUE RESPONSIVE LAYOUT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#s2{background:var(â€“bg);overflow:hidden;}

/* Default: phone portrait */
#s2{flex-direction:column;}
#game-left{display:contents;}
#game-right{display:contents;}

/* Tablet landscape / desktop: side-by-side */
@media (min-width:700px) and (orientation:landscape),(min-width:900px){
#s2{flex-direction:row !important;align-items:stretch;}
#game-left{display:flex !important;flex-direction:column;width:min(420px,42vw);flex-shrink:0;border-right:2px solid var(â€“border2);overflow:hidden;height:100%;}
#game-right{display:flex !important;flex-direction:column;flex:1;min-width:0;overflow:hidden;height:100%;}
#tab-body{flex:1;min-height:0;overflow-y:auto;}
.q-list,.boon-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:var(â€“sp-md);}
.story-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:var(â€“sp-md);}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:var(â€“sp-md);}
.cls-list{grid-template-columns:repeat(auto-fill,minmax(300px,1fr));}
#arena-wrap{flex:1 !important;height:auto !important;}
}
@media (min-width:1300px){
#game-left{width:min(460px,36vw);}
.q-list,.boon-list{grid-template-columns:repeat(3,1fr);}
}

/* â”€â”€ HUD â”€â”€ */
#hud{flex-shrink:0;padding:max(10px,env(safe-area-inset-top,10px)) var(â€“sp-md) 10px;background:linear-gradient(180deg,var(â€“panel) 0%,rgba(19,17,26,.95) 100%);border-bottom:2px solid var(â€“border2);box-shadow:0 3px 16px rgba(0,0,0,.7);display:grid;grid-template-columns:44px 1fr auto;align-items:center;gap:var(â€“sp-sm);}
#hud-av{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle at 40% 35%,#252030,#0c0a14);border:2px solid var(â€“border3);display:flex;align-items:center;justify-content:center;font-size:1.3rem;box-shadow:0 0 12px rgba(106,100,144,.3);}
#hud-bars{display:flex;flex-direction:column;gap:4px;}
.br{display:flex;align-items:center;gap:5px;}
.br-ico{font-size:.7rem;width:13px;flex-shrink:0;}
.br-track{flex:1;height:8px;background:rgba(0,0,0,.7);border-radius:5px;overflow:hidden;border:1px solid rgba(255,255,255,.05);}
.br-fill{height:100%;border-radius:5px;transition:width .35s ease;position:relative;overflow:hidden;}
.br-fill::after{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:45%;background:rgba(255,255,255,.18);border-radius:5px 5px 0 0;}
.br-fill.hp{background:linear-gradient(90deg,#700808,#c02020 30%,#e84040 70%,#ff6060 100%);}
.br-fill.mp{background:linear-gradient(90deg,#080c50,#1830a0 30%,#3858d8 70%,#6090ff 100%);}
.br-fill.xp{background:linear-gradient(90deg,#082808,#156015 30%,#28a028 70%,#50d050 100%);}
.br-val{font-size:var(â€“fs-xs);color:var(â€“txt3);width:56px;text-align:right;flex-shrink:0;white-space:nowrap;}
#hud-right{text-align:right;}
#hud-gold{font-size:var(â€“fs-sm);color:var(â€“gold);display:flex;align-items:center;justify-content:flex-end;gap:4px;text-shadow:0 0 8px var(â€“goldglow);}
#hud-lv{font-size:var(â€“fs-xs);color:var(â€“txtdim);margin-top:2px;}
#hud-zb{font-size:var(â€“fs-xs);color:#e08830;background:rgba(180,90,20,.15);border:1px solid rgba(180,90,20,.3);border-radius:3px;padding:2px 6px;margin-top:3px;display:inline-block;}

/* â”€â”€ STORY TICKER â”€â”€ */
#story-ticker{flex-shrink:0;height:26px;background:linear-gradient(90deg,#0c0910,#141020,#0c0910);border-bottom:1px solid var(â€“border);overflow:hidden;display:flex;align-items:center;padding:0 var(â€“sp-md);gap:8px;}
#story-ico{font-size:.72rem;flex-shrink:0;}
#story-txt{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:.78rem;color:#a08848;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}

/* â”€â”€ ARENA â”€â”€ */
#arena-wrap{flex-shrink:0;height:clamp(140px,26vh,220px);position:relative;background:#050408;overflow:hidden;border-bottom:2px solid var(â€“border);}
#arena-cv{position:absolute;inset:0;width:100%;height:100%;display:block;}
#arena-ov{position:absolute;inset:0;pointer-events:none;z-index:10;}
#zone-prog{position:absolute;top:0;left:0;right:0;height:3px;z-index:15;background:rgba(0,0,0,.5);}
#zone-prog-fill{height:100%;background:linear-gradient(90deg,rgba(90,70,10,.6),var(â€“gold));box-shadow:0 0 6px var(â€“goldglow);transition:width .5s ease;}
#btn-auto{position:absolute;bottom:8px;left:8px;z-index:20;background:rgba(10,9,16,.85);border:1.5px solid var(â€“border2);border-radius:16px;color:var(â€“txtdim);font-family:â€˜Cinzelâ€™,serif;font-size:.6rem;letter-spacing:1.5px;padding:6px 12px;cursor:pointer;min-height:32px;transition:all .2s;backdrop-filter:blur(4px);}
#btn-auto.on{border-color:var(â€“green);color:var(â€“green);box-shadow:0 0 12px rgba(48,192,80,.35);}
#btn-zone-lbl{position:absolute;bottom:8px;left:50%;transform:translateX(-50%);z-index:20;background:rgba(10,9,16,.85);border:1.5px solid var(â€“border3);border-radius:16px;color:var(â€“gold);font-family:â€˜Cinzelâ€™,serif;font-size:.6rem;letter-spacing:1px;padding:6px 12px;min-height:32px;white-space:nowrap;display:flex;align-items:center;gap:5px;cursor:pointer;backdrop-filter:blur(4px);box-shadow:0 0 10px var(â€“goldglow);}
#btn-attack{position:absolute;bottom:8px;right:8px;z-index:20;width:62px;height:62px;border-radius:50%;background:radial-gradient(circle at 35% 30%,#e85030,#b82818,#780810);border:3px solid #d4a020;display:flex;align-items:center;justify-content:center;font-size:1.5rem;cursor:pointer;box-shadow:0 4px 24px rgba(200,60,20,.7),0 0 40px rgba(200,60,20,.2),inset 0 1px 0 rgba(255,255,255,.25);transition:transform .1s,box-shadow .1s;}
#btn-attack::before{content:â€™â€™;position:absolute;width:70%;height:40%;top:8%;border-radius:50%;background:radial-gradient(ellipse,rgba(255,255,255,.18),transparent);}
#btn-attack:active{transform:scale(.87);}

/* â”€â”€ TABS â”€â”€ */
#tabs{flex-shrink:0;display:grid;grid-template-columns:repeat(5,1fr);background:var(â€“panel);border-top:2px solid var(â€“border2);border-bottom:2px solid var(â€“border);}
.tab-btn{padding:7px 2px 6px;display:flex;flex-direction:column;align-items:center;gap:3px;cursor:pointer;border-right:1px solid var(â€“border);transition:background .18s;position:relative;}
.tab-btn:last-child{border-right:none;}
.tab-btn.on{background:linear-gradient(180deg,var(â€“panel3),var(â€“panel2));border-bottom:2px solid var(â€“gold);}
.tab-ico{font-size:1.05rem;line-height:1;}
.tab-lbl{font-size:.5rem;color:var(â€“txtdim);letter-spacing:.5px;text-transform:uppercase;}
.tab-btn.on .tab-lbl{color:var(â€“gold);}
.tab-dot{position:absolute;top:4px;right:5px;width:7px;height:7px;background:var(â€“red);border-radius:50%;border:1.5px solid var(â€“panel);box-shadow:0 0 6px rgba(232,48,64,.6);}

/* â”€â”€ TAB BODY â”€â”€ */
#tab-body{flex:1;min-height:0;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;background:var(â€“bg);padding-bottom:max(var(â€“sp-md),env(safe-area-inset-bottom,10px));}
#tab-body::-webkit-scrollbar{width:3px;}.#tab-body::-webkit-scrollbar-thumb{background:var(â€“border2);}

/* â”€â”€ SHARED SECTION â”€â”€ */
.sec{padding:var(â€“sp-lg) var(â€“sp-md);}
.sec-hdr{font-size:var(â€“fs-xs);color:var(â€“gold);letter-spacing:4px;text-transform:uppercase;padding-bottom:8px;margin-bottom:var(â€“sp-md);border-bottom:1px solid var(â€“border2);display:flex;align-items:center;justify-content:space-between;text-shadow:0 0 10px var(â€“goldglow);}
.sp-badge{background:linear-gradient(135deg,var(â€“panel3),var(â€“panel4));border:1px solid var(â€“border3);border-radius:12px;padding:3px 12px;font-size:var(â€“fs-sm);color:var(â€“gold);box-shadow:0 0 8px var(â€“goldglow);}
.filter-row{display:flex;gap:6px;margin-bottom:var(â€“sp-md);overflow-x:auto;-webkit-overflow-scrolling:touch;padding-bottom:3px;}
.filter-row::-webkit-scrollbar{display:none;}
.f-btn{flex-shrink:0;padding:5px 12px;border:1.5px solid var(â€“border);border-radius:14px;font-size:var(â€“fs-xs);color:var(â€“txtdim);cursor:pointer;background:var(â€“panel2);letter-spacing:.5px;transition:all .18s;}
.f-btn.on{border-color:var(â€“gold);color:var(â€“gold);background:var(â€“panel3);box-shadow:0 0 10px var(â€“goldglow);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STORY TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.story-list{display:flex;flex-direction:column;gap:var(â€“sp-md);}
.chapter-card{background:linear-gradient(135deg,var(â€“panel2),var(â€“panel3));border:2px solid var(â€“border);border-radius:10px;overflow:hidden;position:relative;box-shadow:0 3px 14px rgba(0,0,0,.5);}
.chapter-card.active{border-color:var(â€“border3);}
.chapter-card.complete{border-color:#1e5820;}
.chapter-card.locked{opacity:.3;}
.chapter-card::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:2px;}
.chapter-card.active::before{background:linear-gradient(90deg,transparent,var(â€“gold),transparent);}
.chapter-card.complete::before{background:linear-gradient(90deg,transparent,var(â€“green),transparent);}
.ch-hdr{padding:var(â€“sp-md);display:flex;align-items:center;gap:var(â€“sp-sm);border-bottom:1px solid var(â€“border);}
.ch-num{font-size:var(â€“fs-xs);color:var(â€“golddim,#9a7a20);letter-spacing:2px;text-transform:uppercase;flex-shrink:0;}
.ch-ico{font-size:1.4rem;flex-shrink:0;}
.ch-info{flex:1;min-width:0;}
.ch-title{font-size:var(â€“fs-md);color:#f0d868;font-weight:700;}
.ch-zone{font-size:var(â€“fs-xs);color:#8a7040;letter-spacing:1px;margin-top:2px;}
.ch-lock{font-size:var(â€“fs-sm);color:var(â€“txtdim);flex-shrink:0;}
.ch-body{padding:var(â€“sp-md);}
.ch-quote{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:var(â€“fs-sm);color:#8a7040;margin-bottom:8px;border-left:2px solid var(â€“border3);padding-left:10px;line-height:1.5;}
.ch-desc{font-family:â€˜Crimson Textâ€™,serif;font-size:var(â€“fs-sm);color:#9a8050;line-height:1.6;margin-bottom:10px;}
.ch-objs{display:flex;flex-direction:column;gap:6px;margin-bottom:10px;}
.ch-obj{display:flex;align-items:center;gap:7px;}
.ch-obj-ico{font-size:var(â€“fs-sm);width:16px;flex-shrink:0;}
.ch-obj-txt{font-size:var(â€“fs-xs);color:#a88c50;flex:1;}
.ch-obj-bar{height:4px;flex:1;background:rgba(255,255,255,.05);border-radius:3px;overflow:hidden;}
.ch-obj-fill{height:100%;background:linear-gradient(90deg,#9a7a20,var(â€“gold));border-radius:3px;transition:width .5s;}
.ch-obj-val{font-size:var(â€“fs-xs);color:#9a7a20;white-space:nowrap;}
.ch-rew{font-size:var(â€“fs-xs);color:var(â€“gold);padding:7px var(â€“sp-md);background:rgba(240,192,48,.05);border-top:1px solid var(â€“border);display:flex;align-items:center;gap:7px;}
.ch-complete{font-size:var(â€“fs-xs);color:var(â€“green2);padding:7px var(â€“sp-md);background:rgba(48,192,80,.05);border-top:1px solid #1a4810;display:flex;align-items:center;gap:6px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
SKILLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sk-tree-tabs{display:grid;grid-template-columns:repeat(5,1fr);gap:5px;margin-bottom:var(â€“sp-lg);}
.sk-tree-tab{padding:7px 2px;text-align:center;background:linear-gradient(180deg,var(â€“panel2),var(â€“panel));border:1.5px solid var(â€“border);border-radius:7px;font-size:var(â€“fs-xs);color:var(â€“txtdim);cursor:pointer;transition:all .18s;min-height:44px;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:3px;}
.sk-tree-tab span:first-child{font-size:1.0rem;}
.sk-tree-tab.on{background:linear-gradient(180deg,var(â€“panel4),var(â€“panel3));border-color:var(â€“gold);color:var(â€“gold);box-shadow:0 0 12px var(â€“goldglow);}
.sk-tier-wrap{display:flex;flex-direction:column;}
.sk-connector{height:16px;position:relative;margin:0 8px;}
.sk-connector::before{content:â€™â€™;position:absolute;top:0;left:50%;width:1px;height:100%;background:var(â€“border3);}
.sk-connector.fork::before{display:none;}
.sk-connector.fork::after{content:â€™â€™;position:absolute;top:0;left:25%;right:25%;height:50%;border:1px solid var(â€“border3);border-top:none;}
.sk-row{display:grid;gap:8px;}
.sk-row-1{grid-template-columns:minmax(0,1fr);max-width:180px;margin:0 auto;}
.sk-row-2{grid-template-columns:1fr 1fr;}
.sk-row-3{grid-template-columns:1fr 1fr 1fr;}
.sk-card{background:linear-gradient(180deg,var(â€“panel2),var(â€“panel));border:2px solid var(â€“border);border-radius:8px;padding:10px 8px;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:4px;text-align:center;position:relative;transition:border-color .18s,background .18s,transform .1s;min-height:110px;box-shadow:0 2px 10px rgba(0,0,0,.5);}
.sk-card.unlocked{border-color:var(â€“border3);background:linear-gradient(180deg,var(â€“panel3),var(â€“panel2));}
.sk-card.maxed{border-color:var(â€“gold);background:linear-gradient(180deg,#201a08,#18140a);box-shadow:0 0 16px var(â€“goldglow);}
.sk-card.locked{opacity:.28;pointer-events:none;}
.sk-card.capstone{border-style:dashed;}
.sk-card.capstone.maxed{border-style:solid;}
.sk-card:active:not(.locked){transform:scale(.96);}
.sk-ico{width:44px;height:44px;border-radius:50%;background:radial-gradient(circle at 40% 35%,var(â€“panel3),var(â€“panel));border:2px solid var(â€“border);display:flex;align-items:center;justify-content:center;font-size:1.25rem;transition:all .18s;}
.sk-card.maxed .sk-ico{border-color:var(â€“gold);box-shadow:0 0 16px var(â€“goldglow);}
.sk-name{font-size:var(â€“fs-xs);color:#e8d870;font-weight:700;line-height:1.2;}
.sk-desc{font-size:.58rem;color:#9a8050;font-style:italic;line-height:1.35;}
.sk-pips{display:flex;gap:2.5px;flex-wrap:wrap;justify-content:center;margin-top:2px;}
.pip{width:8px;height:3px;border-radius:2px;background:#0e0c18;border:1px solid rgba(255,255,255,.04);}
.pip.on{background:#c09828;box-shadow:0 0 4px rgba(192,152,40,.5);}
.pip.onmax{background:var(â€“gold);box-shadow:0 0 6px var(â€“goldglow);}
.sk-rank{font-size:var(â€“fs-xs);color:var(â€“gold);}
.sk-cap-tag{position:absolute;top:2px;right:4px;font-size:.42rem;color:#c0a040;letter-spacing:.4px;text-transform:uppercase;}
.sk-req-warn{font-size:.54rem;color:var(â€“red);margin-top:1px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
QUESTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.q-list{display:flex;flex-direction:column;gap:var(â€“sp-md);}
.q-card{background:linear-gradient(135deg,var(â€“panel2),var(â€“panel3));border:2px solid var(â€“border);border-radius:10px;padding:var(â€“sp-md);display:flex;gap:var(â€“sp-md);align-items:flex-start;transition:border-color .18s;box-shadow:0 2px 12px rgba(0,0,0,.45);}
.q-card.in-progress{border-color:var(â€“border3);}
.q-card.done{border-color:#1a4818;background:linear-gradient(135deg,#0e1510,#121a10);}
.q-ico{width:44px;height:44px;border-radius:8px;flex-shrink:0;background:radial-gradient(circle at 40% 35%,var(â€“panel3),var(â€“panel));border:2px solid var(â€“border);display:flex;align-items:center;justify-content:center;font-size:1.2rem;}
.q-body{flex:1;min-width:0;}
.q-name{font-size:var(â€“fs-sm);color:#e8d870;font-weight:700;margin-bottom:3px;}
.q-cat{font-size:var(â€“fs-xs);color:#9a7a20;letter-spacing:1.5px;text-transform:uppercase;margin-bottom:3px;}
.q-desc{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:var(â€“fs-xs);color:#a07c48;line-height:1.45;margin-bottom:6px;}
.q-bar-wrap{height:5px;background:rgba(0,0,0,.5);border-radius:3px;overflow:hidden;margin-bottom:4px;}
.q-bar{height:100%;background:linear-gradient(90deg,#9a7a20,var(â€“gold));border-radius:3px;transition:width .5s;}
.q-prog{font-size:var(â€“fs-xs);color:var(â€“txtdim);}
.q-rew{display:flex;gap:5px;flex-wrap:wrap;margin-top:4px;}
.q-rew-tag{font-size:var(â€“fs-xs);color:var(â€“gold);background:rgba(240,192,48,.08);border:1px solid rgba(240,192,48,.2);border-radius:3px;padding:2px 7px;}
.q-done-lbl{font-size:var(â€“fs-xs);color:var(â€“green2);letter-spacing:.5px;margin-top:3px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
BOONS â€” UPGRADEABLE SYSTEM
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.boon-list{display:flex;flex-direction:column;gap:var(â€“sp-md);}

.boon-card{
background:linear-gradient(135deg,var(â€“panel2),var(â€“panel3));
border:2px solid var(â€“border);border-radius:12px;
padding:var(â€“sp-md);position:relative;overflow:hidden;
transition:border-color .18s,background .18s,box-shadow .18s;
box-shadow:0 2px 12px rgba(0,0,0,.45);
}
.boon-card.owned{border-color:#1a5020;}
.boon-card.elite{border-color:#4a1870;}
.boon-card.elite.owned{border-color:#3a1060;}
.boon-card.maxed{border-color:var(â€“gold);background:linear-gradient(135deg,#1c1608,#241c0a);box-shadow:0 0 20px var(â€“goldglow);}

.boon-rar{position:absolute;top:0;right:0;font-size:.48rem;letter-spacing:.5px;text-transform:uppercase;padding:4px 9px;border-radius:0 10px 0 5px;}
.boon-rar.common{background:rgba(50,100,50,.35);color:#70c070;}
.boon-rar.rare{background:rgba(20,60,200,.35);color:#6898f0;}
.boon-rar.epic{background:rgba(100,20,200,.35);color:#a068f0;}
.boon-rar.legendary{background:rgba(190,100,0,.35);color:#e0a030;}

.boon-main{display:flex;gap:var(â€“sp-md);align-items:flex-start;}
.boon-ico{width:46px;height:46px;border-radius:10px;flex-shrink:0;background:radial-gradient(circle at 40% 35%,var(â€“panel3),var(â€“panel));border:2px solid var(â€“border2);display:flex;align-items:center;justify-content:center;font-size:1.4rem;box-shadow:inset 0 2px 8px rgba(0,0,0,.7);transition:border-color .3s,box-shadow .3s;}
.boon-card.owned .boon-ico{border-color:#285028;box-shadow:inset 0 2px 8px rgba(0,0,0,.5),0 0 8px rgba(48,160,80,.2);}
.boon-card.maxed .boon-ico{border-color:var(â€“gold);box-shadow:inset 0 2px 8px rgba(0,0,0,.4),0 0 12px var(â€“goldglow);}

.boon-body{flex:1;min-width:0;}
.boon-name{font-size:var(â€“fs-sm);color:#e8d870;font-weight:700;margin-bottom:2px;}
.boon-desc{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:var(â€“fs-xs);color:#a07c48;line-height:1.45;margin-bottom:6px;}

/* Tier indicator */
.boon-tier-row{display:flex;align-items:center;gap:6px;margin-bottom:6px;}
.boon-tier-pips{display:flex;gap:3px;}
.boon-tier-pip{width:14px;height:6px;border-radius:3px;background:#0e0c18;border:1px solid rgba(255,255,255,.06);transition:background .3s,box-shadow .3s;}
.boon-tier-pip.filled{background:linear-gradient(90deg,#9a7a20,#f0c030);box-shadow:0 0 4px rgba(240,192,48,.4);}
.boon-tier-pip.filled.max{background:linear-gradient(90deg,#f0c030,#ffe090);box-shadow:0 0 8px rgba(240,192,48,.8);}
.boon-tier-label{font-size:var(â€“fs-xs);color:var(â€“gold);letter-spacing:1px;}
.boon-tier-label.maxed-lbl{color:#50d080;}

/* Upgrade button row */
.boon-upgrade-row{display:flex;gap:8px;align-items:center;flex-wrap:wrap;}
.boon-buy-btn,.boon-upgrade-btn{
font-family:â€˜Cinzelâ€™,serif;font-size:.62rem;font-weight:700;letter-spacing:1px;
border:none;border-radius:5px;padding:7px 14px;cursor:pointer;min-height:32px;
transition:all .14s;
}
.boon-buy-btn{
background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);
color:#1a0e00;box-shadow:0 3px 0 #5a3a00;flex-shrink:0;
}
.boon-buy-btn:disabled{opacity:.25;pointer-events:none;}
.boon-buy-btn:active{transform:translateY(2px);box-shadow:0 1px 0 #5a3a00;}
.boon-upgrade-btn{
background:linear-gradient(180deg,#8060c0,#5030a0,#2c1060);
color:#e0d0ff;box-shadow:0 3px 0 #1a0848;flex-shrink:0;
}
.boon-upgrade-btn:disabled{opacity:.25;pointer-events:none;}
.boon-upgrade-btn:active{transform:translateY(2px);box-shadow:0 1px 0 #1a0848;}
.boon-upgrade-btn.epic-color{background:linear-gradient(180deg,#c060e0,#9030c0,#500880);box-shadow:0 3px 0 #300448;}
.boon-upgrade-btn.legendary-color{background:linear-gradient(180deg,#f0c030,#c08010,#7a5010);color:#1a0e00;box-shadow:0 3px 0 #5a3a00;}

.boon-cost-info{font-size:var(â€“fs-xs);color:var(â€“gold);}
.boon-own-lbl{font-size:var(â€“fs-xs);color:var(â€“green2);}
.boon-stat-preview{font-size:.6rem;color:#a090d0;font-style:italic;padding:4px 8px;background:rgba(100,60,160,.1);border:1px solid rgba(100,60,160,.2);border-radius:4px;margin-top:4px;display:inline-block;}
.boon-maxed-lbl{font-size:var(â€“fs-xs);color:var(â€“gold);font-weight:700;text-shadow:0 0 6px var(â€“goldglow);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.stat-grp{background:linear-gradient(135deg,var(â€“panel2),var(â€“panel3));border:2px solid var(â€“border);border-radius:10px;padding:var(â€“sp-md);margin-bottom:var(â€“sp-md);}
.stat-grp-title{font-size:var(â€“fs-xs);color:var(â€“gold);letter-spacing:2.5px;margin-bottom:8px;padding-bottom:7px;border-bottom:1px solid var(â€“border2);text-shadow:0 0 8px var(â€“goldglow);}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid rgba(255,255,255,.03);}
.stat-row:last-child{border-bottom:none;}
.stat-lbl{font-size:var(â€“fs-sm);color:var(â€“txt3);}
.stat-val{font-size:var(â€“fs-sm);color:#e8d870;font-weight:700;}
.prestige-box{background:linear-gradient(135deg,#14100c,#1e1810,#14100c);border:2px solid var(â€“border3);border-radius:10px;padding:var(â€“sp-lg);margin-bottom:var(â€“sp-sm);box-shadow:0 4px 20px rgba(0,0,0,.5);position:relative;overflow:hidden;}
.prestige-box::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:1px;background:linear-gradient(90deg,transparent,#9a7a20,transparent);}
.pres-title{font-size:var(â€“fs-md);color:var(â€“gold);margin-bottom:7px;}
.pres-desc{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:var(â€“fs-sm);color:#b08c58;line-height:1.6;margin-bottom:7px;}
.pres-warn{font-size:var(â€“fs-xs);color:var(â€“red);margin-bottom:var(â€“sp-md);padding:6px 12px;background:rgba(200,30,30,.08);border:1px solid rgba(200,30,30,.2);border-radius:5px;}
.btn-prestige{width:100%;padding:13px;font-family:â€˜Cinzelâ€™,serif;font-size:var(â€“fs-md);font-weight:700;letter-spacing:2px;color:#1a0e00;background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);border:none;border-radius:5px;cursor:pointer;min-height:48px;box-shadow:0 4px 0 #5a3a00;transition:all .12s;}
.btn-prestige:active{transform:translateY(2px);box-shadow:0 2px 0 #5a3a00;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
DAMAGE NUMBERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.dmg-num{position:absolute;pointer-events:none;font-family:â€˜Cinzelâ€™,serif;font-size:.9rem;font-weight:700;animation:floatup .85s ease-out forwards;white-space:nowrap;text-shadow:0 1px 4px #000,0 0 10px rgba(0,0,0,.95);}
.dmg-num.crit{font-size:1.15rem;color:#ffe040;text-shadow:0 0 12px rgba(255,224,64,.8),0 1px 4px #000;}
.dmg-num.hit{color:#ff6858;}
.dmg-num.heal{color:#50e870;font-size:.8rem;}
.dmg-num.enemy{color:#ff9050;}
.dmg-num.dodge{color:#80d8ff;font-size:.74rem;}
.dmg-num.spell{color:#c878f8;}
.dmg-num.special{color:#ffd868;font-size:1.1rem;}
@keyframes floatup{0%{opacity:1;transform:translateY(0) scale(1.1);}15%{transform:translateY(-8px) scale(1.2);}60%{opacity:1;}100%{opacity:0;transform:translateY(-62px) scale(.72);}}

/* â”€â”€ LEVEL UP â”€â”€ */
#lvlup{position:fixed;inset:0;z-index:500;pointer-events:none;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:7px;opacity:0;transition:opacity .28s;}
#lvlup.show{opacity:1;}
.lvlup-txt{font-family:â€˜Cinzel Decorativeâ€™,serif;font-weight:700;font-size:clamp(1.4rem,4vw,2rem);color:var(â€“gold);text-shadow:0 0 30px var(â€“gold),0 0 60px rgba(200,60,20,.8);animation:lvlpop .78s ease-out forwards;}
.lvlup-sub{font-size:.74rem;color:#a08838;letter-spacing:3px;animation:lvlpop .78s ease-out .12s both;}
@keyframes lvlpop{0%{transform:scale(.35);opacity:0;}55%{transform:scale(1.2);}74%{transform:scale(.93);}100%{transform:scale(1);opacity:1;}}

/* â”€â”€ TOAST â”€â”€ */
#toast{position:fixed;top:max(60px,env(safe-area-inset-top,60px));left:50%;transform:translateX(-50%) translateY(-18px);background:linear-gradient(135deg,var(â€“panel2),var(â€“panel3));border:2px solid var(â€“border3);border-radius:6px;padding:9px 16px;font-family:â€˜Cinzelâ€™,serif;font-size:var(â€“fs-xs);color:var(â€“gold);opacity:0;transition:opacity .22s,transform .22s;z-index:900;pointer-events:none;white-space:nowrap;letter-spacing:1px;box-shadow:0 4px 28px rgba(0,0,0,.9),0 0 16px var(â€“goldglow);max-width:92vw;overflow:hidden;text-overflow:ellipsis;}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* â”€â”€ MODAL â”€â”€ */
#modal{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:800;display:none;align-items:center;justify-content:center;padding:var(â€“sp-md);backdrop-filter:blur(4px);}
#modal.open{display:flex;}
.modal-box{background:linear-gradient(160deg,var(â€“panel2),var(â€“panel3));border:2px solid var(â€“border3);border-radius:12px;padding:24px 20px;width:100%;max-width:min(460px,94vw);text-align:center;box-shadow:0 10px 50px rgba(0,0,0,.95);position:relative;overflow:hidden;}
.modal-box::before{content:â€™â€™;position:absolute;top:0;left:0;right:0;height:2px;background:linear-gradient(90deg,transparent,var(â€“border3),transparent);}
.modal-title{font-size:var(â€“fs-lg);color:var(â€“gold);margin-bottom:10px;text-shadow:0 0 12px var(â€“goldglow);}
.modal-body{font-family:â€˜Crimson Textâ€™,serif;font-style:italic;font-size:var(â€“fs-sm);color:#b89858;line-height:1.7;margin-bottom:9px;}
.modal-warn{font-size:var(â€“fs-xs);color:var(â€“red);margin-bottom:var(â€“sp-md);padding:6px 12px;background:rgba(200,30,30,.08);border:1px solid rgba(200,30,30,.2);border-radius:5px;}
.modal-btns{display:flex;gap:10px;}
.m-btn{flex:1;padding:12px;border:none;border-radius:5px;cursor:pointer;font-family:â€˜Cinzelâ€™,serif;font-size:var(â€“fs-sm);font-weight:700;letter-spacing:1.5px;min-height:48px;transition:all .12s;}
.m-btn.go{background:linear-gradient(180deg,#ffe080,#d4a020,#8a6010);color:#1a0e00;box-shadow:0 4px 0 #5a3a00;}
.m-btn.go:active{transform:translateY(2px);}
.m-btn.cancel{background:var(â€“panel3);color:var(â€“txt3);border:2px solid var(â€“border2);}

@media(max-height:600px){
.t-lore,.t-divider{display:none;}
.ch-desc,.cls-lore{display:none;}
.tab-lbl{display:none;}
}
</style>

</head>
<body>
<div id="app">

<!-- â•â•â•â•â•â• TITLE â•â•â•â•â•â• -->

<div class="scr on" id="s0">
  <canvas id="s0-cv"></canvas>
  <div class="t-body">
    <div class="t-crest">ğŸ°</div>
    <div class="t-title">ASHEN<br>THRONE</div>
    <div class="t-divider"><div class="t-line"></div><span class="t-divider-ico">âœ¦</span><div class="t-line"></div></div>
    <div class="t-sub">Gothic Idle RPG</div>
    <div class="t-lore">"The realm lies shattered beneath an ashen sky. One warrior must reclaim what was taken â€” or burn alongside everything else."</div>
    <div class="t-btns">
      <button class="t-btn" onclick="gotoClassSelect()">âš” ENTER THE REALM</button>
      <button class="t-btn-sec" onclick="clearSavePrompt()">â†º New Game</button>
    </div>
    <div class="t-hint">Progress saves automatically</div>
  </div>
</div>

<!-- â•â•â•â•â•â• CLASS SELECT â•â•â•â•â•â• -->

<div class="scr" id="s1">
  <div class="page-hdr">
    <div class="page-hdr-title">â€” CHOOSE YOUR PATH â€”</div>
    <div class="page-hdr-sub">"Destiny is not given. It is forged."</div>
  </div>
  <div class="cls-list" id="cls-list"></div>
  <div class="cls-foot">
    <button class="cls-go" id="cls-go-btn" disabled onclick="confirmClass()">BEGIN YOUR JOURNEY</button>
  </div>
</div>

<!-- â•â•â•â•â•â• MAIN GAME â•â•â•â•â•â• -->

<div class="scr" id="s2">
  <div id="game-left">
    <div id="hud">
      <div id="hud-av">âš”</div>
      <div id="hud-bars">
        <div class="br"><span class="br-ico" style="color:#ff6060">â™¥</span><div class="br-track"><div class="br-fill hp" id="b-hp" style="width:100%"></div></div><span class="br-val" id="v-hp">100/100</span></div>
        <div class="br"><span class="br-ico" style="color:#6090ff">âœ¦</span><div class="br-track"><div class="br-fill mp" id="b-mp" style="width:100%"></div></div><span class="br-val" id="v-mp">50/50</span></div>
        <div class="br"><span class="br-ico" style="color:#50d050">â˜…</span><div class="br-track"><div class="br-fill xp" id="b-xp" style="width:0%"></div></div><span class="br-val" id="v-xp">0/100</span></div>
      </div>
      <div id="hud-right">
        <div id="hud-gold">ğŸ’° <span id="hud-gold-val">0</span></div>
        <div id="hud-lv">Lv.<span id="hud-lv-val">1</span> Â· <span id="hud-cls-name">?</span></div>
        <div id="hud-zb">Zone <span id="hud-zone-val">1</span></div>
      </div>
    </div>
    <div id="story-ticker">
      <span id="story-ico">ğŸ“œ</span>
      <span id="story-txt">Your journey begins...</span>
    </div>
    <div id="arena-wrap">
      <canvas id="arena-cv"></canvas>
      <div id="arena-ov"></div>
      <div id="zone-prog"><div id="zone-prog-fill" style="width:0%"></div></div>
      <button id="btn-auto" onclick="toggleAuto()">AUTO OFF</button>
      <div id="btn-zone-lbl">ğŸ“ <span id="zone-name-lbl">Ashen Fields</span></div>
      <button id="btn-attack" ontouchstart="doAttackTouch(event)" onmousedown="doAttackTouch(event)">âš”</button>
    </div>
    <div id="tabs">
      <div class="tab-btn on" id="tb-story" onclick="openTab('story')"><span class="tab-ico">ğŸ“–</span><span class="tab-lbl">Story</span></div>
      <div class="tab-btn" id="tb-skills" onclick="openTab('skills')"><span class="tab-ico">âš”</span><span class="tab-lbl">Skills</span></div>
      <div class="tab-btn" id="tb-quests" onclick="openTab('quests')"><span class="tab-ico">ğŸ“œ</span><span class="tab-lbl">Quests</span></div>
      <div class="tab-btn" id="tb-boons" onclick="openTab('boons')"><span class="tab-ico">âš—</span><span class="tab-lbl">Boons</span></div>
      <div class="tab-btn" id="tb-stats" onclick="openTab('stats')"><span class="tab-ico">ğŸ“Š</span><span class="tab-lbl">Stats</span></div>
    </div>
  </div>
  <div id="game-right">
    <div id="tab-body"></div>
  </div>
</div>

</div><!-- #app -->

<div id="lvlup"><div class="lvlup-txt" id="lvlup-txt">LEVEL UP!</div><div class="lvlup-sub">+1 SKILL POINT</div></div>
<div id="toast"></div>
<div id="modal">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Confirm</div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-warn" id="modal-warn"></div>
    <div class="modal-btns">
      <button class="m-btn go" id="modal-ok">Confirm</button>
      <button class="m-btn cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   AUDIO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let AC=null,audioOn=false;
function initAudio(){if(AC)return;try{AC=new(window.AudioContext||window.webkitAudioContext)();audioOn=true;}catch(e){}}
function tone(f,t,d,v,dl=0){if(!AC||!audioOn)return;const o=AC.createOscillator(),g=AC.createGain();o.connect(g);g.connect(AC.destination);o.type=t;o.frequency.value=f;const ts=AC.currentTime+dl;g.gain.setValueAtTime(v,ts);g.gain.exponentialRampToValueAtTime(.001,ts+d);o.start(ts);o.stop(ts+d+.01);}
function noise(d,v,dl=0){if(!AC||!audioOn)return;const b=AC.createBuffer(1,AC.sampleRate*d,AC.sampleRate);const da=b.getChannelData(0);for(let i=0;i<da.length;i++)da[i]=Math.random()*2-1;const s=AC.createBufferSource(),g=AC.createGain();s.buffer=b;s.connect(g);g.connect(AC.destination);const ts=AC.currentTime+dl;g.gain.setValueAtTime(v,ts);g.gain.exponentialRampToValueAtTime(.001,ts+d);s.start(ts);}
const SFX={
  hit(){noise(.042,.16);tone(155,'square',.042,.07,.018)},
  crit(){tone(340,'square',.036,.16);tone(680,'square',.036,.13,.036);tone(1020,'square',.036,.1,.072)},
  die(){tone(190,'sawtooth',.08,.14);tone(130,'sawtooth',.12,.11,.06);tone(95,'sawtooth',.18,.09,.12)},
  kill(){tone(430,'square',.036,.13);tone(340,'square',.036,.11,.036);tone(240,'square',.065,.09,.072)},
  lvlup(){[380,480,600,760,960].forEach((f,i)=>tone(f,'square',.08,.17,i*.08))},
  gold(){tone(860,'sine',.042,.09);tone(1290,'sine',.036,.07,.042)},
  skill(){tone(620,'triangle',.055,.12);tone(930,'triangle',.075,.09,.045)},
  quest(){[510,640,770,640,770,960].forEach((f,i)=>tone(f,'square',.055,.14,i*.062))},
  prestige(){[210,315,420,525,630,840,1050].forEach((f,i)=>tone(f,'square',.1,.19,i*.086))},
  hurt(){tone(180,'sawtooth',.052,.11);noise(.036,.065,.018)},
  chapter(){[300,400,500,650,820].forEach((f,i)=>tone(f,'square',.1,.19,i*.1))},
  boon(){[500,700,900].forEach((f,i)=>tone(f,'triangle',.08,.15,i*.06))},
  upgrade(){[600,800,1000,1300].forEach((f,i)=>tone(f,'triangle',.07,.14,i*.055))},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   32-BIT SPRITES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const PX=3;
function drawSprite32(ctx,sprite,ox,oy,scale=1){
  sprite.forEach((row,ry)=>row.forEach((c,rx)=>{
    if(!c||c==='.')return;
    ctx.fillStyle=c;
    ctx.fillRect(ox+rx*PX*scale,oy+ry*PX*scale,PX*scale,PX*scale);
  }));
}
const SPR32={
  warrior(p){const H=p.helm,Hs=p.helmShad,Hh=p.helmHl,S=p.skin,Ss=p.skinShad,Sh=p.skinHl,A=p.armor,As=p.armorShad,Ah=p.armorHl,B=p.belt;return[[0,0,H,H,H,H,0,0,0],[0,H,Hs,A,A,Hs,H,0,0],[0,0,S,Sh,S,S,Ss,0,0],[0,0,S,p.e,Sh,p.e,Ss,0,0],[0,0,Ss,S,Sh,S,Ss,0,0],[As,A,Ah,B,B,B,Ah,A,As],[A,Ah,A,Ah,A,Ah,A,As,A],[0,A,Ah,A,Ah,A,As,A,0],[0,A,As,Ah,As,Ah,As,A,0],[0,As,A,0,0,0,A,As,0],[0,A,As,0,0,0,As,A,0],[0,As,A,0,0,0,A,As,0]];},
  mage(p){const R=p.robe,Rs=p.robeShad,Rh=p.robeHl,S=p.skin,Ss=p.skinShad,Sh=p.skinHl,H=p.hat,Hs=p.hatShad,G=p.gem,Ga=p.gemAlt;return[[0,H,Hs,H,H,Hs,H,0,0],[0,0,S,Sh,S,Ss,Ss,0,0],[0,0,S,p.e,Sh,p.e,Ss,0,0],[0,0,Ss,S,Sh,S,Ss,0,0],[0,Rh,R,Rh,R,Rh,R,Rh,0],[Rh,R,G,R,Rh,G,R,Rs,Rh],[0,Rh,R,Rh,R,Rh,Rs,R,0],[0,R,Rh,Ga,Rh,Ga,R,Rs,0],[0,Rs,R,0,0,0,R,Rs,0],[0,R,Rs,0,0,0,Rs,R,0],[0,Rs,R,0,0,0,R,Rs,0]];},
  rogue(p){const C=p.cloak,Cs=p.cloakShad,Ch=p.cloakHl,S=p.skin,Ss=p.skinShad,Sh=p.skinHl,H=p.hood,Hs=p.hoodShad,Bl=p.blade,Bl2=p.bladeHl;return[[0,H,Hs,H,H,Hs,0,0,0],[Ch,C,S,Sh,S,Cs,0,0,0],[0,0,S,p.e,Sh,Ss,0,0,0],[0,0,Ss,S,Sh,Ss,0,0,0],[0,Ch,C,Ch,C,C,Ch,0,0],[Ch,C,Ch,C,Ch,C,Cs,Bl,0],[0,Ch,C,Ch,C,Ch,C,Bl2,0],[0,C,Ch,Cs,Ch,Cs,Ch,Bl,0],[0,Cs,C,0,0,C,Cs,0,0],[0,C,Cs,0,0,Cs,C,0,0],[0,Cs,C,0,0,C,Cs,0,0]];},
  paladin(p){const A=p.armor,As=p.armorShad,Ah=p.armorHl,S=p.skin,Ss=p.skinShad,Sh=p.skinHl,H=p.helm,Hs=p.helmShad,Hh=p.helmHl,Y=p.holy,Yd=p.holyDim;return[[0,0,H,Hh,H,Hh,H,0,0],[0,H,Hs,A,Ah,A,Hs,H,0],[0,0,S,Sh,Y,Ss,Ss,0,0],[0,0,Ss,Y,Sh,Y,Ss,0,0],[0,0,A,Ah,A,Ah,As,0,0],[As,A,Ah,Y,Yd,Y,Ah,A,As],[A,Ah,A,Ah,Y,Ah,A,As,A],[0,A,Ah,A,Ah,A,As,A,0],[0,A,As,Ah,As,Ah,As,A,0],[0,As,A,0,0,0,A,As,0],[0,A,As,0,0,0,As,A,0],[0,As,A,0,0,0,A,As,0]];},
  ranger(p){const G=p.gear,Gs=p.gearShad,Gh=p.gearHl,S=p.skin,Ss=p.skinShad,Sh=p.skinHl,H=p.hood,Hs=p.hoodShad,Lf=p.leaf,Lfs=p.leafShad;return[[0,H,Hs,H,H,0,0,0,0],[Gh,G,S,Sh,S,Gs,0,0,0],[0,0,S,p.e,Sh,Ss,0,0,0],[0,0,Ss,S,Sh,Ss,0,0,0],[0,Lf,Lfs,G,G,G,Lf,0,0],[Lf,Lfs,G,Gh,G,Gh,G,Gs,0],[0,Lfs,Lf,G,Gh,G,Lf,Lfs,0],[0,G,Gh,Gs,Gh,Gs,Gh,G,0],[0,Gs,G,0,0,G,Gs,0,0],[0,G,Gs,0,0,Gs,G,0,0],[0,Gs,G,0,0,G,Gs,0,0]];}
};
const PAL32={
  warrior:{helm:'#3c3420',helmShad:'#28200e',helmHl:'#584e2c',skin:'#c8845a',skinShad:'#a05e38',skinHl:'#e0a878',armor:'#607090',armorShad:'#404860',armorHl:'#90a8c0',belt:'#d09828',e:'#180c04'},
  mage:{hat:'#16123c',hatShad:'#0a0820',skin:'#c8845a',skinShad:'#a05e38',skinHl:'#e0a878',robe:'#4a1870',robeShad:'#2e0c48',robeHl:'#6e30a0',gem:'#c838f0',gemAlt:'#9020c0',e:'#7020c0'},
  rogue:{hood:'#181214',hoodShad:'#0c0a0e',skin:'#b87050',skinShad:'#904838',skinHl:'#d89878',cloak:'#1e1c22',cloakShad:'#141218',cloakHl:'#302e38',blade:'#d8e0f0',bladeHl:'#f0f8ff',e:'#180c04'},
  paladin:{helm:'#28200c',helmShad:'#181008',helmHl:'#3a2e10',skin:'#c8845a',skinShad:'#a05e38',skinHl:'#e0a878',armor:'#8090b0',armorShad:'#607090',armorHl:'#b0c8d8',holy:'#f0e040',holyDim:'#c8b820',e:'#b89010'},
  ranger:{hood:'#1a2810',hoodShad:'#0e1608',skin:'#b87050',skinShad:'#904838',skinHl:'#d89878',gear:'#3c5828',gearShad:'#283a18',gearHl:'#507838',leaf:'#6a9848',leafShad:'#4a7030',e:'#180c04'},
};
const ENEMIES32={
  rat:{draw(ctx,x,y,sc){const c=['#604020','#803c20','#b06040','#d09870','#201010','#402010'];const p=PX*sc;const sp=[[0,c[0],c[1],0,c[2],0,0],[0,c[2],c[3],c[2],c[3],0,0],[c[0],c[3],c[2],c[3],c[2],c[0],0],[0,c[2],c[3],c[2],c[3],c[1],0],[0,c[1],c[2],c[0],c[1],0,0],[0,c[0],0,c[0],0,0,0]];sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));}},
  skeleton:{draw(ctx,x,y,sc){const c=['#e0d8c0','#c0b8a0','#f0e8d8','#1a1808','#a0988078','#808070'];const p=PX*sc;const sp=[[0,c[2],c[0],c[0],c[0],c[2],0,0],[0,c[0],c[2],c[0],c[2],c[0],0,0],[0,c[0],c[3],c[2],c[3],c[0],0,0],[0,c[0],c[0],c[2],c[0],c[0],0,0],[0,c[2],c[0],c[0],c[0],c[2],0,0],[c[1],c[0],c[1],c[0],c[1],c[0],c[1],0],[0,c[1],c[0],c[0],c[0],c[1],0,0],[0,c[0],c[1],0,c[1],c[0],0,0],[0,c[1],c[0],0,c[0],c[1],0,0]];sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));}},
  zombie:{draw(ctx,x,y,sc){const c=['#607848','#486038','#90b868','#202810','#c8d8a8','#d87868'];const p=PX*sc;const sp=[[0,c[0],c[1],c[0],c[0],c[1],0,0],[0,c[4],c[0],c[4],c[4],c[0],c[4],0],[0,c[0],c[4],c[3],c[4],c[4],c[0],0],[0,c[0],c[3],c[4],c[3],c[4],c[0],0],[0,c[0],c[2],c[2],c[2],c[2],c[0],0],[0,c[1],c[0],c[5],c[5],c[0],c[1],0],[c[1],c[0],c[1],c[0],c[0],c[1],c[0],c[1]],[0,c[1],c[0],c[0],c[0],c[1],0,0],[0,c[0],c[1],0,c[1],c[0],0,0]];sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));}},
  wraith:{draw(ctx,x,y,sc){const c=['#1828b0','#4060d8','#90a8f8','#ffffff','#080828','#c0d8ff'];const p=PX*sc;const sp=[[0,0,c[2],c[1],c[1],c[2],0,0],[0,c[1],c[5],c[2],c[2],c[5],c[1],0],[0,c[1],c[2],c[5],c[2],c[2],c[1],0],[0,c[0],c[1],c[2],c[2],c[1],c[0],0],[0,c[1],c[0],c[1],c[1],c[0],c[1],0],[c[0],c[1],c[0],c[1],c[1],c[0],c[1],c[0]],[0,c[0],c[1],0,0,c[1],c[0],0],[0,0,c[0],0,0,c[0],0,0]];sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));}},
  dragon:{draw(ctx,x,y,sc){const c=['#881010','#c82820','#e83828','#481010','#ffa030','#ffcc60','#ff6010','#602008'];const p=PX*sc;const sp=[[0,0,0,c[3],c[1],c[0],0,0,0,0,c[4],0],[0,0,c[0],c[2],c[2],c[2],c[0],0,0,c[4],c[5],c[4]],[0,c[0],c[2],c[1],c[2],c[1],c[2],c[0],0,0,c[4],0],[c[0],c[2],c[2],c[3],c[2],c[3],c[2],c[2],c[0],0,0,0],[0,c[1],c[2],c[6],c[5],c[6],c[2],c[1],0,0,0,0],[0,c[0],c[7],c[0],c[0],c[0],c[7],c[0],0,0,0,0],[c[0],c[1],c[0],c[1],c[0],c[1],c[0],c[1],c[0],0,0,0],[0,c[0],c[1],c[0],0,c[0],c[1],c[0],0,0,0,0]];sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}));}},
  lich:{draw(ctx,x,y,sc){const c=['#14162a','#2c2250','#6848a8','#e8e0ff','#c84820','#8868d0','#f0e8ff','#402880'];const p=PX*sc;const sp=[[0,c[1],c[2],c[6],c[3],c[6],c[2],c[1],0],[c[1],c[2],c[6],c[2],c[2],c[2],c[6],c[2],c[1]],[0,c[5],c[3],c[4],c[3],c[4],c[3],c[5],0],[0,c[1],c[3],c[3],c[3],c[3],c[3],c[1],0],[0,c[2],c[7],c[5],c[2],c[5],c[7],c[2],0],[c[1],c[5],c[3],c[2],c[2],c[2],c[3],c[5],c[1]],[0,c[7],c[2],c[3],c[2],c[3],c[2],c[7],0],[0,c[2],c[7],0,0,0,c[7],c[2],0],[0,c[1],c[2],0,0,0,c[2],c[1],0]];sp.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p);}))}},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   WORLD DATA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const ZONES=[
  {name:'Ashen Fields',sky:['#160e0a','#221408'],ground:'#2c1e10',hill:'#180e06',enemies:['rat','rat','skeleton'],story:'The ancient farmlands choke on ash and sorrow.'},
  {name:'Rotwood Forest',sky:['#0c1006','#141808'],ground:'#1a2010',hill:'#0c1006',enemies:['skeleton','zombie','skeleton'],story:"These twisted trees remember the Lich's first corruption."},
  {name:'Catacombs Deep',sky:['#0e0808','#180e0a'],ground:'#1c1210',hill:'#0c0808',enemies:['zombie','wraith','zombie'],story:'Sealed for a reason. That reason still prowls the dark.'},
  {name:'Shadowmere',sky:['#080c18','#101828'],ground:'#1a2030',hill:'#08101e',enemies:['wraith','wraith','lich'],story:'The cursed marshlands where wraiths struck a pact with death.'},
  {name:"Sorcerer's Veil",sky:['#0e0818','#180c28'],ground:'#1a1028',hill:'#0c0814',enemies:['dragon','lich','dragon'],story:'A pocket dimension of corrupted magic. Nothing here is real.'},
  {name:'Obsidian Keep',sky:['#100606','#1a0808'],ground:'#1e0e0c',hill:'#0e0606',enemies:['lich','dragon','lich'],story:'Built from the bones of those who dared resist the king.'},
  {name:'Void Spire',sky:['#060610','#0e0e1e'],ground:'#14141e',hill:'#060610',enemies:['dragon','lich','dragon'],story:'The Spire reaches into a dimension of raw, unraveling power.'},
  {name:'Infernal Core',sky:['#1c0606','#260808'],ground:'#220c0c',hill:'#160404',enemies:['lich','dragon','lich'],story:"The Ashen King's throne. Reality fractures here."},
];
const ENAMES={rat:['Grave Rat','Diseased Rat','Feral Rat','Plague Carrier'],skeleton:['Skeleton Guard','Bone Archer','Crypt Warrior','Restless Dead'],zombie:['Rot Zombie','Plague Shambler','Brute Zombie','Cursed Revenant'],wraith:['Frost Wraith','Shadow Wraith','Banshee','Soul Eater'],dragon:['Shadow Drake','Ember Wyvern','Ancient Dragon','Void Serpent'],lich:['Bone Lich','Void Lich','Soul Lich','Death Incarnate']};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORY CHAPTERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const STORY_CHAPTERS=[
  {id:'ch1',zone:1,ico:'ğŸŒ¾',title:'The Shattered Kingdom',quote:'"Once, Aetheron shone like a beacon. Then the Ashen King came â€” and everything burned."',desc:'You wake in ruined farmlands tasting ash. Corpses rise from shallow graves. Someone must stand.',objs:[{t:'kills',n:'Slay 10 enemies',tar:10},{t:'level',n:'Reach level 5',tar:5}],rew:{g:100,sp:3},done:false,unlocked:true},
  {id:'ch2',zone:2,ico:'ğŸŒ²',title:'The Rotwood Conspiracy',quote:'"The forest\'s corruption began with a single experiment. Now nothing within it is clean."',desc:'The Rotwood was once sacred druidic land. A Crown fragment is buried beneath the oldest oak.',objs:[{t:'kills',n:'Slay 100 enemies',tar:100},{t:'zone',n:'Reach Zone 3',tar:3},{t:'level',n:'Reach level 12',tar:12}],rew:{g:400,sp:6},done:false,unlocked:false},
  {id:'ch3',zone:3,ico:'ğŸ’€',title:'Descent Into Darkness',quote:'"The Catacombs were sealed a hundred years ago. Whatever is down there wasn\'t supposed to wake."',desc:'The labyrinthine tombs beneath the forest. The second Crown fragment is guarded by something ancient.',objs:[{t:'kills',n:'Slay 300 enemies',tar:300},{t:'level',n:'Reach level 20',tar:20},{t:'sktotal',n:'Unlock 8 skills',tar:8}],rew:{g:1000,sp:10},done:false,unlocked:false},
  {id:'ch4',zone:4,ico:'ğŸŒŠ',title:'The Shadowmere Pact',quote:'"The Wraiths gave the King their deathless service. He gave them eternity. Neither was satisfied."',desc:'The cursed marshlands. The third Crown fragment rests at the heart of Shadowmere.',objs:[{t:'kills',n:'Slay 750 enemies',tar:750},{t:'gtotal',n:'Earn 5000 gold',tar:5000},{t:'level',n:'Reach level 30',tar:30}],rew:{g:2500,sp:15},done:false,unlocked:false},
  {id:'ch5',zone:5,ico:'ğŸ”®',title:"The Sorcerer's Betrayal",quote:'"He was the King\'s most trusted advisor. He was also the architect of his master\'s damnation."',desc:"The Sorcerer's Veil â€” a pocket dimension of broken reality. The fourth fragment floats in an arcane cage.",objs:[{t:'kills',n:'Slay 1500 enemies',tar:1500},{t:'boons',n:'Own 3 boons',tar:3},{t:'level',n:'Reach level 42',tar:42}],rew:{g:5000,sp:20},done:false,unlocked:false},
  {id:'ch6',zone:6,ico:'ğŸ°',title:'The Obsidian Keep',quote:'"Its walls are built from the bones of those who resisted. The stones still remember the screams."',desc:"The Ashen King's fortress. The fifth fragment is embedded in the throne room wall.",objs:[{t:'kills',n:'Slay 3000 enemies',tar:3000},{t:'level',n:'Reach level 55',tar:55},{t:'prestige',n:'Ascend once',tar:1}],rew:{g:10000,sp:30},done:false,unlocked:false},
  {id:'ch7',zone:7,ico:'â­',title:'The Void Ascent',quote:'"The Void Spire reaches into dimensions no living mind was meant to perceive."',desc:"Pure void-matter crackles in the air. The Ashen King's phylactery is somewhere within.",objs:[{t:'kills',n:'Slay 6000 enemies',tar:6000},{t:'level',n:'Reach level 70',tar:70},{t:'prestige',n:'Ascend twice',tar:2}],rew:{g:20000,sp:50},done:false,unlocked:false},
  {id:'ch8',zone:8,ico:'ğŸ”¥',title:'The Final Reckoning',quote:'"The Ashen King sits on a throne of cinders, wearing a crown of stolen souls. Today, the debt is repaid."',desc:'The Infernal Core. Six Crown fragments hum with stolen power. This is what all of it was for.',objs:[{t:'kills',n:'Slay 12000 enemies',tar:12000},{t:'level',n:'Reach level 99',tar:99},{t:'prestige',n:'Ascend three times',tar:3}],rew:{g:50000,sp:100},done:false,unlocked:false},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLASSES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const CLASSES={
  warrior:{icon:'âš”',name:'Ironclad Warrior',flavor:'"Where others shatter, I endure."',lore:'A veteran of a hundred campaigns. Raw power backed by iron flesh.',baseAtk:8,baseDef:5,baseHp:160,baseMana:30,baseSpd:1.0,baseCrit:5,baseSpell:0,hints:['âš” Highest Attack','ğŸ›¡ Best Defense','â¤ Most HP']},
  mage:{icon:'ğŸ”®',name:'Void Mage',flavor:'"Power without mercy. Magic without limit."',lore:'A scholar who delved too deep into forbidden lore.',baseAtk:4,baseDef:2,baseHp:90,baseMana:120,baseSpd:1.0,baseCrit:12,baseSpell:14,hints:['ğŸ”® Spell Damage','ğŸ’¥ High Crits','âœ¦ Mana Scaling']},
  rogue:{icon:'ğŸ—¡',name:'Shadow Rogue',flavor:'"Strike unseen. Vanish before the blood hits the ground."',lore:'An assassin born in the slums of a fallen city.',baseAtk:6,baseDef:2,baseHp:110,baseMana:70,baseSpd:1.6,baseCrit:22,baseSpell:0,hints:['âš¡ Fastest Attacks','ğŸ’¥ Best Crits','ğŸ‘¤ Dodge Chance']},
  paladin:{icon:'âœ',name:'Fallen Paladin',flavor:'"Even shattered faith leaves a mark."',lore:'One survivor of the destroyed Paladin order channels divine wrath.',baseAtk:7,baseDef:4,baseHp:130,baseMana:80,baseSpd:1.0,baseCrit:8,baseSpell:8,hints:['âœ Holy Damage','ğŸ›¡ Strong Defense','ğŸ’š Self-Healing']},
  ranger:{icon:'ğŸ¹',name:'Cursed Ranger',flavor:'"The wilds remember every injustice done to them."',lore:'A tracker changed by the Rotwood corruption.',baseAtk:6,baseDef:3,baseHp:105,baseMana:85,baseSpd:1.35,baseCrit:18,baseSpell:5,hints:['ğŸ¹ Ranged Attacks','ğŸŒ¿ Nature Magic','âš¡ High Speed']},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKILL TREES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SKTREES={
  offense:{label:'Offense',ico:'âš”',tiers:[[{id:'heavy',name:'Heavy Strike',ico:'ğŸ’¥',desc:'+4 ATK per rank',max:6,eff:'atk',val:4}],[{id:'execute',name:'Execute',ico:'ğŸ—¡',desc:'+6% crit per rank',max:5,eff:'crit',val:6,req:'heavy'},{id:'cleave',name:'Cleave',ico:'âš”',desc:'+2 bonus DMG per rank',max:4,eff:'atk',val:2,req:'heavy'}],[{id:'berserk',name:'Berserker',ico:'ğŸ”¥',desc:'<30% HP â†’ +70% ATK',max:1,eff:'special',req:'execute',cap:true},{id:'overpower',name:'Overpower',ico:'ğŸ’¢',desc:'Every 5th hit: Ã—3 damage',max:1,eff:'special',req:'execute',cap:true}]]},
  defense:{label:'Defense',ico:'ğŸ›¡',tiers:[[{id:'ironskin',name:'Iron Skin',ico:'ğŸ›¡',desc:'+3 DEF per rank',max:6,eff:'def',val:3}],[{id:'vigor',name:'Vigor',ico:'â¤',desc:'+22 Max HP per rank',max:5,eff:'maxHp',val:22,req:'ironskin'},{id:'fortress',name:'Fortress',ico:'ğŸ°',desc:'Block 18% enemy damage',max:1,eff:'block',val:18,req:'ironskin',cap:true}],[{id:'regen',name:'Regeneration',ico:'ğŸ’š',desc:'Heal 2% HP per kill',max:4,eff:'regen',val:2,req:'vigor'},{id:'secondwind',name:'Second Wind',ico:'ğŸŒ¬',desc:'Revive once at 40% HP',max:1,eff:'special',req:'vigor',cap:true}]]},
  magic:{label:'Magic',ico:'ğŸ”®',tiers:[[{id:'arcane',name:'Arcane Surge',ico:'âœ¨',desc:'+6 Spell DMG per rank',max:6,eff:'spell',val:6}],[{id:'manawell',name:'Mana Well',ico:'âœ¦',desc:'+22 Max Mana per rank',max:5,eff:'maxMana',val:22,req:'arcane'},{id:'soulburn',name:'Soul Burn',ico:'ğŸŒ‘',desc:'Spells deal +35% damage',max:1,eff:'special',req:'arcane',cap:true}],[{id:'drain',name:'Life Drain',ico:'ğŸ©¸',desc:'+3% lifesteal per rank',max:4,eff:'life',val:3,req:'manawell'},{id:'voidbolt',name:'Void Bolt',ico:'âš«',desc:'5% chance: instakill <20% HP',max:1,eff:'special',req:'manawell',cap:true}]]},
  agility:{label:'Agility',ico:'âš¡',tiers:[[{id:'swift',name:'Swiftness',ico:'âš¡',desc:'+0.12 ATK speed per rank',max:5,eff:'spd',val:0.12}],[{id:'dodge',name:'Shadow Step',ico:'ğŸ‘¤',desc:'+8% dodge per rank',max:4,eff:'dodge',val:8,req:'swift'},{id:'flurry',name:'Flurry',ico:'ğŸŒ€',desc:'Crits trigger +2 bonus hits',max:1,eff:'special',req:'swift',cap:true}],[{id:'shadowform',name:'Shadowform',ico:'ğŸŒ«',desc:'+18% to ALL stats',max:1,eff:'allstats',val:18,req:'dodge',cap:true}]]},
  holy:{label:'Holy',ico:'âœ',tiers:[[{id:'smite',name:'Holy Smite',ico:'âœ',desc:'+5 holy DMG per rank',max:6,eff:'spell',val:5}],[{id:'blessed',name:'Blessed Armor',ico:'ğŸŒŸ',desc:'+4 DEF, +0.05 SPD per rank',max:4,eff:'both',req:'smite'},{id:'consecrate',name:'Consecrate',ico:'ğŸ•Š',desc:'+5% ATK heals per rank',max:3,eff:'life',val:5,req:'smite'}],[{id:'divine',name:'Divine Shield',ico:'â›¨',desc:'Negate one fatal hit',max:1,eff:'special',req:'blessed',cap:true},{id:'radiance',name:'Radiance',ico:'â˜€',desc:'+20% gold & XP',max:1,eff:'special',req:'consecrate',cap:true}]]},
};

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUESTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QUESTS=[
  {id:'q_s1',cat:'story',ico:'ğŸ“–',name:'The First Step',desc:'Leave your mark on the Ashen Fields.',type:'kills',target:10,rew:{g:50,sp:2},done:false},
  {id:'q_s2',cat:'story',ico:'ğŸ“–',name:'Into the Dark',desc:'Descend through zones to the Catacombs.',type:'zone',target:3,rew:{g:400,sp:7},done:false},
  {id:'q_s3',cat:'story',ico:'ğŸ“–',name:'The Long March',desc:"Journey beyond the Shadowmere.",type:'zone',target:5,rew:{g:2000,sp:15},done:false},
  {id:'q_s4',cat:'story',ico:'ğŸ“–',name:'The Throne Room',desc:'Reach the heart of the Infernal Core.',type:'zone',target:8,rew:{g:12000,sp:50},done:false},
  {id:'q_k1',cat:'slayer',ico:'ğŸ’€',name:'First Blood',desc:'Slay your first enemies.',type:'kills',target:10,rew:{g:50,sp:2},done:false},
  {id:'q_k2',cat:'slayer',ico:'ğŸ’€',name:'Slaughterer',desc:'One thousand foes shall fall before you.',type:'kills',target:1000,rew:{g:2000,sp:10},done:false},
  {id:'q_k3',cat:'slayer',ico:'ğŸ’€',name:'Undying Reaper',desc:'Five thousand slain.',type:'kills',target:5000,rew:{g:8000,sp:25},done:false},
  {id:'q_k4',cat:'slayer',ico:'ğŸ’€',name:'Death Incarnate',desc:'Ten thousand souls released.',type:'kills',target:10000,rew:{g:25000,sp:60},done:false},
  {id:'q_l1',cat:'mastery',ico:'â¬†',name:'Initiate',desc:'Show the realm what you are capable of.',type:'level',target:10,rew:{g:150,sp:3},done:false},
  {id:'q_l2',cat:'mastery',ico:'â¬†',name:'Champion',desc:'Your power eclipses all who came before.',type:'level',target:30,rew:{g:1500,sp:8},done:false},
  {id:'q_l3',cat:'mastery',ico:'â¬†',name:'Legend',desc:'Your name is spoken in hushed reverence.',type:'level',target:60,rew:{g:6000,sp:20},done:false},
  {id:'q_l4',cat:'mastery',ico:'â¬†',name:'Ascendant',desc:'You have surpassed all mortal limits.',type:'level',target:99,rew:{g:18000,sp:50},done:false},
  {id:'q_m1',cat:'mastery',ico:'âœ¨',name:'Skill Seeker',desc:'Walk the paths of power.',type:'sktotal',target:5,rew:{g:500,sp:4},done:false},
  {id:'q_m2',cat:'mastery',ico:'âœ¨',name:'Skill Master',desc:'The skill trees bend to your will.',type:'sktotal',target:20,rew:{g:2500,sp:14},done:false},
  {id:'q_m3',cat:'mastery',ico:'âœ¨',name:'Skill Lord',desc:'All paths of power walk through you.',type:'sktotal',target:40,rew:{g:8000,sp:30},done:false},
  {id:'q_g1',cat:'wealth',ico:'ğŸ’°',name:'Coin Gatherer',desc:'Wealth is power.',type:'gtotal',target:1000,rew:{g:0,sp:3},done:false},
  {id:'q_g2',cat:'wealth',ico:'ğŸ’°',name:'Treasure Lord',desc:'Your wealth surpasses ancient vaults.',type:'gtotal',target:15000,rew:{g:0,sp:10},done:false},
  {id:'q_g3',cat:'wealth',ico:'ğŸ’°',name:'Vault Sovereign',desc:'Gold beyond reckoning flows through your hands.',type:'gtotal',target:100000,rew:{g:0,sp:25},done:false},
  {id:'q_b1',cat:'mastery',ico:'âš—',name:'Boon Seeker',desc:'Acquire your first permanent boon.',type:'boons',target:1,rew:{g:800,sp:4},done:false},
  {id:'q_b2',cat:'mastery',ico:'âš—',name:'Boon Collector',desc:'Collect five permanent boons.',type:'boons',target:5,rew:{g:3000,sp:12},done:false},
  {id:'q_p1',cat:'prestige',ico:'ğŸ”„',name:'First Ascension',desc:'Die to be reborn.',type:'prestige',target:1,rew:{g:0,sp:30},done:false},
  {id:'q_p2',cat:'prestige',ico:'ğŸ”„',name:'Eternal Cycle',desc:'Three times reborn. Three times stronger.',type:'prestige',target:3,rew:{g:0,sp:75},done:false},
];

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOONS â€” UPGRADEABLE SYSTEM
   Each boon has tiers: [{cost, effect description, multiplier}]
   G.boons[id] = tier index (0=not owned, 1=tier1, 2=tier2, etc.)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BOONS=[
  // â”€â”€â”€ COMMON â”€â”€â”€
  {id:'b1',ico:'ğŸ’ª',name:'Iron Discipline',desc:'Permanently increases base Attack.',rarity:'common',cat:'combat',
   tiers:[
     {cost:300, label:'Tier I',   desc:'+8% ATK',   eff:'atk', mult:0.08},
     {cost:800, label:'Tier II',  desc:'+18% ATK',  eff:'atk', mult:0.18},
     {cost:2000,label:'Tier III', desc:'+32% ATK',  eff:'atk', mult:0.32},
     {cost:5000,label:'Tier IV',  desc:'+50% ATK',  eff:'atk', mult:0.50},
   ]},
  {id:'b2',ico:'ğŸŒ‘',name:'Shadow Harvest',desc:'Enemies drop more gold.',rarity:'common',cat:'wealth',
   tiers:[
     {cost:200, label:'Tier I',   desc:'+12% Gold',  eff:'gold', mult:0.12},
     {cost:600, label:'Tier II',  desc:'+25% Gold',  eff:'gold', mult:0.25},
     {cost:1800,label:'Tier III', desc:'+42% Gold',  eff:'gold', mult:0.42},
     {cost:4500,label:'Tier IV',  desc:'+65% Gold',  eff:'gold', mult:0.65},
   ]},
  {id:'b3',ico:'ğŸ“š',name:'Ancient Wisdom',desc:'Increases XP gain from all sources.',rarity:'common',cat:'growth',
   tiers:[
     {cost:400, label:'Tier I',   desc:'+20% XP',   eff:'xp', mult:0.20},
     {cost:1000,label:'Tier II',  desc:'+40% XP',   eff:'xp', mult:0.40},
     {cost:2800,label:'Tier III', desc:'+65% XP',   eff:'xp', mult:0.65},
     {cost:7000,label:'Tier IV',  desc:'+100% XP',  eff:'xp', mult:1.00},
   ]},
  {id:'b4',ico:'ğŸ©¸',name:'Blood Pact',desc:'Restore HP on every kill.',rarity:'common',cat:'survival',
   tiers:[
     {cost:500, label:'Tier I',   desc:'Restore 15% HP',  eff:'hpkill', mult:0.15},
     {cost:1200,label:'Tier II',  desc:'Restore 35% HP',  eff:'hpkill', mult:0.35},
     {cost:3000,label:'Tier III', desc:'Restore 60% HP',  eff:'hpkill', mult:0.60},
     {cost:8000,label:'Tier IV',  desc:'Full HP restore',  eff:'hpkill', mult:1.00},
   ]},
  // â”€â”€â”€ RARE â”€â”€â”€
  {id:'b5',ico:'ğŸŒ¬',name:'Ethereal Gale',desc:'Permanently increases attack speed.',rarity:'rare',cat:'combat',
   tiers:[
     {cost:800, label:'Tier I',   desc:'+0.2 SPD',   eff:'spd', mult:0.2},
     {cost:2200,label:'Tier II',  desc:'+0.45 SPD',  eff:'spd', mult:0.45},
     {cost:6000,label:'Tier III', desc:'+0.8 SPD',   eff:'spd', mult:0.8},
   ]},
  {id:'b6',ico:'ğŸ”®',name:'Soul Crystal',desc:'Amplifies all spell damage.',rarity:'rare',cat:'combat',
   tiers:[
     {cost:700, label:'Tier I',   desc:'+22% Spell',  eff:'spell', mult:0.22},
     {cost:2000,label:'Tier II',  desc:'+45% Spell',  eff:'spell', mult:0.45},
     {cost:5500,label:'Tier III', desc:'+78% Spell',  eff:'spell', mult:0.78},
   ]},
  {id:'b7',ico:'ğŸŒ¿',name:'Life Root',desc:'Steal life on every attack.',rarity:'rare',cat:'survival',
   tiers:[
     {cost:600, label:'Tier I',   desc:'+2% Lifesteal',  eff:'life', mult:2},
     {cost:1800,label:'Tier II',  desc:'+5% Lifesteal',  eff:'life', mult:5},
     {cost:5000,label:'Tier III', desc:'+9% Lifesteal',  eff:'life', mult:9},
   ]},
  {id:'b8',ico:'âš¡',name:'Static Surge',desc:'Critical hits trigger bonus strikes.',rarity:'rare',cat:'combat',
   tiers:[
     {cost:1200,label:'Tier I',   desc:'Crits: +1 hit',   eff:'critBonusHits', mult:1},
     {cost:3500,label:'Tier II',  desc:'Crits: +2 hits',  eff:'critBonusHits', mult:2},
     {cost:9000,label:'Tier III', desc:'Crits: +4 hits',  eff:'critBonusHits', mult:4},
   ]},
  {id:'b16',ico:'ğŸ•¯',name:'Soul Lantern',desc:'Increases XP in higher zones.',rarity:'rare',cat:'growth',
   tiers:[
     {cost:900, label:'Tier I',   desc:'+30% XP in zones 4+',  eff:'xpzone', mult:0.30},
     {cost:2500,label:'Tier II',  desc:'+60% XP in zones 4+',  eff:'xpzone', mult:0.60},
     {cost:7000,label:'Tier III', desc:'+100% XP in zones 4+', eff:'xpzone', mult:1.00},
   ]},
  // â”€â”€â”€ EPIC â”€â”€â”€
  {id:'b9',ico:'ğŸ‰',name:'Dragonfire Pact',desc:'Huge ATK boost â€” but enemies are tougher.',rarity:'epic',cat:'combat',
   tiers:[
     {cost:1500,label:'Tier I',   desc:'+28% ATK, enemies +25% HP', eff:'dragon', mult:0.28},
     {cost:4500,label:'Tier II',  desc:'+55% ATK, enemies +45% HP', eff:'dragon', mult:0.55},
     {cost:12000,label:'Tier III',desc:'+90% ATK, enemies +70% HP', eff:'dragon', mult:0.90},
   ]},
  {id:'b10',ico:'ğŸ‘‘',name:'Sovereign Mark',desc:'Scales all stats with zone level.',rarity:'epic',cat:'growth',
   tiers:[
     {cost:1800,label:'Tier I',   desc:'+4 to all stats per zone',   eff:'sovereign', mult:4},
     {cost:5000,label:'Tier II',  desc:'+8 to all stats per zone',   eff:'sovereign', mult:8},
     {cost:14000,label:'Tier III',desc:'+14 to all stats per zone',  eff:'sovereign', mult:14},
   ]},
  {id:'b11',ico:'âš—',name:"Alchemist's Greed",desc:'Each prestige grants bonus gold permanently.',rarity:'epic',cat:'wealth',
   tiers:[
     {cost:2000,label:'Tier I',   desc:'+8% gold per prestige',   eff:'alch', mult:0.08},
     {cost:6000,label:'Tier II',  desc:'+16% gold per prestige',  eff:'alch', mult:0.16},
     {cost:18000,label:'Tier III',desc:'+28% gold per prestige',  eff:'alch', mult:0.28},
   ]},
  {id:'b12',ico:'ğŸŒŒ',name:'Void Conduit',desc:'Chance per attack to cast a free spell.',rarity:'epic',cat:'combat',
   tiers:[
     {cost:2500,label:'Tier I',   desc:'15% free spell chance', eff:'voidchance', mult:0.15},
     {cost:7000,label:'Tier II',  desc:'28% free spell chance', eff:'voidchance', mult:0.28},
     {cost:20000,label:'Tier III',desc:'45% free spell chance', eff:'voidchance', mult:0.45},
   ]},
  {id:'b17',ico:'âš”',name:'War Covenant',desc:'Kill streaks stack attack bonus.',rarity:'epic',cat:'combat',
   tiers:[
     {cost:1600,label:'Tier I',   desc:'+2% ATK per kill (max 20%)',  eff:'streak', mult:0.02},
     {cost:5000,label:'Tier II',  desc:'+4% ATK per kill (max 40%)',  eff:'streak', mult:0.04},
     {cost:14000,label:'Tier III',desc:'+7% ATK per kill (max 70%)',  eff:'streak', mult:0.07},
   ]},
  {id:'b18',ico:'ğŸ§¿',name:'Ward of the Ancients',desc:'Block chance + reflect damage.',rarity:'epic',cat:'survival',
   tiers:[
     {cost:2000,label:'Tier I',   desc:'+15% block, reflect 30%', eff:'ward', mult:15},
     {cost:6000,label:'Tier II',  desc:'+28% block, reflect 60%', eff:'ward', mult:28},
     {cost:16000,label:'Tier III',desc:'+45% block, reflect 100%',eff:'ward', mult:45},
   ]},
  // â”€â”€â”€ LEGENDARY â”€â”€â”€
  {id:'b13',ico:'ğŸ’€',name:"Death's Bargain",desc:'Revive upon death with HP restored.',rarity:'legendary',cat:'survival',
   tiers:[
     {cost:4000, label:'Tier I',   desc:'Revive at 25% HP (2 min CD)',  eff:'revive', mult:0.25},
     {cost:12000,label:'Tier II',  desc:'Revive at 50% HP (1 min CD)',  eff:'revive', mult:0.50},
     {cost:35000,label:'Tier III', desc:'Revive at 80% HP (30s CD)',    eff:'revive', mult:0.80},
   ]},
  {id:'b14',ico:'ğŸŒŸ',name:"Fate's Chosen",desc:'ALL stats permanently increased.',rarity:'legendary',cat:'growth',
   tiers:[
     {cost:5000, label:'Tier I',   desc:'+18% ALL stats', eff:'fates', mult:0.18},
     {cost:15000,label:'Tier II',  desc:'+35% ALL stats', eff:'fates', mult:0.35},
     {cost:45000,label:'Tier III', desc:'+60% ALL stats', eff:'fates', mult:0.60},
   ]},
  {id:'b15',ico:'ğŸ”¥',name:'Pyre Ascendant',desc:'Every Nth kill triggers a chain explosion.',rarity:'legendary',cat:'combat',
   tiers:[
     {cost:6000, label:'Tier I',   desc:'Every 15th kill: 4Ã— ATK blast',  eff:'pyre', mult:4},
     {cost:18000,label:'Tier II',  desc:'Every 10th kill: 7Ã— ATK blast',  eff:'pyre', mult:7},
     {cost:50000,label:'Tier III', desc:'Every 7th kill: 12Ã— ATK blast',  eff:'pyre', mult:12},
   ]},
];

// Helper: get current boon tier (0 = not owned)
function boonTier(id){return G.boons[id]||0;}
function boonOwned(id){return boonTier(id)>0;}
function boonMaxed(id){const b=BOONS.find(x=>x.id===id);return b&&boonTier(id)>=b.tiers.length;}
function boonCurrentData(id){const b=BOONS.find(x=>x.id===id);if(!b)return null;const t=boonTier(id);return t>0?b.tiers[t-1]:null;}
function boonNextData(id){const b=BOONS.find(x=>x.id===id);if(!b)return null;const t=boonTier(id);return t<b.tiers.length?b.tiers[t]:null;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAME STATE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const SAVE='ashen_v8';
let G=null;
function mkState(){return{cls:'warrior',selCls:null,lv:1,xp:0,xpNext:100,hp:160,maxHp:160,mana:30,maxMana:30,gold:0,gtotal:0,kills:0,deaths:0,zone:1,zoneKills:0,zoneTarget:10,sp:0,prestige:0,pbonus:1.0,sk:{},quests:QUESTS.map(q=>({...q})),boons:{},boonCount:0,idle:false,lastSave:Date.now(),sktotal:0,chapters:STORY_CHAPTERS.map(c=>({...c,objs:c.objs.map(o=>({...o}))})),chainKills:0,divineReady:true,deathBargain:true,deathBargainTime:0};}
function saveG(){try{localStorage.setItem(SAVE,JSON.stringify({...G,idle:false,lastSave:Date.now()}));}catch(e){}}
function loadG(){
  try{
    const d=localStorage.getItem(SAVE);
    if(d){
      const s=JSON.parse(d);G=mkState();
      ['cls','selCls','lv','xp','xpNext','hp','maxHp','mana','maxMana','gold','gtotal','kills','deaths','zone','zoneKills','zoneTarget','sp','prestige','pbonus','sk','boons','boonCount','sktotal'].forEach(k=>{if(s[k]!==undefined)G[k]=s[k];});
      G.quests=QUESTS.map(q=>{const sq=(s.quests||[]).find(x=>x.id===q.id);return sq?{...q,...sq}:{...q};});
      G.chapters=STORY_CHAPTERS.map(c=>{const sc=(s.chapters||[]).find(x=>x.id===c.id);if(!sc)return{...c,objs:c.objs.map(o=>({...o}))};return{...c,...sc,objs:c.objs.map((o,i)=>sc.objs&&sc.objs[i]?{...o,...sc.objs[i]}:{...o})};});
      return true;
    }
  }catch(e){}G=mkState();return false;
}
function clearSavePrompt(){openModal('New Game','Are you sure you want to start over? All progress will be lost.','This cannot be undone.',()=>{localStorage.removeItem(SAVE);G=mkState();buildClassCards();showScr('s1');closeModal();},true);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMPUTED STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function getStats(){
  const c=CLASSES[G.cls];
  let atk=c.baseAtk,def=c.baseDef,spd=c.baseSpd,crit=c.baseCrit;
  let life=0,spell=c.baseSpell||0,maxHp=c.baseHp,maxMana=c.baseMana,dodge=0,block=0;
  const lv=G.lv,sk=G.sk;
  atk+=(lv-1)*2.2;def+=(lv-1)*1.1;maxHp+=(lv-1)*13;
  if(sk.heavy)atk+=sk.heavy*4;if(sk.cleave)atk+=sk.cleave*2;if(sk.ironskin)def+=sk.ironskin*3;
  if(sk.vigor)maxHp+=sk.vigor*22;if(sk.arcane)spell+=sk.arcane*6;if(sk.smite)spell+=sk.smite*5;
  if(sk.manawell)maxMana+=sk.manawell*22;if(sk.swift)spd+=sk.swift*0.12;if(sk.dodge)dodge+=sk.dodge*8;
  if(sk.execute)crit+=sk.execute*6;if(sk.drain)life+=sk.drain*3;if(sk.consecrate)life+=sk.consecrate*5;
  if(sk.fortress)block+=18;if(sk.blessed){def+=sk.blessed*4;spd+=sk.blessed*0.05;}
  if(sk.soulburn)spell=Math.round(spell*1.35);
  if(sk.shadowform){atk*=1.18;def*=1.18;maxHp=Math.round(maxHp*1.18);}

  // BOON EFFECTS â€” tiered
  const bt=id=>boonTier(id);
  if(bt('b1')>0){const t=boonCurrentData('b1');atk*=1+t.mult;}
  if(bt('b5')>0){const t=boonCurrentData('b5');spd+=t.mult;}
  if(bt('b6')>0){const t=boonCurrentData('b6');spell*=1+t.mult;}
  if(bt('b7')>0){const t=boonCurrentData('b7');life+=t.mult;}
  if(bt('b9')>0){const t=boonCurrentData('b9');atk*=1+t.mult;}
  if(bt('b10')>0){const t=boonCurrentData('b10');const zb=G.zone*t.mult;atk+=zb;def+=zb;maxHp+=Math.round(zb*3);}
  if(bt('b14')>0){const t=boonCurrentData('b14');atk*=1+t.mult;def*=1+t.mult;maxHp=Math.round(maxHp*(1+t.mult));}
  if(bt('b18')>0){const t=boonCurrentData('b18');block+=t.mult;}
  if(bt('b17')>0&&G.chainKills>0){const t=boonCurrentData('b17');atk*=1+Math.min(G.chainKills,10)*t.mult;}

  atk*=G.pbonus;def*=G.pbonus;maxHp=Math.round(maxHp*G.pbonus);
  return{atk:Math.round(atk*10)/10,def:Math.round(def*10)/10,spd:Math.round(Math.max(.5,spd)*100)/100,crit:Math.round(crit),life:Math.round(life),spell:Math.round(spell),maxHp:Math.round(maxHp),maxMana:Math.round(maxMana),dodge:Math.round(dodge),block:Math.round(block)};
}
function xpFor(lv){return Math.floor(100*Math.pow(1.28,lv-1));}
function atkInterval(){return Math.max(200,Math.round(1000/getStats().spd));}
function allSkList(){return Object.values(SKTREES).flatMap(t=>t.tiers.flat());}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CANVAS â€” 32-BIT RENDERING
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let CV=null,CTX=null,raf=null;
let PA={x:0,y:0,bob:0,aflash:0,hflash:0};
let EA={x:0,y:0,bob:0,hflash:0,dead:false,deathT:0};
let bgScroll=0,particles=[],lightPulse=0;

function initCanvas(){CV=document.getElementById('arena-cv');CTX=CV.getContext('2d');resizeCv();window.addEventListener('resize',resizeCv);cancelAnimationFrame(raf);loop();}
function resizeCv(){const w=document.getElementById('arena-wrap');if(!w||!CV)return;CV.width=w.clientWidth;CV.height=w.clientHeight;PA.x=CV.width*.17;PA.y=CV.height*.42;EA.x=CV.width*.66;EA.y=CV.height*.38;}
function loop(){
  PA.bob+=.042;EA.bob+=.036;bgScroll=(bgScroll+.28)%Math.max(CV.width,1);lightPulse+=.035;
  if(PA.aflash>.01)PA.aflash-=.085;else PA.aflash=0;
  if(PA.hflash>.01)PA.hflash-=.085;else PA.hflash=0;
  if(EA.hflash>.01)EA.hflash-=.085;else EA.hflash=0;
  if(EA.dead&&EA.deathT<1)EA.deathT+=.06;
  particles=particles.filter(p=>{p.life-=.048;p.x+=p.vx;p.y+=p.vy;p.vy+=.12;return p.life>0;});
  drawArena32();raf=requestAnimationFrame(loop);
}
function lighten(hex,amt){const r=Math.min(255,parseInt(hex.slice(1,3),16)+amt);const g=Math.min(255,parseInt(hex.slice(3,5),16)+amt);const b=Math.min(255,parseInt(hex.slice(5,7),16)+amt);return`#${r.toString(16).padStart(2,'0')}${g.toString(16).padStart(2,'0')}${b.toString(16).padStart(2,'0')}`;}
function drawArena32(){
  if(!CV||!CTX)return;const ctx=CTX,W=CV.width,H=CV.height;
  const zi=Math.min((G?G.zone:1)-1,ZONES.length-1);const z=ZONES[zi];
  const sky=ctx.createLinearGradient(0,0,0,H*.7);sky.addColorStop(0,z.sky[0]);sky.addColorStop(1,z.sky[1]);
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);
  if(zi>0){for(let i=0;i<24;i++){const sx=((i*139+bgScroll*.04)%W);const sy=3+(i*53)%(H*.42);ctx.globalAlpha=.3+.5*Math.sin(Date.now()*.0012+i*1.4);ctx.fillStyle=i%5===0?'#c0d8ff':'#ffffd8';ctx.fillRect(sx,sy,1,1);}ctx.globalAlpha=1;}
  // Hills
  ctx.fillStyle=lighten(z.hill,-8)+'aa';
  ctx.beginPath();ctx.moveTo(0,H*.72);for(let x=0;x<=W;x+=6)ctx.lineTo(x,H*.72+Math.sin(x*.012+bgScroll*.00035)*18+Math.sin(x*.025)*9);ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  ctx.fillStyle=lighten(z.hill,15);
  ctx.beginPath();ctx.moveTo(0,H*.65);for(let x=0;x<=W;x+=5)ctx.lineTo(x,H*.65+Math.sin(x*.016+bgScroll*.00055)*14);ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  ctx.fillStyle=lighten(z.hill,28);
  ctx.beginPath();ctx.moveTo(0,H*.6);for(let x=0;x<=W;x+=4)ctx.lineTo(x,H*.6+Math.sin(x*.022+bgScroll*.0008)*12);ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();
  const gnd=ctx.createLinearGradient(0,H*.6,0,H);gnd.addColorStop(0,z.ground);gnd.addColorStop(1,'#030202');ctx.fillStyle=gnd;ctx.fillRect(0,H*.6,W,H*.4);
  // Particles
  particles.forEach(p=>{ctx.globalAlpha=Math.max(0,p.life);ctx.fillStyle=p.color;ctx.fillRect(p.x,p.y,p.size,p.size);});ctx.globalAlpha=1;
  // Enemy
  if(G&&curEnemy){
    const es=ENEMIES32[curEnemy.key];if(es){
      const sc=Math.min(2.6,1.15+G.zone*.14);const ey=EA.y+Math.sin(EA.bob)*3;
      ctx.save();
      if(EA.dead){ctx.globalAlpha=Math.max(0,1-EA.deathT*1.2);ctx.translate(EA.x,ey+EA.deathT*28);ctx.rotate(EA.deathT*.4);}else{ctx.translate(EA.x,ey);}
      if(EA.hflash>.3)ctx.filter='brightness(5) saturate(0.2)';
      ctx.scale(-sc,sc);es.draw(ctx,0,0,1);ctx.restore();
      if(!EA.dead){
        const ep=eHP/eMaxHP;const bw=Math.round(58*sc),bx=EA.x-bw/2+PX*sc,by=ey-10;
        ctx.fillStyle='#1a0c08';ctx.fillRect(bx,by,bw,5);
        ctx.fillStyle=ep>.5?'#40c040':ep>.25?'#c0a020':'#d82828';ctx.fillRect(bx,by,bw*Math.max(0,ep),5);
        ctx.font=`bold ${Math.max(6,Math.round(W*.016))}px Cinzel,serif`;ctx.textAlign='center';ctx.fillStyle='rgba(240,216,120,.9)';ctx.fillText(curEnemy.name,EA.x+PX*1.2*sc,by-4);ctx.textAlign='left';
      }
    }
  }
  // Player
  if(G){
    const py=PA.y+Math.sin(PA.bob)*3;const pal=PAL32[G.cls]||PAL32.warrior;const sprFn=SPR32[G.cls]||SPR32.warrior;const spr=sprFn(pal);
    ctx.save();if(PA.hflash>.3)ctx.filter='brightness(3) sepia(1) hue-rotate(280deg)';if(PA.aflash>.55)ctx.filter='brightness(2.8) saturate(1.5)';
    drawSprite32(ctx,spr,PA.x,py);ctx.restore();
    const st=getStats();const php=G.hp/st.maxHp;
    ctx.fillStyle='#100808';ctx.fillRect(PA.x,py-7,PX*9,4);
    ctx.fillStyle=php>.5?'#40c040':php>.25?'#c0a020':'#e03030';ctx.fillRect(PA.x,py-7,PX*9*Math.max(0,php),4);
  }
  if(PA.aflash>.55){const prog=(PA.aflash-.55)*2.2;ctx.save();ctx.globalAlpha=prog*.88;ctx.strokeStyle='#e8d070';ctx.lineWidth=2.5;const sx=PA.x+28+prog*50,sy=PA.y+8;ctx.beginPath();ctx.moveTo(sx,sy-13);ctx.lineTo(sx+18,sy+13);ctx.stroke();ctx.restore();}
}
function spawnParticles(x,y,col,n=10){for(let i=0;i<n;i++){const a=Math.random()*Math.PI*2,s=1.8+Math.random()*3.5;particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-2.2,color:col,size:PX,life:1});}}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   COMBAT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let curEnemy=null,eHP=0,eMaxHP=0,atkTimer=null,atkCount=0;
function spawnEnemy(){
  const zi=Math.min(G.zone-1,ZONES.length-1);const pool=ZONES[zi].enemies;const key=pool[Math.floor(Math.random()*pool.length)];
  const base=Math.round(28*Math.pow(1.6,G.zone-1));
  const dragonMult=boonOwned('b9')?1+boonCurrentData('b9').mult*1.2:1;
  eMaxHP=Math.round(base*dragonMult);eHP=eMaxHP;
  const nl=ENAMES[key];curEnemy={key,name:nl[Math.floor(Math.random()*nl.length)]};
  EA.dead=false;EA.deathT=0;updateZoneBar();
}
function doAttack(){
  if(!G||G.hp<=0)return;initAudio();
  const st=getStats();atkCount++;PA.aflash=1;
  let dmg=st.atk*(0.82+Math.random()*.36);
  const isCrit=Math.random()*100<st.crit;
  if(isCrit)dmg*=2;
  if(G.sk.berserk&&G.hp/st.maxHp<.3)dmg*=1.7;
  if(G.sk.overpower&&atkCount%5===0){dmg*=3;showDmg('OVERPOWER!',true,'special');}
  // Void Conduit
  const voidChance=boonOwned('b12')?boonCurrentData('b12').mult:0;
  if(st.spell>0){const sp=Math.round(st.spell*(.5+Math.random()*.5));dmg+=Math.random()<voidChance?sp*1.5:sp;}
  // Pyre
  if(boonOwned('b15')){const pd=boonCurrentData('b15');const nthKill=pd.mult>=12?7:pd.mult>=7?10:15;G._cc=(G._cc||0)+1;if(G._cc%nthKill===0){dmg*=(pd.mult||4);showDmg('PYRE!',true,'special');}}
  dmg=Math.round(dmg);
  SFX.hit();if(isCrit)SFX.crit();
  spawnParticles(EA.x,EA.y,isCrit?'#f0d020':st.spell>0?'#a050d0':'#d02010',isCrit?18:8);
  eHP=Math.max(0,eHP-dmg);EA.hflash=1;showDmg(dmg,isCrit,'hit');
  if(st.life>0){const h=Math.round(dmg*st.life/100);if(h>0)G.hp=Math.min(st.maxHp,G.hp+h);}
  // Crit bonus hits
  const critHits=boonOwned('b8')?boonCurrentData('b8').mult:G.sk.flurry?2:0;
  if(isCrit&&critHits>0){for(let i=1;i<=critHits;i++)setTimeout(()=>quickHit(),i*88);}
  if(G.sk.voidbolt&&Math.random()<.05&&eHP/eMaxHP<.2)eHP=0;
  if(eHP<=0){killEnemy();return;}
  const eDmgRaw=Math.max(1,(4+G.zone*2.5)*Math.pow(1.18,G.zone-1));
  const blocked=st.block>0?eDmgRaw*st.block/100:0;
  let eDmg=Math.max(0,Math.round(eDmgRaw-st.def-blocked));
  if(Math.random()*100<st.dodge){eDmg=0;showDmg(0,false,'dodge');}
  if(G.sk.divine&&G.divineReady&&G.hp-eDmg<=0){eDmg=0;G.divineReady=false;showDmg('DIVINE!',false,'dodge');}
  if(eDmg>0){G.hp=Math.max(0,G.hp-eDmg);PA.hflash=1;SFX.hurt();showDmg(eDmg,false,'enemy');spawnParticles(PA.x+PX*4,PA.y+PX*5,'#d02020',5);}
  if(G.hp<=0)die();else updateHUD();
}
function quickHit(){if(!G||!curEnemy)return;const st=getStats();let dmg=Math.round(st.atk*.5);eHP=Math.max(0,eHP-dmg);PA.aflash=.62;if(eHP<=0){killEnemy();return;}showDmg(dmg,false,'hit');SFX.hit();updateHUD();}
function killEnemy(){
  G.kills++;G.zoneKills++;EA.dead=true;EA.deathT=0;SFX.kill();spawnParticles(EA.x,EA.y,'#d4a020',22);
  G.chainKills=(G.chainKills||0)+1;
  if(boonOwned('b17')){clearTimeout(G._ct);G._ct=setTimeout(()=>{G.chainKills=0;},5000);}
  let gold=Math.round((3+G.zone*3)*Math.pow(1.4,G.zone-1)*(0.8+Math.random()*.4));
  if(boonOwned('b2'))gold=Math.round(gold*(1+boonCurrentData('b2').mult));
  if(boonOwned('b9'))gold=Math.round(gold*1.1);
  if(boonOwned('b11'))gold=Math.round(gold*(1+G.prestige*(boonCurrentData('b11').mult)));
  G.gold+=gold;G.gtotal+=gold;SFX.gold();
  let xpg=Math.round(9*Math.pow(1.45,G.zone-1));
  if(boonOwned('b3'))xpg=Math.round(xpg*(1+boonCurrentData('b3').mult));
  if(boonOwned('b16')&&G.zone>=4)xpg=Math.round(xpg*(1+boonCurrentData('b16').mult));
  if(G.sk.radiance){gold=Math.round(gold*1.2);xpg=Math.round(xpg*1.2);}
  G.xp+=xpg;
  const st=getStats();
  // Blood Pact heal
  if(boonOwned('b4')){const t=boonCurrentData('b4');G.hp=Math.min(st.maxHp,Math.round(G.hp+st.maxHp*t.mult));}
  if(G.sk.regen)G.hp=Math.min(st.maxHp,G.hp+Math.round(st.maxHp*G.sk.regen*.02));
  while(G.xp>=G.xpNext){G.xp-=G.xpNext;G.lv++;G.xpNext=xpFor(G.lv);G.sp++;const nst=getStats();G.hp=nst.maxHp;G.divineReady=true;SFX.lvlup();showLvlUp();}
  if(G.zoneKills>=G.zoneTarget){
    G.zone=Math.min(G.zone+1,8);G.zoneKills=0;G.zoneTarget=Math.round(G.zoneTarget*1.22);
    const zn=ZONES[Math.min(G.zone-1,ZONES.length-1)].name;
    toast('ğŸ—º Entered '+zn+'!');document.getElementById('zone-name-lbl').textContent=zn;document.getElementById('hud-zone-val').textContent=G.zone;
    setStoryTicker(ZONES[Math.min(G.zone-1,ZONES.length-1)].story,true);checkChapters();
  }
  checkQuests();checkChapters();setTimeout(spawnEnemy,500);updateHUD();
  if(curTab==='quests'||curTab==='story'||curTab==='boons')renderTab();
}
function die(){
  G.deaths++;SFX.die();
  if(boonOwned('b13')){
    const t=boonCurrentData('b13');const cd=t.mult>=0.8?30000:t.mult>=0.5?60000:120000;
    const now=Date.now();
    if(G.deathBargain||(now-G.deathBargainTime>cd)){
      const st=getStats();G.hp=Math.round(st.maxHp*t.mult);G.deathBargain=false;G.deathBargainTime=now;showDmg('REBORN!',true,'special');spawnEnemy();updateHUD();return;
    }
  }
  if(G.sk.secondwind&&G._swr!==false){const st=getStats();G.hp=Math.round(st.maxHp*.4);G._swr=false;showDmg('2ND WIND!',true,'dodge');spawnEnemy();updateHUD();return;}
  const st=getStats();G.hp=Math.round(st.maxHp*.5);spawnEnemy();updateHUD();
}
function toggleAuto(){initAudio();G.idle=!G.idle;const b=document.getElementById('btn-auto');b.textContent=G.idle?'AUTO ON':'AUTO OFF';b.className=G.idle?'on':'';b.id='btn-auto';if(G.idle)startIdle();else stopIdle();}
function startIdle(){stopIdle();atkTimer=setInterval(doAttack,atkInterval());}
function stopIdle(){if(atkTimer){clearInterval(atkTimer);atkTimer=null;}}
function doAttackTouch(e){e.preventDefault();doAttack();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HUD
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function fmt(n){return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':String(n);}
function updateHUD(){
  if(!G)return;const st=getStats();
  const hp=Math.max(0,Math.min(100,G.hp/st.maxHp*100));
  const mp=Math.max(0,Math.min(100,G.mana/st.maxMana*100));
  const xp=Math.max(0,Math.min(100,G.xp/G.xpNext*100));
  document.getElementById('b-hp').style.width=hp+'%';document.getElementById('b-mp').style.width=mp+'%';document.getElementById('b-xp').style.width=xp+'%';
  document.getElementById('v-hp').textContent=Math.round(G.hp)+'/'+st.maxHp;document.getElementById('v-mp').textContent=Math.round(G.mana)+'/'+st.maxMana;document.getElementById('v-xp').textContent=G.xp+'/'+G.xpNext;
  document.getElementById('hud-gold-val').textContent=fmt(G.gold);document.getElementById('hud-lv-val').textContent=G.lv;document.getElementById('hud-cls-name').textContent=CLASSES[G.cls].name.split(' ')[0];document.getElementById('hud-zone-val').textContent=G.zone;
  updateZoneBar();const sp=document.getElementById('sp-badge');if(sp)sp.textContent='SP: '+G.sp;
}
function updateZoneBar(){const pct=G?Math.min(100,(G.zoneKills/G.zoneTarget)*100):0;const el=document.getElementById('zone-prog-fill');if(el)el.style.width=pct+'%';}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORY TICKER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const TLINES=['The realm holds its breath...','Old bones stir in the dark.','Something watches from the shadows.','Power grows in the ruins.','Each kill brings you closer to the truth.',"The Ashen King's influence spreads.",'Whispers speak of a crown that grants dominion over death.'];
function setStoryTicker(msg,hl=false){const el=document.getElementById('story-txt');if(el)el.textContent=msg;if(hl){const b=document.getElementById('story-ticker');if(b){b.style.background='linear-gradient(90deg,#120a04,#1c1008,#120a04)';setTimeout(()=>{b.style.background='';},4000);}}}
let _ti=0;function startTicker(){(function n(){setStoryTicker(TLINES[_ti%TLINES.length]);_ti++;setTimeout(n,8000);})();}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TABS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let curTab='story',skSub='offense',qFilter='all',boonCat='all';
function openTab(t){
  curTab=t;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));
  const tb=document.getElementById('tb-'+t);if(tb){tb.classList.add('on');const dot=tb.querySelector('.tab-dot');if(dot)dot.remove();}
  renderTab();
}
function renderTab(){
  const el=document.getElementById('tab-body');if(!el)return;
  if(curTab==='story')el.innerHTML=buildStory();
  else if(curTab==='skills')el.innerHTML=buildSkills();
  else if(curTab==='quests')el.innerHTML=buildQuests();
  else if(curTab==='boons')el.innerHTML=buildBoons();
  else if(curTab==='stats')el.innerHTML=buildStats();
}
function notifyTab(t){if(curTab===t)return;const tb=document.getElementById('tb-'+t);if(!tb||tb.querySelector('.tab-dot'))return;const dot=document.createElement('div');dot.className='tab-dot';tb.appendChild(dot);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STORY TAB
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function chapV(o){if(o.t==='kills')return G.kills;if(o.t==='level')return G.lv;if(o.t==='zone')return G.zone;if(o.t==='gtotal')return G.gtotal;if(o.t==='sktotal')return G.sktotal||0;if(o.t==='prestige')return G.prestige;if(o.t==='boons')return G.boonCount||0;return 0;}
function buildStory(){
  let h='<div class="sec"><div class="sec-hdr">THE ASHEN CHRONICLES</div><div class="story-list">';
  G.chapters.forEach((ch,i)=>{
    const prev=i===0||G.chapters[i-1].done,locked=!prev&&!ch.done,active=!ch.done&&prev;
    const cls='chapter-card'+(ch.done?' complete':locked?' locked':active?' active':'');
    const rew=[ch.rew.g>0&&'ğŸ’°'+ch.rew.g,ch.rew.sp>0&&'â­'+ch.rew.sp+' SP'].filter(Boolean).join(' ');
    h+=`<div class="${cls}">
      <div class="ch-hdr"><span class="ch-num">Ch.${i+1}</span><span class="ch-ico">${ch.done?'âœ…':ch.ico}</span>
        <div class="ch-info"><div class="ch-title">${ch.title}</div><div class="ch-zone">Zone ${ch.zone} Â· ${ZONES[ch.zone-1].name}</div></div>
        ${locked?'<span class="ch-lock">ğŸ”’</span>':''}
      </div>
      <div class="ch-body">
        <div class="ch-quote">${ch.quote}</div>
        <div class="ch-desc">${ch.desc}</div>
        <div class="ch-objs">${ch.objs.map(o=>{const v=chapV(o);const pct=Math.min(100,(v/o.tar)*100);return`<div class="ch-obj"><span class="ch-obj-ico">${v>=o.tar?'âœ…':'â­•'}</span><span class="ch-obj-txt">${o.n}</span><div class="ch-obj-bar"><div class="ch-obj-fill" style="width:${pct}%"></div></div><span class="ch-obj-val">${Math.min(v,o.tar).toLocaleString()}/${o.tar.toLocaleString()}</span></div>`;}).join('')}</div>
      </div>
      ${ch.done?'<div class="ch-complete">âœ¦ CHAPTER COMPLETE</div>':`<div class="ch-rew">ğŸ“¦ Reward: ${rew}</div>`}
    </div>`;
  });
  return h+'</div></div>';
}
function checkChapters(){
  G.chapters.forEach((ch,i)=>{
    if(ch.done)return;const prev=i===0||G.chapters[i-1].done;if(!prev)return;
    if(ch.objs.every(o=>chapV(o)>=o.tar)){
      ch.done=true;G.gold+=ch.rew.g;G.gtotal+=ch.rew.g;G.sp+=ch.rew.sp;
      SFX.chapter();toast('ğŸ“– Ch.'+(i+1)+' "'+ch.title+'" complete! +'+ch.rew.sp+'SP');
      setStoryTicker('ğŸ“– Chapter: "'+ch.title+'" complete!',true);notifyTab('story');
      if(i+1<G.chapters.length)G.chapters[i+1].unlocked=true;
      if(curTab==='story')renderTab();
    }
  });
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SKILLS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildSkills(){
  const tree=SKTREES[skSub];
  const tabs=Object.entries(SKTREES).map(([k,t])=>`<div class="sk-tree-tab${skSub===k?' on':''}" onclick="setSkSub('${k}')"><span>${t.ico}</span>${t.label}</div>`).join('');
  let h=`<div class="sec"><div class="sec-hdr">SKILL TREES <span class="sp-badge" id="sp-badge">SP: ${G.sp}</span></div><div class="sk-tree-tabs">${tabs}</div><div class="sk-tier-wrap">`;
  tree.tiers.forEach((tier,ti)=>{
    if(ti>0){h+=tier.length===1?'<div class="sk-connector"></div>':'<div class="sk-connector fork"></div>';}
    h+=`<div class="sk-row sk-row-${Math.min(tier.length,3)}">`;
    tier.forEach(sk=>{
      const cur=G.sk[sk.id]||0,maxed=cur>=sk.max,locked=sk.req&&!(G.sk[sk.req]>=1);
      const cc='sk-card'+(sk.cap?' capstone':'')+(maxed?' maxed':locked?' locked':cur>0?' unlocked':'');
      const pips=Array.from({length:sk.max},(_,i)=>`<div class="pip${i<cur?' '+(cur===sk.max?'onmax':'on'):''}"></div>`).join('');
      const rn=sk.req?allSkList().find(s=>s.id===sk.req)?.name:'';
      h+=`<div class="${cc}" onclick="buySkill('${sk.id}')">
        ${sk.cap?'<div class="sk-cap-tag">CAPSTONE</div>':''}
        <div class="sk-ico">${sk.ico}</div><div class="sk-name">${sk.name}</div>
        <div class="sk-desc">${sk.desc}</div>
        ${locked&&rn?`<div class="sk-req-warn">Req: ${rn}</div>`:''}
        <div class="sk-pips">${pips}</div><div class="sk-rank">${cur}/${sk.max}</div>
      </div>`;
    });
    h+='</div>';
  });
  return h+'</div></div>';
}
function setSkSub(s){skSub=s;renderTab();}
function buySkill(id){
  initAudio();if(G.sp<=0){toast('No skill points â€” level up!');return;}
  const sk=allSkList().find(s=>s.id===id);if(!sk)return;
  const cur=G.sk[id]||0;if(cur>=sk.max){toast('Already maxed!');return;}
  if(sk.req&&!(G.sk[sk.req]>=1)){toast('Unlock prerequisite first!');return;}
  G.sp--;G.sk[id]=(G.sk[id]||0)+1;G.sktotal=(G.sktotal||0)+1;
  if(G.sk.secondwind)G._swr=true;if(G.idle)startIdle();SFX.skill();
  checkQuests();checkChapters();renderTab();updateHUD();saveG();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   QUESTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const QCATS=['all','story','slayer','mastery','wealth','prestige'];
function qVal(q){if(q.type==='kills')return G.kills;if(q.type==='level')return G.lv;if(q.type==='zone')return G.zone;if(q.type==='gtotal')return G.gtotal;if(q.type==='sktotal')return G.sktotal||0;if(q.type==='prestige')return G.prestige;if(q.type==='boons')return G.boonCount||0;return 0;}
function buildQuests(){
  const cats=`<div class="filter-row">${QCATS.map(c=>`<div class="f-btn${qFilter===c?' on':''}" onclick="setQFilter('${c}')">${c[0].toUpperCase()+c.slice(1)}</div>`).join('')}</div>`;
  const items=G.quests.filter(q=>qFilter==='all'||q.cat===qFilter);
  let h=`<div class="sec"><div class="sec-hdr">QUEST LOG</div>${cats}<div class="q-list">`;
  items.forEach(q=>{
    const v=qVal(q),pct=Math.min(100,(v/q.target)*100),active=!q.done&&v>0;
    const rew=[q.rew.g>0&&'ğŸ’°'+q.rew.g,q.rew.sp>0&&'â­'+q.rew.sp+'SP'].filter(Boolean);
    h+=`<div class="q-card${q.done?' done':active?' in-progress':''}">
      <div class="q-ico">${q.done?'âœ…':q.ico}</div>
      <div class="q-body">
        <div class="q-name">${q.name}</div><div class="q-cat">${q.cat}</div>
        <div class="q-desc">${q.desc}</div>
        ${q.done?'<div class="q-done-lbl">âœ¦ COMPLETE</div>':`<div class="q-bar-wrap"><div class="q-bar" style="width:${pct}%"></div></div><div class="q-prog">${Math.min(v,q.target).toLocaleString()} / ${q.target.toLocaleString()}</div><div class="q-rew">${rew.map(r=>`<span class="q-rew-tag">${r}</span>`).join('')}</div>`}
      </div>
    </div>`;
  });
  return h+'</div></div>';
}
function setQFilter(f){qFilter=f;renderTab();}
function checkQuests(){G.quests.forEach(q=>{if(q.done)return;if(qVal(q)>=q.target){q.done=true;G.gold+=q.rew.g;G.gtotal+=q.rew.g;G.sp+=q.rew.sp;SFX.quest();toast('ğŸ“œ "'+q.name+'" complete! +'+q.rew.sp+'SP');notifyTab('quests');}});}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOONS â€” UPGRADEABLE UI
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
const BCATS=['all','combat','survival','wealth','growth'];
function rarityColorClass(r){return r==='legendary'?'legendary-color':r==='epic'?'epic-color':'';} 

function buildBoons(){
  const cats=`<div class="filter-row">${BCATS.map(c=>`<div class="f-btn${boonCat===c?' on':''}" onclick="setBoonCat('${c}')">${c[0].toUpperCase()+c.slice(1)}</div>`).join('')}</div>`;
  const rarOrd={common:0,rare:1,epic:2,legendary:3};
  const sorted=[...BOONS].sort((a,b)=>rarOrd[a.rarity]-rarOrd[b.rarity]);
  const filtered=sorted.filter(b=>boonCat==='all'||b.cat===boonCat);
  let h=`<div class="sec"><div class="sec-hdr">PERMANENT BOONS <span style="font-size:.58rem;color:var(--txtdim);font-weight:normal;letter-spacing:1px">UPGRADEABLE</span></div>${cats}<div class="boon-list">`;

  filtered.forEach(b=>{
    const tier=boonTier(b.id);
    const owned=tier>0;
    const maxed=boonMaxed(b.id);
    const cur=owned?b.tiers[tier-1]:null;
    const next=boonNextData(b.id);
    const isElite=b.rarity==='epic'||b.rarity==='legendary';

    let cardCls='boon-card'+(maxed?' maxed':owned?' owned':'')+(isElite?' elite':'');

    // Tier pip indicators
    const numTiers=b.tiers.length;
    const pips=Array.from({length:numTiers},(_,i)=>{
      const filled=i<tier;const isMaxPip=filled&&i===tier-1&&maxed;
      return`<div class="boon-tier-pip${filled?' filled'+(isMaxPip?' max':''):''}"></div>`;
    }).join('');

    // Tier label
    let tierLbl='';
    if(maxed)tierLbl=`<span class="boon-tier-label maxed-lbl">âœ¦ MAXED</span>`;
    else if(owned)tierLbl=`<span class="boon-tier-label">${cur.label} âœ“</span>`;
    else tierLbl=`<span class="boon-tier-label" style="color:var(--txtdim)">Not Acquired</span>`;

    // Button(s)
    let btnHtml='';
    if(!owned){
      const canBuy=G.gold>=b.tiers[0].cost;
      btnHtml=`<button class="boon-buy-btn" onclick="buyBoon('${b.id}')" ${canBuy?'':'disabled'}>âš— Acquire Â· ğŸ’°${fmt(b.tiers[0].cost)}</button>`;
    } else if(!maxed&&next){
      const canUpg=G.gold>=next.cost;
      const upgCls='boon-upgrade-btn '+rarityColorClass(b.rarity);
      btnHtml=`<button class="${upgCls}" onclick="upgradeBoon('${b.id}')" ${canUpg?'':'disabled'}>â–² ${next.label} Â· ğŸ’°${fmt(next.cost)}</button>`;
    }

    // Current/next effect preview
    let effectLine='';
    if(owned&&cur)effectLine=`<div class="boon-stat-preview">Active: ${cur.desc}${next?` â†’ Next: ${next.desc}`:''}</div>`;
    else if(!owned&&next)effectLine=`<div class="boon-stat-preview">Tier I: ${b.tiers[0].desc} â†’ Max: ${b.tiers[b.tiers.length-1].desc}</div>`;

    h+=`<div class="${cardCls}">
      <div class="boon-rar ${b.rarity}">${b.rarity}</div>
      <div class="boon-main">
        <div class="boon-ico">${b.ico}</div>
        <div class="boon-body">
          <div class="boon-name">${b.name}</div>
          <div class="boon-desc">${b.desc}</div>
          <div class="boon-tier-row">
            <div class="boon-tier-pips">${pips}</div>
            ${tierLbl}
          </div>
          ${effectLine}
          <div class="boon-upgrade-row" style="margin-top:6px">
            ${btnHtml}
            ${maxed?'<span class="boon-maxed-lbl">â˜… FULLY UPGRADED</span>':''}
          </div>
        </div>
      </div>
    </div>`;
  });
  return h+'</div></div>';
}

function setBoonCat(c){boonCat=c;renderTab();}

function buyBoon(id){
  initAudio();const b=BOONS.find(x=>x.id===id);if(!b)return;
  if(boonOwned(id)){toast('Already acquired â€” use Upgrade!');return;}
  const cost=b.tiers[0].cost;
  if(G.gold<cost){toast('Not enough gold!');return;}
  G.gold-=cost;G.boons[id]=1;G.boonCount=(G.boonCount||0)+1;
  SFX.boon();if(G.idle)startIdle();
  toast('âš— '+b.name+' Tier I acquired!');renderTab();updateHUD();checkQuests();checkChapters();saveG();
}

function upgradeBoon(id){
  initAudio();const b=BOONS.find(x=>x.id===id);if(!b)return;
  const tier=boonTier(id);if(tier>=b.tiers.length){toast('Already maxed!');return;}
  const next=b.tiers[tier];if(!next)return;
  if(G.gold<next.cost){toast('Not enough gold! Need ğŸ’°'+fmt(next.cost));return;}
  G.gold-=next.cost;G.boons[id]=tier+1;
  SFX.upgrade();if(G.idle)startIdle();
  toast('â–² '+b.name+' upgraded to '+next.label+'!');renderTab();updateHUD();saveG();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildStats(){
  const st=getStats(),gain=Math.max(1,Math.floor(G.lv/5));
  const sr=(l,v)=>`<div class="stat-row"><span class="stat-lbl">${l}</span><span class="stat-val">${v}</span></div>`;
  return`<div class="sec"><div class="sec-hdr">STATISTICS</div>
    <div class="stats-grid">
      <div class="stat-grp">
        <div class="stat-grp-title">âš” COMBAT</div>
        ${sr('âš” Attack',st.atk)}${sr('ğŸ›¡ Defense',st.def)}${sr('âš¡ Speed',st.spd+'Ã—')}
        ${sr('ğŸ’¥ Crit %',st.crit+'%')}${sr('ğŸ”® Spell',st.spell)}${sr('ğŸ©¸ Lifesteal',st.life+'%')}
        ${sr('ğŸ‘¤ Dodge',st.dodge+'%')}${sr('ğŸ° Block',st.block+'%')}
      </div>
      <div class="stat-grp">
        <div class="stat-grp-title">ğŸ“Š LIFETIME</div>
        ${sr('ğŸ’€ Kills',G.kills.toLocaleString())}${sr('ğŸ’° Gold Earned',G.gtotal.toLocaleString())}
        ${sr('ğŸ’€ Deaths',G.deaths)}${sr('âœ¨ Prestige',G.prestige)}
        ${sr('âš— Boons',G.boonCount||0)}${sr('ğŸ“ˆ Stat Bonus','+'+Math.round((G.pbonus-1)*100)+'%')}
        ${sr('ğŸ“œ Quests',G.quests.filter(q=>q.done).length+'/'+G.quests.length)}
        ${sr('ğŸ“– Chapters',G.chapters.filter(c=>c.done).length+'/'+G.chapters.length)}
      </div>
    </div>
    <div class="prestige-box">
      <div class="pres-title">âœ¨ Prestige Ascension</div>
      <div class="pres-desc">Sacrifice your progress to be reborn with greater power. Earn <strong style="color:var(--gold)">${gain}</strong> prestige point${gain>1?'s':''}, increasing ALL stats by <strong style="color:var(--gold)">${gain*5}%</strong> permanently. Boons and upgrades are kept.</div>
      <div class="pres-warn">âš  Resets: level, gold, skill points, skills, zone. Boons persist.</div>
      <button class="btn-prestige" onclick="openPrestige()">âœ¨ ASCEND â€” GAIN ${gain} POINT${gain>1?'S':''}</button>
    </div>
  </div>`;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PRESTIGE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openPrestige(){const gain=Math.max(1,Math.floor(G.lv/5));openModal('âœ¨ Prestige Ascension',`Gain ${gain} prestige point${gain>1?'s':''}, permanently increasing all stats by ${gain*5}%.`,'âš  Your level, gold, skill points, skills, and zone will reset. All boons and their upgrades persist.',doPrestige,true);}
function doPrestige(){
  const gain=Math.max(1,Math.floor(G.lv/5));G.prestige+=gain;G.pbonus=1+G.prestige*.05;
  G.lv=1;G.xp=0;G.xpNext=100;G.sp=0;G.sk={};G.zone=1;G.zoneKills=0;G.zoneTarget=10;G.gold=0;G.sktotal=0;G.chainKills=0;G.divineReady=true;G._swr=true;
  const st=getStats();G.hp=st.maxHp;G.mana=CLASSES[G.cls].baseMana;
  spawnEnemy();closeModal();checkQuests();checkChapters();SFX.prestige();
  toast('âœ¨ Prestige '+G.prestige+'! +'+Math.round((G.pbonus-1)*100)+'% stats!');updateHUD();renderTab();saveG();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DAMAGE NUMBERS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showDmg(val,isCrit,type){
  const ov=document.getElementById('arena-ov');if(!ov)return;
  const el=document.createElement('div');
  el.className='dmg-num '+(isCrit?'crit':type==='heal'?'heal':type==='dodge'?'dodge':type==='spell'?'spell':type==='special'?'special':type==='enemy'?'enemy':'hit');
  const W=CV?CV.width:300,H=CV?CV.height:180;const isEn=type==='enemy';
  const bx=isEn?(PA.x+Math.random()*16):(EA.x+Math.random()*16);
  const by=isEn?(PA.y+3):(EA.y-5);
  el.style.left=Math.max(2,Math.min(W-72,bx))+'px';el.style.top=Math.max(0,Math.min(H-26,by))+'px';
  el.textContent=type==='dodge'?'DODGE':typeof val==='string'?val:type==='heal'?'+'+val:(isCrit?'â˜…':'')+val;
  ov.appendChild(el);setTimeout(()=>el.remove(),880);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CLASS SELECT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function buildClassCards(){
  const list=document.getElementById('cls-list');if(!list)return;list.innerHTML='';
  Object.entries(CLASSES).forEach(([k,c])=>{
    const card=document.createElement('div');card.className='cls-card'+(G.selCls===k?' sel':'');card.id='cls-'+k;card.onclick=()=>pickClass(k);
    const wrap=document.createElement('div');wrap.className='cls-sprite-wrap';
    const cv=document.createElement('canvas');cv.width=80;cv.height=80;
    const cx=cv.getContext('2d');cx.imageSmoothingEnabled=false;
    const pal=PAL32[k]||PAL32.warrior;const sprFn=SPR32[k]||SPR32.warrior;const spr=sprFn(pal);
    const S=1.6;spr.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col||col==='.')return;cx.fillStyle=col;cx.fillRect(3+rx*PX*S,3+ry*PX*S,PX*S,PX*S);}));
    wrap.appendChild(cv);card.appendChild(wrap);
    card.insertAdjacentHTML('beforeend',`<div class="cls-text"><div class="cls-name">${c.icon} ${c.name}</div><div class="cls-flavor">${c.flavor}</div><div class="cls-lore">${c.lore}</div><div class="cls-stats">${c.hints.map(h=>`<span class="cls-stat">${h}</span>`).join('')}</div></div>`);
    list.appendChild(card);
  });
}
function pickClass(k){
  G.selCls=k;G.cls=k;
  document.querySelectorAll('.cls-card').forEach(c=>c.classList.remove('sel'));document.getElementById('cls-'+k)?.classList.add('sel');document.getElementById('cls-go-btn').disabled=false;
  const st=getStats();G.hp=st.maxHp;G.maxHp=st.maxHp;G.mana=CLASSES[k].baseMana;G.maxMana=G.mana;
}
function confirmClass(){
  if(!G.selCls)return;document.getElementById('hud-av').textContent=CLASSES[G.cls].icon;
  showScr('s2');initCanvas();spawnEnemy();updateHUD();openTab('story');renderTab();
  setStoryTicker('Your legend begins in the Ashen Fields.',true);startTicker();if(G.idle)startIdle();setInterval(saveG,30000);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MODAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openModal(title,body,warn,cb,sc=true){
  document.getElementById('modal-title').textContent=title;document.getElementById('modal-body').textContent=body;document.getElementById('modal-warn').textContent=warn||'';
  document.getElementById('modal-ok').onclick=()=>{if(cb)cb();closeModal();};
  document.querySelectorAll('.m-btn.cancel').forEach(b=>b.style.display=sc?'':'none');
  document.getElementById('modal').classList.add('open');
}
function closeModal(){document.getElementById('modal').classList.remove('open');}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SCREEN FLOW
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function showScr(id){document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));document.getElementById(id)?.classList.add('on');}
function gotoClassSelect(){
  initAudio();const had=loadG();
  if(had&&G.selCls){
    document.getElementById('hud-av').textContent=CLASSES[G.cls].icon;
    showScr('s2');initCanvas();spawnEnemy();updateHUD();openTab('story');renderTab();
    setStoryTicker(ZONES[Math.min(G.zone-1,ZONES.length-1)].story);startTicker();if(G.idle)startIdle();setInterval(saveG,30000);
  }else{G=mkState();buildClassCards();showScr('s1');}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TOAST & LEVEL UP
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
let toastT;
function toast(msg){const el=document.getElementById('toast');el.textContent=msg;el.classList.add('show');clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),3200);}
let lvlT;
function showLvlUp(){const el=document.getElementById('lvlup');document.getElementById('lvlup-txt').textContent='LEVEL '+G.lv+'!';el.classList.add('show');clearTimeout(lvlT);lvlT=setTimeout(()=>el.classList.remove('show'),1800);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   TITLE FX
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function titleFX(){
  const cv=document.getElementById('s0-cv');if(!cv)return;
  const resize=()=>{cv.width=window.innerWidth;cv.height=window.innerHeight;};resize();
  window.addEventListener('resize',resize);
  const ctx=cv.getContext('2d');
  const embers=Array.from({length:80},()=>({x:Math.random()*cv.width,y:cv.height+Math.random()*100,spd:.6+Math.random()*2.5,sz:1+Math.random()*2.2,drift:(Math.random()-.5)*.65,life:0,maxLife:.4+Math.random()*.9}));
  function fr(){
    ctx.clearRect(0,0,cv.width,cv.height);
    const g1=ctx.createRadialGradient(cv.width/2,cv.height*.72,0,cv.width/2,cv.height*.72,cv.width*.65);
    g1.addColorStop(0,'rgba(140,40,8,.28)');g1.addColorStop(.4,'rgba(80,16,4,.12)');g1.addColorStop(1,'transparent');
    ctx.fillStyle=g1;ctx.fillRect(0,0,cv.width,cv.height);
    // Castle silhouette scales to screen
    const bh=cv.height,bw=cv.width;
    ctx.fillStyle='rgba(8,4,2,.65)';
    ctx.fillRect(bw*.38,bh*.42,bw*.24,bh*.45);
    ctx.fillRect(bw*.34,bh*.36,bw*.06,bh*.51);ctx.fillRect(bw*.60,bh*.36,bw*.06,bh*.51);
    for(let i=0;i<4;i++){ctx.fillRect(bw*.34+i*bw*.008,bh*.34,bw*.006,bh*.024);}
    for(let i=0;i<4;i++){ctx.fillRect(bw*.60+i*bw*.008,bh*.34,bw*.006,bh*.024);}
    for(let i=0;i<6;i++){ctx.fillRect(bw*.38+i*bw*.014,bh*.40,bw*.009,bh*.022);}
    ctx.fillStyle='rgba(180,40,8,.08)';ctx.fillRect(bw*.47,bh*.64,bw*.06,bh*.23);
    embers.forEach(e=>{
      e.y-=e.spd;e.x+=e.drift;e.life+=.018;
      if(e.y<-10||e.life>e.maxLife){e.y=cv.height+12;e.x=Math.random()*cv.width;e.life=0;}
      const a=Math.sin(e.life/e.maxLife*Math.PI);
      ctx.globalAlpha=a*.78;ctx.fillStyle=e.life<e.maxLife*.5?'#e07018':'#c02808';ctx.fillRect(e.x,e.y,e.sz,e.sz);
    });
    ctx.globalAlpha=1;requestAnimationFrame(fr);
  }
  fr();
}

window.addEventListener('load',()=>{titleFX();});
</script>

</body>
</html>
