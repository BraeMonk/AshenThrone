<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<title>Ashen Throne</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=MedievalSharp&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;-webkit-tap-highlight-color:transparent;user-select:none;-webkit-user-select:none;}
html,body{width:100%;height:100%;background:#000;overflow:hidden;font-family:'Cinzel',Georgia,serif;}

:root{
‚Äìbg:#0d0b07;
‚Äìpanel:#1a1508;
‚Äìpanel2:#221d0c;
‚Äìborder:#4a3e20;
‚Äìgold:#f0c030;
‚Äìgold2:#d4a020;
‚Äìgolddim:#7a5a10;
‚Äìred:#e03030;
‚Äìreddk:#801818;
‚Äìblue:#3060e0;
‚Äìbluedk:#182870;
‚Äìgreen:#40b040;
‚Äìgreendk:#1a5018;
‚Äìember:#d04020;
‚Äìtxt:#ffffff;
‚Äìtxt2:#e8d090;
‚Äìtxt3:#b09050;
‚Äìtxtdim:#806040;
}

#app{
position:fixed;inset:0;
width:100vw;height:100vh;height:100dvh;
display:flex;flex-direction:column;
background:var(‚Äìbg);overflow:hidden;
}

/* ========== SCREENS ========== */
.scr{position:absolute;inset:0;display:none;flex-direction:column;overflow:hidden;}
.scr.on{display:flex;}

/* ========== TITLE ========== */
#s0{
background:radial-gradient(ellipse 100% 80% at 50% 60%,#2a1206 0%,#0a0703 100%);
align-items:center;justify-content:center;
}
#s0-canvas{position:absolute;inset:0;width:100%;height:100%;}
.t-body{position:relative;z-index:2;display:flex;flex-direction:column;align-items:center;gap:14px;padding:20px;}
.t-icon{font-size:5rem;line-height:1;filter:drop-shadow(0 0 30px #c84020)drop-shadow(0 0 60px rgba(200,64,32,.5));}
.t-title{
font-family:‚ÄòCinzel‚Äô,serif;font-weight:900;font-size:clamp(2.2rem,11vw,3.4rem);
color:#f0c030;letter-spacing:6px;line-height:.95;text-align:center;
text-shadow:0 0 30px #f0c030,0 0 60px rgba(200,64,32,.6),0 4px 0 #000,0 6px 12px rgba(0,0,0,.9);
}
.t-sub{font-size:clamp(.65rem,2.5vw,.8rem);color:#b09050;letter-spacing:7px;text-transform:uppercase;text-shadow:0 1px 3px #000;}
.t-line{width:220px;height:2px;background:linear-gradient(90deg,transparent,#7a5a10,#f0c030,#7a5a10,transparent);}
.t-btn{
margin-top:10px;font-family:‚ÄòCinzel‚Äô,serif;font-size:1.1rem;font-weight:700;
letter-spacing:3px;color:#1a1000;
background:linear-gradient(160deg,#f0d060 0%,#d4a020 50%,#8a6010 100%);
border:none;border-radius:6px;padding:16px 52px;
box-shadow:0 0 20px rgba(240,192,48,.5),0 4px 12px rgba(0,0,0,.8),inset 0 1px 0 rgba(255,255,255,.3);
min-height:56px;cursor:pointer;transition:transform .12s,box-shadow .12s;
}
.t-btn:active{transform:scale(.95);box-shadow:0 0 8px rgba(240,192,48,.3),0 2px 6px rgba(0,0,0,.8);}
.t-hint{font-size:.7rem;color:#6a5030;font-style:italic;}

/* ========== CLASS SELECT ========== */
#s1{background:var(‚Äìbg);}
.cls-hdr{
flex-shrink:0;padding:14px 16px 10px;
font-size:.85rem;color:#f0c030;letter-spacing:3px;text-align:center;
background:var(‚Äìpanel);border-bottom:2px solid var(‚Äìborder);
text-shadow:0 1px 4px #000;
}
.cls-list{flex:1;overflow-y:auto;-webkit-overflow-scrolling:touch;padding:10px;display:flex;flex-direction:column;gap:10px;}
.cls-list::-webkit-scrollbar{display:none;}
.cls-card{
background:var(‚Äìpanel2);border:2px solid var(‚Äìborder);border-radius:10px;
padding:14px;display:flex;gap:12px;align-items:center;cursor:pointer;
position:relative;overflow:hidden;transition:border-color .15s;
}
.cls-card.sel{border-color:#f0c030;background:#221d0c;}
.cls-card:active{border-color:#f0c030;}
.cls-sprite-wrap{
width:70px;height:70px;flex-shrink:0;border-radius:8px;
background:#0d0b07;border:2px solid var(‚Äìborder);
display:flex;align-items:center;justify-content:center;overflow:hidden;
}
.cls-sprite-wrap canvas{image-rendering:pixelated;width:70px;height:70px;}
.cls-text{flex:1;min-width:0;}
.cls-name{font-size:1rem;font-weight:700;color:#f0c030;margin-bottom:4px;text-shadow:0 1px 3px #000;}
.cls-flavor{font-style:italic;font-size:.78rem;color:#b09050;line-height:1.4;margin-bottom:7px;}
.cls-stats{display:flex;gap:5px;flex-wrap:wrap;}
.cls-stat{font-size:.68rem;color:#e8d090;background:#0d0b07;border:1px solid #4a3e20;border-radius:3px;padding:2px 6px;}
.cls-foot{flex-shrink:0;padding:10px;background:var(‚Äìpanel);border-top:2px solid var(‚Äìborder);}
.cls-go{
width:100%;padding:15px;font-family:‚ÄòCinzel‚Äô,serif;font-size:.95rem;font-weight:700;
letter-spacing:2px;color:#1a1000;
background:linear-gradient(160deg,#f0d060,#d4a020,#8a6010);
border:none;border-radius:6px;cursor:pointer;min-height:54px;
box-shadow:0 4px 16px rgba(240,192,48,.4);transition:all .12s;
}
.cls-go:disabled{opacity:.3;pointer-events:none;}
.cls-go:active{transform:scale(.97);}

/* ========== MAIN GAME ========== */
#s2{background:var(‚Äìbg);height:100dvh;overflow:hidden;}

/* HUD */
#hud{
flex-shrink:0;
padding:max(10px,env(safe-area-inset-top,10px)) 10px 8px;
background:#000;border-bottom:2px solid var(‚Äìborder);
display:grid;grid-template-columns:42px 1fr auto;align-items:center;gap:8px;
}
#hud-av{
width:42px;height:42px;border-radius:50%;
background:radial-gradient(circle,#221d0c,#0d0b07);border:2px solid #7a5a10;
display:flex;align-items:center;justify-content:center;font-size:1.3rem;
}
#hud-bars{display:flex;flex-direction:column;gap:4px;}
.br{display:flex;align-items:center;gap:5px;}
.br-ico{font-size:.75rem;width:14px;flex-shrink:0;}
.br-track{flex:1;height:9px;background:#0a0806;border-radius:5px;overflow:hidden;border:1px solid #2a2010;}
.br-fill{height:100%;border-radius:5px;transition:width .3s;}
.br-fill.hp{background:linear-gradient(90deg,#801010,#e84040);}
.br-fill.mp{background:linear-gradient(90deg,#102060,#4070e0);}
.br-fill.xp{background:linear-gradient(90deg,#103018,#40b040);}
.br-val{font-size:.6rem;color:#b09050;width:50px;text-align:right;flex-shrink:0;white-space:nowrap;}
#hud-right{text-align:right;}
#hud-gold{font-size:.85rem;color:#f0c030;display:flex;align-items:center;justify-content:flex-end;gap:4px;text-shadow:0 1px 3px #000;}
#hud-lv{font-size:.7rem;color:#b09050;margin-top:2px;}
#hud-zbadge{font-size:.6rem;color:#ff7040;background:rgba(200,64,32,.25);border:1px solid rgba(200,64,32,.6);border-radius:3px;padding:2px 5px;margin-top:2px;display:inline-block;}

/* ARENA */
#arena-wrap{flex-shrink:0;height:min(185px,26vh);position:relative;background:#060402;overflow:hidden;}
#arena-cv{position:absolute;inset:0;width:100%;height:100%;display:block;}
#arena-ov{position:absolute;inset:0;pointer-events:none;z-index:10;}
#zone-prog-bar{position:absolute;top:0;left:0;right:0;height:4px;z-index:15;background:#000;}
#zone-prog-fill{height:100%;background:linear-gradient(90deg,#7a5a10,#f0c030);transition:width .4s;}
#btn-auto{
position:absolute;bottom:8px;left:8px;z-index:20;
background:rgba(0,0,0,.8);border:2px solid #4a3e20;border-radius:20px;
color:#806040;font-family:‚ÄòCinzel‚Äô,serif;font-size:.65rem;letter-spacing:1px;
padding:7px 13px;cursor:pointer;transition:all .2s;min-height:38px;
}
#btn-auto.on{border-color:#40b040;color:#40b040;box-shadow:0 0 12px rgba(64,176,64,.35);}
#btn-zone{
position:absolute;bottom:8px;left:50%;transform:translateX(-50%);z-index:20;
background:rgba(0,0,0,.8);border:2px solid #7a5a10;border-radius:20px;
color:#f0c030;font-family:‚ÄòCinzel‚Äô,serif;font-size:.65rem;letter-spacing:1px;
padding:7px 13px;cursor:pointer;transition:all .2s;min-height:38px;white-space:nowrap;
}
#btn-attack{
position:absolute;bottom:8px;right:8px;z-index:20;
width:60px;height:60px;border-radius:50%;
background:radial-gradient(circle at 38% 32%,#e05030,#c04020,#801010);
border:3px solid #d4a020;
display:flex;align-items:center;justify-content:center;font-size:1.6rem;
cursor:pointer;
box-shadow:0 4px 20px rgba(200,64,32,.7),inset 0 1px 0 rgba(255,255,255,.25);
transition:transform .1s,box-shadow .1s;
}
#btn-attack:active{transform:scale(.88);box-shadow:0 2px 8px rgba(200,64,32,.4);}

/* TABS */
#tabs{
flex-shrink:0;display:grid;grid-template-columns:repeat(4,1fr);
background:#111008;border-top:2px solid var(‚Äìborder);border-bottom:2px solid var(‚Äìborder);
}
.tab-btn{
padding:8px 4px 7px;display:flex;flex-direction:column;align-items:center;gap:2px;
cursor:pointer;border-right:1px solid var(‚Äìborder);transition:background .15s;
}
.tab-btn:last-child{border-right:none;}
.tab-btn.on{background:#221d0c;border-bottom:3px solid #f0c030;}
.tab-ico{font-size:1.2rem;line-height:1;}
.tab-lbl{font-size:.55rem;color:#806040;letter-spacing:1px;text-transform:uppercase;}
.tab-btn.on .tab-lbl{color:#f0c030;}

/* TAB CONTENT */
#tab-body{
flex:1;overflow-y:auto;overflow-x:hidden;
-webkit-overflow-scrolling:touch;
background:var(‚Äìbg);
padding-bottom:max(10px,env(safe-area-inset-bottom,10px));
}
#tab-body::-webkit-scrollbar{width:3px;}
#tab-body::-webkit-scrollbar-thumb{background:#4a3e20;border-radius:2px;}

/* ========== SECTION WRAPPERS ========== */
.sec{padding:10px;}
.sec-title{
font-size:.75rem;color:#f0c030;letter-spacing:3px;text-transform:uppercase;
padding-bottom:8px;margin-bottom:8px;
border-bottom:1px solid var(‚Äìborder);
text-shadow:0 1px 3px #000;
display:flex;align-items:center;justify-content:space-between;
}
.sp-badge{
background:#221d0c;border:1px solid #7a5a10;border-radius:12px;
padding:3px 11px;font-size:.8rem;color:#f0c030;
text-shadow:0 1px 3px #000;
}

/* ========== SKILL TREES ========== */
.sk-tabs{display:grid;grid-template-columns:repeat(4,1fr);gap:4px;margin-bottom:10px;}
.sk-tab{
padding:7px 2px;text-align:center;
background:#0d0b07;border:1.5px solid #4a3e20;border-radius:5px;
font-size:.65rem;color:#806040;cursor:pointer;letter-spacing:.5px;transition:all .15s;
min-height:36px;display:flex;align-items:center;justify-content:center;
}
.sk-tab.on{background:#221d0c;border-color:#f0c030;color:#f0c030;}
.sk-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;}
.sk-card{
background:#1a1508;border:2px solid #4a3e20;border-radius:8px;
padding:10px 8px;cursor:pointer;
display:flex;flex-direction:column;align-items:center;gap:5px;text-align:center;
position:relative;transition:border-color .15s,background .15s;
min-height:110px;
}
.sk-card.unlocked{border-color:#7a5a10;background:#221d0c;}
.sk-card.maxed{border-color:#f0c030;background:#2a2210;}
.sk-card.locked{opacity:.45;pointer-events:none;}
.sk-card:active:not(.locked){transform:scale(.97);background:#2a2210;}
.sk-ico{
width:46px;height:46px;border-radius:50%;
background:#0d0b07;border:2px solid #4a3e20;
display:flex;align-items:center;justify-content:center;font-size:1.4rem;
}
.sk-card.unlocked .sk-ico{border-color:#7a5a10;box-shadow:0 0 10px rgba(212,160,32,.3);}
.sk-card.maxed .sk-ico{border-color:#f0c030;box-shadow:0 0 14px rgba(240,192,48,.5);}
.sk-name{font-size:.72rem;color:#f0d080;font-weight:700;line-height:1.2;}
.sk-desc{font-size:.63rem;color:#a08040;font-style:italic;line-height:1.3;}
.sk-lv{font-size:.65rem;color:#f0c030;}
.sk-pips{display:flex;gap:2px;margin-top:2px;}
.pip{width:9px;height:4px;border-radius:2px;background:#2a2010;}
.pip.on{background:#f0c030;}
.pip.onmax{background:#f0d060;}
.sk-lock{position:absolute;top:4px;right:5px;font-size:.65rem;color:#6a5030;}

/* ========== QUESTS ========== */
.q-list{display:flex;flex-direction:column;gap:8px;}
.q-card{
background:#1a1508;border:2px solid #4a3e20;border-radius:8px;
padding:12px;display:flex;gap:10px;align-items:flex-start;
}
.q-card.done{border-color:#7a5a10;background:#1e1a08;}
.q-ico-wrap{
width:44px;height:44px;border-radius:50%;flex-shrink:0;
background:#0d0b07;border:2px solid #4a3e20;
display:flex;align-items:center;justify-content:center;font-size:1.3rem;
}
.q-card.done .q-ico-wrap{border-color:#7a5a10;}
.q-body{flex:1;min-width:0;}
.q-name{font-size:.82rem;color:#f0d080;font-weight:700;margin-bottom:3px;}
.q-desc{font-size:.7rem;color:#a08040;font-style:italic;margin-bottom:6px;}
.q-pbar-wrap{height:6px;background:#0a0806;border-radius:3px;overflow:hidden;border:1px solid #2a2010;margin-bottom:4px;}
.q-pbar{height:100%;background:linear-gradient(90deg,#7a5a10,#f0c030);border-radius:3px;transition:width .4s;}
.q-prog{font-size:.63rem;color:#806040;}
.q-rew{font-size:.7rem;color:#f0c030;margin-top:4px;}
.q-done-badge{font-size:.68rem;color:#f0c030;letter-spacing:1px;}

/* ========== BOONS ========== */
.boon-list{display:flex;flex-direction:column;gap:8px;}
.boon-card{
background:#1a1508;border:2px solid #4a3e20;border-radius:8px;
padding:12px;display:flex;gap:10px;align-items:center;cursor:pointer;
transition:border-color .15s,background .15s;
}
.boon-card.owned{border-color:#306820;background:#0d1a08;pointer-events:none;}
.boon-card.cant{opacity:.45;pointer-events:none;}
.boon-card:active:not(.owned):not(.cant){background:#2a2210;border-color:#f0c030;}
.boon-ico{
width:46px;height:46px;border-radius:8px;flex-shrink:0;
background:#0d0b07;border:2px solid #4a3e20;
display:flex;align-items:center;justify-content:center;font-size:1.5rem;
}
.boon-card.owned .boon-ico{border-color:#40b040;}
.boon-body{flex:1;min-width:0;}
.boon-name{font-size:.82rem;color:#f0d080;font-weight:700;margin-bottom:3px;}
.boon-desc{font-size:.7rem;color:#a08040;font-style:italic;}
.boon-cost{font-size:.75rem;color:#f0c030;margin-top:4px;}
.boon-owned-lbl{font-size:.7rem;color:#40b040;margin-top:4px;}

/* ========== STATS TAB ========== */
.stat-group{background:#1a1508;border:2px solid #4a3e20;border-radius:8px;padding:12px;margin-bottom:8px;}
.stat-group-title{font-size:.72rem;color:#f0c030;letter-spacing:2px;margin-bottom:8px;padding-bottom:6px;border-bottom:1px solid #4a3e20;}
.stat-row{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid #221d0c;}
.stat-row:last-child{border-bottom:none;}
.stat-lbl{font-size:.75rem;color:#a08040;display:flex;align-items:center;gap:5px;}
.stat-val{font-size:.8rem;color:#f0d080;font-weight:700;}
.prestige-box{background:#1a1508;border:2px solid #4a3e20;border-radius:8px;padding:14px;}
.prestige-box-title{font-size:.85rem;color:#f0c030;margin-bottom:8px;}
.prestige-box-desc{font-size:.75rem;color:#a08040;font-style:italic;line-height:1.5;margin-bottom:6px;}
.prestige-box-warn{font-size:.72rem;color:#e03030;margin-bottom:14px;}
.btn-prestige{
width:100%;padding:14px;font-family:‚ÄòCinzel‚Äô,serif;font-size:.9rem;font-weight:700;
letter-spacing:2px;color:#1a1000;
background:linear-gradient(160deg,#f0d060,#d4a020,#8a6010);
border:none;border-radius:6px;cursor:pointer;min-height:52px;
box-shadow:0 4px 16px rgba(240,192,48,.4);transition:all .12s;
}
.btn-prestige:active{transform:scale(.97);}

/* ========== DAMAGE NUMBERS ========== */
.dmg-num{
position:absolute;pointer-events:none;
font-family:‚ÄòCinzel‚Äô,serif;font-size:1rem;font-weight:700;
animation:floatup .75s ease-out forwards;white-space:nowrap;
text-shadow:0 1px 4px #000,0 0 8px rgba(0,0,0,.8);
}
.dmg-num.crit{font-size:1.3rem;color:#f0d060;}
.dmg-num.hit{color:#ff6060;}
.dmg-num.heal{color:#60e060;}
.dmg-num.enemy{color:#ffa060;}
.dmg-num.dodge{color:#80d0ff;font-size:.85rem;}
@keyframes floatup{0%{opacity:1;transform:translateY(0)scale(1);}60%{opacity:1;}100%{opacity:0;transform:translateY(-55px)scale(.8);}}

/* ========== LEVEL UP SPLASH ========== */
#lvlup{
position:fixed;inset:0;z-index:500;
pointer-events:none;
display:flex;align-items:center;justify-content:center;
opacity:0;transition:opacity .25s;
}
#lvlup.show{opacity:1;}
.lvlup-txt{
font-family:‚ÄòCinzel‚Äô,serif;font-size:2.2rem;font-weight:900;
color:#f0c030;
text-shadow:0 0 30px #f0c030,0 0 60px rgba(200,64,32,.8),0 4px 8px #000;
animation:lvlpop .7s ease-out forwards;
}
@keyframes lvlpop{0%{transform:scale(.5);opacity:0;}50%{transform:scale(1.15);}70%{transform:scale(.95);}100%{transform:scale(1);opacity:1;}}

/* ========== TOAST ========== */
#toast{
position:fixed;top:max(60px,env(safe-area-inset-top,60px));left:50%;
transform:translateX(-50%) translateY(-20px);
background:#221d0c;border:2px solid #7a5a10;border-radius:8px;
padding:10px 18px;
font-family:‚ÄòCinzel‚Äô,serif;font-size:.75rem;color:#f0c030;
opacity:0;transition:opacity .25s,transform .25s;z-index:900;
pointer-events:none;white-space:nowrap;letter-spacing:1px;
text-shadow:0 1px 3px #000;
box-shadow:0 4px 20px rgba(0,0,0,.8);
}
#toast.show{opacity:1;transform:translateX(-50%) translateY(0);}

/* ========== MODAL ========== */
#modal{
position:fixed;inset:0;background:rgba(0,0,0,.85);z-index:800;
display:none;align-items:center;justify-content:center;padding:16px;
}
#modal.open{display:flex;}
.modal-box{
background:#1a1508;border:2px solid #7a5a10;border-radius:10px;
padding:24px;max-width:360px;width:100%;text-align:center;
box-shadow:0 0 40px rgba(0,0,0,.9);
}
.modal-title{font-size:1.1rem;color:#f0c030;margin-bottom:10px;text-shadow:0 1px 4px #000;}
.modal-body{font-size:.82rem;color:#b09050;line-height:1.6;margin-bottom:10px;font-style:italic;}
.modal-warn{font-size:.75rem;color:#e03030;margin-bottom:16px;}
.modal-btns{display:flex;gap:10px;}
.m-btn{
flex:1;padding:13px;border:none;border-radius:6px;cursor:pointer;
font-family:‚ÄòCinzel‚Äô,serif;font-size:.85rem;font-weight:700;letter-spacing:1px;
min-height:50px;transition:all .12s;
}
.m-btn.go{background:linear-gradient(160deg,#f0d060,#d4a020,#8a6010);color:#1a1000;box-shadow:0 4px 16px rgba(240,192,48,.3);}
.m-btn.cancel{background:#221d0c;color:#a08040;border:2px solid #4a3e20;}
.m-btn:active{transform:scale(.96);}
</style>

</head>
<body>
<div id="app">

<!-- TITLE -->

<div class="scr on" id="s0">
  <canvas id="s0-canvas"></canvas>
  <div class="t-body">
    <div class="t-icon">üè∞</div>
    <div class="t-title">ASHEN<br>THRONE</div>
    <div class="t-line"></div>
    <div class="t-sub">Gothic Idle RPG</div>
    <button class="t-btn" onclick="gotoClassSelect()">‚öî ENTER REALM</button>
    <div class="t-hint">Progress saves automatically</div>
  </div>
</div>

<!-- CLASS SELECT -->

<div class="scr" id="s1">
  <div class="cls-hdr">‚Äî CHOOSE YOUR PATH ‚Äî</div>
  <div class="cls-list" id="cls-list"></div>
  <div class="cls-foot">
    <button class="cls-go" id="cls-go-btn" disabled onclick="confirmClass()">BEGIN JOURNEY</button>
  </div>
</div>

<!-- MAIN GAME -->

<div class="scr" id="s2">
  <!-- HUD -->
  <div id="hud">
    <div id="hud-av">‚öî</div>
    <div id="hud-bars">
      <div class="br">
        <span class="br-ico" style="color:#e84040;">‚ô•</span>
        <div class="br-track"><div class="br-fill hp" id="b-hp" style="width:100%"></div></div>
        <span class="br-val" id="v-hp">100/100</span>
      </div>
      <div class="br">
        <span class="br-ico" style="color:#4070e0;">‚ú¶</span>
        <div class="br-track"><div class="br-fill mp" id="b-mp" style="width:100%"></div></div>
        <span class="br-val" id="v-mp">50/50</span>
      </div>
      <div class="br">
        <span class="br-ico" style="color:#40b040;">‚òÖ</span>
        <div class="br-track"><div class="br-fill xp" id="b-xp" style="width:0%"></div></div>
        <span class="br-val" id="v-xp">0/100</span>
      </div>
    </div>
    <div id="hud-right">
      <div id="hud-gold">üí∞ <span id="hud-gold-val">0</span></div>
      <div id="hud-lv">Lv.<span id="hud-lv-val">1</span></div>
      <div id="hud-zbadge">Zone <span id="hud-zone-val">1</span></div>
    </div>
  </div>

  <!-- ARENA -->

  <div id="arena-wrap">
    <canvas id="arena-cv"></canvas>
    <div id="arena-ov"></div>
    <div id="zone-prog-bar"><div id="zone-prog-fill" style="width:0%"></div></div>
    <button id="btn-auto" onclick="toggleAuto()">AUTO OFF</button>
    <button id="btn-zone" onclick="advanceZone()">‚Üí NEXT ZONE</button>
    <button id="btn-attack" ontouchstart="doAttackTouch(event)" onmousedown="doAttackTouch(event)">‚öî</button>
  </div>

  <!-- TABS -->

  <div id="tabs">
    <div class="tab-btn on" id="tb-skills" onclick="openTab('skills')">
      <span class="tab-ico">‚öî</span><span class="tab-lbl">Skills</span>
    </div>
    <div class="tab-btn" id="tb-quests" onclick="openTab('quests')">
      <span class="tab-ico">üìú</span><span class="tab-lbl">Quests</span>
    </div>
    <div class="tab-btn" id="tb-boons" onclick="openTab('boons')">
      <span class="tab-ico">‚öó</span><span class="tab-lbl">Boons</span>
    </div>
    <div class="tab-btn" id="tb-stats" onclick="openTab('stats')">
      <span class="tab-ico">üìä</span><span class="tab-lbl">Stats</span>
    </div>
  </div>

  <!-- TAB BODY -->

  <div id="tab-body"></div>
</div>

</div><!-- #app -->

<!-- OVERLAYS -->

<div id="lvlup"><div class="lvlup-txt" id="lvlup-txt">LEVEL UP!</div></div>
<div id="toast"></div>
<div id="modal">
  <div class="modal-box">
    <div class="modal-title" id="modal-title">Confirm</div>
    <div class="modal-body" id="modal-body"></div>
    <div class="modal-warn" id="modal-warn"></div>
    <div class="modal-btns">
      <button class="m-btn go" id="modal-ok">Confirm</button>
      <button class="m-btn cancel" onclick="closeModal()">Cancel</button>
    </div>
  </div>
</div>

<script>
/* =====================================================
   AUDIO ENGINE
===================================================== */
let AC=null,audioOn=false;
function initAudio(){
  if(AC)return;
  try{AC=new(window.AudioContext||window.webkitAudioContext)();audioOn=true;}catch(e){}
}
function tone(freq,type,dur,vol,delay=0){
  if(!AC||!audioOn)return;
  const o=AC.createOscillator(),g=AC.createGain();
  o.connect(g);g.connect(AC.destination);
  o.type=type;o.frequency.value=freq;
  const t=AC.currentTime+delay;
  g.gain.setValueAtTime(vol,t);
  g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  o.start(t);o.stop(t+dur+.01);
}
function noise(dur,vol,delay=0){
  if(!AC||!audioOn)return;
  const buf=AC.createBuffer(1,AC.sampleRate*dur,AC.sampleRate);
  const d=buf.getChannelData(0);
  for(let i=0;i<d.length;i++)d[i]=Math.random()*2-1;
  const s=AC.createBufferSource(),g=AC.createGain();
  s.buffer=buf;s.connect(g);g.connect(AC.destination);
  const t=AC.currentTime+delay;
  g.gain.setValueAtTime(vol,t);
  g.gain.exponentialRampToValueAtTime(0.001,t+dur);
  s.start(t);
}
const SFX={
  hit(){noise(.045,.18);tone(160,'square',.05,.09,.02)},
  crit(){tone(350,'square',.04,.18);tone(700,'square',.04,.15,.04);tone(1050,'square',.04,.12,.08)},
  die(){tone(200,'sawtooth',.08,.15);tone(140,'sawtooth',.12,.12,.06);tone(100,'sawtooth',.18,.1,.12)},
  kill(){tone(450,'square',.04,.14);tone(350,'square',.04,.12,.04);tone(250,'square',.07,.1,.08)},
  lvlup(){[400,500,630,800,1000].forEach((f,i)=>tone(f,'square',.08,.18,i*.08))},
  gold(){tone(900,'sine',.05,.1);tone(1350,'sine',.04,.08,.05)},
  skill(){tone(650,'triangle',.06,.13);tone(975,'triangle',.08,.1,.05)},
  quest(){[530,660,800,660,800,1000].forEach((f,i)=>tone(f,'square',.06,.15,i*.07))},
  prestige(){[220,330,440,550,660,880,1100].forEach((f,i)=>tone(f,'square',.1,.2,i*.09))},
  hurt(){tone(190,'sawtooth',.06,.12);noise(.04,.08,.02)},
};
let bgHandle=null;
function startBGM(){
  if(!AC)return;
  const melody=[220,261,330,220,196,220,261,196];
  let i=0;
  function next(){
    if(audioOn){
      const o=AC.createOscillator(),g=AC.createGain();
      o.connect(g);g.connect(AC.destination);
      o.type='triangle';o.frequency.value=melody[i%melody.length];
      g.gain.setValueAtTime(.03,AC.currentTime);
      g.gain.exponentialRampToValueAtTime(.001,AC.currentTime+.35);
      o.start();o.stop(AC.currentTime+.35);
    }
    i++;bgHandle=setTimeout(next,i%4===0?900:450);
  }
  setTimeout(next,800);
}

/* =====================================================
   PIXEL ART ‚Äî 3px grid renderer
===================================================== */
const PX=3;
function drawSprite(ctx,sprite,ox,oy){
  sprite.forEach((row,ry)=>row.forEach((c,rx)=>{
    if(!c)return;ctx.fillStyle=c;ctx.fillRect(ox+rx*PX,oy+ry*PX,PX,PX);
  }));
}

// Player sprites
const SPRITES={
  warrior(p){return[
    [0,0,p.h,p.h,p.h,p.h,0,0,0],
    [0,p.h,p.s,p.s,p.s,p.s,p.h,0,0],
    [0,0,p.s,p.s,p.s,p.s,p.s,0,0],
    [0,0,p.s,p.e,p.s,p.e,p.s,0,0],
    [0,0,p.s,p.s,p.s,p.s,p.s,0,0],
    [p.a2,p.a,p.a,p.b,p.b,p.b,p.a,p.a,p.a2],
    [p.a,p.a2,p.a,p.a,p.a,p.a,p.a,p.a2,p.a],
    [0,p.a,p.a2,p.a,p.a,p.a,p.a2,p.a,0],
    [0,p.a,p.a,p.a2,p.a2,p.a2,p.a,p.a,0],
    [0,p.a2,p.a,0,0,0,p.a,p.a2,0],
    [0,p.a,p.a,0,0,0,p.a,p.a,0],
    [0,p.a2,p.a2,0,0,0,p.a2,p.a2,0],
  ]},
  mage(p){return[
    [0,p.h,p.h,p.h,p.h,p.h,p.h,0,0],
    [0,0,p.s,p.s,p.s,p.s,p.s,0,0],
    [0,0,p.s,p.e,p.s,p.e,p.s,0,0],
    [0,0,p.s,p.s,p.s,p.s,p.s,0,0],
    [0,p.r2,p.r,p.r,p.r,p.r,p.r,p.r2,0],
    [p.r,p.r2,p.r,p.g,p.r,p.g,p.r,p.r2,p.r],
    [0,p.r,p.r2,p.r,p.r,p.r,p.r2,p.r,0],
    [0,p.r,p.r,p.r2,p.r2,p.r2,p.r,p.r,0],
    [0,p.r2,p.r,0,0,0,p.r,p.r2,0],
    [0,p.r,p.r,0,0,0,p.r,p.r,0],
    [0,p.r2,p.r2,0,0,0,p.r2,p.r2,0],
  ]},
  rogue(p){return[
    [0,p.h,p.h,p.h,p.h,0,0,0,0],
    [p.c2,p.c,p.s,p.s,p.s,p.c,0,0,0],
    [0,0,p.s,p.e,p.s,p.s,0,0,0],
    [0,0,p.s,p.s,p.s,p.s,0,0,0],
    [0,p.c2,p.c,p.c,p.c,p.c,p.c2,0,0],
    [p.c,p.c2,p.c,p.c,p.c,p.c,p.c2,p.bl,0],
    [0,p.c,p.c2,p.c,p.c,p.c2,p.c,p.bl2,0],
    [0,p.c,p.c,p.c2,p.c2,p.c,p.c,p.bl,0],
    [0,p.c2,p.c,0,0,p.c,p.c2,0,0],
    [0,p.c,p.c,0,0,p.c,p.c,0,0],
    [0,p.c2,p.c2,0,0,p.c2,p.c2,0,0],
  ]},
};
const PAL={
  warrior:{s:'#d4906a',h:'#403020',e:'#1a1008',a:'#607090',a2:'#8090b0',b:'#c08020'},
  mage:{s:'#d4906a',h:'#1a1a3a',e:'#8020e0',r:'#4a1a6a',r2:'#7040a0',g:'#c020e0'},
  rogue:{s:'#c07050',h:'#181210',e:'#1a1008',c:'#202020',c2:'#383838',bl:'#c0c8d0',bl2:'#e0e8f0'},
};

// Enemy sprites
const ENEMY={
  rat:{w:7,h:7,draw(ctx,x,y,sc){
    const c=['#603020','#804030','#a06040','#201010'];const p=PX*sc;
    [[0,c[0],c[0],0,c[1],0,0],[0,c[1],c[2],c[1],c[2],0,0],
     [c[0],c[2],c[2],c[2],c[1],c[0],0],[0,c[1],c[2],c[1],c[2],c[0],0],
     [0,c[0],c[1],c[0],c[0],0,0],[0,c[0],0,c[0],0,0,0]].forEach((row,ry)=>
      row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
  }},
  skeleton:{w:8,h:10,draw(ctx,x,y,sc){
    const c=['#d8d0b8','#b8b0a0','#e8e0d0','#1a1808'];const p=PX*sc;
    [[0,c[2],c[0],c[0],c[0],c[2],0,0],[0,c[0],c[2],c[0],c[2],c[0],0,0],
     [0,c[0],c[3],c[0],c[3],c[0],0,0],[0,c[0],c[2],c[0],c[2],c[0],0,0],
     [0,c[2],c[0],c[0],c[0],c[2],0,0],[c[1],c[0],c[1],c[0],c[1],c[0],c[1],0],
     [0,c[1],c[0],c[0],c[0],c[1],0,0],[0,c[0],c[1],0,c[1],c[0],0,0],
     [0,c[1],c[0],0,c[0],c[1],0,0]].forEach((row,ry)=>
      row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
  }},
  zombie:{w:8,h:10,draw(ctx,x,y,sc){
    const c=['#507840','#406030','#a8c888','#1a1808'];const p=PX*sc;
    [[0,c[0],c[1],c[0],c[0],c[1],0,0],[0,c[2],c[0],c[2],c[2],c[0],c[2],0],
     [0,c[0],c[2],c[3],c[2],c[2],c[0],0],[0,c[0],c[3],c[2],c[3],c[2],c[0],0],
     [0,c[0],c[2],c[2],c[2],c[2],c[0],0],[0,c[1],c[0],c[0],c[0],c[0],c[1],0],
     [c[1],c[0],c[1],c[0],c[0],c[1],c[0],c[1]],[0,c[1],c[0],c[0],c[0],c[1],0,0],
     [0,c[0],c[1],0,c[1],c[0],0,0]].forEach((row,ry)=>
      row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
  }},
  wraith:{w:8,h:9,draw(ctx,x,y,sc){
    const c=['#2020a0','#5050d0','#9090f8','#ffffff'];const p=PX*sc;
    [[0,0,c[2],c[1],c[1],c[2],0,0],[0,c[1],c[3],c[2],c[2],c[3],c[1],0],
     [0,c[1],c[2],c[3],c[2],c[2],c[1],0],[0,c[0],c[1],c[2],c[2],c[1],c[0],0],
     [0,c[1],c[0],c[1],c[1],c[0],c[1],0],[c[0],c[1],c[0],c[1],c[1],c[0],c[1],c[0]],
     [0,c[0],c[1],0,0,c[1],c[0],0],[0,0,c[0],0,0,c[0],0,0]].forEach((row,ry)=>
      row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
  }},
  dragon:{w:12,h:9,draw(ctx,x,y,sc){
    const c=['#801010','#c03020','#e04030','#401010','#ffa030','#ffcc60'];const p=PX*sc;
    [[0,0,0,c[0],c[1],c[0],0,0,0,0,c[4],0],
     [0,0,c[0],c[2],c[2],c[2],c[0],0,0,c[4],c[5],c[4]],
     [0,c[0],c[2],c[1],c[2],c[1],c[2],c[0],0,0,c[4],0],
     [c[0],c[2],c[2],c[3],c[2],c[3],c[2],c[2],c[0],0,0,0],
     [0,c[1],c[2],c[2],c[2],c[2],c[2],c[1],0,0,0,0],
     [0,c[0],c[1],c[0],c[0],c[0],c[1],c[0],0,0,0,0],
     [c[0],c[1],c[0],c[1],c[0],c[1],c[0],c[1],c[0],0,0,0],
     [0,c[0],c[1],c[0],0,c[0],c[1],c[0],0,0,0,0]].forEach((row,ry)=>
      row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
  }},
  lich:{w:9,h:10,draw(ctx,x,y,sc){
    const c=['#1a1a2a','#3a2a5a','#7050b0','#e8e0ff','#c84820'];const p=PX*sc;
    [[0,c[1],c[2],c[3],c[3],c[2],c[1],0,0],
     [c[1],c[2],c[3],c[2],c[2],c[3],c[2],c[1],0],
     [0,c[2],c[3],c[4],c[3],c[4],c[3],c[2],0],
     [0,c[1],c[3],c[3],c[3],c[3],c[3],c[1],0],
     [0,c[2],c[1],c[2],c[2],c[2],c[1],c[2],0],
     [c[1],c[2],c[3],c[2],c[2],c[2],c[3],c[2],c[1]],
     [0,c[1],c[2],c[3],c[2],c[3],c[2],c[1],0],
     [0,c[2],c[1],0,0,0,c[1],c[2],0],
     [0,c[1],c[2],0,0,0,c[2],c[1],0]].forEach((row,ry)=>
      row.forEach((col,rx)=>{if(!col)return;ctx.fillStyle=col;ctx.fillRect(x+rx*p,y+ry*p,p,p)}));
  }},
};

// Zone backgrounds
const ZBGS=[
  {sky:['#1a1208','#2a1a0e'],ground:'#2a1e10',hill:'#141008',name:'Ashen Fields'},
  {sky:['#120808','#1e1010'],ground:'#1a1208',hill:'#0e0808',name:'Catacombs'},
  {sky:['#080c18','#101828'],ground:'#1a2030',hill:'#08101e',name:'Frostmere'},
  {sky:['#0c0818','#180c28'],ground:'#1a1028',hill:'#0c0814',name:'Shadowmere'},
  {sky:['#180808','#200a0a'],ground:'#201010',hill:'#100808',name:'Obsidian Keep'},
  {sky:['#080c18','#141428'],ground:'#181820',hill:'#0a0a14',name:'Spectral Wastes'},
  {sky:['#100818','#1a0c20'],ground:'#1a1020',hill:'#0c0810',name:'Void Spire'},
  {sky:['#100808','#180808'],ground:'#1c0c0c',hill:'#0c0404',name:'Infernal Core'},
];
const ZPOOL=[
  ['rat','rat','skeleton'],['skeleton','zombie','skeleton'],
  ['zombie','wraith','zombie'],['wraith','wraith','lich'],
  ['dragon','lich','dragon'],['lich','dragon','wraith'],
  ['dragon','lich','dragon'],['lich','dragon','lich'],
];
const ENAMES={
  rat:['Grave Rat','Diseased Rat','Feral Rat'],
  skeleton:['Skeleton Guard','Bone Archer','Crypt Warrior'],
  zombie:['Rot Zombie','Plague Shambler','Brute Zombie'],
  wraith:['Frost Wraith','Shadow Wraith','Banshee'],
  dragon:['Shadow Drake','Ember Wyvern','Ancient Dragon'],
  lich:['Bone Lich','Void Lich','Soul Lich'],
};

/* =====================================================
   GAME DATA
===================================================== */
const CLASSES={
  warrior:{icon:'‚öî',name:'Ironclad Warrior',flavor:'"Steel will, iron flesh"',baseAtk:8,baseDef:5,baseHp:160,baseMana:30,baseSpd:1.0,baseCrit:5,baseSpell:0,hints:['‚öî High Damage','üõ° Best Defense','‚ù§ Most HP']},
  mage:{icon:'üîÆ',name:'Void Mage',flavor:'"Power without mercy"',baseAtk:4,baseDef:2,baseHp:90,baseMana:120,baseSpd:1.0,baseCrit:12,baseSpell:14,hints:['üîÆ Spell Damage','üí• High Crit','‚ú¶ Mana Scaling']},
  rogue:{icon:'üó°',name:'Shadow Rogue',flavor:'"Strike unseen, vanish"',baseAtk:6,baseDef:2,baseHp:110,baseMana:70,baseSpd:1.6,baseCrit:22,baseSpell:0,hints:['‚ö° Fast Attacks','üí• Best Crit','üë§ Dodge']},
};

const SKTREES={
  offense:[
    {id:'heavy',name:'Heavy Strike',ico:'üí•',desc:'+4 ATK per level',max:6,eff:'atk',val:4},
    {id:'execute',name:'Execute',ico:'üó°',desc:'+6% crit per level',max:5,eff:'crit',val:6,req:'heavy'},
    {id:'berserk',name:'Berserker',ico:'üî•',desc:'<30% HP ‚Üí +60% ATK',max:1,eff:'special'},
    {id:'overpower',name:'Overpower',ico:'üí¢',desc:'Every 5th hit = 3√ó dmg',max:1,eff:'special',req:'execute'},
  ],
  defense:[
    {id:'ironskin',name:'Iron Skin',ico:'üõ°',desc:'+3 DEF per level',max:6,eff:'def',val:3},
    {id:'vigor',name:'Vigor',ico:'‚ù§',desc:'+20 Max HP per level',max:5,eff:'maxHp',val:20},
    {id:'regen',name:'Regeneration',ico:'üíö',desc:'Regen 2% HP per kill',max:3,eff:'regen',val:2,req:'vigor'},
    {id:'fortress',name:'Fortress',ico:'üè∞',desc:'Block 15% enemy damage',max:1,eff:'block',val:15,req:'ironskin'},
  ],
  magic:[
    {id:'arcane',name:'Arcane Surge',ico:'‚ú®',desc:'+6 Spell DMG per level',max:6,eff:'spell',val:6},
    {id:'manawell',name:'Mana Well',ico:'‚ú¶',desc:'+20 Max Mana per level',max:5,eff:'maxMana',val:20},
    {id:'soulburn',name:'Soul Burn',ico:'üåë',desc:'Spells deal +25% damage',max:1,eff:'special',req:'arcane'},
    {id:'drain',name:'Life Drain',ico:'ü©∏',desc:'+3% lifesteal per level',max:4,eff:'life',val:3},
  ],
  agility:[
    {id:'swift',name:'Swiftness',ico:'‚ö°',desc:'+0.12 ATK speed per level',max:5,eff:'spd',val:0.12},
    {id:'dodge',name:'Shadow Step',ico:'üë§',desc:'+8% dodge per level',max:3,eff:'dodge',val:8},
    {id:'flurry',name:'Flurry',ico:'üåÄ',desc:'Crits trigger +2 bonus hits',max:1,eff:'special',req:'swift'},
    {id:'shadowform',name:'Shadowform',ico:'üå´',desc:'+15% to all stats',max:1,eff:'allstats',val:15},
  ],
};

const QUESTS=[
  {id:'q1',ico:'ü©∏',name:'First Blood',desc:'Slay 10 enemies',type:'kills',target:10,rew:{g:50,sp:2},done:false},
  {id:'q2',ico:'üíÄ',name:'Slaughterer',desc:'Slay 100 enemies',type:'kills',target:100,rew:{g:300,sp:5},done:false},
  {id:'q3',ico:'üíÄ',name:'Reaper',desc:'Slay 1000 enemies',type:'kills',target:1000,rew:{g:2000,sp:15},done:false},
  {id:'q4',ico:'‚¨Ü',name:'Initiate',desc:'Reach level 5',type:'level',target:5,rew:{g:100,sp:3},done:false},
  {id:'q5',ico:'‚¨Ü',name:'Champion',desc:'Reach level 20',type:'level',target:20,rew:{g:1000,sp:10},done:false},
  {id:'q6',ico:'‚¨Ü',name:'Legend',desc:'Reach level 50',type:'level',target:50,rew:{g:5000,sp:25},done:false},
  {id:'q7',ico:'üó∫',name:'Explorer',desc:'Reach Zone 3',type:'zone',target:3,rew:{g:400,sp:8},done:false},
  {id:'q8',ico:'üó∫',name:'Conqueror',desc:'Reach Zone 6',type:'zone',target:6,rew:{g:2000,sp:20},done:false},
  {id:'q9',ico:'üí∞',name:'Miser',desc:'Earn 1000 total gold',type:'gtotal',target:1000,rew:{g:0,sp:5},done:false},
  {id:'q10',ico:'üí∞',name:'Wealthy',desc:'Earn 10000 total gold',type:'gtotal',target:10000,rew:{g:0,sp:15},done:false},
  {id:'q11',ico:'‚ú®',name:'Awakened',desc:'Unlock 10 skills',type:'sktotal',target:10,rew:{g:1500,sp:12},done:false},
  {id:'q12',ico:'üîÑ',name:'Reborn',desc:'Prestige once',type:'prestige',target:1,rew:{g:0,sp:30},done:false},
];

const BOONS=[
  {id:'b1',ico:'üí™',name:'Iron Discipline',desc:'+10% base ATK permanently',cost:500},
  {id:'b2',ico:'üåë',name:'Shadow Harvest',desc:'+15% gold from all enemies',cost:300},
  {id:'b3',ico:'üìö',name:'Ancient Wisdom',desc:'+20% XP from all sources',cost:600},
  {id:'b4',ico:'ü©∏',name:'Blood Pact',desc:'Restore HP to full on kill',cost:800},
  {id:'b5',ico:'üå¨',name:'Ethereal Gale',desc:'+0.3 attack speed',cost:1200},
  {id:'b6',ico:'üêâ',name:'Dragonfire',desc:'+30% ATK and +30% enemy HP',cost:1500},
  {id:'b7',ico:'üîÆ',name:'Soul Crystal',desc:'+25% spell damage',cost:1000},
  {id:'b8',ico:'üëë',name:'Sovereign Mark',desc:'+5 all stats per zone level',cost:2000},
  {id:'b9',ico:'‚ö°',name:'Static Surge',desc:'+2 attacks on every crit',cost:1800},
  {id:'b10',ico:'üåø',name:'Life Root',desc:'+3% lifesteal',cost:900},
];

/* =====================================================
   GAME STATE
===================================================== */
const SAVE='ashen_v4';
let G=null;
function mkState(){
  return{
    cls:'warrior',selCls:null,
    lv:1,xp:0,xpNext:100,
    hp:160,maxHp:160,mana:30,maxMana:30,
    gold:0,gtotal:0,kills:0,deaths:0,
    zone:1,zoneKills:0,zoneTarget:10,
    sp:0,prestige:0,pbonus:1.0,
    sk:{},quests:QUESTS.map(q=>({...q})),
    boons:{},idle:false,lastSave:Date.now(),
    sktotal:0,
  };
}
function saveG(){try{localStorage.setItem(SAVE,JSON.stringify({...G,idle:false,lastSave:Date.now()}));}catch(e){}}
function loadG(){
  try{
    const d=localStorage.getItem(SAVE);
    if(d){
      const s=JSON.parse(d);G=mkState();Object.assign(G,s);
      G.quests=QUESTS.map(q=>{const sq=(s.quests||[]).find(x=>x.id===q.id);return sq?{...q,...sq}:{...q};});
      return true;
    }
  }catch(e){}
  G=mkState();return false;
}

/* =====================================================
   COMPUTED STATS
===================================================== */
function getStats(){
  const c=CLASSES[G.cls];
  let atk=c.baseAtk,def=c.baseDef,spd=c.baseSpd,crit=c.baseCrit;
  let life=0,spell=c.baseSpell||0,maxHp=c.baseHp,maxMana=c.baseMana,dodge=0,block=0;
  const lv=G.lv;
  atk+=(lv-1)*2.2;def+=(lv-1)*1.1;maxHp+=(lv-1)*13;
  const sk=G.sk;
  if(sk.heavy)   atk  +=sk.heavy*4;
  if(sk.ironskin)def  +=sk.ironskin*3;
  if(sk.vigor)   maxHp+=sk.vigor*20;
  if(sk.arcane)  spell+=sk.arcane*6;
  if(sk.manawell)maxMana+=sk.manawell*20;
  if(sk.swift)   spd  +=sk.swift*0.12;
  if(sk.dodge)   dodge+=sk.dodge*8;
  if(sk.execute) crit +=sk.execute*6;
  if(sk.drain)   life +=sk.drain*3;
  if(sk.fortress)block+=15;
  if(sk.soulburn)spell=Math.round(spell*1.25);
  if(sk.shadowform){atk*=1.15;def*=1.15;maxHp=Math.round(maxHp*1.15);}
  if(G.boons.b1) atk*=1.1;
  if(G.boons.b5) spd+=0.3;
  if(G.boons.b6) atk*=1.3;
  if(G.boons.b7) spell*=1.25;
  if(G.boons.b8){const zb=G.zone*5;atk+=zb;def+=zb;maxHp+=zb*3;}
  if(G.boons.b10)life+=3;
  atk*=G.pbonus;def*=G.pbonus;maxHp=Math.round(maxHp*G.pbonus);
  return{
    atk:Math.round(atk*10)/10,def:Math.round(def*10)/10,
    spd:Math.round(Math.max(.5,spd)*100)/100,
    crit:Math.round(crit),life:Math.round(life),
    spell:Math.round(spell),maxHp:Math.round(maxHp),
    maxMana:Math.round(maxMana),dodge:Math.round(dodge),block:Math.round(block),
  };
}
function xpFor(lv){return Math.floor(100*Math.pow(1.28,lv-1));}
function atkInterval(){return Math.max(250,Math.round(1000/getStats().spd));}

/* =====================================================
   CANVAS & ANIMATION
===================================================== */
let CV=null,CTX=null,raf=null;
let PA={x:0,y:0,bob:0,aflash:0,hflash:0};
let EA={x:0,y:0,bob:0,aflash:0,hflash:0,dead:false,deathT:0};
let bgScroll=0,particles=[];

function initCanvas(){
  CV=document.getElementById('arena-cv');
  CTX=CV.getContext('2d');
  resizeCv();
  window.addEventListener('resize',resizeCv);
  cancelAnimationFrame(raf);
  loop();
}
function resizeCv(){
  const w=document.getElementById('arena-wrap');
  CV.width=w.clientWidth;CV.height=w.clientHeight;
  PA.x=CV.width*.2;PA.y=CV.height*.45;
  EA.x=CV.width*.7;EA.y=CV.height*.42;
}
function loop(){
  PA.bob+=.04;EA.bob+=.035;bgScroll=(bgScroll+.3)%CV.width;
  if(PA.aflash>.01)PA.aflash-=.09;else PA.aflash=0;
  if(PA.hflash>.01)PA.hflash-=.09;else PA.hflash=0;
  if(EA.hflash>.01)EA.hflash-=.09;else EA.hflash=0;
  if(EA.dead&&EA.deathT<1)EA.deathT+=.06;
  particles=particles.filter(p=>{p.life-=.05;p.x+=p.vx;p.y+=p.vy;p.vy+=.12;return p.life>0;});
  drawArena();
  raf=requestAnimationFrame(loop);
}

function drawArena(){
  if(!CV||!CTX)return;
  const ctx=CTX,W=CV.width,H=CV.height;
  const zi=Math.min((G?G.zone:1)-1,ZBGS.length-1);
  const bg=ZBGS[zi];

  // Sky
  const sky=ctx.createLinearGradient(0,0,0,H*.65);
  sky.addColorStop(0,bg.sky[0]);sky.addColorStop(1,bg.sky[1]);
  ctx.fillStyle=sky;ctx.fillRect(0,0,W,H);

  // Stars for dark zones
  if(zi>0){
    ctx.fillStyle='rgba(255,255,200,.5)';
    for(let i=0;i<25;i++){
      const sx=((i*113+bgScroll*.08)%W),sy=5+(i*37)%(H*.45);
      ctx.fillRect(sx,sy,i%5===0?2:1,i%5===0?2:1);
    }
  }

  // Hills
  ctx.fillStyle=bg.hill;
  ctx.beginPath();ctx.moveTo(0,H*.58);
  for(let x=0;x<=W;x+=6){
    const h=Math.sin(x*.018+bgScroll*.001)*12+Math.sin(x*.04)*6;
    ctx.lineTo(x,H*.58+h);
  }
  ctx.lineTo(W,H);ctx.lineTo(0,H);ctx.closePath();ctx.fill();

  // Ground
  const gnd=ctx.createLinearGradient(0,H*.64,0,H);
  gnd.addColorStop(0,bg.ground);gnd.addColorStop(1,'#080604');
  ctx.fillStyle=gnd;ctx.fillRect(0,H*.64,W,H*.36);

  // Zone name
  ctx.font='bold 9px Cinzel,serif';ctx.textAlign='right';
  ctx.fillStyle='rgba(240,192,48,.3)';
  ctx.fillText(bg.name,W-6,14);ctx.textAlign='left';

  // Particles
  particles.forEach(p=>{
    ctx.globalAlpha=Math.max(0,p.life);
    ctx.fillStyle=p.color;
    ctx.fillRect(p.x,p.y,p.size,p.size);
  });
  ctx.globalAlpha=1;

  // Enemy
  if(G&&curEnemy){
    const es=ENEMY[curEnemy.key];
    if(es){
      const escale=Math.min(2.2,1+G.zone*.14);
      const ey=EA.y+Math.sin(EA.bob)*2;
      ctx.save();
      if(EA.dead){ctx.globalAlpha=Math.max(0,1-EA.deathT);ctx.translate(EA.x,ey+EA.deathT*18);}
      else{ctx.translate(EA.x,ey);}
      if(EA.hflash>.3){ctx.filter='brightness(4) saturate(0)';}
      ctx.scale(-escale,escale);
      es.draw(ctx,0,0,1);
      ctx.restore();
      if(!EA.dead){
        // Enemy HP bar
        const ehp=eHP/eMaxHP;
        const bw=52*escale,bx=EA.x-bw/2,by=ey-7;
        ctx.fillStyle='rgba(0,0,0,.7)';ctx.fillRect(bx,by,bw,5);
        ctx.fillStyle=ehp>.5?'#40b040':ehp>.25?'#c0a020':'#e03030';
        ctx.fillRect(bx,by,bw*Math.max(0,ehp),5);
        ctx.font='bold 8px Cinzel,serif';ctx.textAlign='center';
        ctx.fillStyle='rgba(240,216,160,.8)';
        ctx.fillText(curEnemy.name,EA.x+PX*2*escale,by-3);
        ctx.textAlign='left';
      }
    }
  }

  // Player
  if(G){
    const py=PA.y+Math.sin(PA.bob)*2;
    const pal=PAL[G.cls];
    const psp=SPRITES[G.cls](pal);
    ctx.save();
    if(PA.hflash>.3){ctx.filter='brightness(3) sepia(1) hue-rotate(320deg)';}
    if(PA.aflash>.5){ctx.filter='brightness(2.5)';}
    drawSprite(ctx,psp,PA.x,py);
    ctx.restore();
    // Player HP mini
    const st=getStats();const phpp=G.hp/st.maxHp;
    const pw=PX*9;
    ctx.fillStyle='rgba(0,0,0,.6)';ctx.fillRect(PA.x,py-7,pw,4);
    ctx.fillStyle=phpp>.5?'#40b040':phpp>.25?'#c0a020':'#e03030';
    ctx.fillRect(PA.x,py-7,pw*Math.max(0,phpp),4);
  }

  // Attack slash effect
  if(PA.aflash>.5){
    const prog=(PA.aflash-.5)*2;
    ctx.globalAlpha=prog*.9;
    ctx.strokeStyle='#f0e0a0';ctx.lineWidth=PX;
    const sx=PA.x+32+prog*50,sy=PA.y+5;
    ctx.beginPath();ctx.moveTo(sx,sy-12);ctx.lineTo(sx+18,sy+12);ctx.stroke();
    ctx.beginPath();ctx.moveTo(sx+6,sy-18);ctx.lineTo(sx+24,sy+6);ctx.stroke();
    ctx.globalAlpha=1;
  }
  if(G&&G.cls==='mage'&&PA.aflash>.5){
    const prog=(PA.aflash-.5)*2;
    for(let i=0;i<6;i++){
      const a=(i/6)*Math.PI*2+prog*4;const r=22*prog;
      ctx.globalAlpha=prog*.7;
      ctx.fillStyle=i%2?'#9050e0':'#c090f8';
      ctx.fillRect(PA.x+30+r*Math.cos(a),PA.y+15+r*Math.sin(a)*.6,PX,PX);
    }
    ctx.globalAlpha=1;
  }
}

function spawnParticles(x,y,col,n=8){
  for(let i=0;i<n;i++){
    const a=Math.random()*Math.PI*2,s=1.5+Math.random()*3;
    particles.push({x,y,vx:Math.cos(a)*s,vy:Math.sin(a)*s-1.5,color:col,size:PX,life:1});
  }
}

/* =====================================================
   COMBAT
===================================================== */
let curEnemy=null,eHP=0,eMaxHP=0,atkTimer=null,atkCount=0;

function spawnEnemy(){
  const zi=Math.min(G.zone-1,ZPOOL.length-1);
  const pool=ZPOOL[zi];
  const key=pool[Math.floor(Math.random()*pool.length)];
  const base=Math.round(28*Math.pow(1.6,G.zone-1));
  const boost=G.boons.b6?1.3:1;
  eMaxHP=Math.round(base*boost);eHP=eMaxHP;
  const nlist=ENAMES[key];
  curEnemy={key,name:nlist[Math.floor(Math.random()*nlist.length)]};
  EA.dead=false;EA.deathT=0;
  updateZoneBar();
}

function doAttack(manual=false){
  if(!G||G.hp<=0)return;
  initAudio();
  const st=getStats();atkCount++;
  PA.aflash=1;

  let dmg=st.atk*(0.85+Math.random()*.3);
  const isCrit=Math.random()*100<st.crit;
  if(isCrit)dmg*=2;
  if(G.sk.berserk&&G.hp/st.maxHp<.3)dmg*=1.6;
  if(G.sk.overpower&&atkCount%5===0)dmg*=3;
  if(st.spell>0)dmg+=st.spell*(.6+Math.random()*.4);
  dmg=Math.round(dmg);

  SFX.hit();if(isCrit)SFX.crit();
  spawnParticles(EA.x,EA.y,isCrit?'#f0c030':'#c03020',isCrit?14:7);
  eHP=Math.max(0,eHP-dmg);EA.hflash=1;
  showDmg(dmg,isCrit,'hit');

  if(st.life>0){
    const h=Math.round(dmg*st.life/100);
    if(h>0){G.hp=Math.min(st.maxHp,G.hp+h);showDmg(h,false,'heal');}
  }
  if(isCrit&&G.sk.flurry){
    setTimeout(()=>quickHit(),100);setTimeout(()=>quickHit(),200);
  }
  if(eHP<=0){killEnemy();return;}

  const eDmgRaw=Math.max(1,(4+G.zone*2.5)*Math.pow(1.18,G.zone-1));
  const blocked=st.block>0?eDmgRaw*st.block/100:0;
  let eDmg=Math.max(0,Math.round(eDmgRaw-st.def-blocked));
  if(Math.random()*100<st.dodge){eDmg=0;showDmg(0,false,'dodge');}
  if(eDmg>0){
    G.hp=Math.max(0,G.hp-eDmg);PA.hflash=1;EA.aflash=.4;
    SFX.hurt();showDmg(eDmg,false,'enemy');
    spawnParticles(PA.x+PX*4,PA.y+PX*5,'#c02020',4);
  }
  if(G.hp<=0)die();
  else updateHUD();
}
function quickHit(){
  if(!G||!curEnemy)return;
  const st=getStats();let dmg=Math.round(st.atk*.5);
  eHP=Math.max(0,eHP-dmg);PA.aflash=.7;
  if(eHP<=0){killEnemy();return;}
  showDmg(dmg,false,'hit');SFX.hit();updateHUD();
}
function killEnemy(){
  G.kills++;G.zoneKills++;EA.dead=true;EA.deathT=0;
  SFX.kill();spawnParticles(EA.x,EA.y,'#d4a020',18);

  let gold=Math.round((3+G.zone*3)*Math.pow(1.4,G.zone-1)*(0.8+Math.random()*.4));
  if(G.boons.b2)gold=Math.round(gold*1.15);
  if(G.boons.b6)gold=Math.round(gold*1.3);
  G.gold+=gold;G.gtotal+=gold;SFX.gold();

  let xpg=Math.round(9*Math.pow(1.45,G.zone-1));
  if(G.boons.b3)xpg=Math.round(xpg*1.2);
  G.xp+=xpg;

  const st=getStats();
  if(G.boons.b4)G.hp=st.maxHp;
  if(G.sk.regen)G.hp=Math.min(st.maxHp,G.hp+Math.round(st.maxHp*G.sk.regen*.02));

  while(G.xp>=G.xpNext){
    G.xp-=G.xpNext;G.lv++;G.xpNext=xpFor(G.lv);G.sp++;
    G.hp=getStats().maxHp;SFX.lvlup();showLvlUp();toast(`‚ö° Level ${G.lv}!`);
  }
  if(G.zoneKills>=G.zoneTarget){
    G.zone=Math.min(G.zone+1,8);G.zoneKills=0;G.zoneTarget=Math.round(G.zoneTarget*1.25);
    toast(`üó∫ Zone ${G.zone}: ${ZBGS[Math.min(G.zone-1,ZBGS.length-1)].name}!`);
  }
  checkQuests();
  setTimeout(spawnEnemy,500);
  updateHUD();if(curTab==='quests')renderTab();
}
function die(){
  G.deaths++;SFX.die();
  spawnParticles(PA.x+PX*4,PA.y+PX*5,'#c02020',20);
  const st=getStats();G.hp=Math.round(st.maxHp*.5);
  spawnEnemy();updateHUD();
}
function toggleAuto(){
  initAudio();G.idle=!G.idle;
  const b=document.getElementById('btn-auto');
  b.textContent=G.idle?'AUTO ON':'AUTO OFF';
  b.className=G.idle?'on':'';b.id='btn-auto';
  if(G.idle)startIdle();else stopIdle();
}
function startIdle(){stopIdle();atkTimer=setInterval(doAttack,atkInterval());}
function stopIdle(){if(atkTimer){clearInterval(atkTimer);atkTimer=null;}}
function advanceZone(){if(G.zone<8){G.zone++;G.zoneKills=0;spawnEnemy();toast(`‚Üí Zone ${G.zone}`);updateHUD();}}
function doAttackTouch(e){e.preventDefault();doAttack(true);}

/* =====================================================
   HUD
===================================================== */
function fmt(n){return n>=1e6?(n/1e6).toFixed(1)+'M':n>=1e3?(n/1e3).toFixed(1)+'K':n;}
function updateHUD(){
  if(!G)return;
  const st=getStats();
  const hp=Math.max(0,Math.min(100,G.hp/st.maxHp*100));
  const mp=Math.max(0,Math.min(100,G.mana/st.maxMana*100));
  const xp=Math.max(0,Math.min(100,G.xp/G.xpNext*100));
  document.getElementById('b-hp').style.width=hp+'%';
  document.getElementById('b-mp').style.width=mp+'%';
  document.getElementById('b-xp').style.width=xp+'%';
  document.getElementById('v-hp').textContent=Math.round(G.hp)+'/'+st.maxHp;
  document.getElementById('v-mp').textContent=Math.round(G.mana)+'/'+st.maxMana;
  document.getElementById('v-xp').textContent=G.xp+'/'+G.xpNext;
  document.getElementById('hud-gold-val').textContent=fmt(G.gold);
  document.getElementById('hud-lv-val').textContent=G.lv;
  document.getElementById('hud-zone-val').textContent=G.zone;
  updateZoneBar();
  const spEl=document.getElementById('sp-badge');
  if(spEl)spEl.textContent='SP: '+G.sp;
}
function updateZoneBar(){
  const pct=G?Math.min(100,(G.zoneKills/G.zoneTarget)*100):0;
  const el=document.getElementById('zone-prog-fill');
  if(el)el.style.width=pct+'%';
}

/* =====================================================
   TABS
===================================================== */
let curTab='skills',skSub='offense';
function openTab(t){
  curTab=t;
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));
  const tb=document.getElementById('tb-'+t);if(tb)tb.classList.add('on');
  renderTab();
}
function renderTab(){
  const el=document.getElementById('tab-body');
  if(!el)return;
  if(curTab==='skills')el.innerHTML=buildSkills();
  else if(curTab==='quests')el.innerHTML=buildQuests();
  else if(curTab==='boons')el.innerHTML=buildBoons();
  else if(curTab==='stats')el.innerHTML=buildStats();
}

/* SKILLS */
function buildSkills(){
  const sub=skSub;
  const allSk=Object.values(SKTREES).flat();
  const subIcos={offense:'‚öî',defense:'üõ°',magic:'üîÆ',agility:'‚ö°'};
  let h=`<div class="sec">
    <div class="sec-title">SKILL TREES <span class="sp-badge" id="sp-badge">SP: ${G.sp}</span></div>
    <div class="sk-tabs">
      ${Object.keys(SKTREES).map(k=>`<div class="sk-tab${skSub===k?' on':''}" onclick="setSkSub('${k}')">${subIcos[k]}</div>`).join('')}
    </div>
    <div class="sk-grid">`;
  SKTREES[sub].forEach(sk=>{
    const cur=G.sk[sk.id]||0;
    const maxed=cur>=sk.max;
    const locked=sk.req&&!(G.sk[sk.req]>=1);
    let cls='sk-card'+(maxed?' maxed':locked?' locked':cur>0?' unlocked':'');
    const pips=Array.from({length:sk.max},(_,i)=>`<div class="pip${i<cur?' '+(cur===sk.max?'onmax':'on'):''}"></div>`).join('');
    const reqName=sk.req?allSk.find(s=>s.id===sk.req)?.name:'';
    h+=`<div class="${cls}" onclick="buySkill('${sk.id}')">
      ${locked?`<div class="sk-lock">üîí</div>`:''}
      <div class="sk-ico">${sk.ico}</div>
      <div class="sk-name">${sk.name}</div>
      <div class="sk-desc">${sk.desc}${locked?`<br><span style="color:#e03030;font-size:.6rem">Req: ${reqName}</span>`:''}</div>
      <div class="sk-pips">${pips}</div>
      <div class="sk-lv">${cur}/${sk.max}</div>
    </div>`;
  });
  return h+'</div></div>';
}
function setSkSub(s){skSub=s;renderTab();}
function buySkill(id){
  initAudio();
  if(G.sp<=0){toast('No skill points!');return;}
  const allSk=Object.values(SKTREES).flat();
  const sk=allSk.find(s=>s.id===id);if(!sk)return;
  const cur=G.sk[id]||0;if(cur>=sk.max){toast('Already maxed!');return;}
  if(sk.req&&!(G.sk[sk.req]>=1)){toast('Skill locked!');return;}
  G.sp--;G.sk[id]=(G.sk[id]||0)+1;G.sktotal=(G.sktotal||0)+1;
  if(G.idle)startIdle();SFX.skill();
  checkQuests();renderTab();updateHUD();saveG();
}

/* QUESTS */
function buildQuests(){
  function prog(q){
    if(q.type==='kills')return G.kills;
    if(q.type==='level')return G.lv;
    if(q.type==='zone')return G.zone;
    if(q.type==='gtotal')return G.gtotal;
    if(q.type==='sktotal')return G.sktotal||0;
    if(q.type==='prestige')return G.prestige;
    return 0;
  }
  let h='<div class="sec"><div class="sec-title">QUEST LOG</div><div class="q-list">';
  G.quests.forEach(q=>{
    const p=prog(q),pct=Math.min(100,(p/q.target)*100);
    const rew=[q.rew.g>0&&`üí∞${q.rew.g}`,q.rew.sp>0&&`‚≠ê${q.rew.sp}SP`].filter(Boolean).join(' ');
    h+=`<div class="q-card${q.done?' done':''}">
      <div class="q-ico-wrap">${q.done?'‚úÖ':q.ico}</div>
      <div class="q-body">
        <div class="q-name">${q.name}</div>
        <div class="q-desc">${q.desc}</div>
        ${q.done
          ?'<div class="q-done-badge">‚ú¶ COMPLETE</div>'
          :`<div class="q-pbar-wrap"><div class="q-pbar" style="width:${pct}%"></div></div>
            <div class="q-prog">${Math.min(p,q.target).toLocaleString()} / ${q.target.toLocaleString()}</div>
            <div class="q-rew">Reward: ${rew}</div>`
        }
      </div>
    </div>`;
  });
  return h+'</div></div>';
}
function checkQuests(){
  function prog(q){
    if(q.type==='kills')return G.kills;if(q.type==='level')return G.lv;
    if(q.type==='zone')return G.zone;if(q.type==='gtotal')return G.gtotal;
    if(q.type==='sktotal')return G.sktotal||0;if(q.type==='prestige')return G.prestige;
    return 0;
  }
  G.quests.forEach(q=>{
    if(q.done)return;
    if(prog(q)>=q.target){
      q.done=true;G.gold+=q.rew.g;G.gtotal+=q.rew.g;G.sp+=q.rew.sp;
      SFX.quest();toast(`üìú ${q.name} done! +${q.rew.sp}SP`);
    }
  });
}

/* BOONS */
function buildBoons(){
  let h='<div class="sec"><div class="sec-title">UNLOCKABLE BOONS</div><div class="boon-list">';
  BOONS.forEach(b=>{
    const owned=!!G.boons[b.id];
    const cant=!owned&&G.gold<b.cost;
    h+=`<div class="boon-card${owned?' owned':cant?' cant':''}" onclick="${owned||cant?'':''}" onpointerdown="${owned||cant?'':  `buyBoon('${b.id}')`}">
      <div class="boon-ico">${b.ico}</div>
      <div class="boon-body">
        <div class="boon-name">${b.name}</div>
        <div class="boon-desc">${b.desc}</div>
        ${owned?'<div class="boon-owned-lbl">‚úì Acquired</div>':`<div class="boon-cost">üí∞ ${fmt(b.cost)}</div>`}
      </div>
    </div>`;
  });
  return h+'</div></div>';
}
function buyBoon(id){
  initAudio();
  const b=BOONS.find(x=>x.id===id);if(!b||G.boons[id])return;
  if(G.gold<b.cost){toast('Not enough gold!');return;}
  G.gold-=b.cost;G.boons[id]=true;SFX.skill();
  if(G.idle)startIdle();
  toast(`‚öó ${b.name} acquired!`);renderTab();updateHUD();saveG();
}

/* STATS */
function buildStats(){
  const st=getStats();
  const gain=Math.max(1,Math.floor(G.lv/5));
  return`<div class="sec">
    <div class="stat-group">
      <div class="stat-group-title">‚öî COMBAT STATS</div>
      ${statR('‚öî Attack',st.atk)}${statR('üõ° Defense',st.def)}
      ${statR('‚ö° Speed',st.spd+'x')}${statR('üí• Crit %',st.crit+'%')}
      ${statR('üîÆ Spell',st.spell)}${statR('ü©∏ Lifesteal',st.life+'%')}
      ${statR('üë§ Dodge',st.dodge+'%')}${statR('üè∞ Block',st.block+'%')}
    </div>
    <div class="stat-group">
      <div class="stat-group-title">üìä LIFETIME STATS</div>
      ${statR('üíÄ Kills',G.kills.toLocaleString())}
      ${statR('üí∞ Gold Earned',G.gtotal.toLocaleString())}
      ${statR('üíÄ Deaths',G.deaths)}
      ${statR('‚ú® Prestige',G.prestige)}
      ${statR('üìà Stat Bonus','+'+Math.round((G.pbonus-1)*100)+'%')}
    </div>
    <div class="prestige-box">
      <div class="prestige-box-title">‚ú® Prestige Ascension</div>
      <div class="prestige-box-desc">Sacrifice your progress to gain permanent power. Earn <b style="color:#f0c030">${gain}</b> prestige point${gain>1?'s':''} (+5% all stats each).</div>
      <div class="prestige-box-warn">‚ö† Resets: level, gold, skills, zone</div>
      <button class="btn-prestige" onclick="openPrestige()">‚ú® ASCEND ‚Äî GAIN ${gain} POINT${gain>1?'S':''}</button>
    </div>
  </div>`;
}
function statR(l,v){return`<div class="stat-row"><span class="stat-lbl">${l}</span><span class="stat-val">${v}</span></div>`;}

/* =====================================================
   PRESTIGE
===================================================== */
function openPrestige(){
  const gain=Math.max(1,Math.floor(G.lv/5));
  document.getElementById('modal-title').textContent='‚ú® Prestige Ascension';
  document.getElementById('modal-body').textContent=`You will gain ${gain} prestige point${gain>1?'s':''}, permanently increasing all stats by ${gain*5}%.`;
  document.getElementById('modal-warn').textContent='‚ö† Your level, gold, skills and zone will reset.';
  document.getElementById('modal-ok').onclick=doPrestige;
  document.getElementById('modal').classList.add('open');
}
function closeModal(){document.getElementById('modal').classList.remove('open');}
function doPrestige(){
  const gain=Math.max(1,Math.floor(G.lv/5));
  G.prestige+=gain;G.pbonus=1+G.prestige*.05;
  G.lv=1;G.xp=0;G.xpNext=100;
  G.sp=0;G.sk={};
  G.zone=1;G.zoneKills=0;G.zoneTarget=10;
  G.gold=0;G.sktotal=0;
  const st=getStats();G.hp=st.maxHp;G.mana=CLASSES[G.cls].baseMana;
  spawnEnemy();closeModal();checkQuests();SFX.prestige();
  toast(`‚ú® Prestige ${G.prestige}! +${Math.round((G.pbonus-1)*100)}% stats!`);
  updateHUD();renderTab();saveG();
}

/* =====================================================
   DAMAGE NUMBERS
===================================================== */
function showDmg(val,isCrit,type){
  const ov=document.getElementById('arena-ov');if(!ov)return;
  const el=document.createElement('div');
  el.className='dmg-num '+(isCrit?'crit':type==='heal'?'heal':type==='dodge'?'dodge':type==='enemy'?'enemy':'hit');
  const W=CV?CV.width:300,H=CV?CV.height:180;
  const isEnemy=(type==='enemy');
  const bx=isEnemy?(PA.x+Math.random()*16):(EA.x+Math.random()*16);
  const by=isEnemy?(PA.y+5):(EA.y);
  el.style.left=Math.max(2,Math.min(W-60,bx))+'px';
  el.style.top=Math.max(0,Math.min(H-24,by))+'px';
  el.textContent=type==='dodge'?'DODGE':type==='heal'?'+'+val:(isCrit?'‚òÖ':'')+val;
  ov.appendChild(el);setTimeout(()=>el.remove(),780);
}

/* =====================================================
   CLASS SELECT
===================================================== */
function buildClassCards(){
  const list=document.getElementById('cls-list');if(!list)return;
  list.innerHTML='';
  Object.entries(CLASSES).forEach(([k,c])=>{
    const card=document.createElement('div');
    card.className='cls-card'+(G.selCls===k?' sel':'');
    card.id='cls-'+k;card.onclick=()=>pickClass(k);
    const wrap=document.createElement('div');wrap.className='cls-sprite-wrap';
    const cv=document.createElement('canvas');cv.width=70;cv.height=70;
    const cx=cv.getContext('2d');cx.imageSmoothingEnabled=false;
    const pal=PAL[k];const spr=SPRITES[k](pal);
    spr.forEach((row,ry)=>row.forEach((col,rx)=>{if(!col)return;cx.fillStyle=col;cx.fillRect(4+rx*PX*1.5,4+ry*PX*1.5,PX*1.5,PX*1.5);}));
    wrap.appendChild(cv);card.appendChild(wrap);
    card.insertAdjacentHTML('beforeend',`
      <div class="cls-text">
        <div class="cls-name">${c.name}</div>
        <div class="cls-flavor">${c.flavor}</div>
        <div class="cls-stats">${c.hints.map(h=>`<span class="cls-stat">${h}</span>`).join('')}</div>
      </div>`);
    list.appendChild(card);
  });
}
function pickClass(k){
  G.selCls=k;G.cls=k;
  document.querySelectorAll('.cls-card').forEach(c=>c.classList.remove('sel'));
  document.getElementById('cls-'+k)?.classList.add('sel');
  document.getElementById('cls-go-btn').disabled=false;
  const st=getStats();G.hp=st.maxHp;G.maxHp=st.maxHp;
  G.mana=CLASSES[k].baseMana;G.maxMana=G.mana;
}
function confirmClass(){
  if(!G.selCls)return;
  document.getElementById('hud-av').textContent=CLASSES[G.cls].icon;
  showScr('s2');
  initCanvas();spawnEnemy();updateHUD();renderTab();
  startBGM();
  if(G.idle)startIdle();
  setInterval(saveG,30000);
}

/* =====================================================
   TITLE / SCREEN FLOW
===================================================== */
function showScr(id){document.querySelectorAll('.scr').forEach(s=>s.classList.remove('on'));document.getElementById(id)?.classList.add('on');}
function gotoClassSelect(){
  initAudio();
  const had=loadG();
  if(had&&G.selCls){
    document.getElementById('hud-av').textContent=CLASSES[G.cls].icon;
    showScr('s2');initCanvas();spawnEnemy();updateHUD();renderTab();
    startBGM();if(G.idle)startIdle();setInterval(saveG,30000);
  } else {
    G=mkState();buildClassCards();showScr('s1');
  }
}

/* =====================================================
   TOAST & LEVEL UP
===================================================== */
let toastT;
function toast(msg){
  const el=document.getElementById('toast');
  el.textContent=msg;el.classList.add('show');
  clearTimeout(toastT);toastT=setTimeout(()=>el.classList.remove('show'),2800);
}
let lvlT;
function showLvlUp(){
  const el=document.getElementById('lvlup');
  document.getElementById('lvlup-txt').textContent='LEVEL '+G.lv+'!';
  el.classList.add('show');clearTimeout(lvlT);lvlT=setTimeout(()=>el.classList.remove('show'),1400);
}

/* =====================================================
   TITLE CANVAS
===================================================== */
function titleFX(){
  const cv=document.getElementById('s0-canvas');if(!cv)return;
  cv.width=window.innerWidth;cv.height=window.innerHeight;
  const ctx=cv.getContext('2d');
  const embers=Array.from({length:70},()=>({
    x:Math.random()*cv.width,y:cv.height+Math.random()*80,
    spd:.8+Math.random()*2.5,sz:1+Math.random()*2,
    drift:(Math.random()-.5)*.6,life:0,maxLife:.5+Math.random()*.8,
  }));
  function frame(){
    ctx.clearRect(0,0,cv.width,cv.height);
    const g=ctx.createRadialGradient(cv.width/2,cv.height*.65,0,cv.width/2,cv.height*.65,cv.width*.8);
    g.addColorStop(0,'rgba(120,40,10,.35)');g.addColorStop(.5,'rgba(60,15,5,.15)');g.addColorStop(1,'transparent');
    ctx.fillStyle=g;ctx.fillRect(0,0,cv.width,cv.height);
    embers.forEach(e=>{
      e.y-=e.spd;e.x+=e.drift;e.life+=.02;
      if(e.y<-10||e.life>e.maxLife){e.y=cv.height+10;e.x=Math.random()*cv.width;e.life=0;}
      const a=Math.sin(e.life/e.maxLife*Math.PI);
      ctx.globalAlpha=a*.8;
      ctx.fillStyle=e.life<e.maxLife*.5?'#f08020':'#c03010';
      ctx.fillRect(e.x,e.y,e.sz,e.sz);
    });
    ctx.globalAlpha=1;requestAnimationFrame(frame);
  }
  frame();
}

window.addEventListener('load',()=>{titleFX();});
</script>

</body>
</html>
